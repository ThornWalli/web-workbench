var t=Object.defineProperty,__publicField=(e,i,n)=>((e,i,n)=>i in e?t(e,i,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[i]=n)(e,"symbol"!=typeof i?i+"":i,n);import{i as e,p as i}from"./BHmTNEz3.js";import{B as n,p as s,b as r,T as o}from"./Bk3HlLVR.js";import{f as a,p as h,r as d}from"./BteAwo4N.js";import{S as l,N as c}from"./Ci-h6nfG.js";import{G as g}from"./CybH7Zs2.js";import{d as u,r as f,a0 as x,k as v,o as y,y as m,z as w,A as p,X as b,Y as R,Z as C,$ as B,B as M,a1 as P,_ as N}from"./BfpYGSxR.js";class GridRenderer{constructor(t,e={}){__publicField(this,"canvas"),__publicField(this,"ctx"),__publicField(this,"margin",0),__publicField(this,"beatCount",1),__publicField(this,"gutter",27),__publicField(this,"count",1),__publicField(this,"height",36),__publicField(this,"outerMargin",[10,0,10,0]),__publicField(this,"innerMargin",[0,48,0,48]),__publicField(this,"innerPadding",[20,0,10,0]),__publicField(this,"color","#ffaa55"),this.setOptions(e),this.canvas=t;const i=t.getContext("2d");if(!i)throw new Error("Canvas context is not available");this.ctx=i}setOptions(t){const{gutter:e,height:i,margin:n,color:s,outerMargin:r,innerMargin:o,innerPadding:a}=t||{};this.gutter=e||this.gutter,this.height=i||this.height,this.margin=n||this.margin,this.color=s||this.color,this.outerMargin=r||this.outerMargin,this.innerMargin=o||this.innerMargin,this.innerPadding=a||this.innerPadding}render({beatCount:t,count:e}){this.count=e,this.beatCount=t;const i=this.ctx;i.clearRect(0,0,i.canvas.width,i.canvas.height);for(let n=0;n<this.count;n++)this.renderGridRow(this.getGridBoundingBox(n),this.getInnerGridBoundingBox(n))}getInnerGridRowBoundingBox(t){const{position:i,dimension:n}=this.getInnerGridBoundingBox(t);return{position:i,dimension:e(n.x,n.y*this.beatGrid.y+1)}}get firstRowIndex(){return 0}get lastRowIndex(){return this.count-1}get innerBoundingBox(){return{position:e(this.outerMargin[0],this.outerMargin[1]),dimension:e(this.ctx.canvas.width-(this.outerMargin[0]+this.outerMargin[2]),this.ctx.canvas.height-(this.outerMargin[1]+this.outerMargin[3]))}}get beatGrid(){return e(this.beatCount,4)}get dimension(){return e(this.canvas.width,this.canvas.height)}get mergedMargin(){return[this.outerMargin[0]+this.innerMargin[0],this.outerMargin[1]+this.innerMargin[1],this.outerMargin[2]+this.innerMargin[2],this.outerMargin[3]+this.innerMargin[3]]}getGridBoundingBox(t){const i=this.mergedMargin,n=i[0]+0,s=i[1]+t*this.height+t*this.gutter,r=-(i[0]+i[2])+this.dimension.x,o=this.height/this.beatGrid.y;return{position:e(n,s),dimension:e(r,o)}}getInnerGridBoundingBox(t){const{position:i,dimension:n}=this.getGridBoundingBox(t);return{position:e(i.x+this.innerPadding[0],i.y+this.innerPadding[1]),dimension:e(n.x-this.innerPadding[0]-this.innerPadding[2],(this.height-this.innerPadding[1]-this.innerPadding[3])/this.beatGrid.y)}}renderGridRow(t,e){const i=this.ctx;i.fillStyle=i.strokeStyle=this.color;let n=new Path2D;!function horizontalLines(t,e,{position:i,dimension:n}){for(let s=0;s<=e.y;s++)t.rect(i.x,s*n.y+i.y,n.x,1)}(n,this.beatGrid,t),i.fill(n),n=new Path2D,function verticalLines(t,e,{position:i,dimension:n},s={}){const{first:r,last:o}={first:!1,last:!1,...s};for(let a=r?0:1;a<e.x+o;a++)t.rect(i.x+0+a*Math.floor(n.x/e.x),i.y,1,n.y*e.y)}(n,this.beatGrid,e,{first:!0,last:!0}),i.fill(n),i.fillRect(t.position.x+t.dimension.x-5,t.position.y,5,t.dimension.y*this.beatGrid.y)}}class BeatRenderer{constructor(t,e){__publicField(this,"canvas"),__publicField(this,"ctx"),__publicField(this,"gridRenderer"),__publicField(this,"noteRenderer"),__publicField(this,"padding",10),__publicField(this,"flipActive",!1),__publicField(this,"colors",{primary:"#000000",secondary:"#000000",background:"#0055aa",foreground:"#ffffff",highlight:"#ffaa55"}),__publicField(this,"baseNote",4),__publicField(this,"noteCount",4),__publicField(this,"beats",[]);const{colors:i,gridRenderer:n,noteRenderer:s}={...e};this.colors={...this.colors,...i},this.gridRenderer=n,this.noteRenderer=s,this.canvas=t;const r=t.getContext("2d");if(!r)throw new Error("Canvas context is not available");this.ctx=r}async render({baseNote:t,noteCount:e,beats:i,flipActive:n}){this.flipActive=n||!1,this.baseNote=t,this.noteCount=e,this.beats=i;const s=this.gridRenderer.beatCount,{position:r,dimension:o}=this.gridRenderer.getInnerGridRowBoundingBox(this.gridRenderer.lastRowIndex),a=[];for(let h=0;h<this.beats.length;h++){const t=this.beats[Number(h)],e=o.x/s-2*this.padding,i=r.x+this.padding+h*e+h*this.padding*2;a.push(await this.renderBeat(t,i,e))}return a.flat()}async renderBeat(t,s,r){const o=[],{position:h,dimension:d}=this.gridRenderer.getInnerGridRowBoundingBox(this.gridRenderer.lastRowIndex),c=Object.entries(t.noteGroups);for(let g=0;g<c.length;g++){const[,u]=c[Number(g)];for(let c=0;c<u.length;c++){const{notes:g,align:f}=u[Number(c)];let x;for(let u=0;u<g.length;u++){const v=0===u,y=u===g.length-1,m=g[Number(u)].bindingCount&&(v||x),w=this.flipActive&&g[Number(u)].bindingCount>0&&c%2==1&&g[Number(u)].name,p=await this.resolveNote(g,u,{align:f,flip:!!w,binding:!!m}),{position:b,note:R,canvas:C}=p;let B=p.firstPixel;w&&(B=[C.width-B.x-1,C.height-B.y-1-n]);let M=i(s,h.y);M.x=M.x+r*(R.delay-2*t.index)/2,M.y+=(d.y-C.height)/2,M.y-=C.height/2,M.y+=l,M.y+=n/2,M.y-=b.y,M=i(()=>Math.round(M));let P=C;if(w&&(P=a(C),M.y+=l+P.height-2*n),this.ctx.drawImage(P,M.x,M.y),o.push({dimension:e(P.width,P.height),position:M,note:R}),!R.isPause)if(this.ctx.fillStyle=this.getNoteColors(R).primary||"#000000",0===u&&u===g.length-1){const t={width:5,height:2};for(let e=0;e<R.bindingCount;e++)w?(this.ctx.fillRect(M.x+B.x,M.y+n+B.y+-6*e,t.width,t.height),this.ctx.fillRect(M.x+B.x+t.width-2,M.y+n+B.y+-6*e-2,2,2)):(this.ctx.fillRect(M.x+B.x,M.y+B.y+6*e,t.width,t.height),this.ctx.fillRect(M.x+B.x+t.width-2,2+M.y+B.y+6*e,2,2))}else if(v)x=e(M.x+B.x,M.y+B.y);else if(y){if(!x)throw new Error("startNote is not defined");this.ctx.lineWidth=1;const t=4;this.ctx.beginPath();for(let e=0;e<R.bindingCount;e++)if(w){const i=6;this.ctx.moveTo(x.x,x.y+n-e*i),this.ctx.lineTo(M.x+B.x+1,M.y+B.y+n-e*i),this.ctx.lineTo(M.x+B.x+1,M.y+B.y+n-e*i+t),this.ctx.lineTo(x.x,x.y+n-e*i+t),this.ctx.lineTo(x.x,x.y+n-e*i)}else{const i=6;this.ctx.moveTo(x.x,x.y+e*i),this.ctx.lineTo(M.x+B.x+1,M.y+B.y+e*i),this.ctx.lineTo(M.x+B.x+1,M.y+B.y+e*i+t),this.ctx.lineTo(x.x,x.y+e*i+t),this.ctx.lineTo(x.x,x.y+e*i)}this.ctx.fill(),x=null}}}}return o}async resolveNote(t,i,{align:s,flip:r,binding:o}){const a=t[Number(i)],h=e(0,a.octavePosition*n);let d=0;const l=s===g.ASCENDING,c=s===g.EQUAL?0:3,u=t[t.length-1],f=t[0];o&&(d=r?l?Math.floor((a.octavePosition-f.octavePosition)*n-c*i):Math.floor((a.octavePosition-u.octavePosition)*n-c*(t.length-1-i)):l?Math.floor((u.octavePosition-a.octavePosition)*n-c*(t.length-1-i)):Math.floor((f.octavePosition-a.octavePosition)*n-c*i));const{canvas:x,...v}=await this.noteRenderer.render(a,{colors:this.getNoteColors(a)},d);return{offsetHeight:d,position:h,note:a,canvas:x,...v}}getNoteColors(t){return{primary:t.selected?this.colors.highlight:this.colors.foreground,secondary:this.colors.background}}}class TimelineRenderer{constructor(t,e={colors:{}}){__publicField(this,"canvas"),__publicField(this,"ctx"),__publicField(this,"noteRenderer"),__publicField(this,"gridRenderer"),__publicField(this,"beatRenderer"),__publicField(this,"colors",{background:"#0055aa",foreground:"#ffffff",highlight:"#ffaa55"}),__publicField(this,"gridInnerPadding",[20,0,10,0]);const{colors:i}=e||{};if(this.colors={...this.colors,...i},!t)throw new Error("Canvas is not available");this.canvas=t;const n=t.getContext("2d",{willReadFrequently:!0});if(!n)throw new Error("Canvas context is not available");this.ctx=n,this.noteRenderer=new c,this.gridRenderer=new GridRenderer(this.canvas,{innerPadding:this.gridInnerPadding}),this.beatRenderer=new BeatRenderer(this.canvas,{gridRenderer:this.gridRenderer,noteRenderer:this.noteRenderer})}async render(t,e={}){e={selectedIndex:[],flipActive:!1,...e},this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.gridRenderer.render({beatCount:t.beatCount,count:this.getOctaveLength(t)});let i=[];try{const n=t.getVisibleBeatsByDuration(void 0,s(t.notes));i=await this.beatRenderer.render({flipActive:e.flipActive,baseNote:t.baseNote,noteCount:t.noteCount,beats:n})}catch(n){console.error(n)}for(let s=0;s<this.gridRenderer.count;s++){const{position:e}=this.gridRenderer.getGridBoundingBox(s);this.renderTimeSignature(t,e.x+(this.gridInnerPadding[0]-6)/2,e.y+3)}return h(this.ctx,["#000000","#ffffff",...Object.values(this.colors)]),{notes:i}}renderTimeSignature(t,e,i){const n=this.ctx;n.fillStyle=this.colors.foreground,n.textBaseline="top",n.font='16px "Amiga Topaz 13", sans-serif',n.fillText(String(t.baseNote),e,i),n.fillText(String(t.noteCount),e,i+16+1)}getOctaveLength(t){const{length:e}=r(t.notes);return Math.max(Math.floor(.8*e),1)}getDimension(t){const{height:i,gutter:n,outerMargin:s,innerMargin:r}=this.gridRenderer,o=this.getOctaveLength(t);return e(0,i*o+n*(o-1)+s[1]+s[3]+r[1]+r[3])}}const G={class:"synthesizer-timeline-canvas"},T=["data-note","data-time","onClick"],I=N(u({__name:"TimelineCanvas",props:{flipActive:{type:Boolean,default:!1},track:{type:o,required:!0},clickable:{type:Boolean,default:!1},static:{type:Boolean,default:!1},selectedNotes:{type:Array,default:()=>[]},density:{type:Number,default:()=>window.devicePixelRatio||1}},emits:["refresh","ready","note:click"],setup(t,{emit:i}){const n=f(),s=t,r=i,o=f(),a=f(),h=f(e(0,0));let l,c;const g=f(!1),u=f();x(()=>s.track,()=>{s.static||(window.clearTimeout(c),c=window.setTimeout(async()=>{await render(),c=void 0},250))},{deep:!0});const N=v(()=>{var t;return s.clickable&&(null==(t=o.value)?void 0:t.notes)||[]}),render=async()=>{var t;if(a.value&&n.value&&u.value){h.value=a.value.getDimension(s.track),n.value.width=n.value.offsetWidth*s.density,n.value.height=h.value.y*s.density,u.value.width=n.value.offsetWidth,u.value.height=h.value.y,o.value=await a.value.render(s.track,{flipActive:s.flipActive});const e=d(u.value,n.value.width);null==(t=n.value.getContext("2d"))||t.drawImage(e,0,0,e.width,e.height,0,0,n.value.width,n.value.height)}};y(()=>{u.value=u.value||document.createElement("canvas"),createRenderer(),r("ready"),g.value=!0});const createRenderer=async()=>{if(!u.value)throw new Error("Canvas not found");a.value=new TimelineRenderer(u.value),await(()=>{const subRender=t=>{window.requestAnimationFrame(()=>{P(async()=>{await render(),r("refresh"),t()})})};return new Promise(t=>{g.value?(window.clearTimeout(l),l=window.setTimeout(async()=>{await subRender(t),l=void 0},100)):subRender(t)})})()};return(e,i)=>(w(),m("div",G,[p("canvas",{ref_key:"canvasEl",ref:n,width:"0",height:"0"},null,512),(w(!0),m(b,null,R(N.value,({position:e,dimension:i,note:n})=>{var o,a;return w(),m("button",{key:n.index,"data-note":null==(o=n.note)?void 0:o.toString(),"data-time":null==(a=n.time)?void 0:a.toString(),class:B({selected:n.index===t.track.selectedIndex}),style:C({...e.toCSSVars("position"),...i.toCSSVars("dimension")}),onClick:t=>(t=>{s.track.selectedIndex===t.index?s.track.setSelectedIndex(-1):s.track.setSelectedIndex(t.index),r("note:click",{note:t,selected:s.track.selectedIndex===t.index})})(n)},[p("span",null,"Note "+M(n.index),1)],14,T)}),128))]))}}),[["__scopeId","data-v-89880751"]]);export{I as T};
