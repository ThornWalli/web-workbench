import{N as m,T as I}from"./ehWpBOkw.js";import{G as g,I as S}from"./B1Xgq4rl.js";var f={},p;function A(){if(p)return f;p=1,Object.defineProperty(f,"__esModule",{value:!0}),f.isRangeOverlap=void 0;function s(e,t,r,n,a){var c,o,h,d,i=!1;return Array.isArray(e)&&Array.isArray(t)?(c=e[0],o=e[1],h=t[0],d=t[1],i=r===!0):r===void 0?(e=e,t=t,c=e.start,o=e.end,h=t.start,d=t.end,i=r===!0):(c=e,o=t,h=r||e,d=n||t,i=a===!0),i?c<d&&h<o:c<=d&&h<=o}return f.isRangeOverlap=s,f}var v=A();class y extends m{octavePosition;origin;constructor(e={}){super(e);const{selected:t,octavePosition:r,origin:n}=e||{};this.selected=t!==void 0?t:!1,this.octavePosition=r!==void 0?r:0,this.origin=n}resolvedIndex(){return this.origin!==void 0?this.origin.index:this.index}toJSON(){return{...super.toJSON(),selected:this.selected,octavePosition:this.octavePosition,index:this.index}}}function L(){return Object.fromEntries([2,4,8,12,16].map(s=>[String(s),s]))}function q(s){return Math.max(Math.min((-1+s/.5)*30,30),-30)}const H=9;function G(s,e){let t=e.name;if(t){const r=t.match(/(.+)(\d+)/)||[];t=r[1];const n=Number(r[2]);let a=t;t.length&&(a=t[0]);const c=n-s,o={c:3,d:2.5,e:2,f:1.5,g:1,a:.5,b:0}[a.toLowerCase()];if(o===void 0)throw new Error(`Unknown note name: ${a}`);return o*-1+c+2.5*c}else return-2.5/2}const C={cbbb:-3,cbb:-2,cb:-1,c:0,"c#":1,cx:2,"c##":2,"c###":3,"cx#":3,"c#x":3,dbbb:-1,dbb:0,db:1,d:2,"d#":3,dx:4,"d##":4,"d###":5,"dx#":5,"d#x":5,ebbb:1,ebb:2,eb:3,e:4,"e#":5,ex:6,"e##":6,"e###":7,"ex#":7,"e#x":7,fbbb:2,fbb:3,fb:4,f:5,"f#":6,fx:7,"f##":7,"f###":8,"fx#":8,"f#x":8,gbbb:4,gbb:5,gb:6,g:7,"g#":8,gx:9,"g##":9,"g###":10,"gx#":10,"g#x":10,abbb:6,abb:7,ab:8,a:9,"a#":10,ax:11,"a##":11,"a###":12,"ax#":12,"a#x":12,bbbb:8,bbb:9,bb:10,b:11,"b#":12,bx:13,"b##":13,"b###":14,"bx#":14,"b#x":14};Object.values(C).reduce((s,e)=>s=Math.min(s,e),1/0);Object.values(C).reduce((s,e)=>s=Math.max(s,e),-1/0);function D(s){const{min:e,max:t}=s.filter(r=>r.octave).reduce((r,n)=>(n.octave!==void 0&&(r.min=Math.min(n.octave,r.min),r.max=Math.max(n.octave,r.max)),r),{min:1/0,max:-1/0});return{max:t,min:e,length:Math.max(Math.ceil(t-e),1)}}function O(s){return s.reduce((e,t)=>(e+=t.toSeconds(),e),0)}const T={"A#":["A","C#","E"],"B#":["B","D#","F#"],"C#":["C","E","G"],"D#":["D","F#","A"],"E#":["E","G#","B"],"F#":["F","A","C"],"G#":["G","B","D"],"Ab#":["Ab","C","Eb"],"Bb#":["Bb","D","F"],"Cb#":["Cb","Eb","Gb"],"Db#":["Db","F","Ab"],"Eb#":["Eb","G","Bb"],"A#2":["A","C#","E","B"],"B#2":["B","D#","F#","C#"],"C#2":["C","E","G","D"],"D#2":["D","F#","A","E"],"F#2":["F","A","C","D"],"G#2":["G","B","D","A"],"Ab#2":["Ab","C","Eb","Bb"],"Bb#2":["Bb","D","F","C"],"Cb#2":["Cb","Eb","Gb","Db"],"Db#2":["Db","F","Ab","Eb"],"Eb#2":["Eb","G","Bb","F"]};function F(s){if(/^([A-Za-z]+[#xb]{,2})(\d)+$/.test(s)){const[,e,t]=s.match(/^([A-Za-z]+[#xb]{,2})(\d)+$/)||[];return Array.from(new Set(T[e]?.map(F).flat()||[s])).map(r=>`${r}${t||""}`)}return[s]}function V({triplet:s=!1,dotted:e=!1,natural:t=!0}={}){return[1,2,4,8,16,32].map(r=>[t?`${r}n`:void 0,s?`${r}t`:void 0,e?`${r}n.`:void 0].filter(Boolean)).flat().map(r=>(r=r,[r,I(r).toSeconds()]))}class P{noteGroups;index;constructor({noteGroups:e,index:t}){this.noteGroups=e,this.index=t}get empty(){return!Object.values(this.noteGroups).length}get selected(){return Object.values(this.noteGroups).some(e=>e.some(t=>t.notes.some(r=>r.selected)))}}class w{notes;align;constructor({align:e,notes:t}){this.notes=t,this.align=e}get startSeconds(){return this.notes[0].delay}get endSeconds(){const e=this.notes[this.notes.length-1];return e.delay+e.toSeconds()}get selected(){return this.notes.some(({selected:e})=>e)}getNote(e){return this.notes[Number(e)]}}function J(s){const{min:e}=D(s);return Array().concat(s).sort((t,r)=>t.delay-r.delay).map((t,r)=>new y({...t,index:r,octavePosition:G(e,t)}))}function M(s){return s.reduce((e,[,t])=>Math.max(t.reduce((r,{notes:n})=>Math.max(n.reduce((a,c)=>Math.max(c.delay+c.toSeconds(),a),0),r),0),e),0)}function R(s,e=1){const t=Object.entries(s),r=e*2,n=M(t),a=Math.ceil(n/r),c=[];for(let o=0;o<a;o++){const h=[];for(let d=0;d<t.length;d++){const[i,u]=t[Number(d)],l=u.filter(({startSeconds:B,endSeconds:E})=>B>=o*r&&E<=(o+1)*r);l.length&&h.push([i,l])}c.push(new P({noteGroups:Object.fromEntries(h),index:o}))}return c}function $(s){const e=s.reduce((n,a)=>{const{time:c}=a,o=c?.toString();return n[o||"pause"]||(n[o||"pause"]=[]),n[o||"pause"].push(a),n},{}),r=Object.entries(e).map(([n,a])=>[n,a.sort((c,o)=>c.octave-o.octave||c.delay-o.delay)]).map(([n,a])=>[n,j(a)]).sort((n,a)=>n.toString()[0].localeCompare(a.toString()[0]));return Object.fromEntries(r)}function j(s){const e=[];for(;s.length;){const t=s.shift();let r=[];r=s.reduce((i,u)=>(u.delay>=t.delay+t.toSeconds()&&i.push(u),i),[]),r=r.reduce((i,u)=>((!i.length||i.length&&i[i.length-1].delay<=u.delay+u.toSeconds())&&i.push(u),i),[]),r=r.reduce((i,u,l)=>(r[0].delay-t.delay<=.5&&(!t.time?.triplet||t.time.triplet&&l<2)&&i.push(u),i),[]),r=r.reduce((i,u)=>(u.delay-t.delay%2+u.toSeconds()<=t.delay-t.delay%2+2-t.delay%2&&i.push(u),i),[]);let n=!1,a=t;r=r.reduce((i,u)=>((!n||n===x(u.octavePosition-a.octavePosition))&&i.push(u),n=x(u.octavePosition-a.octavePosition),a=u,i),[]);const c=1;let o;r=r.reduce((i,u)=>{const l=(o||t).octavePosition-u.octavePosition;return l>-c&&l<c&&i.push(u),o=u,i},[]);let h=0;r.length&&(h=r[0].octavePosition-t.octavePosition);let d=g.ASCENDING;d=x(h),s=s.filter(i=>!r.includes(i)),r.unshift(t),e.push(new w({notes:r,align:d}))}return e}function x(s){return s<0?g.DESCENDING:s>0?g.ASCENDING:g.EQUAL}class N{number;baseCharacter;dot;triplet;constructor(e){const{number:t,character:r,dot:n}=_(e);this.number=t,this.baseCharacter=r,this.dot=n||!1,this.triplet=r==="t"}get character(){return this.triplet?"t":this.baseCharacter}toString(){return`${this.number}${this.character}${this.dot?".":""}`}static parse(e){return new N(e)}}function _(s){if(s instanceof N||typeof s=="number")return s;try{const[,e,t,r]=s.match(/^(\d+)([a-z])(\.?)$/i)||[];return{number:Number(e),character:t,dot:!!r,triplet:t==="t"}}catch(e){console.error(e);debugger;throw e}}const b=2;class U{id;type;name;notes;baseNote;beatCount;noteCount;speed=1;selectedIndex=-1;currentDuration=0;constructor(e={}){const{id:t,type:r,name:n,notes:a,baseNote:c,beatCount:o,noteCount:h,speed:d}=e;this.id=t||crypto.randomUUID(),this.type=r||S.SYNTH,this.name=n||"Track",this.notes=(a||[]).map(i=>new m(i)),this.refreshNotes(),this.beatCount=Number(o||1),this.baseNote=Number(c||4),this.noteCount=Number(h||4),this.speed=Number(d||1)}setSelectedIndex(e){this.selectedIndex=e}setCurrentDuration(e){this.currentDuration=e}getOctaveRange(){const{min:e,length:t}=D(this.notes);return{start:e,count:t}}reset(){this.selectedIndex=-1,this.notes=[]}addNote(e){if(e=new m(e),!this.notes.find(t=>t.getName()===e.getName()&&v.isRangeOverlap(t.delay,t.toSeconds(),e.delay,e.delay+e.toSeconds())))return this.notes.push(e),this.refreshNotes(),e}addNoteTo(e,t){return this.notes=[...this.notes.slice(0,e+1),new m(t),...this.notes.slice(e+1)],this.refreshNotes(),t}getNote(e){return this.notes[Number(e)]}replaceNote(e,t){return this.notes[Number(e)]=new m(t),this.refreshNotes(),this.notes[Number(e)]}removeNote(e){this.notes=this.notes.filter((t,r)=>e!==r),this.refreshNotes()}refreshNotes(){this.notes=[...this.notes].sort((e,t)=>e.delay-t.delay).map((e,t)=>(e.index=t,e))}removeNotesByDurationRange(e,t){this.getNotesByDurationRange(e,t).forEach(({index:r})=>this.removeNote(r))}removeNotesFromBeat(e){const t=e*b,r=b;this.removeNotesByDurationRange(t,r)}getDuration(){return O(this.notes)}getNotesByDurationRange(e,t){return this.notes.filter(r=>v.isRangeOverlap(e,e+t,r.delay,r.delay+r.toSeconds()))}getVisibleBeatsByDuration(e,t=this.notes){e=e!==void 0?e:this.currentDuration;const r=this.getBeatIndex(e);t=t.filter(a=>a.delay>=r*b&&a.delay+a.toSeconds()<r*b+this.beatCount*b);const n=this.getBeats({selectedIndex:this.selectedIndex,speed:this.speed},t);return console.log("slice",t.length),n.slice(r,r+this.beatCount)}getVisibleBeats(){const e=this.getBeats({selectedIndex:this.selectedIndex,speed:this.speed});let t=e.find(r=>r.selected)?.index||0;return t=Math.floor(t/this.beatCount)*this.beatCount,e.slice(t,t+this.beatCount)}getNotationFromNoteCount(){return new N(`${this.noteCount}n`)}getBeats(e={},t=this.notes){const{selectedIndex:r,speed:n}={selectedIndex:-1,speed:1,...e};r>-1&&t.find(({index:o})=>r===o)&&t.filter(({index:o})=>r===o).forEach(o=>o.selected=!0);const a=t.filter(o=>o instanceof y);if(a.length!==t.length){debugger;throw new Error("TimelineNoteDesciptions and notes not equal.")}const c=$(a);return R(c,n)}getBeatIndex(e=this.currentDuration){return(e/(b*this.beatCount)-e%(b*this.beatCount)/(b*this.beatCount))*this.beatCount}getCurrentNote(){return this.getNote(this.selectedIndex)}selectPrevNote(){this.selectedIndex=Math.max(this.selectedIndex-1,-1)}selectNextNote(){this.selectedIndex=Math.min(this.selectedIndex+1,this.notes.length-1)}}const Z=Object.freeze(Object.defineProperty({__proto__:null,default:U},Symbol.toStringTag,{value:"Module"}));export{H as B,U as T,L as a,D as b,V as c,Z as d,q as g,J as p,F as r};
