import{g as R,w as x,j as K,k as U,u as H,C as Y,r as Z,q as u}from"./index.69ac9e5a.js";import{N as D,j as L,g as V,k as F,C as s,l as B,I as T,m as $,n as A,o as v,p as _,M as z,q as P}from"./index.01a5c491.js";import{W}from"./ContextMenu.189b859b.js";import{_ as S,f as p,k as l,l as d,m,q as y,N as f,O,L as C,M as E,t as g,C as N,S as b,Z as j,W as w,E as q,I,z as G,H as M,a3 as X}from"./entry.e14887ae.js";import{N as J,T as Q,u as ee,c as te}from"./Navigation.905ae09b.js";import{T as ae}from"./TimelineCanvas.dec8cd2e.js";import"./index.56665add.js";import"./viewport.b344546e.js";import"./math.2df7af34.js";import"./async.59d11cc0.js";const se={components:{WbEnvMoleculeContextMenu:W},props:{parentLayout:{type:Object,default(){return{size:R(window.innerWidth,window.innerHeight)}}},title:{type:String,default:"Web-Workbench release. Version 1.3"},items:{type:Array,default(){return x.modules.windows.contextMenu.activeItems.items}}},emits:["inputContextMenu"],data(){return{cover:!1}},methods:{onUpdateModelValueContextMenu(...e){this.$emit("inputContextMenu",...e)}}},ne={class:"wb-env-molecule-footer"},oe={ref:"menu",class:"menu"};function ie(e,a,n,i,o,t){const r=p("wb-env-molecule-context-menu");return l(),d("footer",ne,[m("nav",oe,[y(r,{direction:"top",items:n.items,"parent-layout":n.parentLayout,"onUpdate:modelValue":t.onUpdateModelValueContextMenu},null,8,["items","parent-layout","onUpdate:modelValue"])],512)])}const re=S(se,[["render",ie],["__scopeId","data-v-f49caf4e"]]);const le=9,ce={props:{selectedNote:{type:D,default:null},size:{type:String,validator:e=>["small","medium","large"].includes(e),default:"large"},showNoteLabels:{type:Boolean,default:!1},startOctave:{type:Number,default:4},octaveCount:{type:Number,default:6}},emits:["down","up"],data:function(){return{keys:[],dimension:R()}},computed:{selectedNotes(){var e;return this.selectedNote&&L((e=this.selectedNote)==null?void 0:e.name)||[]},height(){return{small:140,medium:210,large:280}[this.size]},octaveRange(){const e=[],a=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];for(let n=0;n<this.octaveCount;n++)e.push(...a.map(i=>{const o=`${i}${this.startOctave+n}`;return{note:o,black:this.isBlackKey(o)}}));return this.startOctave+this.octaveCount<=le&&e.push({note:a[0]+(this.startOctave+this.octaveCount),black:!1}),e},styleClasses(){return{...this.dimension.toCSSVars("dimension"),"--height":this.height,"--keys":this.octaveRange.filter(({black:e})=>!e).length,"--white-keys":this.octaveRange.filter(({black:e})=>!e).length,"--black-keys":this.octaveRange.filter(({black:e})=>e).length}}},mounted(){this.dimension=R(this.$el.offsetWidth,0)},methods:{isBlackKey(e){return/^[a-zA-Z]{2}\d+/.test(e)},onPointerDown(e){this.$emit("down",e)},onPointerUp(e){this.$emit("up",e)}}},de={class:"keys white"},ue=["onPointerdown","onPointerup"],_e={key:0},me={key:0},he={class:"keys black"},Te=["onPointerdown","onPointerup"],Ne={key:0},ke={key:0};function pe(e,a,n,i,o,t){return l(),d("div",{style:E(t.styleClasses),class:"wb-disks-debug-synthesizer-keyboard"},[m("div",null,[m("div",de,[(l(!0),d(f,null,O(t.octaveRange,({note:r,black:c},h)=>(l(),d("div",{key:h,class:C(["key",{black:c,white:!c,selected:t.selectedNotes.includes(r)}]),style:E({"--index":h}),onPointerdown:k=>t.onPointerDown(r),onPointerup:k=>t.onPointerUp(r)},[c?N("",!0):(l(),d("span",_e,[n.showNoteLabels?(l(),d("i",me,g(r),1)):N("",!0)]))],46,ue))),128))]),m("div",he,[(l(!0),d(f,null,O(t.octaveRange,({note:r,black:c},h)=>(l(),d("div",{key:h,class:C(["key",{black:c,white:!c,selected:t.selectedNotes.includes(r)}]),style:E({"--index":h}),onPointerdown:k=>t.onPointerDown(r),onPointerup:k=>t.onPointerUp(r)},[c?(l(),d("span",Ne,[n.showNoteLabels?(l(),d("i",ke,g(r),1)):N("",!0)])):N("",!0)],46,Te))),128))])])],4)}const ye=S(ce,[["render",pe],["__scopeId","data-v-4e246311"]]);const Ce={components:{WbEnvMoleculeFooter:re,Navigation:J,Keyboard:ye,SynthesizerTimelineCanvas:ae},props:{...K,model:{type:Object,default:V()},trackModel:{type:Object,default:F()},toneDestination:{type:Object,default:null}},emits:[...U],setup(e,a){const n=b(e,"model"),i=b(e,"trackModel"),o=H(e,a);j(n,()=>{o.setContextMenu(te,{model:n.value,trackModel:i.value,preserveContextMenu:o.preserveContextMenu})},{immediate:!0,deep:!0});const t=w(i.value[s.SYNTHESIZER_TRACK]),r=w(new Q(t));return{...o,...ee(),track:t,trackPlayer:r}},data(){return{CONFIG_NAMES:s,currentSequence:null,synth:null,maxLength:11,playing:!1,footerModel:{},windowsModule:q(this.core.modules.windows)}},computed:{selectedNoteIndex(){return this.track.selectedIndex},styleClasses(){return{[`keyboard-alignment-${this.trackModel[s.SYNTHESIZER_TRACK_KEYBOARD_ALIGNMENT]}`]:!0}},notes:{get(){return this.track.notes},set(e){this.track.notes=e}},showKeyboard(){return this.trackModel[s.SYNTHESIZER_TRACK_SHOW_KEYBOARD]},keybordData(){return{size:this.trackModel[s.SYNTHESIZER_TRACK_KEYBOARD_SIZE],showNoteLabels:this.trackModel[s.SYNTHESIZER_TRACK_SHOW_NOTE_LABELS],selectedNote:this.notes[this.selectedNoteIndex],startOctave:this.trackModel[s.SYNTHESIZER_TRACK_START_OCTAVE],octaveCount:this.trackModel[s.SYNTHESIZER_TRACK_OCTAVE_COUNT]}},bpm(){return Number(this.model[s.SYNTHESIZER_BPM])},masterVolume(){return this.core.config.observable[Y.SCREEN_CONFIG].soundVolume},decibelValue(){return B(this.masterVolume)},isMaxLength(){return this.track.octaveCount>=this.maxLength},duration(){return this.trackModel[s.SYNTHESIZER_TRACK_DURATION]},noteDiagramControlNavigation(){var e;return{model:this.trackModel,items:[[this.trackPlayer.playing?{selected:!0,title:"Pause",disabled:!this.trackPlayer.currentSequence||!this.trackPlayer.playing,onClick:()=>this.onClickPlause()}:{title:"Play",disabled:this.trackPlayer.playing||this.track.notes.length===0,onClick:()=>this.onClickPlay()},{title:"Stop",disabled:!this.trackPlayer.currentSequence,onClick:()=>this.onClickStop()},{title:"Restart",disabled:this.selectedNoteIndex<0,onClick:()=>this.onClickRestart()},{title:"Reset",disabled:this.track.notes.length===0,onClick:()=>this.onClickReset()}],[{disabled:!((e=this.track.getCurrentNote())!=null&&e.isPaused),title:"Duration",onClick:async()=>{const a=this.track.getCurrentNote();this.preserveContextMenu(!0);const n="Set Duration:",i=await this.core.executeCommand(`openDialog -title="${n}" -prompt -prompt-type=number -prompt-step=0.01 -prompt-value="${a.toSeconds()/2}" -apply="Save" -abort="Cancel"`);i&&(a.duration=Number(i*2),a.time=null),this.preserveContextMenu(!1),this.window.focus()}},{disabled:this.selectedNoteIndex===-1,title:"Replace",name:s.SYNTHESIZER_TRACK_INPUT_OPERATION,value:T.REPLACE},{disabled:this.selectedNoteIndex===-1,title:"Add",name:s.SYNTHESIZER_TRACK_INPUT_OPERATION,value:T.ADD},{disabled:this.selectedNoteIndex===-1,title:"Remove",onClick:()=>{this.track.removeNote(this.selectedNoteIndex)}},{spacer:!0},{title:"Prev",disabled:this.selectedNoteIndex<0,onClick:()=>{this.track.selectPrevNote()}},{title:"Next",disabled:this.selectedNoteIndex>=this.track.notes.length-1,onClick:()=>{this.track.selectNextNote()}}]]}},footer(){const e=this.track,a=this.trackModel,n=e.getDuration();return{items:Z([{type:u.TEXT,text:`${this.track.selectedIndex}/${this.notes.length}`},{type:u.DEFAULT,title:`Instrument: ${this.track.type}`,items:Object.entries($()).map(([i,o])=>({type:u.RADIO,title:o,model:e,name:"type",value:i}))},{type:u.SEPARATOR},{title:`Octave: ${a[s.SYNTHESIZER_TRACK_START_OCTAVE]}-${a[s.SYNTHESIZER_TRACK_START_OCTAVE]+a[s.SYNTHESIZER_TRACK_OCTAVE_COUNT]-1}`,items:[{type:u.DEFAULT,title:"Start Octave",items:Array(9).fill({}).map((i,o)=>({type:u.RADIO,title:String(o+1),model:a,name:s.SYNTHESIZER_TRACK_START_OCTAVE,value:o+1,action(t){t=Number(t),t+a[s.SYNTHESIZER_TRACK_OCTAVE_COUNT]>9&&(a[s.SYNTHESIZER_TRACK_OCTAVE_COUNT]=10-t)}}))},{type:u.DEFAULT,title:"Octave Count",items:Array(10-a[s.SYNTHESIZER_TRACK_START_OCTAVE]).fill({}).map((i,o)=>({type:u.RADIO,title:String(o+1),model:a,name:s.SYNTHESIZER_TRACK_OCTAVE_COUNT,value:o+1}))}]},{type:u.SPACER},{type:u.TEXT,text:`Dur.: ${n}`},{type:u.TEXT,text:`BPM: ${this.bpm}`},{type:u.TEXT,text:`${this.decibelValue.toFixed(2)} db`}])}},currentNoteTimeName(){var e;return(e=this.track.getCurrentNote())==null?void 0:e.time.toString()},noteNavigation(){const e=this.trackModel,a=this.selectedNoteIndex>-1?this.track.getCurrentNote():this.trackModel,n=this.trackModel[s.SYNTHESIZER_TRACK_INPUT_OPERATION]===T.REPLACE&&this.selectedNoteIndex>-1;return{model:e,items:[n?[{fill:!0,title:"Pause",onClick:()=>this.addPause()},...Object.entries(A(!0,a.time.triplet)).map(([i,o])=>({title:`${o} Note`,selected:this.currentNoteTimeName===i,action(){a.time=new v(i)}}))]:[{fill:!0,title:"Pause",onClick:()=>this.addPause()},...Object.entries(A(!0,this.trackModel[s.SYNTHESIZER_TRACK_INPUT_TRIPLET])).map(([i,o])=>({title:`${o} Note`,name:s.SYNTHESIZER_TRACK_DURATION,value:i}))],n?[{title:"Dot",name:"dot",model:a.time},{title:"Triplet",name:"triplet",model:a.time},{fill:!0,title:"Natural",name:"modification",model:a.note,value:_.NATURAL},{fill:!0,title:"Flat",name:"modification",model:a.note,value:_.FLAT},{fill:!0,title:"2x Flat",name:"modification",model:a.note,value:_.DOUBLE_FLAT},{fill:!0,title:"Sharp",name:"modification",model:a.note,value:_.SHARP},{fill:!0,title:"2x Sharp",name:"modification",model:a.note,value:_.DOUBLE_SHARP}]:[{title:"Dot",name:s.SYNTHESIZER_TRACK_INPUT_DOT},{title:"Triplet",name:s.SYNTHESIZER_TRACK_INPUT_TRIPLET},{fill:!0,title:"Natural",name:s.SYNTHESIZER_TRACK_INPUT_MODIFICATION,value:_.NATURAL},{fill:!0,title:"Flat",name:s.SYNTHESIZER_TRACK_INPUT_MODIFICATION,value:_.FLAT},{fill:!0,title:"2x Flat",name:s.SYNTHESIZER_TRACK_INPUT_MODIFICATION,value:_.DOUBLE_FLAT},{fill:!0,title:"Sharp",name:s.SYNTHESIZER_TRACK_INPUT_MODIFICATION,value:_.SHARP},{fill:!0,title:"2x Sharp",name:s.SYNTHESIZER_TRACK_INPUT_MODIFICATION,value:_.DOUBLE_SHARP}]]}}},watch:{"trackPlayer.noteIndex"(e){this.track.selectedIndex=e},bpm(){var e;(e=this.trackPlayer)==null||e.stop()},masterVolume:{handler(){z.volume.value=this.decibelValue},immediate:!0},"track.type":{handler(){this.trackPlayer.createInstrument(this.track.type)},immediate:!0}},mounted(){console.log("TRACK",this.track)},unmounted(){this.trackPlayer.destroy()},methods:{async setup(){this.tone.ready||(await this.tone.start(),this.trackPlayer.createInstrument(this.track.type))},onClickReset(){this.trackModel[s.SYNTHESIZER_TRACK_INPUT_OPERATION]=T.ADD,this.trackPlayer.reset(),this.track.selectedIndex=-1},async onClickPlay(){await this.setup(),this.trackPlayer.play(this.selectedNoteIndex)},onClickPlause(){this.trackPlayer.pause()},onClickStop(){this.trackPlayer.stop()},onClickRestart(){this.trackPlayer.restart()},async onClickNote({note:e,selected:a}){await this.setup(),a&&e.name&&this.trackPlayer.instrument.triggerAttackRelease(e.name,e.time)},addPause(){this.noteInput()},noteInput(e,a){const n=this.track.selectedIndex;if(e===T.REPLACE){const c=this.track.getCurrentNote(),{name:h}=P.parse(a);return c.note.name=h,this.track.replaceNote(n,c)}const i=this.trackModel[s.SYNTHESIZER_TRACK_INPUT_MODIFICATION],o=new P(a,{modification:i}),t=new v(this.duration);t.dot=this.trackModel[s.SYNTHESIZER_TRACK_INPUT_DOT],t.triplet=this.trackModel[s.SYNTHESIZER_TRACK_INPUT_TRIPLET];const r=new D({note:o,time:t});if(n>-1)switch(e){case T.ADD:return this.track.addNoteTo(n,r);case T.REPLACE:return this.track.replaceNote(n,r)}return this.track.addNote(r)},async onDownKeyboard(e){await this.setup(),this.noteInput(this.trackModel[s.SYNTHESIZER_TRACK_INPUT_OPERATION],e),this.trackPlayer.instrument.triggerAttack(e)},async onUpKeyboard(){await this.tone.awaitReady,this.trackPlayer.instrument.triggerRelease()}}},Ee={key:0,class:"keyboard"},Ie={class:"panel"},Re={key:0,class:"test"},Se={class:"sheet"};function Ae(e,a,n,i,o,t){const r=p("keyboard"),c=p("navigation"),h=p("synthesizer-timeline-canvas"),k=p("wb-env-molecule-footer");return l(),d("div",{class:C(["wb-disks-extras13-synthesizer-track",t.styleClasses])},[m("div",null,[m("div",null,[t.showKeyboard?(l(),d("div",Ee,[y(r,I(t.keybordData,{onDown:t.onDownKeyboard,onUp:t.onUpKeyboard}),null,16,["onDown","onUp"]),m("span",{class:C(["message",{show:t.isMaxLength}])},"Octave length is to largeâ€¦",2)])):N("",!0),t.showKeyboard?(l(),G(c,M(I({key:1},t.noteNavigation)),null,16)):N("",!0)]),m("div",Ie,[t.showKeyboard?(l(),d("div",Re)):N("",!0),y(c,M(X(t.noteDiagramControlNavigation)),null,16),m("div",Se,[m("div",null,[y(h,{clickable:"",track:i.trackPlayer.track,"onNote:click":t.onClickNote},null,8,["track","onNote:click"])])])])]),y(k,I(t.footer,{"parent-layout":o.windowsModule.contentWrapper.layout}),null,16,["parent-layout"])],2)}const Ke=S(Ce,[["render",Ae],["__scopeId","data-v-aee9efa0"]]);export{Ke as default};
