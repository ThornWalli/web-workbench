var xe=Object.defineProperty;var ue=s=>{throw TypeError(s)};var _e=(s,e,t)=>e in s?xe(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var c=(s,e,t)=>_e(s,typeof e!="symbol"?e+"":e,t),Ae=(s,e,t)=>e.has(s)||ue("Cannot "+t);var k=(s,e,t)=>(Ae(s,e,"read from private field"),t?t.call(s):e.get(s)),he=(s,e,t)=>e.has(s)?ue("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t);import{I as Le,i as m,p as Te}from"./BGIFtisS.js";import{S as B}from"./RAasLaaH.js";import{v as ee}from"./BYXSjlja.js";import{f as fe}from"./CSlkdJUE.js";import{M as _,J as R,r as ge,aa as Re}from"./BHV1diwp.js";import{S as y,I as d}from"./Dhinf-AH.js";class H{constructor(e){c(this,"id");c(this,"_locked",!1);c(this,"storage");c(this,"name");c(this,"_data",[]);this.id=e.id,this._locked=e.locked||this._locked,this.storage=e.storage,this.name=e.name}get locked(){return this._locked}get data(){return this._data}set data(e){this._data=e}async mount(...e){return this}async unmount(...e){return this}getItem(e){throw new Error("not implemented")}setItem(e,t){throw new Error("not implemented")}async load(){if(!this.storage)throw new Error("no storage");return this._data}async save(e){if(!this.storage)throw new Error("no storage");return this._data=e||this._data,this._data}}class C{isLogged(){throw new Error("Method not implemented.")}getItem(e){throw new Error("Method not implemented.")}setItem(e,t){throw new Error("Method not implemented.")}removeItem(e){throw new Error("Method not implemented.")}clear(){throw new Error("Method not implemented.")}}var b;class be extends C{constructor(){super(...arguments);he(this,b,new Map)}isLogged(){return!0}getItem(t){return k(this,b).get(t)||null}setItem(t,i){k(this,b).set(t,i)}removeItem(t){k(this,b).delete(t)}clear(){k(this,b).clear()}}b=new WeakMap;class re extends H{constructor(e){super({...e,storage:new be})}}class ze extends C{isLogged(){return!0}getItem(e){return localStorage.getItem(e)}setItem(e,t){localStorage.setItem(e,JSON.stringify(t))}removeItem(e){localStorage.removeItem(e)}clear(){localStorage.clear()}}class ve extends H{async mount(){let e;if(this.storage instanceof H){const t=this.storage;try{if(e=t.getItem(this.name),e){if(e=JSON.parse(e),!e||!(e instanceof Object))throw new Error("json invalid")}else throw new Error("json invalid")}catch(i){console.error(i),e={}}this.storage.setItem(this.name,e)}return this}async load(){return this.storage&&this.storage instanceof C&&(this.data=JSON.parse(this.storage.getItem(this.name)||"[]")),this.data}async save(e){return this.storage&&this.storage instanceof C&&(this.data=e||this.data,this.storage.setItem(this.name,this.data)),this.data}}class Me extends ve{constructor(e){super({...e,storage:new ze})}}class Pe extends C{isLogged(){return!0}getItem(e){return sessionStorage.getItem(e)}setItem(e,t){sessionStorage.setItem(e,JSON.stringify(t))}removeItem(e){sessionStorage.removeItem(e)}clear(){sessionStorage.clear()}}class Oe extends ve{constructor(e){super({...e,storage:new Pe})}}class ke extends H{constructor(e){super({...e})}isLogged(){throw new Error("Not implemented")}}var x=(s=>(s[s.NONE=0]="NONE",s[s.AUTO=1]="AUTO",s[s.TEMP=3]="TEMP",s[s.LOCAL=4]="LOCAL",s[s.SESSION=5]="SESSION",s[s.CLOUD=6]="CLOUD",s))(x||{});function Ne(s){switch(s){case 3:return re;case 4:return Me;case 5:return Oe;case 6:return ke;default:return re}}function It(s){return typeof s=="string"&&te(s.trim())}const Ce=['"',"'"];function yt(s,e='"'){return te(s)?s:(s=s.replace(/"/g,'\\"'),`${e}${s}${e}`)}function wt(s){return s.length===2&&s[0]===s[s.length-1]&&te(s)}function te(s){return s[0]===s[s.length-1]&&Ce.includes(s[0])}function Et(s){if(typeof s=="string"){const e=s.trim();if(te(e))return e.slice(1,s.length-1)}return s}function vt(s){return typeof s=="boolean"||s==="true"||s==="false"}function St(s){return!isNaN(s)&&!isNaN(parseFloat(s))}function Fe(s){return decodeURIComponent(globalThis.atob(s))}function We(s){return globalThis.btoa(encodeURIComponent(s))}class Be{constructor(){c(this,"items",new Map)}add(e,t){Array.isArray(e)?e.forEach(([i,r])=>{this.add(i,r)}):t&&(Array.isArray(t)||(t=[t]),this.items.set(e,t))}get(...e){var i;const t=e.shift()||"";return(i=this.items.get(t))==null?void 0:i.map(r=>e.reduce((a,n)=>a.replace(/%\d+/,n),r))}}const p=new Be;p.add("bad_args","Bad args");p.add("cant_find","Can't find %1");const $e="/",se="ROOT",Ke="CLOUD";function S(s){return typeof s=="object"&&"id"in s?s.id:s.replace(/.*[\\/:]{1,1}([^:\\/]+)$/,"$1")}function Ue(s){return/^[a-zA-Z0-9_-]+:/.test(s)}function Ye(...s){return s.reduce((e,t)=>(e.push(...t.replace(/[\\/]+/,"/").replace(/^\//,"").replace(/\/$/,"").split("/")),e),[]).join("/").replace(/:\//,":").replace(/\/$/,"")}function je(s){return s.replace(/(.*)[:/]([^\\/:]+)/,"$1")}function He(s){return s.replace(/^(.*)[\\/:]([^\\/:]+)$/,"$2")}function N(s){return s.replace(/(.*[\\/:]{1,1})[^:\\/]+$/,"$1")}function U(s){return s.length&&/^[\w .\\/:-]+$/.test(s)}function Ge(s){return U(s)&&!!(s.includes("/")||s.match(/^([^:]+):.*/))}function Ve(s){return s*1e3}function le(s){return s.replace(/^(.*)\.[^.]+$/,"$1")}function me(s){const e=s.match(/^.*\.([^.]*)$/);return e?e[1]:""}function Xe(s){return s.replace(/[^.a-zA-Z0-9_-]/g,"_")}function ae(s,e){return e?`${le(s)}.${e}`:s}function Se(s,e,t){let i=s;return e.hasItem(ae(i,t))?(i=`copy_${s}`,e.hasItem(ae(i,t))?Se(i,e,t):i):i}async function Ze(s){var e;if(s.locked)throw new Error((e=p.get("FileSystemItem_itemLocked",await s.getPath()))==null?void 0:e.join(" "));return s}function A(s){var t;const e=O(s);if(e){if(e!=null&&e.locked)throw new Error((t=p.get("FileSystem_permissionsNeeded"))==null?void 0:t.join(" "));return s}return s}async function D(s,e){return e=e||O(s),e&&(await s.save(),await e.save()),s}async function Je(s,e){const t=await e.remove({recursive:s});return Array.isArray(t)?t:[t]}function O(s){if(s.storage)return s;if(s.parent)return O(s.parent)}class h{constructor({name:e,value:t,scope:i}){c(this,"name");c(this,"value");c(this,"scope");this.name=e,this.value=t,this.scope=i}}const qe={basic:y.BASIC,bas:y.BASIC,markdown:y.DISK_MARKDOWN,md:y.DISK_MARKDOWN,image:y.IMAGE,img:y.IMAGE};function Qe(s,e=y.NOTE_BLANK){const t=qe,i=me(s).toLowerCase();return t[i]||e}class et extends h{}class E{constructor(e,{type:t,symbol:i=y.NOTE_BLANK}={type:"Unknown",symbol:y.NOTE_BLANK}){c(this,"type");c(this,"events");c(this,"_locked",!1);c(this,"parent");c(this,"createdDate");c(this,"editedDate");c(this,"id");c(this,"_name","");c(this,"meta");c(this,"_data");c(this,"_action");const{locked:r=!1,id:a,name:n=void 0,meta:o=void 0,data:l=void 0,action:u,createdDate:g=Date.now(),editedDate:w=void 0}=e;this.events=_(new B),this.createdDate=g||Date.now(),this.editedDate=w||g,this._locked=r||!1,this.id=a,this._name=n||"",this.type=t||"Unknown",this.meta=new Map([[d.SYMBOL,Qe(a||"",i||y.NOTE_BLANK)],[d.VISIBLE,!0],...o||[]]);let v=l;if(typeof l=="string")try{v=JSON.parse(l)}catch($){throw console.log(v),$}this._action=u,this._data=tt(v||{})}async remove(e={}){var a,n;const{silent:t}=Object.assign({silent:!1},e);let i;const r=this.isLocked();if(!r)i={type:this.type,id:this.id,name:this.name,path:await this.getPath(),size:this.size,storage:O(this)};else if(!t)throw new Error((a=p.get("FileSystemItem_itemLocked",await this.getPath()))==null?void 0:a.join(" "));return(t||!r)&&(this.events.next(new h({name:"remove",value:{item:this}})),this.events.unsubscribe(),(n=this.parent)==null||n.removeItem(this)),i?[i]:[]}isLocked(e=!1){return e?!1:this.parent&&this.parent.locked&&this.parent.id!==se?!0:this._locked}async copy(){const e=this.constructor,t=await this.export({encodeData:!1}),i=new e(t);return Promise.resolve(i)}rename(e,t={}){const{name:i=!1,ignore:r=!1}=Object.assign({name:!1,ignore:!1},t);if(!this.isLocked(r)){if(i)return this.name=e,this;{const a=this.id;this.id=Xe(e||""),this.parent&&a!==this.id&&this.parent.changeItemId(this,a,this.id)}this.events.next(new et({name:"rename",value:{item:this}}))}return this}save(){this.events.next(new h({name:"save",value:{item:this}}))}getUsedMemory(){return this.size/this.maxSize}async export(e={}){const{encodeData:t}=Object.assign({encodeData:!0},e),i=new Map(this.meta);Array.from(i.keys()).forEach(a=>{i.get(a)instanceof Le&&i.set(a,i.get(a).toJSON())});let r;return t&&typeof this._data=="string"?r=await We(this._data):r=this._data,{type:this.type,id:this.id,name:this._name,createdDate:this.createdDate,editedDate:this.editedDate,data:r,meta:Array.from(i)}}get data(){let e=this._data;if(typeof this._data=="string")try{e=JSON.parse(this._data)}catch(t){console.error(t),e={type:"markdown",content:"Cannot parse data"}}return e}set data(e){typeof e=="object"&&(e=JSON.stringify(e)),this._data=e}get action(){return this._action}setId(e){this.id=e}setParent(e){this.parent=e}get locked(){var e;return((e=this.parent)==null?void 0:e.locked)||this._locked}get name(){return this._name||this.id}set name(e){this._name=e||""}get extension(){return me(this.id)}get size(){const e=Object.values(this.data||{});return new Blob(e).size}get maxSize(){return new Blob(Object.values(this.data||{})).size}getRealMaxSize(){return new Blob(Object.values(this.data||{})).size}getBase(){return E.getBaseRecursive({item:this},!1)}getPath(){return E.getBaseRecursive({item:this})}static getBaseRecursive({item:e,path:t=[]},i=!0){if(i&&t.push(e.id),e.parent)return E.getBaseRecursive({item:e.parent,path:t});if(t=t.reverse(),t[0]===se&&t.shift(),t.length>0){let r=t[0];return/\./.test(r)||(r+=":"),`${r}${t.slice(1,t.length).join($e)}`}else return se}}p.add([["FileSystemItem_itemLocked",["Item Locked","Item is locked, can't be edit… %1"]]]);function tt(s){return typeof s=="object"&&(s=JSON.stringify(s)),s}class I extends E{constructor(t,i){t={...t};super(t,i);c(this,"items",new Map);c(this,"_maxSize",Ve(1));this.addItems(t.items||this.items),this._maxSize=t.maxSize||this._maxSize}async export(t={}){const i={...await super.export(t),items:[]};return Reflect.deleteProperty(i,"data"),i.items=await Promise.all(Array.from(this.items.values()).map(r=>r.export())),i}async addItems(t,i=!1){let r=[];t instanceof Map?r=Array.from(t.values()):Array.isArray(t)&&(r=t),r=r.map(n=>(typeof n.data=="string"&&(n.data=Fe(n.data)),n));const a=this.parseItems(r);return Promise.all(a.map(n=>this.addItem(n,i)))}static normalizeItemData(t){const i={...t},r=[];if("items"in t&&!(t.items instanceof Map)&&(i.items=new Map(t.items.map(a=>[a.id,a]))),"info"in t&&t.info)debugger;return"extension"in i&&(i.id+="."+i.extension,delete i.extension,r.push("extension")),"createTime"in i&&(i.createdDate=i.createTime,delete i.createTime,r.push("createTime")),"editTime"in i&&(i.editedDate=i.editTime,delete i.editTime,r.push("editTime")),"icon"in i&&(delete i.icon,r.push("icon")),r.length&&console.warn("@deprecated TODO: muss weg, hier werden die alten Items angepasst.",i,r),i}parseItems(t){return t.map(i=>{const r=I.normalizeItemData(i);let a;return r.type?a=ie(r.type):"items"in r?a=ie("Directory"):a=ie(),new a(r)})}async addItem(t,i=!1){const r=t.parent;if(!i&&this.hasItem(t.id))throw new Error(`File ${t.id} exists`);if(r&&await r.removeItem(t),i){const a=me(t.id),n=le(t.id);t.setId(ae(Se(n,this,a),a))}return this.items.set(t.id,t),t.setParent(this),t.events.next(new h({name:"move",value:{item:t,lastParent:r}})),this.events.next(new h({name:"addItem",value:{item:t}})),t}removeItem(t){return t.setParent(void 0),this.items.delete(t.id),this.events.next(new h({name:"removeItem",value:{item:t}})),Promise.resolve()}async remove(t={}){var a;const{recursive:i}={recursive:!1,...t},r=[];if(i){const n=await this.getItems();for(const o of n.values())r.push(...await o.remove(t));return r.push(...await super.remove(t)),r}else{if((await this.getItems()).size>0)throw new Error((a=p.get("FileSystemItem_itemContainerNotEmpty",await this.getPath()))==null?void 0:a.join(" "));return await super.remove(t)}}changeItemId(t,i,r){this.items.delete(i),this.items.set(r,t),this.parent&&console.log("changeItemId by parent",i,r,this.parent.items)}getItems(){return Promise.resolve(this.items)}getItem(t){return this.items.get(t)}hasItem(t){return this.items.has(t)}get size(){return Array.from(this.items.values()).reduce(function(t,i){return i instanceof I||(t+=i.size),t},0)}get maxSize(){return t(this);function t(i){return i.parent&&i.getRealMaxSize()?t(i.parent):i.getRealMaxSize()}}}p.add([["FileSystemItem_itemContainerNotEmpty",["ItemWrapp Not Empty","ItemContainer not empty… %1"]]]);class T extends I{constructor(t,i){t={...t,locked:!0};super(t,i);c(this,"storage");this.storage=t.storage}get locked(){return this.storage.locked}mount(...t){return this.storage.mount(...t)}unmount(...t){return this.storage.unmount(...t)}async save(){return this.storage.save(await this.export())}}c(T,"TYPE","Storage");const Q=class Q extends T{constructor(e){super(e,{type:Q.TYPE,symbol:y.CLOUD_DISK})}isLogged(e=!1){var t;return e||((t=this.storage.storage)==null?void 0:t.isLogged())||!1}isLocked(e){return this.isLogged(e)&&super.isLocked(e)}};c(Q,"TYPE","CloudDisk");let F=Q;class W extends I{constructor(e){super(e,{type:"Directory",symbol:y.DIRECTORY}),[d.WINDOW_SCALE,d.WINDOW_SCROLL_X,d.WINDOW_SCROLL_Y].forEach(t=>{this.meta.has(t)||this.meta.set(t,!0)})}}c(W,"TYPE","Directory");class M extends E{constructor(e){super(e,{type:"File"})}}c(M,"TYPE","File");class G extends I{constructor(e){super(e,{type:"FloppyDisk"})}}c(G,"TYPE","FloppyDisk");class V extends T{constructor(e){super(e,{type:"HardDisk",symbol:y.HARD_DISK})}}c(V,"TYPE","HardDisk");class X extends E{constructor(t){t={refPath:void 0,...t};super(t);c(this,"refPath");this.refPath=t.refPath}}c(X,"TYPE","Link");class Z extends T{constructor(e){super(e,{type:"RamDisk",symbol:y.RAM_DISK})}}c(Z,"TYPE","RamDisk");class De extends I{constructor(e){e={...e,locked:!0,id:"ROOT",name:"ROOT"},super(e,{type:"Root"})}}c(De,"TYPE","Root");class J extends T{constructor(e){super(e,{type:"TmpDisk",symbol:y.TMP_DISK}),this.meta.set(d.VISIBLE,!1),this.meta.set(d.IGNORE_SYMBOL_REARRANGE,!0)}}c(J,"TYPE","TmpDisk");class L extends I{constructor(e){super(e,{type:"Trashcan",symbol:y.TRASHCAN})}}c(L,"TYPE","Trashcan");const f=class f{constructor(e){c(this,"name");c(this,"root");c(this,"currentItem");c(this,"storages",new Map);c(this,"events",_(new B));this.name=e,this.root=new De,this.setup()}setup(){this.currentItem=this.root;const e=[this.addStorage(f.RAM_DISK_TITLE,x.SESSION,{id:f.RAM_DISK_NAME}),this.addStorage(f.HARD_DISK_NAME,x.LOCAL,{trashcan:!0}),this.addStorage(f.TMP_DISK_TITLE,x.TEMP,{id:f.TMP_DISK_NAME,trashcan:!1})];return Promise.all(e).catch(t=>{throw t})}createTmpFile(e,t,i,r){return this.createRootFile(`TMP:${e}`,t,i,r)}createRootDir(e,t,i){const r=`${e}`;return this.makedir(r,t,{override:!0,...i})}createRootFile(e,t,i,r){let a=t,n=i;typeof t=="object"&&(n=t,a=void 0);const o=`${e||"Unknown"}`;return this.makefile(o,a,n,{...r||{},override:!0})}async get(e,t=!1){if(e instanceof E)return e;if(U(e))try{return await this.parsePath(e)}catch(i){if(t)return new E({id:S(e),name:S(e)});throw i}else throw p.get("FileSystem_pathInvalid",S(e),N(e))}async parsePath(e){var a,n;let t=e,i=this.currentItem;const r=e.match(/^([^:\\/]+):(.*)$/);if(r?(i=(a=this.root)==null?void 0:a.getItem(r[1]),t=r[2]):t[0]==="/"&&this.currentItem?(t=t.slice(1),i=O(this.currentItem)):t==="ROOT"?(i=this.root,t=""):t&&!t.includes("/")&&!/^\.+$/.test(t.trim())&&(i=this.root.getItem(t),t=""),t&&t.length>0&&(i=ne(t.split("/"),i)),i)return i;throw p.get("FileSystem_pathInvalid",e,await((n=this.currentItem)==null?void 0:n.getBase())||"")}async addFloppyDisk(e){let t;if(typeof e=="function"?(t=await e(),t instanceof Promise&&(t=await t)):t=e,Array.isArray(t))throw new Error('data is an Array, use "defineFloppyDisk" for define a Disk');return this.addStorage(t)}async removeFloppyDisk(e){await e.remove({silent:!0})}async addStorage(e,t,i={}){i=Object.assign({id:null},i);let r;typeof t=="function"&&(r=t,t=x.CLOUD);const a=this.getFreeSlot(f.PREFIX.FLOPPY_DISK),n={id:a,itemClass:G,items:new Map};let o={};if(typeof e=="object"){const l=e;n.name=l.name||l.id,l.items&&(n.items=l.items),n.meta=Array.from(new Map([[d.SYMBOL,y.DISK_1],...l.meta||[]]))}else{switch(t){case x.SESSION:n.id=f.PREFIX.RAM,n.itemClass=Z;break;case x.TEMP:n.id=f.PREFIX.TMP,n.itemClass=J;break;case x.LOCAL:n.id=this.getFreeSlot(f.PREFIX.HARD_DISK),n.itemClass=V;break;case x.CLOUD:n.id=this.getFreeSlot(f.PREFIX.CLOUD_DISK),n.itemClass=F;break}n.id=i.id||n.id;let l;r&&typeof r=="function"?l=await this.registerStorageByStorage(n.id,r).mount(i):l=await this.registerStorageByType(n.id,t).mount(i);const u=await l.load();o=I.normalizeItemData(u),n.storage=l,x.NONE!==t&&(n.name=o.name||o.id||e)}return console.log("normalizedData",o),(n.meta=n.meta||[]).push(...o.meta||[]),this.addDisk({...n,...o,storage:n.storage||new re({id:a,name:f.TMP_DISK_TITLE})},i)}removeStorage(e){return e.unmount().then(()=>(this.events.next(new h({name:"removeStorage",value:{itemStorage:e}})),e))}registerStorageByType(e,t){const i=Ne(t),r=`${this.name}_${e}`,a=new i({id:e,name:r});return this.storages.set(r,a),a}registerStorageByStorage(e,t){const i=`${this.name}_${e}`,r=new t({id:e,name:i});return this.storages.set(i,r),r}connect(e,t){return this.addStorage(Ke,e,t).then(i=>i).catch(i=>{throw i})}async disconnect(e){return e=await this.removeStorage(e),e.remove({silent:!0,recursive:!0}),e}addDisk({id:e,name:t,meta:i,items:r,itemClass:a,storage:n},o){var g;o={trashcan:!1,...o},r instanceof Map&&o.trashcan&&(!r||r&&!r.has(L.TYPE))&&(r=r||new Map,r.set(L.TYPE,{type:L.TYPE,id:L.TYPE,name:L.TYPE}));const l=a;if(!l)throw new Error("ItemClass is empty!");const u=new l({id:e,name:t||e,meta:i,items:r,storage:n});return(g=this.root)==null||g.addItem(u),this.events.next(new h({name:"addDisk",value:{id:e,item:u}})),u}getFreeSlot(e){var i;let t=0;for(;(i=this.root)!=null&&i.hasItem(`${e}${t}`);)t++;return`${e}${t}`}async exist(e){try{return!!await this.get(e)}catch(t){return console.error(t),!1}}async changeDirectory(e){const t=await this.get(e);return this.currentItem=t,this.events.next(new h({name:"changeDirectory",value:t})),t}async makedir(e,t,i){const{override:r,meta:a}={override:!1,meta:[],...i};let n;e&&Ge(e)&&e!==t?n=await this.get(N(e)):n=this.currentItem;const o=new W({id:S(e),name:t||"",createdDate:Date.now(),meta:a});if(await A(n),r||!n.getItem(o.id))n.addItem(o,r),this.events.next(new h({name:"writeItem",value:o}));else throw p.get("FileSystem_fileExist",o.id);return await D(n),o}async makefile(e,t,i,r){var v,$,de;const{override:a,meta:n}={...r,meta:r.meta||[]},o=S(e),l=new M({id:o,name:t||o,data:i,meta:n,createdDate:Date.now()});if(!U(e))throw p.get("FileSystem_invalidPath",e);let u=je(e);const g=He(e);u===g&&(u=".");let w;if(Ue(u)?w=await this.get(u):((v=this.currentItem)==null?void 0:v.id)!=="ROOT"?w=await this.get(Ye(await(($=this.currentItem)==null?void 0:$.getPath())||"",u)):w=await this.get(u),w.hasItem(g))if(a)await((de=w.getItem(g))==null?void 0:de.remove()),w.addItem(l);else throw p.get("FileSystem_fileExist",l.id);else w.addItem(l),this.events.next(new h({name:"writeItem",value:l}));return await D(w),l}async editfile(e,t){const i=await this.get(e);return await A(i),await Ze(i),i.data=t,D(i)}async editfileMeta(e,t,i){const r=await this.get(e);return Array.isArray(t)?t.map(a=>({name:a[0],value:a[1]})):r.meta.set(t,i),D(r)}async getItemMetaList(e){const t=await this.get(e);return Array.from(t.meta).map(i=>({name:i[0],value:i[1]}))}async saveItem(e){const t=await this.get(e);return D(t)}async makelink(e,t=null){const i=await this.get(e);await A(i);const r=this.currentItem,a=new X({id:le(i.id)+".ref",name:`${t||i.name}`,createdDate:Date.now(),meta:[[d.REFERENCE,await i.getPath()]]});return await r.addItem(a),await D(i),a}async editlink(e,t){const i=await this.get(e);await A(i);const r=await this.get(t);return i.refPath=await r.getPath(),D(i)}async rename(e,t,{name:i,removeName:r}={name:!1,removeName:!1}){let a;if(e instanceof E)a=e;else if(U(e)||typeof e=="string")a=await this.get(e);else throw p.get("FileSystem_pathInvalid",N(e),e);return await A(a),r&&(i=!0,t=void 0),await a.rename(t,{ignore:!0,name:i}),D(a)}async copy(e,t,i={ignore:!1}){const{ignore:r}={ignore:!1,...i};let a,n,o;if(e instanceof E?(n=e,a=e.id):(n=await this.get(e),a=S(e)),t instanceof E)t instanceof I||(t=t.parent),o=t;else if(t){a=S(t);const u=await this.get(t,!0);if(u.parent?o=u.parent:o=await this.get(N(t)),!(o instanceof I))throw new Error("no ItemContainer")}else throw new Error('"to" is empty!');await A(n);const l=await n.copy();if(o instanceof I&&(r||!o.getItem(a)))l.rename(a),o.addItem(l,r),this.events.next(new h({name:"copyItem",value:l}));else throw p.get("FileSystem_fileExist",a);return D(l)}async move(e,t,{override:i}={}){let r,a,n;if(e instanceof E)a=e,r=e.id;else{if(a=await this.get(e),a instanceof T)throw p.get("FileSystem_cantMoveStorage",a.id);r=S(e)}if(t instanceof E)t instanceof I?n=t:n=t.parent;else{if(r=S(t),n=await this.get(t),n instanceof I)r=S(e);else return this.get(N(t));if(!(n instanceof I))throw new Error("no ItemContainer")}let o;if(await A(a),i||!await n.getItem(r))o=O(a),await a.rename(r),await n.addItem(a,i),this.events.next(new h({name:"moveItem",value:a}));else throw p.get("FileSystem_fileExist",a.id,r);return await D(a),o?o.save().then(()=>a):a}async remove(e,t,i={ignore:!1}){var n;const{ignore:r}={ignore:!1,...i},a=await this.get(e);await A(a);try{const o=await Je(t,a);return o[o.length-1].storage&&await((n=o[o.length-1].storage)==null?void 0:n.save()),o}catch(o){if(!r)throw o}}};c(f,"PREFIX",{FLOPPY_DISK:"DF",TMP:"TMP",RAM:"RAM",HARD_DISK:"HD",CLOUD_DISK:"CD"}),c(f,"TMP_DISK_NAME","TMP"),c(f,"TMP_DISK_TITLE","TMP DISK"),c(f,"RAM_DISK_NAME","RAM"),c(f,"RAM_DISK_TITLE","RAM DISK"),c(f,"HARD_DISK_NAME","HARD DISK");let pe=f;function ne(s,e){const t=s.shift();if(t===void 0)return e;if(t===".."){if(e.parent)return e.parent}else if(t==="."||t==="")return ne(s,e);if(e){const i=e.getItem(t);return s.length>0&&i instanceof I?ne(s,i):i}}function ie(s){switch(s){case W.TYPE:return W;case L.TYPE:return L;case T.TYPE:return T;case J.TYPE:return J;case Z.TYPE:return Z;case V.TYPE:return V;case G.TYPE:return G;case F.TYPE:return F;case X.TYPE:return X;case M.TYPE:return M}return M}p.add([["FileSystem_invalidPath",["Invalid File",'Invalid path "%1"']],["FileSystem_invalidFile",["Invalid File",'Invalid file… "%1"']],["FileSystem_fileExist",["File Ready",'File already exists… "%1"']],["FileSystem_pathInvalid",["Path Invalid",'Path invalid… "%1"; base: "%2"']],["FileSystem_itemInvalid",["Item Invalid",'Item id invalid… "%1" from "%2"']],["FileSystem_cantMoveStorage",["Can't Move",`Can't move BaseStorage "%1"`]],["FileSystem_permissionsNeeded",["Permissions needed","Permissions needed"]]]);class q{constructor({fsItem:e,command:t,model:i,layout:r}){c(this,"ready",!1);c(this,"fsItem");c(this,"command");c(this,"type");c(this,"id",ee());c(this,"layout",R({position:m(0,0),size:m(0,0)}));c(this,"ignoreRearrange",!1);c(this,"model",R({title:"Item Title",symbol:y.DEFAULT,used:!1,visible:!0,url:void 0,ignoreRearrange:!1}));this.type="default",this.command=t,this.model=R({...this.model,...i||{}}),this.layout=R({...this.layout,...r||{}}),this.fsItem=e}async setup({core:e}){const t=this.fsItem;!t||this.ready||(this.type=st(t),await Ie(this,e),t.events.subscribe(async({name:i})=>{i!=="addItem"&&i!=="removeItem"&&t&&await Ie(this,e)}),this.ready=!0)}setLayout(e){e.position&&(this.layout.position=m(e.position.x,e.position.y)),e.size&&(this.layout.size=m(e.size.x,e.size.y))}}async function Ie(s,e){var i;const t=s.fsItem;if(t)if(s.model.title=t.name||"",s.layout.position=t.meta.get(d.POSITION)&&oe(t.meta.get(d.POSITION))||m(0,0),s.model.visible=!!t.meta.get(d.VISIBLE),s.model.symbol=t.meta.get(d.SYMBOL),t.meta.get(d.WEB_URL)&&(s.model.url=String(t.meta.get(d.WEB_URL))),s.model.ignoreRearrange=!!t.meta.get(d.IGNORE_SYMBOL_REARRANGE),t.meta.get(d.REFERENCE)){const r=await((i=e.modules.files)==null?void 0:i.fileSystem.get(String(t.meta.get(d.REFERENCE))));if(!r)throw new Error("Reference item not found");r.meta.get(d.WEB_URL)&&(s.model.url=String(r.meta.get(d.WEB_URL))),s.command=ye(r,s.model)}else s.command=ye(t,s.model)}function ye(s,e){if(s instanceof I){const t=[`openDirectory "${s.getPath()}"`];s.meta.get(d.WINDOW_SYMBOL_REARRANGE)&&t.push("-sort-symbols");const i=s.meta.get(d.WINDOW_POSITION)&&oe(s.meta.get(d.WINDOW_POSITION))||m(0,0);i.length>0&&t.push(`--window-position="${m(i.x,i.y).toArray().join(",")}"`);const r=s.meta.get(d.WINDOW_SIZE)&&oe(s.meta.get(d.WINDOW_SIZE))||m(0,0);return r.length>0&&t.push(`--window-size="${m(r.x,r.y).toArray().join(",")}"`),s.meta.has(d.WINDOW_SCALE)&&t.push(`--window-scale=${s.meta.get(d.WINDOW_SCALE)}`),s.meta.has(d.WINDOW_SCROLL_X)&&t.push(`--window-scroll-x=${s.meta.get(d.WINDOW_SCROLL_X)}`),s.meta.has(d.WINDOW_SCROLL_Y)&&t.push(`--window-scroll-y=${s.meta.get(d.WINDOW_SCROLL_Y)}`),s.meta.has(d.WINDOW_SIDEBAR)&&t.push(`--window-sidebar=${s.meta.get(d.WINDOW_SIDEBAR)}`),s.meta.has(d.WINDOW_FULL_SIZE)&&t.push(`--window-full-size=${s.meta.get(d.WINDOW_FULL_SIZE)}`),t.join(" ")}else if(!e.url)return`execute "${s.getPath()}"`}function we(s,e){return s.map(t=>{const i=t instanceof q?t:new q({...t});return i.setup({core:e}),i})}function st(s){return s instanceof I?"container":s.meta.get(d.WEB_URL)?"link":"default"}function oe(s){return m(s.x,s.y)}var z=(s=>(s[s.NAME=0]="NAME",s[s.TYPE=1]="TYPE",s[s.CREATED_DATE=2]="CREATED_DATE",s[s.EDITED_DATE=3]="EDITED_DATE",s))(z||{}),Y=(s=>(s[s.ASCENDING=0]="ASCENDING",s[s.DESCENDING=1]="DESCENDING",s))(Y||{}),j=(s=>(s.SHOW_INVISIBLE_SYMBOLS="symbolWrapper_showInvisibleItems",s.ORDER_TYPE="symbolWrapper_iconsOrderType",s.ORDER_DIRECTION="symbolWrapper_iconsOrderDirection",s))(j||{});class Ee extends h{}class it{constructor(e,t=[],i=!1){c(this,"id",ee());c(this,"items",ge([]));c(this,"selectedItems",ge([]));c(this,"core");c(this,"root",!1);c(this,"layout",R({size:m(0,0),position:m(0,0)}));c(this,"size",m(0,0));c(this,"parentSize",m(0,0));this.root=i||!1,this.core=e,this.items.value=we(t||[],this.core)}setLayout(e){e.position&&(this.layout.position=m(e.position.x,e.position.y)),e.size&&(this.layout.size=m(e.size.x,e.position.y))}setSize(e){this.size=m(e.x,e.y)}setParentSize(e){this.parentSize=m(e.x,e.y)}rearrangeIcons(e={root:!1,margin:10}){e=Object.assign({orderType:this.core.config.get(j.ORDER_TYPE)||z.NAME,orderDirection:this.core.config.get(j.ORDER_DIRECTION)||Y.ASCENDING,onlyVisible:!this.core.config.get(j.SHOW_INVISIBLE_SYMBOLS)||!1,root:!1,margin:10},e);let t=this.items.value;switch(e.root&&(e.orderType=z.NAME,e.orderDirection=Y.DESCENDING),e.onlyVisible&&(t=t.filter(o=>o.model.visible)),t=t.filter(o=>!o.model.ignoreRearrange),e.orderType){case z.TYPE:t=t.sort((o,l)=>o.type.localeCompare(l.type));break;case z.CREATED_DATE:t=t.sort((o,l)=>{var w,v;const[u,g]=[((w=o.fsItem)==null?void 0:w.createdDate)||0,((v=l.fsItem)==null?void 0:v.createdDate)||0];return u===g?0:u>g?1:-1});break;case z.EDITED_DATE:t=t.sort((o,l)=>{var w,v;const[u,g]=[((w=o.fsItem)==null?void 0:w.editedDate)||0,((v=l.fsItem)==null?void 0:v.editedDate)||0];return u===g?0:u>g?1:-1});break;default:t=t.sort(o=>o.model.title.localeCompare(o.model.title))}switch(e.orderDirection){case Y.ASCENDING:t.reverse();break}const i=e.margin||0;let r,a=i;const n=Te(0,0);return e.root?r=this.size.x:r=i,t.forEach(o=>{e.root?(o.layout.position=m(r-o.layout.size.x,a),o.layout.size.x>n.x&&(n.x=o.layout.size.x),a+o.layout.size.y<this.parentSize.y?a+=o.layout.size.y+i:(r-=n.x+i,a=i)):(o.layout.size.y>n.y&&(n.y=o.layout.size.y),o.layout.position=m(r,a),r+o.layout.size.x<this.parentSize.x||(r=i,a+=n.y+i,o.layout.position=m(r,a)),r+=o.layout.size.x+i)}),Promise.all(t.map(({id:o,layout:l})=>this.savePosition(o,l.position)))}clearSelectedItems(){[...this.selectedItems.value].forEach(e=>this.unselectItem(e))}isSelectedItem(e){return this.selectedItems.value.includes(e)}selectItem(e){return this.isSelectedItem(e)?!1:(this.selectedItems.value.push(e),!0)}unselectItem(e){return this.isSelectedItem(e)?(this.selectedItems.value=this.selectedItems.value.filter(t=>t!==e),!0):!1}async moveItem(e,t){console.warn("Method not implemented.",e,t)}async moveItemToItem(e,t){console.warn("Method not implemented.",t,e)}async savePosition(e,t){console.warn("Method not implemented.",e,t)}get(e){return this.items.value.find(t=>t.id===e)}has(e){return!!this.items.value.find(t=>t.id===e)}add(...e){const t=we(e,this.core);return this.items.value.push(...t),t}remove(e){let t;return typeof e=="string"?t=this.get(e):t=e,t&&(this.unselectItem(t.id),this.items.value.splice(this.items.value.indexOf(t),1)),t}}class rt extends it{constructor(){super(...arguments);c(this,"events",_(new B))}add(...t){const i=super.add(...t);return this.events.next(new Ee({name:"add",value:{wrapper:this,items:Array.from(i)}})),i}remove(t){const i=super.remove(t);return i&&this.events.next(new Ee({name:"remove",value:{wrapper:this,item:i||void 0}})),i}setup(...t){return Promise.resolve()}selectItem(t){return super.selectItem(t)?(this.events.next(new h({name:"selectItem",value:{wrapper:this,id:t}})),!0):!1}unselectItem(t){return super.unselectItem(t)?(this.events.next(new h({name:"unselectItem",value:{wrapper:this,id:t}})),!0):!1}}class P extends rt{constructor(){super(...arguments);c(this,"fsItem");c(this,"usedMemory",0)}async setup(t){this.fsItem=t;const i=Array.from((await t.getItems()).values());await Promise.all(i.map(async r=>this.add(await P.fsItemToSymbol(r)))),t.events.subscribe(this.onEventItem.bind(this))}async moveItemToItem(t,i){var r,a;if(t.locked)throw new Error("Items are locked!");if(i.locked)throw new Error("Destination is locked!");t.meta.set(d.POSITION,m(0,0)),await((r=this.core.modules.files)==null?void 0:r.fs.saveItem(t)),await((a=this.core.modules.files)==null?void 0:a.fs.move(t,i,{override:!0}))}async moveItem(t,i){const r=this.get(t);if(r&&(r.fsItem instanceof M||r.fsItem instanceof W))try{if(r!=null&&r.fsItem&&(i!=null&&i.fsItem))await this.moveItemToItem(r.fsItem,i.fsItem);else throw new Error("Item or wrapper not found");return!0}catch(a){return console.warn(a),!1}return!1}async savePosition(t,i){var a;let r;if(typeof t=="string"&&this.get(t)?r=this.get(t):t instanceof q&&(r=t),r)if(r.fsItem)r.fsItem.meta.set(d.POSITION,i),(a=this.core.modules.files)==null||a.fs.saveItem(r.fsItem);else throw new Error(`Item has no fsItem. ${t}`);else throw new Error(`Item not found. ${t}`)}hasFsItem(t){return this.items.value.find(i=>{var r;return((r=i.fsItem)==null?void 0:r.id)===t.id})}async onEventItem({name:t,value:i}){var r,a;if(i!=null&&i.item){let n;if(t==="addItem")n=await P.fsItemToSymbol(i.item),this.hasFsItem(i.item)||this.add(n);else if(t==="removeItem"){const o=this.items.value.find(l=>{var u,g;return((u=l.fsItem)==null?void 0:u.id)===((g=i.item)==null?void 0:g.id)});if(o)this.remove(o);else throw new Error(`Item not found in symbol wrapper. ${(r=i.item)==null?void 0:r.id}`)}this.usedMemory=((a=this.fsItem)==null?void 0:a.getUsedMemory())||0}else console.warn("Item event without value",t,i)}static getItemsFromItem(t){return Promise.all(Array.from(t.items.values()).map(P.fsItemToSymbol))}static async fsItemToSymbol(t){const i=await t.getPath(),r=new q({fsItem:t,model:{title:t.name||"Untitled"}});return typeof t.action=="function"&&(r.command=`executeFile "${i}"`),t.meta.get(d.WEB_URL)&&(r.model.url=String(t.meta.get(d.WEB_URL))),r}}const at=m(0,0);class K{constructor({sidebarComponent:e,sidebarComponentData:t,component:i,componentData:r,options:a,wrapper:n,layout:o,parentWindow:l}){c(this,"events",new B);c(this,"id",ee());c(this,"component");c(this,"componentData");c(this,"sidebarComponent");c(this,"sidebarComponentData");c(this,"parentWindow");c(this,"options",R({title:void 0,scale:!1,scaleX:!1,scaleY:!1,scroll:!1,scrollX:!1,scrollY:!1,clamp:!1,clampX:!0,clampY:!1,freeze:!1,focused:!1,center:!0,close:!0,overlay:!0,embed:!1,fillHeader:!1,filled:!1,borderless:!1,hideRootHeader:!1,sidebar:!0,prompt:!1}));c(this,"group");c(this,"wrapper");c(this,"layout",R({focused:!1,position:m(0,0),size:at,scrollOffset:m(0,0),zIndex:0}));this.parentWindow=l,e&&(this.sidebarComponent=_(e)),t&&(this.sidebarComponentData=_(t)),i&&(this.component=_(i)),this.componentData={...r||{}},n&&(this.wrapper=_(n)),this.options=Object.assign(this.options,a),this.layout=Object.assign(this.layout,o)}setLayout(e){e.position&&(this.layout.position=m(e.position.x,e.position.y)),e.size&&(this.layout.size=m(e.size.x,e.size.y)),e.scrollOffset&&(this.layout.scrollOffset=m(e.scrollOffset.x,e.scrollOffset.y)),e.focused&&(this.layout.focused=e.focused)}ready(){this.options.ready=!0,this.events.next(new h({name:"ready"}))}focus(){this.options.focused=!0,this.events.next(new h({name:"focus"}))}unfocus(){this.options.focused=!1,this.events.next(new h({name:"unfocus"}))}close(e){this.wrapper&&(this.events.next(new h({name:"close",value:e})),this.wrapper.remove(this.id),this.wrapper=void 0)}setWrapper(e){this.wrapper=_(e)}setGroup(e){this.group=e}awaitClose(){return new Promise(e=>{const t=this.events.pipe(fe(({name:i})=>i==="close")).subscribe(i=>{t.unsubscribe(),e(i)})})}awaitReady(){return new Promise(e=>{if(this.options.ready)e(this);else{const t=this.events.pipe(fe(({name:i})=>i==="ready")).subscribe(()=>{t.unsubscribe(),e(this)})}})}}var nt=(s=>(s[s.CENTER=0]="CENTER",s[s.ORDER_HORIZONTAL=1]="ORDER_HORIZONTAL",s[s.ORDER_VERTICAL=2]="ORDER_VERTICAL",s[s.ORDER_DIAGONAL_LEFT=3]="ORDER_DIAGONAL_LEFT",s[s.ORDER_DIAGONAL_RIGHT=4]="ORDER_DIAGONAL_RIGHT",s[s.SPLIT_HORIZONTAL=5]="SPLIT_HORIZONTAL",s[s.SPLIT_VERTICAL=6]="SPLIT_VERTICAL",s[s.FULL=7]="FULL",s))(nt||{});class Dt{constructor(e,t=[]){c(this,"events",_(new B));c(this,"id",ee());c(this,"core");c(this,"layout",{size:m(0,0),position:m(0,0)});c(this,"groups",new Map);c(this,"modelMap",new Map);c(this,"models",[]);c(this,"_activeWindow");this.core=e,t.forEach(i=>this.add(i))}setLayout(e){e.position&&(this.layout.position=m(e.position.x,e.position.y)),e.size&&(this.layout.size=m(e.size.x,e.size.y))}getActiveWindow(){return this.models.find(e=>e.options.focused)}setActiveWindow(e){this.models.forEach(t=>{t.options.focused=e===t.id,e===t.id&&(this._activeWindow=t,this.events.next(new h({name:"setActiveWindow",value:t})))})}hasEmbbedWindow(){return!!this.models.find(e=>e.options.embed)}isHeaderVsible(){return!this.models.find(e=>e.options.embed&&e.options.hideRootHeader)}add(e,t){const{full:i,maximize:r,active:a,group:n}={full:!1,maximize:!1,active:!0,group:null,...t||{}};let o;if(e instanceof K?o=e:o=new K(e),o.setWrapper(this),r?o.layout.size=m(this.layout.size.x,this.layout.size.y):i&&(o.layout.size=m(()=>m(this.layout.size.x,this.layout.size.y)+m(0,0))),n){let l;this.groups.has(n)?(l=this.groups.get(n),l.windows.push(o)):(l={primary:o,windows:[],name:n},this.groups.set(n,l)),o.setGroup(l)}return o.layout.zIndex=this.models.length,this.models.push(o),this.events.next(new h({name:"add",value:o})),this.modelMap.set(o.id,o),a&&this.setActiveWindow(o.id),o}remove(e){let t;e instanceof K?t=e:t=this.get(e),t!==void 0&&(t.group&&(t.group.primary===e?(t.group.windows.forEach(i=>i.close()),this.groups.delete(t.group.name)):t.group.primary.focus()),this.models.splice(this.models.indexOf(t),1),this.modelMap.delete(t.id))}get(e){return this.modelMap.get(e)}clear(){this.models=[].splice(0,this.models.length),this.modelMap.clear()}setWindowUpDown(e,t){const i=this.models,r=Array.from(i).filter(n=>!n.options.embed).sort((n,o)=>(n.layout.zIndex||0)-(o.layout.zIndex||0)).map(Re),a=this.get(e);if(a){const n=r.findIndex(({id:l})=>l===a.id),o=r[t?n-1:n+1];if(o){const l=a.layout.zIndex;a.layout.zIndex=o.layout.zIndex,o.layout.zIndex=l}}}centerWindow(e){let t;e instanceof K?t=e:t=this.get(e),t&&ce(t,this.layout)}setWindowPositions(e,t=[],i){const{embed:r}={embed:!1,...i};switch(t.length<1&&t.push(...this.models),r||(t=t.filter(a=>!a.options.embed)),e){case 7:t.forEach(a=>{ot(a,this.layout)});break;case 0:t.forEach(a=>{ce(a,this.layout)});break;case 3:case 4:ct(t,this.layout,e===4);break;case 5:case 6:lt(t,this.layout,e===6);break}}saveSize(e,t){var r,a,n,o;const i=this.get(e);if(i&&(r=i.componentData)!=null&&r.symbolWrapper&&((a=i.componentData)==null?void 0:a.symbolWrapper)instanceof P){const l=(n=i.componentData)==null?void 0:n.symbolWrapper.fsItem;l&&(l.meta.set(d.WINDOW_SIZE,t),(o=this.core.modules.files)==null||o.fs.saveItem(l))}}savePosition(e,t){var r,a,n,o;const i=this.get(e);if(i&&(r=i.componentData)!=null&&r.symbolWrapper&&((a=i.componentData)==null?void 0:a.symbolWrapper)instanceof P){const l=(n=i.componentData)==null?void 0:n.symbolWrapper.fsItem;l&&(l.meta.set(d.WINDOW_POSITION,t),(o=this.core.modules.files)==null||o.fs.saveItem(l))}}}function ot(s,e){s.layout.size=e.size}function ce(s,e){s.layout.position=m(()=>(m(e.size.x,e.size.y)-m(s.layout.size.x,s.layout.size.y))/2)}function ct(s,e,t){const i=1/s.length;s.forEach((r,a)=>{ce(r,e),a=-Math.floor(s.length/2)+a;const n=m(r.layout.position.x+(t?-1:1)*(i*r.layout.size.x)*a,r.layout.position.y+i*r.layout.size.y*a),o=m(()=>m(e.size.x,e.size.y)-m(r.layout.size.x,r.layout.size.y));r.layout.position=m(()=>Math.max(Math.min(n,o),0))})}function lt(s,e,t){let i;const r=s.length;t?(i=m(e.size.x,e.size.y/r),s.forEach((a,n)=>{a.layout.position=m(0,n*i.y),a.layout.size=i})):(i=m(e.size.x/r,e.size.y),s.forEach((a,n)=>{a.layout.position=m(n*i.x,0),a.layout.size=i}))}export{ke as C,W as D,h as E,P as F,it as I,z as O,De as R,C as S,x as T,Dt as W,K as a,nt as b,me as c,vt as d,p as e,ae as f,Ne as g,T as h,St as i,I as j,E as k,L as l,Xe as m,S as n,Fe as o,Ye as p,pe as q,j as r,D as s,Y as t,Et as u,q as v,yt as w,wt as x,It as y,We as z};
