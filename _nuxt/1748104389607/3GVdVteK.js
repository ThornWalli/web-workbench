import{C as Y}from"./BJmh0rUk.js";import{g as oe,c as ne,I as ie,C as l}from"./DeMeSnuU.js";import{d as H}from"./B3mcEltb.js";import{i as K}from"./BGIFtisS.js";import{D as ae,W as se}from"./sdO6LC0d.js";import{u as re,m as le,a as b,b as _}from"./Dhinf-AH.js";import{d as ee,k as N,v as h,x as p,y,A as k,E as ce,_ as B,r as O,o as me,a0 as V,a1 as Z,Z as P,$ as I,G as w,z as U,g as R,N as x,C as F,Q as z,ab as W,B as ue,M as de,ag as j,a2 as he,J as D}from"./BHV1diwp.js";import{u as pe}from"./CuqlnsaG.js";import{M as be,a as ye}from"./DiA4mDH-.js";import fe from"./DcMfwrs4.js";import{N as Ce,u as ve}from"./RfKXynV2.js";import{N as ke}from"./BtMqbO0Q.js";import{r as _e,c as L}from"./D7vRPbLd.js";import{T as Ne,c as we}from"./B9hcRVP1.js";import{T as Te}from"./zsr9g00h.js";import{T as q}from"./D69hJOPr.js";import{S}from"./B5gsEXs2.js";import{o as ge,n as Re,S as G}from"./6C4StZv5.js";import{c as J,f as A}from"./CSlkdJUE.js";import{i as Ee}from"./Ce6njBYG.js";import{t as Q}from"./C6SzTwG0.js";import"./CaAbksje.js";import"./9V19AFUE.js";import"./DXnSAPcy.js";import"./DN3eHOnZ.js";import"./D4lI5vpz.js";import"./DdQrQ7-5.js";import"./nufkX4jA.js";import"./RAasLaaH.js";import"./BlnwQcI7.js";import"./BYXSjlja.js";import"./CEMoWgfm.js";import"./BVsX1iIx.js";import"./Cn-aGPUZ.js";import"./CxKYomUj.js";import"./Cw6MfX_O.js";import"./Do8_-Ux3.js";import"./BG0OyHeb.js";import"./CNkvSXuu.js";import"./CzBXAPyu.js";import"./WL2z-xAH.js";import"./CJLX7oOC.js";function X(e){return ge(function(n,a){var t=!1,i=null,o=null,m=function(){if(o==null||o.unsubscribe(),o=null,t){t=!1;var s=i;i=null,a.next(s)}};n.subscribe(J(a,function(s){o==null||o.unsubscribe(),t=!0,i=s,o=J(a,m,Re),Ee(e(s)).subscribe(o)},function(){m(),a.complete()},void 0,function(){i=o=null}))})}const Se={class:"wb-env-molecule-footer"},Ae={ref:"menu",class:"menu"},Ie=ee({__name:"Footer",props:{parentLayout:{},title:{},items:{}},emits:["inputContextMenu"],setup(e,{emit:n}){const{core:a}=re(),t={size:K(window.innerWidth,window.innerHeight)},i=e,o=n,m=N(()=>{var c,d;return i.items||((d=(c=a.value)==null?void 0:c.modules.windows)==null?void 0:d.contextMenu.activeItems.items)});function s(...c){o("inputContextMenu",...c)}return(c,d)=>(p(),h("footer",Se,[y("nav",Ae,[k(se,{direction:ce(ae).TOP,items:m.value,"parent-layout":c.parentLayout||t,"onUpdate:modelValue":s},null,8,["direction","items","parent-layout"])],512)]))}}),Me=B(Ie,[["__scopeId","data-v-3b5ecfda"]]),Oe=["disabled"],Pe={class:"keys white"},xe=["onMouseout","onPointerdown","onPointerup"],De={key:0},Le={key:0},Ke={class:"keys black"},Be=["onMouseout","onPointerdown","onPointerup"],$e={key:0},Ye={key:0},He=9,Ve=ee({__name:"Keyboard",props:{disabled:{type:Boolean,default:!1},selectedNotes:{type:Array,default:null},size:{type:String,validator:e=>["small","medium","large"].includes(e),default:"large"},showNoteLabels:{type:Boolean,default:!1},startOctave:{type:Number,default:4},octaveCount:{type:Number,default:6}},emits:["down","up"],setup(e,{emit:n}){const a=O(),t=e,i=n,o=O([]),m=O(K(0,0)),s=N(()=>Array.from(new Set(t.selectedNotes.map(r=>_e(r.getName()||"")).flat()))),c=N(()=>({small:96,medium:96*1.5,large:96*2})[t.size]),d=N(()=>{const r=[],T=["c","c#","d","d#","e","f","f#","g","g#","a","a#","b"];for(let u=0;u<t.octaveCount;u++)r.push(...T.map(f=>{const C=`${f}${t.startOctave+u}`;return{note:C,black:te(C)}}));return t.startOctave+t.octaveCount<=He&&r.push({note:T[0]+(t.startOctave+t.octaveCount),black:!1}),r}),M=N(()=>({disabled:t.disabled})),v=N(()=>({...m.value.toCSSVars("dimension"),"--height":c.value,"--keys":d.value.filter(({black:r})=>!r).length,"--white-keys":d.value.filter(({black:r})=>!r).length,"--black-keys":d.value.filter(({black:r})=>r).length}));me(()=>{var r;m.value=K(((r=a.value)==null?void 0:r.offsetWidth)||0,0)});function te(r){return/^[a-z]#\d+/.test(r)}function $(r){t.disabled||(o.value.push(r),i("down",r))}function E(r){!t.disabled&&o.value.includes(r)&&(i("up",r),o.value=o.value.filter(T=>T!==r))}return(r,T)=>(p(),h("div",{ref_key:"rootEl",ref:a,style:P(v.value),class:I([M.value,"wb-disks-synthesizer-keyboard"]),disabled:e.disabled},[y("div",null,[y("div",Pe,[(p(!0),h(V,null,Z(d.value,({note:u,black:f},C)=>(p(),h("div",{key:C,class:I(["key",{black:f,white:!f,selected:s.value.includes(u.toLowerCase())}]),style:P({"--index":C}),onMouseout:g=>E(u),onPointerdown:g=>$(u),onPointerup:g=>E(u)},[f?w("",!0):(p(),h("span",De,[e.showNoteLabels?(p(),h("i",Le,U(u),1)):w("",!0)]))],46,xe))),128))]),y("div",Ke,[(p(!0),h(V,null,Z(d.value,({note:u,black:f},C)=>(p(),h("div",{key:C,class:I(["key",{black:f,white:!f,selected:s.value.includes(u.toLowerCase())}]),style:P({"--index":C}),onMouseout:g=>E(u),onPointerdown:g=>$(u),onPointerup:g=>E(u)},[f?(p(),h("span",$e,[e.showNoteLabels?(p(),h("i",Ye,U(u),1)):w("",!0)])):w("",!0)],46,Be))),128))])])],14,Oe))}}),Ze=B(Ve,[["__scopeId","data-v-5b9ecf1b"]]),Ue={components:{TimelineCanvas:Te,Navigation:Ce,Metronom:be,Keyboard:Ze,WbEnvMoleculeFooter:Me},props:{model:{type:Object,default:ne()},trackModel:{type:Object,default:oe()},toneDestination:{type:Object,default:null}},emits:["refresh"],async setup(e){const n=j(e,"model"),a=j(e,"trackModel"),t=pe();he(n,()=>{t.setContextMenu(we,{model:n.value,trackModel:a.value,preserveContextMenu:t.preserveContextMenu})},{immediate:!0,deep:!0});const i=D(a.value[l.SYNTHESIZER_TRACK]);console.log("track",i);const o=D(new ye(i)),m=D(new Ne(i));console.log("trackPlayer",m);const s=await ve(),c=new fe;await c.start();const d=c.hasInputs;return{...t,...s,metronom:o,track:i,trackPlayer:m,midiController:c,hasMidi:d}},data(){return{windowsModule:de(this.core.modules.windows),duration:0,subscriptions:new G,midiControllerListener:null,openNotes:new Map,footerModel:{}}},computed:{styleClasses(){return{[`keyboard-align-${this.trackModel[l.SYNTHESIZER_TRACK_KEYBOARD_ALIGN]}`]:!0}},showKeyboard(){return this.trackModel[l.SYNTHESIZER_TRACK_SHOW_KEYBOARD]},inputNote(){return this.trackModel[l.SYNTHESIZER_TRACK_INPUT_NOTE]},bpm(){return Number(this.model[l.SYNTHESIZER_BPM])},trackPlayerIndex(){return Object.values(this.trackPlayer.sequenceNoteIndex).flat()},selectedNotes(){return this.track.notes.filter(e=>Object.values(this.trackPlayer.sequenceNoteIndex).flat().includes(e.index))},timelineCanvasData(){return{track:this.track,duration:this.metronom.getDuration()}},keybordData(){return{size:this.trackModel[l.SYNTHESIZER_TRACK_KEYBOARD_SIZE],showNoteLabels:this.trackModel[l.SYNTHESIZER_TRACK_SHOW_NOTE_LABELS],startOctave:this.trackModel[l.SYNTHESIZER_TRACK_START_OCTAVE],octaveCount:this.trackModel[l.SYNTHESIZER_TRACK_OCTAVE_COUNT],selectedNotes:this.selectedNotes}},metronomNavigation(){return{modelValue:this.metronom,"onUpdate:model-value":({name:e,value:n})=>{debugger;this.metronom[String(e)]=n},items:[[{icon:"skipPrev",label:"Prev Beat",hideLabel:!0,disabled:this.metronom.value===0,action:()=>{this.metronom.reset()}},{icon:"doublePrev",label:"Prev Beat",hideLabel:!0,disabled:Math.floor(this.metronom.currentBeat/2)===0,action:()=>{this.metronom.prevBeat()}},{icon:"prev",label:"Prev",hideLabel:!0,disabled:this.metronom.value===0,action:()=>{this.metronom.prev()}},{icon:"reset",iconAlign:"right",label:"Next",disabled:this.metronom.value/2-Math.floor(this.metronom.currentBeat)===0,hideLabel:!0,action:()=>{this.metronom.setBeat(this.metronom.currentBeat)}},{icon:"next",iconAlign:"right",label:"Next",hideLabel:!0,action:()=>{this.metronom.next()}},{icon:"doubleNext",label:"Next Beat",hideLabel:!0,action:()=>{this.metronom.nextBeat()}},{spacer:!0},{text:`Duration: ${this.metronom.value.toFixed(2)}`},{text:`Beat: ${this.metronom.currentBeat}-${this.metronom.currentBeat+this.metronom.beatCount}`}],[...L().map(([e])=>({label:`1/${e.replace(/(\d+)[nm]/,"$1")} n`,name:"time",value:e})),{spacer:!0}]]}},navigation(){return{model:this.trackModel,items:[[{text:"Input:"},{label:"Note",value:"note",name:l.SYNTHESIZER_TRACK_INPUT},{label:"Pause",value:"pause",name:l.SYNTHESIZER_TRACK_INPUT,disabled:!0},{spacer:!0},{label:"Remove Note",action:()=>{this.track.removeNote(this.track.selectedIndex)}},{label:"Clean Range",action:()=>{this.track.removeNotesByDurationRange(this.metronom.getDuration(),this.metronom.timeDuration)}},{label:"Clean Beat",action:()=>{this.track.removeNotesFromBeat(this.track.getBeatIndex())}},{label:"Reset",action:()=>{this.reset()}}],[{text:"Note:&nbsp;"},{label:"Auto",value:"",name:l.SYNTHESIZER_TRACK_INPUT_NOTE},...L().map(([e])=>({label:`1/${e.replace(/(\d+)[nm]/,"$1")} n`,name:l.SYNTHESIZER_TRACK_INPUT_NOTE,value:e})),{spacer:!0},this.trackPlayer.playing?{selected:!0,label:"Pause",icon:"pause",disabled:!this.trackPlayer.currentSequence||!this.trackPlayer.playing,onClick:()=>this.onClickPlause()}:{label:"Play",icon:"play",disabled:this.trackPlayer.playing||this.track.notes.length===0,onClick:()=>this.onClickPlay()},{label:"Stop",icon:"stop",disabled:!this.trackPlayer.currentSequence,onClick:()=>this.onClickStop()},{label:"Restart",disabled:this.track.selectedIndex>-1,onClick:()=>this.onClickRestart()}]]}},footerData(){const e=this.track,n=this.trackModel,a=e.getDuration().toFixed(2);return{items:le([new b({options:{disabled:!this.hasMidi},title:`MIDI (${this.midiController.input?this.midiController.input.name:"OFF"})`,action:async()=>{this.midiControllerListener||await this.registerMidiListener()},items:this.midiController.ready&&this.midiControllerListener?[new b({title:"Inputs",items:this.midiController.inputs.map((t,i)=>({title:t.name,model:this.midiController,name:"activeInput",type:_.RADIO,value:t.id,action:async()=>{await this.registerMidiListener(this.midiController.listen(i))}}))}),new b({title:"Input Channel",items:Array(16).fill(null).map((t,i)=>({title:String(i+1),value:i+1,type:_.RADIO,model:this.midiController,name:"inputChannel",action:async()=>{await this.registerMidiListener(this.midiController.listen(this.midiController.input))}}))}),new b({title:"Outputs",items:this.midiController.outputs.map(t=>({title:t.name,model:this.midiController,name:"activeOutput",type:_.RADIO,value:t.id,action(){}}))}),new S,new b({title:"Disconnect",action:()=>{var t;(t=this.midiControllerListener)==null||t.unsubscribe(),this.midiControllerListener=null,this.midiController.unlisten()}})]:[]}),new S,new b({title:`Instr.: ${this.track.type}`,items:Object.values(ie).map(t=>new b({type:_.RADIO,title:t,model:e,name:"type",value:t}))}),new S,new b({title:`Octave: ${n[l.SYNTHESIZER_TRACK_START_OCTAVE]}-${n[l.SYNTHESIZER_TRACK_START_OCTAVE]+n[l.SYNTHESIZER_TRACK_OCTAVE_COUNT]-1}`,items:[new b({title:"Start Octave",items:Array(9).fill({}).map((t,i)=>new b({type:_.RADIO,title:String(i+1),model:n,name:l.SYNTHESIZER_TRACK_START_OCTAVE,value:i+1,action(o){o=Number(o),o+n[l.SYNTHESIZER_TRACK_OCTAVE_COUNT]>9&&(n[l.SYNTHESIZER_TRACK_OCTAVE_COUNT]=10-o)}}))}),new b({title:"Octave Count",items:Array(10-n[l.SYNTHESIZER_TRACK_START_OCTAVE]).fill({}).map((t,i)=>new b({type:_.RADIO,title:String(i+1),model:n,name:l.SYNTHESIZER_TRACK_OCTAVE_COUNT,value:i+1}))})]}),new S,new q({text:`BPM: ${this.bpm}`}),new q({text:`Dur.: ${a}`})])}}},watch:{"track.beatCount"(e){this.metronom.beatCount=e}},mounted(){console.log("TRACK",this.track),this.subscriptions.add(H.keyDown.pipe(X(()=>Q(100)),A(e=>e.key==="Enter")).subscribe(()=>{this.onClickActivateMidi()})),this.subscriptions.add(H.keyDown.pipe(X(()=>Q(100))).subscribe(e=>{switch(e.code){case"ArrowLeft":this.metronom.prev();break;case"ArrowRight":this.metronom.next();break;case"ArrowUp":this.metronom.prevBeat();break;case"ArrowDown":this.metronom.nextBeat();break;default:if(/Digit(\d+)/.test(e.code)){const n=e.code.replace(/Digit(\d+)/,"$1"),a=L()[n-1];a&&(this.metronom.time=a[0])}break}console.log(e)})),this.$nextTick(()=>{this.$emit("refresh")})},unmounted(){this.subscriptions.unsubscribe(),this.midiController.destroy()},methods:{async registerMidiListener(e){var n;try{await this.midiController.start();const a=this.midiController.listen(e>-1&&this.midiController.inputs[e]||this.midiController.inputs[0]);(n=this.midiControllerListener)==null||n.unsubscribe(),this.midiControllerListener=new G,this.midiControllerListener.add(a.pipe(A(({type:t})=>t==="noteOn")).subscribe(this.onNoteOn.bind(this)),a.pipe(A(({type:t})=>t==="noteOff")).subscribe(this.onNoteOff.bind(this)),a.pipe(A(({type:t})=>t==="volume")).subscribe(({value:t})=>{console.log("Volume: ",t),this.core.config.set(Y.SCREEN_CONFIG,{...this.core.config.get(Y.SCREEN_CONFIG),soundVolume:t})}))}catch(a){console.warn(a)}},async setup(){this.tone.ready||(await this.tone.start(),this.trackPlayer.createInstrument())},onReady({render:e}){this._render=e},onRender(e,{position:n,dimension:a}){if(this.inputNote==="auto"){const t=Array.from(this.openNotes.values());for(let i=0;i<t.length;i++){const o=t[Number(i)],s=(this.metronom.now()-o)/1e3/(this.metronom.speed*2)*a.x/this.track.beatCount;e.fillRect(n.x,n.y,s,a.y)}}},async onNoteOn({value:e}){await this.setup();const n=e.identifier;console.log("value.identifier",n,this.metronom.getDuration()),this.startNote(n),this.trackPlayer.triggerAttack(n)},async onNoteOff({value:e}){this.endNote(e.identifier),await this.tone.ready,this.trackPlayer.triggerRelease()},startNote(e){this.animationLoop||(this.animationLoop=Fe(()=>{this._render&&this._render()})),this.openNotes.set(e,this.metronom.now())},endNote(e){var m;const n=[1,2,4,8,16,32].map(s=>[`${s}n`,`${s}t`,`${s}n.`]).flat().map(s=>[s,new(this.tone.getTone()).Time(s).toSeconds()]).sort((s,c)=>c[1]-s[1]),a=Math.max((this.metronom.now()-this.openNotes.get(e))/1e3,n[n.length-1][1]);this.openNotes.delete(e);const{Time:t}=this.tone.getTone();let i;this.inputNote?i=new t(this.inputNote):i=new t(n.map(([,s])=>s).find(s=>{const c=s*.2;return s-c<=a&&a<=s+c}));const o=this.metronom.getDuration();console.log({delay:o,name:e,time:i.toNotation()}),this.track.addNote(new ke({delay:o,name:e,time:i.toNotation()})),this.openNotes.size<1&&((m=this.animationLoop)==null||m.stop(),this.animationLoop=null)},async onClickNote({note:e,selected:n}){await this.setup(),n&&e.getName()&&this.trackPlayer.triggerAttackRelease(e)},async onClickPlay(){await this.setup(),this.trackPlayer.play()},onClickPlause(){this.trackPlayer.pause()},onClickStop(){this.trackPlayer.stop()},onClickRestart(){this.trackPlayer.restart()},async onDownKeyboard(e){await this.setup(),this.startNote(e),this.trackPlayer.triggerAttack(e)},async onUpKeyboard(e){await this.tone.awaitReady,this.endNote(e),this.trackPlayer.triggerRelease()},reset(){this.track.reset()},onClickActivateMidi(){this.registerMidiListener()}}};function Fe(e){let n=0,a=0,t=!1;const i=o=>{const m=o-n;n=o,a+=m,e(o,a),t||requestAnimationFrame(i)};return requestAnimationFrame(i),{stop:()=>t=!0}}const ze={key:0,class:"keyboard"},We={class:"sheet"},je={class:"panel"};function qe(e,n,a,t,i,o){const m=R("keyboard"),s=R("navigation"),c=R("timeline-canvas"),d=R("metronom"),M=R("wb-env-molecule-footer");return p(),h("div",{class:I(["wb-disks-extras13-synthesizer-track",o.styleClasses])},[y("div",null,[y("div",null,[o.showKeyboard?(p(),h("div",ze,[k(m,x({disabled:t.trackPlayer.playing},o.keybordData,{onDown:o.onDownKeyboard,onUp:o.onUpKeyboard}),null,16,["disabled","onDown","onUp"]),t.hasMidi&&!i.midiControllerListener?(p(),h("div",{key:0,class:"midi-message",onClick:n[0]||(n[0]=(...v)=>o.onClickActivateMidi&&o.onClickActivateMidi(...v))},n[2]||(n[2]=[y("div",null,[y("div",null,[y("span",null,[F("Click here, or press "),y("strong",null,"Enter"),F(" to activate the Midi Keyboard!")])])],-1)]))):w("",!0)])):w("",!0)]),k(s,z(W(o.navigation)),null,16),y("div",We,[k(d,{model:t.metronom,onRender:o.onRender,onReady:o.onReady,onValue:n[1]||(n[1]=v=>t.track.setCurrentDuration(v))},{background:ue(({onRefresh:v})=>[k(c,x(o.timelineCanvasData,{clickable:"",onRefresh:v,"onNote:click":o.onClickNote}),null,16,["onRefresh","onNote:click"])]),_:1},8,["model","onRender","onReady"])]),y("div",je,[k(s,z(W(o.metronomNavigation)),null,16)])]),k(M,x(o.footerData,{"parent-layout":i.windowsModule.contentWrapper.layout}),null,16,["parent-layout"])],2)}const Bt=B(Ue,[["render",qe],["__scopeId","data-v-a2ac0b7f"]]);export{Bt as default};
