var E=Object.defineProperty;var A=(r,e,t)=>e in r?E(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var h=(r,e,t)=>A(r,typeof e!="symbol"?e+"":e,t);import{N as m,b as I}from"./Buxpp1Xz.js";import{K as x,b as C,G as g}from"./jOwywQQp.js";import{v as M}from"./TlYR_Xhg.js";var v={};Object.defineProperty(v,"__esModule",{value:!0});var p=v.isRangeOverlap=void 0;function G(r,e,t,n,s){var i,o,u,d,l=!1;return Array.isArray(r)&&Array.isArray(e)?(i=r[0],o=r[1],u=e[0],d=e[1],l=t===!0):t===void 0?(r=r,e=e,i=r.start,o=r.end,u=e.start,d=e.end,l=t===!0):(i=r,o=e,u=t||r,d=n||e,l=s===!0),l?i<d&&u<o:i<=d&&u<=o}p=v.isRangeOverlap=G;class O extends m{constructor(e={}){super(e);const{selected:t,octavePosition:n,origin:s}=e||{};this.selected=t!==void 0?t:!1,this.octavePosition=n!==void 0?n:0,this.origin=s}resolvedIndex(){return this.origin!==void 0?this.origin.index:this.index}toJSON(){return{...super.toJSON(),selected:this.selected,octavePosition:this.octavePosition,index:this.index}}}function J(){return{AMSynth:"AM",DuoSynth:"Duo",FMSynth:"FM",MembraneSynth:"Membrane",MetalSynth:"Metal",MonoSynth:"Mono",PluckSynth:"Pluck",PolySynth:"Poly",Synth:"Synth"}}function Q(){return Object.fromEntries([2,4,8,12,16].map(r=>[String(r),r]))}function q(){return{"2n":2,"4n":4,"8n":8,"16n":16,"32n":32,"64n":64}}function W(){return{[x.SMALL]:"Small",[x.MEDIUM]:"Medium",[x.LARGE]:"Large"}}function X(){return{[C.TOP]:"Top",[C.BOTTOM]:"Bottom"}}function ee(r){return Math.max(Math.min((-1+r/.5)*30,30),-30)}const te=9;function F(r,e){let t=e.name;if(t){const n=t.match(/(.+)(\d+)/);t=n[1];const s=Number(n[2]);let i=t;t.length&&(i=t[0]);const o=s-r;return{c:3,d:2.5,e:2,f:1.5,g:1,a:.5,b:0}[String(i.toLowerCase())]*-1+o+2.5*o}else return-2.5/2}const D={cbbb:-3,cbb:-2,cb:-1,c:0,"c#":1,cx:2,"c##":2,"c###":3,"cx#":3,"c#x":3,dbbb:-1,dbb:0,db:1,d:2,"d#":3,dx:4,"d##":4,"d###":5,"dx#":5,"d#x":5,ebbb:1,ebb:2,eb:3,e:4,"e#":5,ex:6,"e##":6,"e###":7,"ex#":7,"e#x":7,fbbb:2,fbb:3,fb:4,f:5,"f#":6,fx:7,"f##":7,"f###":8,"fx#":8,"f#x":8,gbbb:4,gbb:5,gb:6,g:7,"g#":8,gx:9,"g##":9,"g###":10,"gx#":10,"g#x":10,abbb:6,abb:7,ab:8,a:9,"a#":10,ax:11,"a##":11,"a###":12,"ax#":12,"a#x":12,bbbb:8,bbb:9,bb:10,b:11,"b#":12,bx:13,"b##":13,"b###":14,"bx#":14,"b#x":14};Object.values(D).reduce((r,e)=>r=Math.min(r,e),1/0);Object.values(D).reduce((r,e)=>r=Math.max(r,e),-1/0);function S(r){const{min:e,max:t}=r.filter(n=>n.octave).reduce((n,s)=>(n.min=Math.min(s.octave,n.min),n.max=Math.max(s.octave,n.max),n),{min:1/0,max:-1/0});return{max:t,min:e,length:Math.max(Math.ceil(t-e),1)}}function P(r){return r.reduce((e,t)=>(e+=t.toSeconds(),e),0)}const T={"A#":["A","C#","E"],"B#":["B","D#","F#"],"C#":["C","E","G"],"D#":["D","F#","A"],"E#":["E","G#","B"],"F#":["F","A","C"],"G#":["G","B","D"],"Ab#":["Ab","C","Eb"],"Bb#":["Bb","D","F"],"Cb#":["Cb","Eb","Gb"],"Db#":["Db","F","Ab"],"Eb#":["Eb","G","Bb"],"A#2":["A","C#","E","B"],"B#2":["B","D#","F#","C#"],"C#2":["C","E","G","D"],"D#2":["D","F#","A","E"],"F#2":["F","A","C","D"],"G#2":["G","B","D","A"],"Ab#2":["Ab","C","Eb","Bb"],"Bb#2":["Bb","D","F","C"],"Cb#2":["Cb","Eb","Gb","Db"],"Db#2":["Db","F","Ab","Eb"],"Eb#2":["Eb","G","Bb","F"]};function R(r){var e;if(/^([A-Za-z]+[#xb]{,2})(\d)+$/.test(r)){const[,t,n]=r.match(/^([A-Za-z]+[#xb]{,2})(\d)+$/)||[];return Array.from(new Set(((e=T[String(t)])==null?void 0:e.map(R).flat())||[r])).map(s=>`${s}${n||""}`)}return[r]}function ne({triplet:r=!1,dotted:e=!1,natural:t=!0}={}){return[1,2,4,8,16,32].map(n=>[t&&`${n}n`,r&&`${n}t`,e&&`${n}n.`].filter(Boolean)).flat().map(n=>[n,new I(n).toSeconds()])}class w{constructor({align:e,notes:t}){this.notes=t,this.align=e}get startSeconds(){return this.notes[0].delay}get endSeconds(){const e=this.notes[this.notes.length-1];return e.delay+e.toSeconds()}get selected(){return this.notes.some(({selected:e})=>e)}getNote(e){return this.notes[Number(e)]}}class _{constructor({noteGroups:e,index:t}){this.noteGroups=e,this.index=t}get empty(){return!Object.values(this.noteGroups).length}get selected(){return Object.values(this.noteGroups).some(e=>e.some(t=>t.notes.some(n=>n.selected)))}getGroupFromNoteIndex(e){return this.noteGroups.find(t=>t.getNote(e))}getNoteFromNoteIndex(e){return this.noteGroups.find(t=>t.getNote(e)).getNote(e)}}function re(r){const{min:e}=S(r);return[].concat(r).sort((t,n)=>t.delay-n.delay).map((t,n)=>new O({...t,index:n,octavePosition:F(e,t)}))}function $(r){return r.reduce((e,[,t])=>Math.max(t.reduce((n,{notes:s})=>Math.max(s.reduce((i,o)=>Math.max(o.delay+o.toSeconds(),i),0),n),0),e),0)}function j(r,e=1){r=Object.entries(r);const t=e*2,n=$(r),s=Math.ceil(n/t),i=[];for(let o=0;o<s;o++){const u=[];for(let d=0;d<r.length;d++){const[l,a]=r[Number(d)],c=a.filter(({startSeconds:f,endSeconds:B})=>f>=o*t&&B<=(o+1)*t);c.length&&u.push([l,c])}i.push(new _({noteGroups:Object.fromEntries(u),index:o}))}return i}function L(r){const e=r.reduce((s,i)=>{const{time:o}=i;return s[o||"pause"]||(s[o||"pause"]=[]),s[o||"pause"].push(i),s},{}),n=Object.entries(e).map(([s,i])=>[s,i.sort((o,u)=>o.octave-u.octave||o.delay-u.delay)]).map(([s,i])=>[s,k(i)]).sort((s,i)=>s[0].localeCompare(i[0]));return Object.fromEntries(n)}function k(r){const e=[];for(;r.length;){const t=r.shift();let n=[];n=r.reduce((a,c)=>(c.delay>=t.delay+t.toSeconds()&&a.push(c),a),[]),n=n.reduce((a,c)=>((!a.length||a.length&&a[a.length-1].delay<=c.delay+c.toSeconds())&&a.push(c),a),[]),n=n.reduce((a,c,f)=>(n[0].delay-t.delay<=.5&&(!t.time.triplet||t.time.triplet&&f<2)&&a.push(c),a),[]),n=n.reduce((a,c)=>(c.delay-t.delay%2+c.toSeconds()<=t.delay-t.delay%2+2-t.delay%2&&a.push(c),a),[]);let s,i=t;n=n.reduce((a,c)=>((!s||s===y(c.octavePosition-i.octavePosition))&&a.push(c),s=y(c.octavePosition-i.octavePosition),i=c,a),[]);const o=1;let u;n=n.reduce((a,c)=>{const f=(u||t).octavePosition-c.octavePosition;return f>-o&&f<o&&a.push(c),u=c,a},[]);let d=0;n.length&&(d=n[0].octavePosition-t.octavePosition);let l=g.ASCENDING;l=y(d),r=r.filter(a=>!n.includes(a)),n.unshift(t),e.push(new w({notes:n,align:l}))}return e}function y(r){return r<0?g.DESCENDING:r>0?g.ASCENDING:g.EQUAL}class N{constructor(e){const{number:t,character:n,dot:s}=z(e);this.number=Number(t),this.baseCharacter=n,this.dot=s||!1,this.triplet=n==="t"}get character(){return this.triplet?"t":this.baseCharacter}toString(){return`${this.number}${this.character}${this.dot?".":""}`}static parse(e){return new N(e)}}function z(r){if(r instanceof N||typeof r=="number")return r;try{const[,e,t,n]=r.match(/^(\d+)([a-z])(\.?)$/i);return{number:e,character:t,dot:!!n,triplet:t==="t"}}catch(e){console.error(e);debugger;return null}}const K="Synth",b=2;class U{constructor(e={}){h(this,"id");h(this,"type");h(this,"name");h(this,"notes");h(this,"baseNote");h(this,"beatCount");h(this,"noteCount");h(this,"octaveCount");h(this,"speed",1);h(this,"selectedIndex",-1);h(this,"currentDuration",0);const{id:t,type:n,name:s,notes:i,baseNote:o,beatCount:u,noteCount:d,speed:l}=e;this.id=t||M(),this.type=n||K,this.name=s||"Track",this.notes=(i||[]).map(a=>new m(a)),this.refreshNotes(),this.beatCount=Number(u||1),this.baseNote=Number(o||4),this.noteCount=Number(d||4),this.speed=Number(l||1)}getOctaveRange(){const{min:e,length:t}=S(this.notes);return{start:e,count:t}}reset(){this.selectedIndex=-1,this.notes=[]}addNote(e=null){if(e=new m(e),!this.notes.find(t=>t.getName()===e.getName()&&p(t.delay,t.toSeconds(),e.delay,e.delay+e.toSeconds())))return this.notes.push(e),this.refreshNotes(),e}addNoteTo(e,t=null){return this.notes=[...this.notes.slice(0,e+1),new m(t),...this.notes.slice(e+1)],this.refreshNotes(),t}getNote(e){return this.notes[Number(e)]}replaceNote(e,t){return this.notes[Number(e)]=new m(t),this.refreshNotes(),this.notes[Number(e)]}removeNote(e){this.notes=this.notes.filter((t,n)=>![].concat(e).includes(n)),this.refreshNotes()}refreshNotes(){this.notes=[].concat(this.notes).sort((e,t)=>e.delay-t.delay).map((e,t)=>(e.index=t,e))}removeNotesByDurationRange(e,t){this.removeNote(this.getNotesByDurationRange(e,t).map(({index:n})=>n))}removeNotesFromBeat(e){const t=e*b,n=b;this.removeNotesByDurationRange(t,n)}getDuration(){return P(this.notes)}getNotesByDurationRange(e,t){return this.notes.filter(n=>p(e,e+t,n.delay,n.delay+n.toSeconds()))}getVisibleBeatsByDuration(e,t=this.notes){e=e!==void 0?e:this.currentDuration;const n=this.getBeatIndex(e);t=t.filter(i=>i.delay>=n*b&&i.delay+i.toSeconds()<n*b+this.beatCount*b);const s=this.getBeats({selectedIndex:this.selectedIndex,speed:this.speed},t);return console.log("slice",t.length),s.slice(n,n+this.beatCount)}getVisibleBeats(){var n;const e=this.getBeats({selectedIndex:this.selectedIndex,speed:this.speed});let t=((n=e.find(s=>s.selected))==null?void 0:n.index)||0;return t=Math.floor(t/this.beatCount)*this.beatCount,e.slice(t,t+this.beatCount)}getNotationFromNoteCount(){return new N(`${this.noteCount}n`)}getBeats(e={},t=this.notes){const{selectedIndex:n,speed:s}={selectedIndex:-1,speed:1,...e};n>-1&&t.find(({index:o})=>n===o)&&t.filter(({index:o})=>n===o).forEach(o=>o.selected=!0);const i=L(t);return j(i,s)}getBeatIndex(e=this.currentDuration){return(e/(b*this.beatCount)-e%(b*this.beatCount)/(b*this.beatCount))*this.beatCount}getCurrentNote(){return this.getNote(this.selectedIndex)}selectPrevNote(){this.selectedIndex=Math.max(this.selectedIndex-1,-1)}selectNextNote(){this.selectedIndex=Math.min(this.selectedIndex+1,this.notes.length-1)}}const se=Object.freeze(Object.defineProperty({__proto__:null,default:U},Symbol.toStringTag,{value:"Module"}));export{te as B,U as T,ne as a,J as b,W as c,X as d,q as e,Q as f,ee as g,S as h,se as i,re as p,R as r};
