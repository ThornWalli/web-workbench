var A=Object.defineProperty;var I=(r,e,t)=>e in r?A(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var l=(r,e,t)=>I(r,typeof e!="symbol"?e+"":e,t);import{N as g,T as M}from"./DMsu-ujD.js";import{K as y,a as v,G as N}from"./CkopU8PM.js";import{v as G}from"./C6aID195.js";var m={},C;function O(){if(C)return m;C=1,Object.defineProperty(m,"__esModule",{value:!0}),m.isRangeOverlap=void 0;function r(e,t,n,s,a){var o,u,d,h,i=!1;return Array.isArray(e)&&Array.isArray(t)?(o=e[0],u=e[1],d=t[0],h=t[1],i=n===!0):n===void 0?(e=e,t=t,o=e.start,u=e.end,d=t.start,h=t.end,i=n===!0):(o=e,u=t,d=n||e,h=s||t,i=a===!0),i?o<h&&d<u:o<=h&&d<=u}return m.isRangeOverlap=r,m}var D=O();class F extends g{constructor(e={}){super(e);const{selected:t,octavePosition:n,origin:s}=e||{};this.selected=t!==void 0?t:!1,this.octavePosition=n!==void 0?n:0,this.origin=s}resolvedIndex(){return this.origin!==void 0?this.origin.index:this.index}toJSON(){return{...super.toJSON(),selected:this.selected,octavePosition:this.octavePosition,index:this.index}}}function J(){return{AMSynth:"AM",DuoSynth:"Duo",FMSynth:"FM",MembraneSynth:"Membrane",MetalSynth:"Metal",MonoSynth:"Mono",PluckSynth:"Pluck",PolySynth:"Poly",Synth:"Synth"}}function Q(){return Object.fromEntries([2,4,8,12,16].map(r=>[String(r),r]))}function W(){return{"2n":2,"4n":4,"8n":8,"16n":16,"32n":32,"64n":64}}function X(){return{[y.SMALL]:"Small",[y.MEDIUM]:"Medium",[y.LARGE]:"Large"}}function ee(){return{[v.TOP]:"Top",[v.BOTTOM]:"Bottom"}}function te(r){return Math.max(Math.min((-1+r/.5)*30,30),-30)}const ne=9;function P(r,e){let t=e.name;if(t){const n=t.match(/(.+)(\d+)/);t=n[1];const s=Number(n[2]);let a=t;t.length&&(a=t[0]);const o=s-r;return{c:3,d:2.5,e:2,f:1.5,g:1,a:.5,b:0}[String(a.toLowerCase())]*-1+o+2.5*o}else return-2.5/2}const S={cbbb:-3,cbb:-2,cb:-1,c:0,"c#":1,cx:2,"c##":2,"c###":3,"cx#":3,"c#x":3,dbbb:-1,dbb:0,db:1,d:2,"d#":3,dx:4,"d##":4,"d###":5,"dx#":5,"d#x":5,ebbb:1,ebb:2,eb:3,e:4,"e#":5,ex:6,"e##":6,"e###":7,"ex#":7,"e#x":7,fbbb:2,fbb:3,fb:4,f:5,"f#":6,fx:7,"f##":7,"f###":8,"fx#":8,"f#x":8,gbbb:4,gbb:5,gb:6,g:7,"g#":8,gx:9,"g##":9,"g###":10,"gx#":10,"g#x":10,abbb:6,abb:7,ab:8,a:9,"a#":10,ax:11,"a##":11,"a###":12,"ax#":12,"a#x":12,bbbb:8,bbb:9,bb:10,b:11,"b#":12,bx:13,"b##":13,"b###":14,"bx#":14,"b#x":14};Object.values(S).reduce((r,e)=>r=Math.min(r,e),1/0);Object.values(S).reduce((r,e)=>r=Math.max(r,e),-1/0);function B(r){const{min:e,max:t}=r.filter(n=>n.octave).reduce((n,s)=>(n.min=Math.min(s.octave,n.min),n.max=Math.max(s.octave,n.max),n),{min:1/0,max:-1/0});return{max:t,min:e,length:Math.max(Math.ceil(t-e),1)}}function T(r){return r.reduce((e,t)=>(e+=t.toSeconds(),e),0)}const R={"A#":["A","C#","E"],"B#":["B","D#","F#"],"C#":["C","E","G"],"D#":["D","F#","A"],"E#":["E","G#","B"],"F#":["F","A","C"],"G#":["G","B","D"],"Ab#":["Ab","C","Eb"],"Bb#":["Bb","D","F"],"Cb#":["Cb","Eb","Gb"],"Db#":["Db","F","Ab"],"Eb#":["Eb","G","Bb"],"A#2":["A","C#","E","B"],"B#2":["B","D#","F#","C#"],"C#2":["C","E","G","D"],"D#2":["D","F#","A","E"],"F#2":["F","A","C","D"],"G#2":["G","B","D","A"],"Ab#2":["Ab","C","Eb","Bb"],"Bb#2":["Bb","D","F","C"],"Cb#2":["Cb","Eb","Gb","Db"],"Db#2":["Db","F","Ab","Eb"],"Eb#2":["Eb","G","Bb","F"]};function w(r){var e;if(/^([A-Za-z]+[#xb]{,2})(\d)+$/.test(r)){const[,t,n]=r.match(/^([A-Za-z]+[#xb]{,2})(\d)+$/)||[];return Array.from(new Set(((e=R[String(t)])==null?void 0:e.map(w).flat())||[r])).map(s=>`${s}${n||""}`)}return[r]}function re({triplet:r=!1,dotted:e=!1,natural:t=!0}={}){return[1,2,4,8,16,32].map(n=>[t&&`${n}n`,r&&`${n}t`,e&&`${n}n.`].filter(Boolean)).flat().map(n=>[n,new M(n).toSeconds()])}class ${constructor({align:e,notes:t}){this.notes=t,this.align=e}get startSeconds(){return this.notes[0].delay}get endSeconds(){const e=this.notes[this.notes.length-1];return e.delay+e.toSeconds()}get selected(){return this.notes.some(({selected:e})=>e)}getNote(e){return this.notes[Number(e)]}}class j{constructor({noteGroups:e,index:t}){this.noteGroups=e,this.index=t}get empty(){return!Object.values(this.noteGroups).length}get selected(){return Object.values(this.noteGroups).some(e=>e.some(t=>t.notes.some(n=>n.selected)))}getGroupFromNoteIndex(e){return this.noteGroups.find(t=>t.getNote(e))}getNoteFromNoteIndex(e){return this.noteGroups.find(t=>t.getNote(e)).getNote(e)}}function se(r){const{min:e}=B(r);return[].concat(r).sort((t,n)=>t.delay-n.delay).map((t,n)=>new F({...t,index:n,octavePosition:P(e,t)}))}function _(r){return r.reduce((e,[,t])=>Math.max(t.reduce((n,{notes:s})=>Math.max(s.reduce((a,o)=>Math.max(o.delay+o.toSeconds(),a),0),n),0),e),0)}function L(r,e=1){r=Object.entries(r);const t=e*2,n=_(r),s=Math.ceil(n/t),a=[];for(let o=0;o<s;o++){const u=[];for(let d=0;d<r.length;d++){const[h,i]=r[Number(d)],c=i.filter(({startSeconds:f,endSeconds:E})=>f>=o*t&&E<=(o+1)*t);c.length&&u.push([h,c])}a.push(new j({noteGroups:Object.fromEntries(u),index:o}))}return a}function k(r){const e=r.reduce((s,a)=>{const{time:o}=a;return s[o||"pause"]||(s[o||"pause"]=[]),s[o||"pause"].push(a),s},{}),n=Object.entries(e).map(([s,a])=>[s,a.sort((o,u)=>o.octave-u.octave||o.delay-u.delay)]).map(([s,a])=>[s,z(a)]).sort((s,a)=>s[0].localeCompare(a[0]));return Object.fromEntries(n)}function z(r){const e=[];for(;r.length;){const t=r.shift();let n=[];n=r.reduce((i,c)=>(c.delay>=t.delay+t.toSeconds()&&i.push(c),i),[]),n=n.reduce((i,c)=>((!i.length||i.length&&i[i.length-1].delay<=c.delay+c.toSeconds())&&i.push(c),i),[]),n=n.reduce((i,c,f)=>(n[0].delay-t.delay<=.5&&(!t.time.triplet||t.time.triplet&&f<2)&&i.push(c),i),[]),n=n.reduce((i,c)=>(c.delay-t.delay%2+c.toSeconds()<=t.delay-t.delay%2+2-t.delay%2&&i.push(c),i),[]);let s,a=t;n=n.reduce((i,c)=>((!s||s===p(c.octavePosition-a.octavePosition))&&i.push(c),s=p(c.octavePosition-a.octavePosition),a=c,i),[]);const o=1;let u;n=n.reduce((i,c)=>{const f=(u||t).octavePosition-c.octavePosition;return f>-1&&f<o&&i.push(c),u=c,i},[]);let d=0;n.length&&(d=n[0].octavePosition-t.octavePosition);let h=N.ASCENDING;h=p(d),r=r.filter(i=>!n.includes(i)),n.unshift(t),e.push(new $({notes:n,align:h}))}return e}function p(r){return r<0?N.DESCENDING:r>0?N.ASCENDING:N.EQUAL}class x{constructor(e){const{number:t,character:n,dot:s}=K(e);this.number=Number(t),this.baseCharacter=n,this.dot=s||!1,this.triplet=n==="t"}get character(){return this.triplet?"t":this.baseCharacter}toString(){return`${this.number}${this.character}${this.dot?".":""}`}static parse(e){return new x(e)}}function K(r){if(r instanceof x||typeof r=="number")return r;try{const[,e,t,n]=r.match(/^(\d+)([a-z])(\.?)$/i);return{number:e,character:t,dot:!!n,triplet:t==="t"}}catch(e){console.error(e);debugger;return null}}const U="Synth",b=2;class V{constructor(e={}){l(this,"id");l(this,"type");l(this,"name");l(this,"notes");l(this,"baseNote");l(this,"beatCount");l(this,"noteCount");l(this,"octaveCount");l(this,"speed",1);l(this,"selectedIndex",-1);l(this,"currentDuration",0);const{id:t,type:n,name:s,notes:a,baseNote:o,beatCount:u,noteCount:d,speed:h}=e;this.id=t||G(),this.type=n||U,this.name=s||"Track",this.notes=(a||[]).map(i=>new g(i)),this.refreshNotes(),this.beatCount=Number(u||1),this.baseNote=Number(o||4),this.noteCount=Number(d||4),this.speed=Number(h||1)}setSelectedIndex(e){this.selectedIndex=Number(e)}setCurrentDuration(e){this.currentDuration=Number(e)}getOctaveRange(){const{min:e,length:t}=B(this.notes);return{start:e,count:t}}reset(){this.selectedIndex=-1,this.notes=[]}addNote(e=null){if(e=new g(e),!this.notes.find(t=>t.getName()===e.getName()&&D.isRangeOverlap(t.delay,t.toSeconds(),e.delay,e.delay+e.toSeconds())))return this.notes.push(e),this.refreshNotes(),e}addNoteTo(e,t=null){return this.notes=[...this.notes.slice(0,e+1),new g(t),...this.notes.slice(e+1)],this.refreshNotes(),t}getNote(e){return this.notes[Number(e)]}replaceNote(e,t){return this.notes[Number(e)]=new g(t),this.refreshNotes(),this.notes[Number(e)]}removeNote(e){this.notes=this.notes.filter((t,n)=>![].concat(e).includes(n)),this.refreshNotes()}refreshNotes(){this.notes=[].concat(this.notes).sort((e,t)=>e.delay-t.delay).map((e,t)=>(e.index=t,e))}removeNotesByDurationRange(e,t){this.removeNote(this.getNotesByDurationRange(e,t).map(({index:n})=>n))}removeNotesFromBeat(e){const t=e*b,n=b;this.removeNotesByDurationRange(t,n)}getDuration(){return T(this.notes)}getNotesByDurationRange(e,t){return this.notes.filter(n=>D.isRangeOverlap(e,e+t,n.delay,n.delay+n.toSeconds()))}getVisibleBeatsByDuration(e,t=this.notes){e=e!==void 0?e:this.currentDuration;const n=this.getBeatIndex(e);t=t.filter(a=>a.delay>=n*b&&a.delay+a.toSeconds()<n*b+this.beatCount*b);const s=this.getBeats({selectedIndex:this.selectedIndex,speed:this.speed},t);return console.log("slice",t.length),s.slice(n,n+this.beatCount)}getVisibleBeats(){var n;const e=this.getBeats({selectedIndex:this.selectedIndex,speed:this.speed});let t=((n=e.find(s=>s.selected))==null?void 0:n.index)||0;return t=Math.floor(t/this.beatCount)*this.beatCount,e.slice(t,t+this.beatCount)}getNotationFromNoteCount(){return new x(`${this.noteCount}n`)}getBeats(e={},t=this.notes){const{selectedIndex:n,speed:s}={selectedIndex:-1,speed:1,...e};n>-1&&t.find(({index:o})=>n===o)&&t.filter(({index:o})=>n===o).forEach(o=>o.selected=!0);const a=k(t);return L(a,s)}getBeatIndex(e=this.currentDuration){return(e/(b*this.beatCount)-e%(b*this.beatCount)/(b*this.beatCount))*this.beatCount}getCurrentNote(){return this.getNote(this.selectedIndex)}selectPrevNote(){this.selectedIndex=Math.max(this.selectedIndex-1,-1)}selectNextNote(){this.selectedIndex=Math.min(this.selectedIndex+1,this.notes.length-1)}}const oe=Object.freeze(Object.defineProperty({__proto__:null,default:V},Symbol.toStringTag,{value:"Module"}));export{ne as B,V as T,X as a,ee as b,W as c,Q as d,B as e,re as f,te as g,J as h,oe as i,se as p,w as r};
