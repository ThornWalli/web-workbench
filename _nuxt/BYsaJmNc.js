var U=Object.defineProperty;var B=(s,t,e)=>t in s?U(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var f=(s,t,e)=>B(s,typeof t!="symbol"?t+"":t,e);import{i as a}from"./CpIyErmU.js";import{d as N,E as d,l as G,D as F}from"./Q6z_XoCT.js";import{S}from"./RAasLaaH.js";import{f as R}from"./DNvW6rqi.js";import{L as y,r as W,O as p,a9 as k}from"./oWuEt9Fj.js";import{S as _,I as m}from"./CFct_F1V.js";class b{constructor({fsItem:t,command:e,model:i,layout:o}){f(this,"ready",!1);f(this,"fsItem");f(this,"command");f(this,"type","default");f(this,"id",crypto.randomUUID());f(this,"layout",y({position:a(0,0),size:a(0,0)}));f(this,"ignoreRearrange",!1);f(this,"model",y({title:"Item Title",symbol:_.DEFAULT,used:!1,visible:!0,url:void 0,ignoreRearrange:!1}));this.type="default",this.command=e,this.model=y({...this.model,...i||{}}),this.layout=y({...this.layout,...o||{}}),this.fsItem=t}async setup({core:t}){try{const e=this.fsItem;if(!e||this.ready)return;this.type=P(e),await T(this,t),e.events.subscribe(async({name:i})=>{i!=="addItem"&&i!=="removeItem"&&e&&await T(this,t)})}catch(e){console.warn(e),this.model.symbol=_.DISALLOW_1}this.ready=!0}setLayout(t){t.position&&(this.layout.position=a(t.position.x,t.position.y)),t.size&&(this.layout.size=a(t.size.x,t.size.y))}}async function T(s,t){var i;const e=s.fsItem;if(e)if(s.model.title=e.name||"",s.layout.position=e.meta.get(m.POSITION)&&L(e.meta.get(m.POSITION))||a(0,0),s.model.visible=!!e.meta.get(m.VISIBLE),s.model.symbol=e.meta.get(m.SYMBOL),e.meta.get(m.WEB_URL)&&(s.model.url=String(e.meta.get(m.WEB_URL))),s.model.ignoreRearrange=!!e.meta.get(m.IGNORE_SYMBOL_REARRANGE),e.meta.get(m.REFERENCE)){const o=await((i=t.modules.files)==null?void 0:i.fileSystem.get(String(e.meta.get(m.REFERENCE))));if(!o)throw new Error("Reference item not found");o.meta.get(m.WEB_URL)&&(s.model.url=String(o.meta.get(m.WEB_URL))),s.command=()=>M(o,s.model)}else s.command=()=>M(e,s.model)}function M(s,t){if(s instanceof N){const e=[`openDirectory "${s.getPath()}"`];s.meta.get(m.WINDOW_SYMBOL_REARRANGE)&&e.push("-sort-symbols");const i=s.meta.get(m.WINDOW_POSITION)&&L(s.meta.get(m.WINDOW_POSITION))||a(0,0);i.length>0&&e.push(`--window-position="${a(i.x,i.y).toArray().join(",")}"`);const o=s.meta.get(m.WINDOW_SIZE)&&L(s.meta.get(m.WINDOW_SIZE))||a(0,0);return o.length>0&&e.push(`--window-size="${a(o.x,o.y).toArray().join(",")}"`),s.meta.has(m.WINDOW_SCALE)&&e.push(`--window-scale=${s.meta.get(m.WINDOW_SCALE)}`),s.meta.has(m.WINDOW_SCROLL_X)&&e.push(`--window-scroll-x=${s.meta.get(m.WINDOW_SCROLL_X)}`),s.meta.has(m.WINDOW_SCROLL_Y)&&e.push(`--window-scroll-y=${s.meta.get(m.WINDOW_SCROLL_Y)}`),s.meta.has(m.WINDOW_SIDEBAR)&&e.push(`--window-sidebar=${s.meta.get(m.WINDOW_SIDEBAR)}`),s.meta.has(m.WINDOW_FULL_SIZE)&&e.push(`--window-full-size=${s.meta.get(m.WINDOW_FULL_SIZE)}`),e.join(" ")}else if(!t.url)return`execute "${s.getPath()}"`}function C(s,t){return s.map(e=>{const i=e instanceof b?e:new b({...e});return i.setup({core:t}),i})}function P(s){return s instanceof N?"container":s.meta.get(m.WEB_URL)?"link":"default"}function L(s){return a(s.x,s.y)}function ie(s){return typeof s=="function"?s():s}var g=(s=>(s[s.NAME=0]="NAME",s[s.TYPE=1]="TYPE",s[s.CREATED_DATE=2]="CREATED_DATE",s[s.EDITED_DATE=3]="EDITED_DATE",s))(g||{}),w=(s=>(s[s.ASCENDING=0]="ASCENDING",s[s.DESCENDING=1]="DESCENDING",s))(w||{}),D=(s=>(s.SHOW_INVISIBLE_SYMBOLS="symbolWrapper_showInvisibleItems",s.ORDER_TYPE="symbolWrapper_iconsOrderType",s.ORDER_DIRECTION="symbolWrapper_iconsOrderDirection",s))(D||{});class O extends d{}class ${constructor(t,e=[],i=!1){f(this,"id",crypto.randomUUID());f(this,"items",W([]));f(this,"selectedItems",W([]));f(this,"core");f(this,"root",!1);f(this,"layout",y({size:a(0,0),position:a(0,0)}));f(this,"size",a(0,0));f(this,"parentSize",a(0,0));this.root=i||!1,this.core=t,this.items.value=C(e||[],this.core)}setLayout(t){t.position&&(this.layout.position=a(t.position.x,t.position.y)),t.size&&(this.layout.size=a(t.size.x,t.position.y))}setSize(t){this.size=a(t.x,t.y)}setParentSize(t){this.parentSize=a(t.x,t.y)}rearrangeIcons(t={align:"left",axis:"horizontal",force:!1,root:!1,margin:10}){t=Object.assign({orderType:this.core.config.get(D.ORDER_TYPE)||g.NAME,orderDirection:this.core.config.get(D.ORDER_DIRECTION)||w.ASCENDING,onlyVisible:!this.core.config.get(D.SHOW_INVISIBLE_SYMBOLS)||!1,align:"left",axis:"horizontal",root:!1,margin:10},t);let e=this.items.value;switch(t.root&&(t.orderType=g.NAME,t.orderDirection=w.DESCENDING,t.force||(t.axis="vertical",t.align="right")),t.onlyVisible&&(e=e.filter(n=>n.model.visible)),t.force||(e=e.filter(n=>!n.model.ignoreRearrange)),t.orderType){case g.TYPE:e=e.sort((n,u)=>n.type.localeCompare(u.type));break;case g.CREATED_DATE:e=e.sort((n,u)=>{var v,z;const[h,E]=[((v=n.fsItem)==null?void 0:v.createdDate)||0,((z=u.fsItem)==null?void 0:z.createdDate)||0];return h===E?0:h>E?1:-1});break;case g.EDITED_DATE:e=e.sort((n,u)=>{var v,z;const[h,E]=[((v=n.fsItem)==null?void 0:v.editedDate)||0,((z=u.fsItem)==null?void 0:z.editedDate)||0];return h===E?0:h>E?1:-1});break;default:e=e.sort(n=>n.model.title.localeCompare(n.model.title))}switch(t.orderDirection){case w.ASCENDING:e.reverse();break}const i=t.margin||0;let o,r=i,c=0,l=0;return t.align==="right"?o=this.size.x:o=i,e.forEach(n=>{t.axis==="horizontal"?((t.align==="left"&&o+(n.layout.size.x+i)>=this.parentSize.x||t.align==="right"&&o-(n.layout.size.x+i)<=0)&&(t.align==="right"?o=this.size.x:o=i,r+=c+i,c=0),n.layout.position=a(o,r),o+=(n.layout.size.x+i)*(t.align==="right"?-1:1),c=Math.max(c,n.layout.size.y)):(r+n.layout.size.y>this.parentSize.y-i*2&&(o+=(l+i)*(t.align==="right"?-1:1),r=i,l=0),t.align==="right"?n.layout.position=a(o-(n.layout.size.x+i),r):n.layout.position=a(o,r),r=r+(n.layout.size.y+i),l=Math.max(l,n.layout.size.x))}),e.reduce((n,{id:u,layout:h})=>n.then(()=>this.savePosition(u,h.position)),Promise.resolve())}clearSelectedItems(){[...this.selectedItems.value].forEach(t=>this.unselectItem(t))}isSelectedItem(t){return this.selectedItems.value.includes(t)}selectItem(t){return this.isSelectedItem(t)?!1:(this.selectedItems.value.push(t),!0)}unselectItem(t){return this.isSelectedItem(t)?(this.selectedItems.value=this.selectedItems.value.filter(e=>e!==t),!0):!1}async moveItem(t,e){console.warn("Method not implemented.",t,e)}async moveItemToItem(t,e){console.warn("Method not implemented.",e,t)}async savePosition(t,e){console.warn("Method not implemented.",t,e)}get(t){return this.items.value.find(e=>e.id===t)}has(t){return!!this.items.value.find(e=>e.id===t)}add(...t){const e=C(t,this.core);return this.items.value.push(...e),e}remove(t){let e;return typeof t=="string"?e=this.get(t):e=t,e&&(this.unselectItem(e.id),this.items.value.splice(this.items.value.indexOf(e),1)),e}}class H extends ${constructor(){super(...arguments);f(this,"events",p(new S))}add(...e){const i=super.add(...e);return this.events.next(new O({name:"add",value:{wrapper:this,items:Array.from(i)}})),i}remove(e){const i=super.remove(e);return i&&this.events.next(new O({name:"remove",value:{wrapper:this,item:i||void 0}})),i}setup(...e){return Promise.resolve()}selectItem(e){return super.selectItem(e)?(this.events.next(new d({name:"selectItem",value:{wrapper:this,id:e}})),!0):!1}unselectItem(e){return super.unselectItem(e)?(this.events.next(new d({name:"unselectItem",value:{wrapper:this,id:e}})),!0):!1}}class I extends H{constructor(){super(...arguments);f(this,"fsItem");f(this,"usedMemory",0)}async setup(e){this.fsItem=e;const i=Array.from((await e.getItems()).values());await Promise.all(i.map(async o=>this.add(await I.fsItemToSymbol(o)))),e.events.subscribe(this.onEventItem.bind(this))}async moveItemToItem(e,i){var o,r;if(e.locked)throw new Error("Items are locked!");if(i.locked)throw new Error("Destination is locked!");e.meta.set(m.POSITION,a(0,0)),await((o=this.core.modules.files)==null?void 0:o.fs.saveItem(e)),await((r=this.core.modules.files)==null?void 0:r.fs.move(e,i,{override:!0}))}async moveItem(e,i){const o=this.get(e);if(o&&(o.fsItem instanceof G||o.fsItem instanceof F))try{if(o!=null&&o.fsItem&&(i!=null&&i.fsItem))await this.moveItemToItem(o.fsItem,i.fsItem);else throw new Error("Item or wrapper not found");return!0}catch(r){return console.warn(r),!1}return!1}async savePosition(e,i){var r;let o;if(typeof e=="string"&&this.get(e)?o=this.get(e):e instanceof b&&(o=e),o)if(o.fsItem)o.fsItem.meta.set(m.POSITION,i),(r=this.core.modules.files)==null||r.fs.saveItem(o.fsItem);else throw new Error(`Item has no fsItem. ${e}`);else throw new Error(`Item not found. ${e}`)}hasFsItem(e){return this.items.value.find(i=>{var o;return((o=i.fsItem)==null?void 0:o.id)===e.id})}async onEventItem({name:e,value:i}){var o,r;if(i!=null&&i.item){let c;if(e==="addItem")c=await I.fsItemToSymbol(i.item),this.hasFsItem(i.item)||this.add(c);else if(e==="removeItem"){const l=this.items.value.find(n=>{var u,h;return((u=n.fsItem)==null?void 0:u.id)===((h=i.item)==null?void 0:h.id)});if(l)this.remove(l);else throw new Error(`Item not found in symbol wrapper. ${(o=i.item)==null?void 0:o.id}`)}this.usedMemory=((r=this.fsItem)==null?void 0:r.getUsedMemory())||0}else console.warn("Item event without value",e,i)}static getItemsFromItem(e){return Promise.all(Array.from(e.items.values()).map(I.fsItemToSymbol))}static async fsItemToSymbol(e){const i=await e.getPath(),o=new b({fsItem:e,model:{title:e.name||"Untitled"}});return typeof e.action=="function"&&(o.command=`executeFile "${i}"`),e.meta.get(m.WEB_URL)&&(o.model.url=String(e.meta.get(m.WEB_URL))),o}}const Z=a(0,0);class x{constructor({sidebarComponent:t,sidebarComponentData:e,component:i,componentData:o,options:r,wrapper:c,layout:l,parentWindow:n}){f(this,"events",new S);f(this,"id",crypto.randomUUID());f(this,"component");f(this,"componentData");f(this,"sidebarComponent");f(this,"sidebarComponentData");f(this,"parentWindow");f(this,"options",y({title:void 0,scale:!1,scaleX:!1,scaleY:!1,scroll:!1,scrollX:!1,scrollY:!1,clamp:!1,clampX:!0,clampY:!1,freeze:!1,focused:!1,center:!0,close:!0,overlay:!0,embed:!1,fillHeader:!1,filled:!1,borderless:!1,hideRootHeader:!1,sidebar:!0,prompt:!1}));f(this,"group");f(this,"wrapper");f(this,"layout",y({focused:!1,position:a(0,0),size:Z,scrollOffset:a(0,0),zIndex:0}));this.parentWindow=n,t&&(this.sidebarComponent=p(t)),e&&(this.sidebarComponentData=p(e)),i&&(this.component=p(i)),this.componentData={...o||{}},c&&(this.wrapper=p(c)),this.options=Object.assign(this.options,r),this.layout=Object.assign(this.layout,l)}setLayout(t){t.position&&(this.layout.position=a(t.position.x,t.position.y)),t.size&&(this.layout.size=a(t.size.x,t.size.y)),t.scrollOffset&&(this.layout.scrollOffset=a(t.scrollOffset.x,t.scrollOffset.y)),t.focused&&(this.layout.focused=t.focused)}ready(){this.options.ready=!0,this.events.next(new d({name:"ready"}))}focus(){this.options.focused=!0,this.events.next(new d({name:"focus"}))}unfocus(){this.options.focused=!1,this.events.next(new d({name:"unfocus"}))}close(t){this.wrapper&&(this.events.next(new d({name:"close",value:t})),this.wrapper.remove(this.id),this.wrapper=void 0)}setWrapper(t){this.wrapper=p(t)}setGroup(t){this.group=t}awaitClose(){return new Promise(t=>{const e=this.events.pipe(R(({name:i})=>i==="close")).subscribe(i=>{e.unsubscribe(),t(i)})})}awaitReady(){return new Promise(t=>{if(this.options.ready)t(this);else{const e=this.events.pipe(R(({name:i})=>i==="ready")).subscribe(()=>{e.unsubscribe(),t(this)})}})}}var V=(s=>(s[s.CENTER=0]="CENTER",s[s.ORDER_HORIZONTAL=1]="ORDER_HORIZONTAL",s[s.ORDER_VERTICAL=2]="ORDER_VERTICAL",s[s.ORDER_DIAGONAL_LEFT=3]="ORDER_DIAGONAL_LEFT",s[s.ORDER_DIAGONAL_RIGHT=4]="ORDER_DIAGONAL_RIGHT",s[s.SPLIT_HORIZONTAL=5]="SPLIT_HORIZONTAL",s[s.SPLIT_VERTICAL=6]="SPLIT_VERTICAL",s[s.FULL=7]="FULL",s))(V||{});class oe{constructor(t,e=[]){f(this,"events",p(new S));f(this,"id",crypto.randomUUID());f(this,"core");f(this,"layout",{size:a(0,0),position:a(0,0)});f(this,"groups",new Map);f(this,"modelMap",new Map);f(this,"models",[]);f(this,"_activeWindow");this.core=t,e.forEach(i=>this.add(i))}setLayout(t){t.position&&(this.layout.position=a(t.position.x,t.position.y)),t.size&&(this.layout.size=a(t.size.x,t.size.y))}getActiveWindow(){return this.models.find(t=>t.options.focused)}setActiveWindow(t){this.models.forEach(e=>{e.options.focused=t===e.id,t===e.id&&(this._activeWindow=e,this.events.next(new d({name:"setActiveWindow",value:e})))})}hasEmbbedWindow(){return!!this.models.find(t=>t.options.embed)}isHeaderVsible(){return!this.models.find(t=>t.options.embed&&t.options.hideRootHeader)}add(t,e){const{full:i,maximize:o,active:r,group:c}={full:!1,maximize:!1,active:!0,group:null,...e||{}};let l;if(t instanceof x?l=t:l=new x(t),l.setWrapper(this),o?l.layout.size=a(this.layout.size.x,this.layout.size.y):i&&(l.layout.size=a(()=>a(this.layout.size.x,this.layout.size.y)+a(0,0))),c){let n;this.groups.has(c)?(n=this.groups.get(c),n.windows.push(l)):(n={primary:l,windows:[],name:c},this.groups.set(c,n)),l.setGroup(n)}return l.layout.zIndex=this.models.length,this.models.push(l),this.events.next(new d({name:"add",value:l})),this.modelMap.set(l.id,l),r&&this.setActiveWindow(l.id),l}remove(t){let e;t instanceof x?e=t:e=this.get(t),e!==void 0&&(e.group&&(e.group.primary===t?(e.group.windows.forEach(i=>i.close()),this.groups.delete(e.group.name)):e.group.primary.focus()),this.models.splice(this.models.indexOf(e),1),this.modelMap.delete(e.id))}get(t){return this.modelMap.get(t)}clear(){this.models=[].splice(0,this.models.length),this.modelMap.clear()}setWindowUpDown(t,e){const i=this.models,o=Array.from(i).filter(c=>!c.options.embed).sort((c,l)=>(c.layout.zIndex||0)-(l.layout.zIndex||0)).map(k),r=this.get(t);if(r){const c=o.findIndex(({id:n})=>n===r.id),l=o[e?c-1:c+1];if(l){const n=r.layout.zIndex;r.layout.zIndex=l.layout.zIndex,l.layout.zIndex=n}}}centerWindow(t){let e;t instanceof x?e=t:e=this.get(t),e&&A(e,this.layout)}setWindowPositions(t,e=[],i){const{embed:o}={embed:!1,...i};switch(e.length<1&&e.push(...this.models),o||(e=e.filter(r=>!r.options.embed)),t){case 7:e.forEach(r=>{Y(r,this.layout)});break;case 0:e.forEach(r=>{A(r,this.layout)});break;case 3:case 4:j(e,this.layout,t===4);break;case 5:case 6:X(e,this.layout,t===6);break}}saveSize(t,e){var o,r,c,l;const i=this.get(t);if(i&&(o=i.componentData)!=null&&o.symbolWrapper&&((r=i.componentData)==null?void 0:r.symbolWrapper)instanceof I){const n=(c=i.componentData)==null?void 0:c.symbolWrapper.fsItem;n&&(n.meta.set(m.WINDOW_SIZE,e),(l=this.core.modules.files)==null||l.fs.saveItem(n))}}savePosition(t,e){var o,r,c,l;const i=this.get(t);if(i&&(o=i.componentData)!=null&&o.symbolWrapper&&((r=i.componentData)==null?void 0:r.symbolWrapper)instanceof I){const n=(c=i.componentData)==null?void 0:c.symbolWrapper.fsItem;n&&(n.meta.set(m.WINDOW_POSITION,e),(l=this.core.modules.files)==null||l.fs.saveItem(n))}}}function Y(s,t){s.layout.position=a(0,0),s.layout.size=t.size}function A(s,t){s.layout.position=a(()=>(a(t.size.x,t.size.y)-a(s.layout.size.x,s.layout.size.y))/2)}function j(s,t,e){const i=1/s.length;s.forEach((o,r)=>{A(o,t),r=-Math.floor(s.length/2)+r;const c=a(o.layout.position.x+(e?-1:1)*(i*o.layout.size.x)*r,o.layout.position.y+i*o.layout.size.y*r),l=a(()=>a(t.size.x,t.size.y)-a(o.layout.size.x,o.layout.size.y));o.layout.position=a(()=>Math.max(Math.min(c,l),0))})}function X(s,t,e){let i;const o=s.length;e?(i=a(t.size.x,t.size.y/o),s.forEach((r,c)=>{r.layout.position=a(0,c*i.y),r.layout.size=i})):(i=a(t.size.x/o,t.size.y),s.forEach((r,c)=>{r.layout.position=a(c*i.x,0),r.layout.size=i}))}export{D as C,I as F,$ as I,g as O,oe as W,x as a,w as b,V as c,ie as r};
