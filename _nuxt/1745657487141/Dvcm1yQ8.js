import{C as E}from"./CGk7t0fz.js";import{d as A}from"./CI-V28mB.js";import{x as V,i as R,S}from"./2o4skMhU.js";import{W as H}from"./Z5oCkG7_.js";import{u as Z}from"./ElCJ8M34.js";import{d as F,j as $,t as d,x as h,z as y,v as u,_ as w,Y as M,Z as P,W as v,X as k,F as b,y as O,J as N,g as f,B as I,M as x,aa as D,A as z,I as W,a5 as L,$ as j,T}from"./CSrBrIb-.js";import{g as q,M as m,u as G}from"./CwTyMeF_.js";import{M as X,a as J}from"./C9gXaSH0.js";import Q from"./DMGkdCmz.js";import{N as ee,u as te}from"./fkrD9QA-.js";import{N as oe}from"./CWuhyOxF.js";import{r as ie,f as g,h as ne}from"./DGDReys3.js";import{g as se,b as re,C as l}from"./CPvqz4AR.js";import{T as ae,c as le}from"./C2h4z5IK.js";import{T as ce}from"./DbTrm4Mj.js";import{c as K,f as _}from"./DNGU8wv-.js";import{o as me}from"./CNtMeql4.js";import{i as de}from"./1qXVShGN.js";import{t as B}from"./FUWZzGg5.js";import"./BY0KaPQX.js";import"./C5mdboMC.js";import"./C59C2sh_.js";import"./V6wQfr-d.js";import"./7vWQM-aF.js";import"./CiKic5u-.js";import"./Cpj98o6Y.js";import"./DSSEMlfr.js";import"./CNkvSXuu.js";import"./Ko4_WgSz.js";import"./CCkQXBCT.js";import"./PbH3iXZM.js";import"./CgYAjA5S.js";import"./HAQpSXI-.js";import"./DLb_KJKV.js";import"./BUQWKlAd.js";import"./DzFcxpbm.js";import"./CV0dHcg-.js";import"./C6aID195.js";import"./U0J9jNun.js";import"./ey0azPGz.js";import"./DG3wQKIc.js";import"./BSj7esSs.js";import"./BcHo-crN.js";import"./SdfA2v9k.js";import"./cePB7ZwW.js";function U(e){return me(function(o,r){var i=!1,n=null,t=null,a=function(){if(t==null||t.unsubscribe(),t=null,i){i=!1;var s=n;n=null,r.next(s)}};o.subscribe(K(r,function(s){t==null||t.unsubscribe(),i=!0,n=s,t=K(r,a,V),de(e(s)).subscribe(t)},function(){a(),r.complete()},void 0,function(){n=t=null}))})}const ue={class:"wb-env-molecule-footer"},he={ref:"menu",class:"menu"},pe=F({__name:"Footer",props:{parentLayout:{type:Object,default(){return{size:R(window.innerWidth,window.innerHeight)}}},title:{type:String,default:"Web-Workbench release. Version 1.3"},items:{type:Array,default(){}}},emits:["inputContextMenu"],setup(e,{emit:o}){const{core:r}=Z(),i=e,n=o,t=$(()=>{var s,c;return i.items||((c=(s=r.value)==null?void 0:s.modules.windows)==null?void 0:c.contextMenu.activeItems.items)});function a(...s){n("inputContextMenu",...s)}return(s,c)=>(u(),d("footer",ue,[h("nav",he,[y(H,{direction:"top",items:t.value,"parent-layout":e.parentLayout,"onUpdate:modelValue":a},null,8,["items","parent-layout"])],512)]))}}),ye=w(pe,[["__scopeId","data-v-6104b57a"]]),be=9,Ce={props:{disabled:{type:Boolean,default:!1},selectedNotes:{type:Array,default:null},size:{type:String,validator:e=>["small","medium","large"].includes(e),default:"large"},showNoteLabels:{type:Boolean,default:!1},startOctave:{type:Number,default:4},octaveCount:{type:Number,default:6}},emits:["down","up"],data:function(){return{pressedKeys:[],dimension:R()}},computed:{noteNames(){return Array.from(new Set(this.selectedNotes.map(e=>ie(e.getName())).flat()))},height(){return{small:96,medium:96*1.5,large:96*2}[this.size]},octaveRange(){const e=[],o=["c","c#","d","d#","e","f","f#","g","g#","a","a#","b"];for(let r=0;r<this.octaveCount;r++)e.push(...o.map(i=>{const n=`${i}${this.startOctave+r}`;return{note:n,black:this.isBlackKey(n)}}));return this.startOctave+this.octaveCount<=be&&e.push({note:o[0]+(this.startOctave+this.octaveCount),black:!1}),e},styleClasses(){return{disabled:this.disabled}},style(){return{...this.dimension.toCSSVars("dimension"),"--height":this.height,"--keys":this.octaveRange.filter(({black:e})=>!e).length,"--white-keys":this.octaveRange.filter(({black:e})=>!e).length,"--black-keys":this.octaveRange.filter(({black:e})=>e).length}}},mounted(){this.dimension=R(this.$el.offsetWidth,0)},methods:{isBlackKey(e){return/^[a-z]#\d+/.test(e)},onPointerDown(e){this.disabled||(this.pressedKeys.push(e),this.$emit("down",e))},onPointerUp(e){!this.disabled&&this.pressedKeys.includes(e)&&(this.$emit("up",e),this.pressedKeys=this.pressedKeys.filter(o=>o!==e))}}},fe=["disabled"],_e={class:"keys white"},ke=["onMouseout","onPointerdown","onPointerup"],ve={key:0},Ne={key:0},Te={class:"keys black"},ge=["onMouseout","onPointerdown","onPointerup"],Re={key:0},we={key:0};function Ee(e,o,r,i,n,t){return u(),d("div",{style:v(t.style),class:k([t.styleClasses,"wb-disks-synthesizer-keyboard"]),disabled:r.disabled},[h("div",null,[h("div",_e,[(u(!0),d(M,null,P(t.octaveRange,({note:a,black:s},c)=>(u(),d("div",{key:c,class:k(["key",{black:s,white:!s,selected:t.noteNames.includes(a.toLowerCase())}]),style:v({"--index":c}),onMouseout:p=>t.onPointerUp(a),onPointerdown:p=>t.onPointerDown(a),onPointerup:p=>t.onPointerUp(a)},[s?b("",!0):(u(),d("span",ve,[r.showNoteLabels?(u(),d("i",Ne,O(a),1)):b("",!0)]))],46,ke))),128))]),h("div",Te,[(u(!0),d(M,null,P(t.octaveRange,({note:a,black:s},c)=>(u(),d("div",{key:c,class:k(["key",{black:s,white:!s,selected:t.noteNames.includes(a.toLowerCase())}]),style:v({"--index":c}),onMouseout:p=>t.onPointerUp(a),onPointerdown:p=>t.onPointerDown(a),onPointerup:p=>t.onPointerUp(a)},[s?(u(),d("span",Re,[r.showNoteLabels?(u(),d("i",we,O(a),1)):b("",!0)])):b("",!0)],46,ge))),128))])])],14,fe)}const Ae=w(Ce,[["render",Ee],["__scopeId","data-v-a1c1d00f"]]),Se={components:{TimelineCanvas:ce,Navigation:ee,Metronom:X,Keyboard:Ae,WbEnvMoleculeFooter:ye},props:{model:{type:Object,default:re()},trackModel:{type:Object,default:se()},toneDestination:{type:Object,default:null}},emits:["refresh"],async setup(e){const o=L(e,"model"),r=L(e,"trackModel"),i=G();j(o,()=>{i.setContextMenu(le,{model:o.value,trackModel:r.value,preserveContextMenu:i.preserveContextMenu})},{immediate:!0,deep:!0});const n=T(r.value[l.SYNTHESIZER_TRACK]);console.log("track",n);const t=T(new J(n)),a=T(new ae(n));console.log("trackPlayer",a);const s=await te(),c=new Q;await c.start();const p=c.hasInputs;return{...i,...s,metronom:t,track:n,trackPlayer:a,midiController:c,hasMidi:p}},data(){return{windowsModule:W(this.core.modules.windows),duration:0,subscriptions:new S,midiControllerListener:null,openNotes:new Map,footerModel:{}}},computed:{styleClasses(){return{[`keyboard-align-${this.trackModel[l.SYNTHESIZER_TRACK_KEYBOARD_ALIGN]}`]:!0}},showKeyboard(){return this.trackModel[l.SYNTHESIZER_TRACK_SHOW_KEYBOARD]},inputNote(){return this.trackModel[l.SYNTHESIZER_TRACK_INPUT_NOTE]},bpm(){return Number(this.model[l.SYNTHESIZER_BPM])},trackPlayerIndex(){return Object.values(this.trackPlayer.sequenceNoteIndex).flat()},selectedNotes(){return this.track.notes.filter(e=>Object.values(this.trackPlayer.sequenceNoteIndex).flat().includes(e.index))},timelineCanvasData(){return{track:this.track,duration:this.metronom.getDuration()}},keybordData(){return{size:this.trackModel[l.SYNTHESIZER_TRACK_KEYBOARD_SIZE],showNoteLabels:this.trackModel[l.SYNTHESIZER_TRACK_SHOW_NOTE_LABELS],startOctave:this.trackModel[l.SYNTHESIZER_TRACK_START_OCTAVE],octaveCount:this.trackModel[l.SYNTHESIZER_TRACK_OCTAVE_COUNT],selectedNotes:this.selectedNotes}},metronomNavigation(){return{modelValue:this.metronom,"onUpdate:model-value":({name:e,value:o})=>{debugger;this.metronom[String(e)]=o},items:[[{icon:"skipPrev",label:"Prev Beat",hideLabel:!0,disabled:this.metronom.value===0,action:()=>{this.metronom.reset()}},{icon:"doublePrev",label:"Prev Beat",hideLabel:!0,disabled:Math.floor(this.metronom.currentBeat/2)===0,action:()=>{this.metronom.prevBeat()}},{icon:"prev",label:"Prev",hideLabel:!0,disabled:this.metronom.value===0,action:()=>{this.metronom.prev()}},{icon:"reset",iconAlign:"right",label:"Next",disabled:this.metronom.value/2-Math.floor(this.metronom.currentBeat)===0,hideLabel:!0,action:()=>{this.metronom.setBeat(this.metronom.currentBeat)}},{icon:"next",iconAlign:"right",label:"Next",hideLabel:!0,action:()=>{this.metronom.next()}},{icon:"doubleNext",label:"Next Beat",hideLabel:!0,action:()=>{this.metronom.nextBeat()}},{spacer:!0},{text:`Duration: ${this.metronom.value.toFixed(2)}`},{text:`Beat: ${this.metronom.currentBeat}-${this.metronom.currentBeat+this.metronom.beatCount}`}],[...g().map(([e])=>({label:`1/${e.replace(/(\d+)[nm]/,"$1")} n`,name:"time",value:e})),{spacer:!0}]]}},navigation(){return{model:this.trackModel,items:[[{text:"Input:"},{label:"Note",value:"note",name:l.SYNTHESIZER_TRACK_INPUT},{label:"Pause",value:"pause",name:l.SYNTHESIZER_TRACK_INPUT,disabled:!0},{spacer:!0},{label:"Remove Note",action:()=>{this.track.removeNote(this.track.selectedIndex)}},{label:"Clean Range",action:()=>{this.track.removeNotesByDurationRange(this.metronom.getDuration(),this.metronom.timeDuration)}},{label:"Clean Beat",action:()=>{this.track.removeNotesFromBeat(this.track.getBeatIndex())}},{label:"Reset",action:()=>{this.reset()}}],[{text:"Note:&nbsp;"},{label:"Auto",value:"",name:l.SYNTHESIZER_TRACK_INPUT_NOTE},...g().map(([e])=>({label:`1/${e.replace(/(\d+)[nm]/,"$1")} n`,name:l.SYNTHESIZER_TRACK_INPUT_NOTE,value:e})),{spacer:!0},this.trackPlayer.playing?{selected:!0,label:"Pause",icon:"pause",disabled:!this.trackPlayer.currentSequence||!this.trackPlayer.playing,onClick:()=>this.onClickPlause()}:{label:"Play",icon:"play",disabled:this.trackPlayer.playing||this.track.notes.length===0,onClick:()=>this.onClickPlay()},{label:"Stop",icon:"stop",disabled:!this.trackPlayer.currentSequence,onClick:()=>this.onClickStop()},{label:"Restart",disabled:this.track.selectedIndex>-1,onClick:()=>this.onClickRestart()}]]}},footer(){const e=this.track,o=this.trackModel,r=e.getDuration().toFixed(2);return{items:q([{options:{disabled:!this.hasMidi},title:`MIDI (${this.midiController.input?this.midiController.input.name:"OFF"})`,action:async()=>{this.midiControllerListener||await this.registerMidiListener()},items:this.midiController.ready&&this.midiControllerListener?[{title:"Inputs",items:this.midiController.inputs.map((i,n)=>({title:i.name,model:this.midiController,name:"activeInput",type:m.RADIO,value:i.id,action:async()=>{await this.registerMidiListener(this.midiController.listen(n))}}))},{title:"Input Channel",items:Array(16).fill(null).map((i,n)=>({title:String(n+1),value:n+1,type:m.RADIO,model:this.midiController,name:"inputChannel",action:async()=>{await this.registerMidiListener(this.midiController.listen(this.midiController.input))}}))},{title:"Outputs",items:this.midiController.outputs.map(i=>({title:i.name,model:this.midiController,name:"activeOutput",type:m.RADIO,value:i.id,action(){}}))},{type:m.SEPARATOR},{title:"Disconnect",action:()=>{var i;(i=this.midiControllerListener)==null||i.unsubscribe(),this.midiControllerListener=null,this.midiController.unlisten()}}]:[]},{type:m.SEPARATOR},{type:m.DEFAULT,title:`Instr.: ${this.track.type}`,items:Object.entries(ne()).map(([i,n])=>({type:m.RADIO,title:n,model:e,name:"type",value:i}))},{type:m.SEPARATOR},{title:`Octave: ${o[l.SYNTHESIZER_TRACK_START_OCTAVE]}-${o[l.SYNTHESIZER_TRACK_START_OCTAVE]+o[l.SYNTHESIZER_TRACK_OCTAVE_COUNT]-1}`,items:[{type:m.DEFAULT,title:"Start Octave",items:Array(9).fill({}).map((i,n)=>({type:m.RADIO,title:String(n+1),model:o,name:l.SYNTHESIZER_TRACK_START_OCTAVE,value:n+1,action(t){t=Number(t),t+o[l.SYNTHESIZER_TRACK_OCTAVE_COUNT]>9&&(o[l.SYNTHESIZER_TRACK_OCTAVE_COUNT]=10-t)}}))},{type:m.DEFAULT,title:"Octave Count",items:Array(10-o[l.SYNTHESIZER_TRACK_START_OCTAVE]).fill({}).map((i,n)=>({type:m.RADIO,title:String(n+1),model:o,name:l.SYNTHESIZER_TRACK_OCTAVE_COUNT,value:n+1}))}]},{type:m.SPACER},{type:m.TEXT,text:`BPM: ${this.bpm}`},{type:m.TEXT,text:`Dur.: ${r}`}])}}},watch:{"track.beatCount"(e){this.metronom.beatCount=e}},mounted(){console.log("TRACK",this.track),this.subscriptions.add(A.keyDown.pipe(U(()=>B(100)),_(e=>e.key==="Enter")).subscribe(()=>{this.onClickActivateMidi()})),this.subscriptions.add(A.keyDown.pipe(U(()=>B(100))).subscribe(e=>{switch(e.code){case"ArrowLeft":this.metronom.prev();break;case"ArrowRight":this.metronom.next();break;case"ArrowUp":this.metronom.prevBeat();break;case"ArrowDown":this.metronom.nextBeat();break;default:if(/Digit(\d+)/.test(e.code)){const o=e.code.replace(/Digit(\d+)/,"$1"),r=g()[o-1];r&&(this.metronom.time=r[0])}break}console.log(e)})),this.$nextTick(()=>{this.$emit("refresh")})},unmounted(){this.subscriptions.unsubscribe(),this.midiController.destroy()},methods:{async registerMidiListener(e){var o;try{await this.midiController.start();const r=this.midiController.listen(e>-1&&this.midiController.inputs[e]||this.midiController.inputs[0]);(o=this.midiControllerListener)==null||o.unsubscribe(),this.midiControllerListener=new S,this.midiControllerListener.add(r.pipe(_(({type:i})=>i==="noteOn")).subscribe(this.onNoteOn.bind(this)),r.pipe(_(({type:i})=>i==="noteOff")).subscribe(this.onNoteOff.bind(this)),r.pipe(_(({type:i})=>i==="volume")).subscribe(({value:i})=>{console.log("Volume: ",i),this.core.config.set(E.SCREEN_CONFIG,{...this.core.config.get(E.SCREEN_CONFIG),soundVolume:i})}))}catch(r){console.warn(r)}},async setup(){this.tone.ready||(await this.tone.start(),this.trackPlayer.createInstrument())},onReady({render:e}){this._render=e},onRender(e,{position:o,dimension:r}){if(this.inputNote==="auto"){const i=Array.from(this.openNotes.values());for(let n=0;n<i.length;n++){const t=i[Number(n)],s=(this.metronom.now()-t)/1e3/(this.metronom.speed*2)*r.x/this.track.beatCount;e.fillRect(o.x,o.y,s,r.y)}}},async onNoteOn({value:e}){await this.setup();const o=e.identifier;console.log("value.identifier",o,this.metronom.getDuration()),this.startNote(o),this.trackPlayer.triggerAttack(o)},async onNoteOff({value:e}){this.endNote(e.identifier),await this.tone.ready,this.trackPlayer.triggerRelease()},startNote(e){this.animationLoop||(this.animationLoop=Me(()=>{this._render&&this._render()})),this.openNotes.set(e,this.metronom.now())},endNote(e){var a;const o=[1,2,4,8,16,32].map(s=>[`${s}n`,`${s}t`,`${s}n.`]).flat().map(s=>[s,new(this.tone.getTone()).Time(s).toSeconds()]).sort((s,c)=>c[1]-s[1]),r=Math.max((this.metronom.now()-this.openNotes.get(e))/1e3,o[o.length-1][1]);this.openNotes.delete(e);const{Time:i}=this.tone.getTone();let n;this.inputNote?n=new i(this.inputNote):n=new i(o.map(([,s])=>s).find(s=>{const c=s*.2;return s-c<=r&&r<=s+c}));const t=this.metronom.getDuration();console.log({delay:t,name:e,time:n.toNotation()}),this.track.addNote(new oe({delay:t,name:e,time:n.toNotation()})),this.openNotes.size<1&&((a=this.animationLoop)==null||a.stop(),this.animationLoop=null)},async onClickNote({note:e,selected:o}){await this.setup(),o&&e.getName()&&this.trackPlayer.triggerAttackRelease(e)},async onClickPlay(){await this.setup(),this.trackPlayer.play()},onClickPlause(){this.trackPlayer.pause()},onClickStop(){this.trackPlayer.stop()},onClickRestart(){this.trackPlayer.restart()},async onDownKeyboard(e){await this.setup(),this.startNote(e),this.trackPlayer.triggerAttack(e)},async onUpKeyboard(e){await this.tone.awaitReady,this.endNote(e),this.trackPlayer.triggerRelease()},reset(){this.track.reset()},onClickActivateMidi(){this.registerMidiListener()}}};function Me(e){let o=0,r=0,i=!1;const n=t=>{const a=t-o;o=t,r+=a,e(t,r),i||requestAnimationFrame(n)};return requestAnimationFrame(n),{stop:()=>i=!0}}const Pe={key:0,class:"keyboard"},Oe={class:"sheet"},Ie={class:"panel"};function xe(e,o,r,i,n,t){const a=f("keyboard"),s=f("navigation"),c=f("timeline-canvas"),p=f("metronom"),Y=f("wb-env-molecule-footer");return u(),d("div",{class:k(["wb-disks-extras13-synthesizer-track",t.styleClasses])},[h("div",null,[h("div",null,[t.showKeyboard?(u(),d("div",Pe,[y(a,N({disabled:i.trackPlayer.playing},t.keybordData,{onDown:t.onDownKeyboard,onUp:t.onUpKeyboard}),null,16,["disabled","onDown","onUp"]),i.hasMidi&&!n.midiControllerListener?(u(),d("div",{key:0,class:"midi-message",onClick:o[0]||(o[0]=(...C)=>t.onClickActivateMidi&&t.onClickActivateMidi(...C))},o[2]||(o[2]=[h("div",null,[h("div",null,[h("span",null,[I("Click here, or press "),h("strong",null,"Enter"),I(" to activate the Midi Keyboard!")])])],-1)]))):b("",!0)])):b("",!0)]),y(s,x(D(t.navigation)),null,16),h("div",Oe,[y(p,{model:i.metronom,onRender:t.onRender,onReady:t.onReady,onValue:o[1]||(o[1]=C=>i.track.setCurrentDuration(C))},{background:z(({onRefresh:C})=>[y(c,N(t.timelineCanvasData,{clickable:"",onRefresh:C,"onNote:click":t.onClickNote}),null,16,["onRefresh","onNote:click"])]),_:1},8,["model","onRender","onReady"])]),h("div",Ie,[y(s,x(D(t.metronomNavigation)),null,16)])]),y(Y,N(t.footer,{"parent-layout":n.windowsModule.contentWrapper.layout}),null,16,["parent-layout"])],2)}const wt=w(Se,[["render",xe],["__scopeId","data-v-d8c2268e"]]);export{wt as default};
