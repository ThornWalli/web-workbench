import{u as A,N as y}from"./DHpNT36l.js";import{a as D,M as S}from"./B3Vtoes6.js";import{c as _,T as j}from"./cM1evs2P.js";import{d as q}from"./B3mcEltb.js";import z from"./DcMfwrs4.js";import{N as F}from"./0q2hPU4O.js";import{T as U}from"./YWL9jSA6.js";import{f as T}from"./CSlkdJUE.js";import{S as V}from"./6C4StZv5.js";import{d as I,r as m,k as Q,o as W,Y,v as M,x as w,A as v,B as x,Q as C,ab as $,D as G,_ as H,g as J}from"./CFj-hhFp.js";import{u as K}from"./DOQHPoIb.js";import"./BGIFtisS.js";import"./CozWepQ0.js";import"./udq3idvc.js";import"./Lxd48n3n.js";import"./BhtCLcUc.js";import"./CaAbksje.js";import"./9V19AFUE.js";import"./DXnSAPcy.js";import"./DN3eHOnZ.js";import"./D4lI5vpz.js";import"./Ce6njBYG.js";import"./DdQrQ7-5.js";import"./nufkX4jA.js";import"./RAasLaaH.js";import"./BVsX1iIx.js";import"./BG0OyHeb.js";import"./CNkvSXuu.js";import"./CzBXAPyu.js";const X=I({__name:"Editor",props:{track:{}},setup(c){const{tone:N}=A(),b=c,g=m({input:"note",inputType:""}),r=m(new D),p=m(new V),d=m(new z),f=m(new Map),k=m(),h=Q(()=>({model:g.value,items:[[],[{text:"Input:"},{label:"Note",value:"note",name:"input"},{label:"Pause",value:"pause",name:"input",disabled:!0}],[{text:"Note:&nbsp;"},{label:"Auto",value:"",name:"inputType"},..._().map(([e])=>({label:`1/${e.replace(/(\d+)[nm]/,"$1")} n`,name:"inputType",value:e}))]]}));W(()=>{d.value.start();const e=d.value.listen();p.value.add(q.keyDown.subscribe(t=>{switch(t.code){case"ArrowLeft":r.value.prev();break;case"ArrowRight":r.value.next();break;case"ArrowUp":r.value.prevBeat();break;case"ArrowDown":r.value.nextBeat();break;default:if(/Digit(\d+)/.test(t.code)){const o=Number(t.code.replace(/Digit(\d+)/,"$1")),a=_()[o-1];a&&(r.value.time=a[0])}break}})),p.value.add(e.pipe(T(({type:t})=>t==="noteOn")).subscribe(O)),p.value.add(e.pipe(T(({type:t})=>t==="noteOff")).subscribe(E))}),Y(()=>{p.value.unsubscribe(),d.value.destroy()});function B({render:e}){k.value=e}function R(e,{position:t,dimension:o}){const a=Array.from(f.value.values());for(let i=0;i<a.length;i++){const s=a[Number(i)],l=(r.value.now()-s)/1e3/(r.value.speed*2)*o.x;e.fillRect(t.x,t.y,l,o.y)}}let u;function O({value:e}){e&&typeof e=="object"&&(u||(u=P(()=>{k.value&&k.value()})),f.value.set(e.identifier,r.value.now()))}function E({value:e}){if(e&&typeof e=="object"){const t=N.getTone(),o=[1,2,4,8,16,32].map(n=>[`${n}n`,`${n}t`,`${n}n.`]).flat().map(n=>[n,t.Time(n).toSeconds()]).sort((n,l)=>Number(l[1])-Number(n[1])),a=Math.max((r.value.now()-f.value.get(e.identifier))/1e3,Number(o[o.length-1][1]));f.value.delete(e.identifier);const i=t.Time(o.map(([,n])=>Number(n)).find(n=>{const l=n*.2;return n-l<=a&&a<=n+l})),s=r.value.getDuration();console.log({delay:s,name:e.identifier,time:i.toNotation()}),b.track.addNote(new F({delay:s,name:e.identifier,time:i.toNotation()})),console.log("notes",b.track.notes),f.value.size<1&&(u==null||u.stop(),u=void 0)}else console.warn("onNoteOff",e)}function L({note:e,selected:t}){console.log("onClickNote",{note:e,selected:t})}function P(e){let t=0,o=0,a=!1;const i=s=>{const n=s-t;t=s,o+=n,e(s,o),a||requestAnimationFrame(i)};return requestAnimationFrame(i),{stop:()=>a=!0}}return(e,t)=>(w(),M("div",null,[v(S,{model:r.value,onRender:R,onReady:B,onValue:t[0]||(t[0]=o=>e.track.setCurrentDuration(o))},{background:x(({onRefresh:o})=>[(w(),G(U,{key:r.value.value,track:e.track,duration:r.value.getDuration(),clickable:"",onRefresh:o,"onNote:click":L},null,8,["track","duration","onRefresh"]))]),navigation:x(({navigation:o})=>[v(y,C($(o)),null,16),v(y,C($(h.value)),null,16)]),_:1},8,["model"])]))}}),Z={components:{Editor:X},async setup(){return{...K(),...await A()}},data(){const c=new D;return{track:new j({beatCount:1,speed:c.speed,notes:[{name:"C4",time:"2n",delay:4}]})}}};function ee(c,N,b,g,r,p){const d=J("editor");return w(),M("div",null,[v(d,{track:r.track},null,8,["track"])])}const he=H(Z,[["render",ee]]);export{he as default};
