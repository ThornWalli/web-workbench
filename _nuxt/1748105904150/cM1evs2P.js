var S=Object.defineProperty;var A=(s,e,t)=>e in s?S(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var d=(s,e,t)=>A(s,typeof e!="symbol"?e+"":e,t);import{N as m,T as G}from"./0q2hPU4O.js";import{G as x,I as O}from"./CozWepQ0.js";import{v as T}from"./Lxd48n3n.js";var g={},y;function F(){if(y)return g;y=1,Object.defineProperty(g,"__esModule",{value:!0}),g.isRangeOverlap=void 0;function s(e,t,r,n,i){var c,o,b,h,a=!1;return Array.isArray(e)&&Array.isArray(t)?(c=e[0],o=e[1],b=t[0],h=t[1],a=r===!0):r===void 0?(e=e,t=t,c=e.start,o=e.end,b=t.start,h=t.end,a=r===!0):(c=e,o=t,b=r||e,h=n||t,a=i===!0),a?c<h&&b<o:c<=h&&b<=o}return g.isRangeOverlap=s,g}var C=F();class D extends m{constructor(t={}){super(t);d(this,"octavePosition");d(this,"origin");const{selected:r,octavePosition:n,origin:i}=t||{};this.selected=r!==void 0?r:!1,this.octavePosition=n!==void 0?n:0,this.origin=i}resolvedIndex(){return this.origin!==void 0?this.origin.index:this.index}toJSON(){return{...super.toJSON(),selected:this.selected,octavePosition:this.octavePosition,index:this.index}}}function Q(){return Object.fromEntries([2,4,8,12,16].map(s=>[String(s),s]))}function Y(s){return Math.max(Math.min((-1+s/.5)*30,30),-30)}const K=9;function P(s,e){let t=e.name;if(t){const r=t.match(/(.+)(\d+)/)||[];t=r[1];const n=Number(r[2]);let i=t;t.length&&(i=t[0]);const c=n-s,o={c:3,d:2.5,e:2,f:1.5,g:1,a:.5,b:0}[i.toLowerCase()];if(o===void 0)throw new Error(`Unknown note name: ${i}`);return o*-1+c+2.5*c}else return-2.5/2}const B={cbbb:-3,cbb:-2,cb:-1,c:0,"c#":1,cx:2,"c##":2,"c###":3,"cx#":3,"c#x":3,dbbb:-1,dbb:0,db:1,d:2,"d#":3,dx:4,"d##":4,"d###":5,"dx#":5,"d#x":5,ebbb:1,ebb:2,eb:3,e:4,"e#":5,ex:6,"e##":6,"e###":7,"ex#":7,"e#x":7,fbbb:2,fbb:3,fb:4,f:5,"f#":6,fx:7,"f##":7,"f###":8,"fx#":8,"f#x":8,gbbb:4,gbb:5,gb:6,g:7,"g#":8,gx:9,"g##":9,"g###":10,"gx#":10,"g#x":10,abbb:6,abb:7,ab:8,a:9,"a#":10,ax:11,"a##":11,"a###":12,"ax#":12,"a#x":12,bbbb:8,bbb:9,bb:10,b:11,"b#":12,bx:13,"b##":13,"b###":14,"bx#":14,"b#x":14};Object.values(B).reduce((s,e)=>s=Math.min(s,e),1/0);Object.values(B).reduce((s,e)=>s=Math.max(s,e),-1/0);function E(s){const{min:e,max:t}=s.filter(r=>r.octave).reduce((r,n)=>(n.octave!==void 0&&(r.min=Math.min(n.octave,r.min),r.max=Math.max(n.octave,r.max)),r),{min:1/0,max:-1/0});return{max:t,min:e,length:Math.max(Math.ceil(t-e),1)}}function w(s){return s.reduce((e,t)=>(e+=t.toSeconds(),e),0)}const M={"A#":["A","C#","E"],"B#":["B","D#","F#"],"C#":["C","E","G"],"D#":["D","F#","A"],"E#":["E","G#","B"],"F#":["F","A","C"],"G#":["G","B","D"],"Ab#":["Ab","C","Eb"],"Bb#":["Bb","D","F"],"Cb#":["Cb","Eb","Gb"],"Db#":["Db","F","Ab"],"Eb#":["Eb","G","Bb"],"A#2":["A","C#","E","B"],"B#2":["B","D#","F#","C#"],"C#2":["C","E","G","D"],"D#2":["D","F#","A","E"],"F#2":["F","A","C","D"],"G#2":["G","B","D","A"],"Ab#2":["Ab","C","Eb","Bb"],"Bb#2":["Bb","D","F","C"],"Cb#2":["Cb","Eb","Gb","Db"],"Db#2":["Db","F","Ab","Eb"],"Eb#2":["Eb","G","Bb","F"]};function R(s){var e;if(/^([A-Za-z]+[#xb]{,2})(\d)+$/.test(s)){const[,t,r]=s.match(/^([A-Za-z]+[#xb]{,2})(\d)+$/)||[];return Array.from(new Set(((e=M[t])==null?void 0:e.map(R).flat())||[s])).map(n=>`${n}${r||""}`)}return[s]}function W({triplet:s=!1,dotted:e=!1,natural:t=!0}={}){return[1,2,4,8,16,32].map(r=>[t?`${r}n`:void 0,s?`${r}t`:void 0,e?`${r}n.`:void 0].filter(Boolean)).flat().map(r=>(r=r,[r,G(r).toSeconds()]))}class ${constructor({noteGroups:e,index:t}){d(this,"noteGroups");d(this,"index");this.noteGroups=e,this.index=t}get empty(){return!Object.values(this.noteGroups).length}get selected(){return Object.values(this.noteGroups).some(e=>e.some(t=>t.notes.some(r=>r.selected)))}}class j{constructor({align:e,notes:t}){d(this,"notes");d(this,"align");this.notes=t,this.align=e}get startSeconds(){return this.notes[0].delay}get endSeconds(){const e=this.notes[this.notes.length-1];return e.delay+e.toSeconds()}get selected(){return this.notes.some(({selected:e})=>e)}getNote(e){return this.notes[Number(e)]}}function X(s){const{min:e}=E(s);return Array().concat(s).sort((t,r)=>t.delay-r.delay).map((t,r)=>new D({...t,index:r,octavePosition:P(e,t)}))}function _(s){return s.reduce((e,[,t])=>Math.max(t.reduce((r,{notes:n})=>Math.max(n.reduce((i,c)=>Math.max(c.delay+c.toSeconds(),i),0),r),0),e),0)}function U(s,e=1){const t=Object.entries(s),r=e*2,n=_(t),i=Math.ceil(n/r),c=[];for(let o=0;o<i;o++){const b=[];for(let h=0;h<t.length;h++){const[a,u]=t[Number(h)],f=u.filter(({startSeconds:N,endSeconds:I})=>N>=o*r&&I<=(o+1)*r);f.length&&b.push([a,f])}c.push(new $({noteGroups:Object.fromEntries(b),index:o}))}return c}function k(s){const e=s.reduce((n,i)=>{const{time:c}=i,o=c==null?void 0:c.toString();return n[o||"pause"]||(n[o||"pause"]=[]),n[o||"pause"].push(i),n},{}),r=Object.entries(e).map(([n,i])=>[n,i.sort((c,o)=>c.octave-o.octave||c.delay-o.delay)]).map(([n,i])=>[n,z(i)]).sort((n,i)=>n.toString()[0].localeCompare(i.toString()[0]));return Object.fromEntries(r)}function z(s){const e=[];for(;s.length;){const t=s.shift();let r=[];r=s.reduce((a,u)=>(u.delay>=t.delay+t.toSeconds()&&a.push(u),a),[]),r=r.reduce((a,u)=>((!a.length||a.length&&a[a.length-1].delay<=u.delay+u.toSeconds())&&a.push(u),a),[]),r=r.reduce((a,u,f)=>{var N;return r[0].delay-t.delay<=.5&&(!((N=t.time)!=null&&N.triplet)||t.time.triplet&&f<2)&&a.push(u),a},[]),r=r.reduce((a,u)=>(u.delay-t.delay%2+u.toSeconds()<=t.delay-t.delay%2+2-t.delay%2&&a.push(u),a),[]);let n=!1,i=t;r=r.reduce((a,u)=>((!n||n===v(u.octavePosition-i.octavePosition))&&a.push(u),n=v(u.octavePosition-i.octavePosition),i=u,a),[]);const c=1;let o;r=r.reduce((a,u)=>{const f=(o||t).octavePosition-u.octavePosition;return f>-1&&f<c&&a.push(u),o=u,a},[]);let b=0;r.length&&(b=r[0].octavePosition-t.octavePosition);let h=x.ASCENDING;h=v(b),s=s.filter(a=>!r.includes(a)),r.unshift(t),e.push(new j({notes:r,align:h}))}return e}function v(s){return s<0?x.DESCENDING:s>0?x.ASCENDING:x.EQUAL}class p{constructor(e){d(this,"number");d(this,"baseCharacter");d(this,"dot");d(this,"triplet");const{number:t,character:r,dot:n}=L(e);this.number=t,this.baseCharacter=r,this.dot=n||!1,this.triplet=r==="t"}get character(){return this.triplet?"t":this.baseCharacter}toString(){return`${this.number}${this.character}${this.dot?".":""}`}static parse(e){return new p(e)}}function L(s){if(s instanceof p||typeof s=="number")return s;try{const[,e,t,r]=s.match(/^(\d+)([a-z])(\.?)$/i)||[];return{number:Number(e),character:t,dot:!!r,triplet:t==="t"}}catch(e){console.error(e);debugger;throw e}}const l=2;class q{constructor(e={}){d(this,"id");d(this,"type");d(this,"name");d(this,"notes");d(this,"baseNote");d(this,"beatCount");d(this,"noteCount");d(this,"speed",1);d(this,"selectedIndex",-1);d(this,"currentDuration",0);const{id:t,type:r,name:n,notes:i,baseNote:c,beatCount:o,noteCount:b,speed:h}=e;this.id=t||T(),this.type=r||O.SYNTH,this.name=n||"Track",this.notes=(i||[]).map(a=>new m(a)),this.refreshNotes(),this.beatCount=Number(o||1),this.baseNote=Number(c||4),this.noteCount=Number(b||4),this.speed=Number(h||1)}setSelectedIndex(e){this.selectedIndex=e}setCurrentDuration(e){this.currentDuration=e}getOctaveRange(){const{min:e,length:t}=E(this.notes);return{start:e,count:t}}reset(){this.selectedIndex=-1,this.notes=[]}addNote(e){if(e=new m(e),!this.notes.find(t=>t.getName()===e.getName()&&C.isRangeOverlap(t.delay,t.toSeconds(),e.delay,e.delay+e.toSeconds())))return this.notes.push(e),this.refreshNotes(),e}addNoteTo(e,t){return this.notes=[...this.notes.slice(0,e+1),new m(t),...this.notes.slice(e+1)],this.refreshNotes(),t}getNote(e){return this.notes[Number(e)]}replaceNote(e,t){return this.notes[Number(e)]=new m(t),this.refreshNotes(),this.notes[Number(e)]}removeNote(e){this.notes=this.notes.filter((t,r)=>e!==r),this.refreshNotes()}refreshNotes(){this.notes=[...this.notes].sort((e,t)=>e.delay-t.delay).map((e,t)=>(e.index=t,e))}removeNotesByDurationRange(e,t){this.getNotesByDurationRange(e,t).forEach(({index:r})=>this.removeNote(r))}removeNotesFromBeat(e){const t=e*l,r=l;this.removeNotesByDurationRange(t,r)}getDuration(){return w(this.notes)}getNotesByDurationRange(e,t){return this.notes.filter(r=>C.isRangeOverlap(e,e+t,r.delay,r.delay+r.toSeconds()))}getVisibleBeatsByDuration(e,t=this.notes){e=e!==void 0?e:this.currentDuration;const r=this.getBeatIndex(e);t=t.filter(i=>i.delay>=r*l&&i.delay+i.toSeconds()<r*l+this.beatCount*l);const n=this.getBeats({selectedIndex:this.selectedIndex,speed:this.speed},t);return console.log("slice",t.length),n.slice(r,r+this.beatCount)}getVisibleBeats(){var r;const e=this.getBeats({selectedIndex:this.selectedIndex,speed:this.speed});let t=((r=e.find(n=>n.selected))==null?void 0:r.index)||0;return t=Math.floor(t/this.beatCount)*this.beatCount,e.slice(t,t+this.beatCount)}getNotationFromNoteCount(){return new p(`${this.noteCount}n`)}getBeats(e={},t=this.notes){const{selectedIndex:r,speed:n}={selectedIndex:-1,speed:1,...e};r>-1&&t.find(({index:o})=>r===o)&&t.filter(({index:o})=>r===o).forEach(o=>o.selected=!0);const i=t.filter(o=>o instanceof D);if(i.length!==t.length){debugger;throw new Error("TimelineNoteDesciptions and notes not equal.")}const c=k(i);return U(c,n)}getBeatIndex(e=this.currentDuration){return(e/(l*this.beatCount)-e%(l*this.beatCount)/(l*this.beatCount))*this.beatCount}getCurrentNote(){return this.getNote(this.selectedIndex)}selectPrevNote(){this.selectedIndex=Math.max(this.selectedIndex-1,-1)}selectNextNote(){this.selectedIndex=Math.min(this.selectedIndex+1,this.notes.length-1)}}const ee=Object.freeze(Object.defineProperty({__proto__:null,default:q},Symbol.toStringTag,{value:"Module"}));export{K as B,q as T,Q as a,E as b,W as c,ee as d,Y as g,X as p,R as r};
