var Ee=Object.defineProperty;var he=i=>{throw TypeError(i)};var De=(i,e,t)=>e in i?Ee(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var c=(i,e,t)=>De(i,typeof e!="symbol"?e+"":e,t),xe=(i,e,t)=>e.has(i)||he("Cannot "+t);var k=(i,e,t)=>(xe(i,e,"read from private field"),t?t.call(i):e.get(i)),ue=(i,e,t)=>e.has(i)?he("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(i):e.set(i,t);import{I as _e,i as m,p as Ae}from"./BGIFtisS.js";import{S as B}from"./RAasLaaH.js";import{v as ee}from"./BDV1uWkE.js";import{f as fe}from"./CSlkdJUE.js";import{K as _,I as L,r as ge,a9 as Te}from"./DepUWdG1.js";import{S as y,I as d}from"./hgdfUW9W.js";class H{constructor(e){c(this,"id");c(this,"_locked",!1);c(this,"storage");c(this,"name");c(this,"_data",[]);this.id=e.id,this._locked=e.locked||this._locked,this.storage=e.storage,this.name=e.name}get locked(){return this._locked}get data(){return this._data}set data(e){this._data=e}async mount(...e){return this}async unmount(...e){return this}getItem(e){throw new Error("not implemented")}setItem(e,t){throw new Error("not implemented")}async load(){if(!this.storage)throw new Error("no storage");return this._data}async save(e){if(!this.storage)throw new Error("no storage");return this._data=e||this._data,this._data}}class C{isLogged(){throw new Error("Method not implemented.")}getItem(e){throw new Error("Method not implemented.")}setItem(e,t){throw new Error("Method not implemented.")}removeItem(e){throw new Error("Method not implemented.")}clear(){throw new Error("Method not implemented.")}}var z;class be extends C{constructor(){super(...arguments);ue(this,z,new Map)}isLogged(){return!0}getItem(t){return k(this,z).get(t)||null}setItem(t,s){k(this,z).set(t,s)}removeItem(t){k(this,z).delete(t)}clear(){k(this,z).clear()}}z=new WeakMap;class ae extends H{constructor(e){super({...e,storage:new be})}}class Le extends C{isLogged(){return!0}getItem(e){return localStorage.getItem(e)}setItem(e,t){localStorage.setItem(e,JSON.stringify(t))}removeItem(e){localStorage.removeItem(e)}clear(){localStorage.clear()}}class we extends H{async mount(){let e;if(this.storage instanceof H){const t=this.storage;try{if(e=t.getItem(this.name),e){if(e=JSON.parse(e),!e||!(e instanceof Object))throw new Error("json invalid")}else throw new Error("json invalid")}catch(s){console.error(s),e={}}this.storage.setItem(this.name,e)}return this}async load(){return this.storage&&this.storage instanceof C&&(this.data=JSON.parse(this.storage.getItem(this.name)||"[]")),this.data}async save(e){return this.storage&&this.storage instanceof C&&(this.data=e||this.data,this.storage.setItem(this.name,this.data)),this.data}}class ze extends we{constructor(e){super({...e,storage:new Le})}}class Re extends C{isLogged(){return!0}getItem(e){return sessionStorage.getItem(e)}setItem(e,t){sessionStorage.setItem(e,JSON.stringify(t))}removeItem(e){sessionStorage.removeItem(e)}clear(){sessionStorage.clear()}}class Pe extends we{constructor(e){super({...e,storage:new Re})}}class Me extends H{constructor(e){super({...e})}isLogged(){throw new Error("Not implemented")}}var x=(i=>(i[i.NONE=0]="NONE",i[i.AUTO=1]="AUTO",i[i.TEMP=3]="TEMP",i[i.LOCAL=4]="LOCAL",i[i.SESSION=5]="SESSION",i[i.CLOUD=6]="CLOUD",i))(x||{});function Oe(i){switch(i){case 3:return ae;case 4:return ze;case 5:return Pe;case 6:return Me;default:return ae}}function pt(i){return typeof i=="string"&&te(i.trim())}const ke=['"',"'"];function yt(i,e='"'){return te(i)?i:(i=i.replace(/"/g,'\\"'),`${e}${i}${e}`)}function It(i){return i.length===2&&i[0]===i[i.length-1]&&te(i)}function te(i){return i[0]===i[i.length-1]&&ke.includes(i[0])}function wt(i){if(typeof i=="string"){const e=i.trim();if(te(e))return e.slice(1,i.length-1)}return i}function vt(i){return typeof i=="boolean"||i==="true"||i==="false"}function St(i){return!isNaN(i)&&!isNaN(parseFloat(i))}function Ne(i){return decodeURIComponent(globalThis.atob(i))}function Ce(i){return globalThis.btoa(encodeURIComponent(i))}class Fe{constructor(){c(this,"items",new Map)}add(e,t){Array.isArray(e)?e.forEach(([s,r])=>{this.add(s,r)}):t&&(Array.isArray(t)||(t=[t]),this.items.set(e,t))}get(...e){var s;const t=e.shift()||"";return(s=this.items.get(t))==null?void 0:s.map(r=>e.reduce((a,n)=>a.replace(/%\d+/,n),r))}}const p=new Fe;p.add("bad_args","Bad args");p.add("cant_find","Can't find %1");const We="/",se="ROOT",Be="CLOUD";function E(i){return typeof i=="object"&&"id"in i?i.id:i.replace(/.*[\\/:]{1,1}([^:\\/]+)$/,"$1")}function $e(i){return/^[a-zA-Z0-9_-]+:/.test(i)}function Ke(...i){return i.reduce((e,t)=>(e.push(...t.replace(/[\\/]+/,"/").replace(/^\//,"").replace(/\/$/,"").split("/")),e),[]).join("/").replace(/:\//,":").replace(/\/$/,"")}function Ye(i){return i.replace(/(.*)[:/]([^\\/:]+)/,"$1")}function Ue(i){return i.replace(/^(.*)[\\/:]([^\\/:]+)$/,"$2")}function N(i){return i.replace(/(.*[\\/:]{1,1})[^:\\/]+$/,"$1")}function Y(i){return i.length&&/^[\w .\\/:-]+$/.test(i)}function je(i){return Y(i)&&!!(i.includes("/")||i.match(/^([^:]+):.*/))}function He(i){return i*1e3}function le(i){return i.replace(/^(.*)\.[^.]+$/,"$1")}function me(i){const e=i.match(/^.*\.([^.]*)$/);return e?e[1]:""}function Ge(i){return i.replace(/[^.a-zA-Z0-9_-]/g,"_")}function ne(i,e){return e?`${le(i)}.${e}`:i}function ve(i,e,t){let s=i;return e.hasItem(ne(s,t))?(s=`copy_${i}`,e.hasItem(ne(s,t))?ve(s,e,t):s):s}async function Ve(i){var e;if(i.locked)throw new Error((e=p.get("FileSystemItem_itemLocked",await i.getPath()))==null?void 0:e.join(" "));return i}function A(i){var t;const e=O(i);if(e){if(e!=null&&e.locked)throw new Error((t=p.get("FileSystem_permissionsNeeded"))==null?void 0:t.join(" "));return i}return i}async function D(i,e){return e=e||O(i),e&&(await i.save(),await e.save()),i}async function Xe(i,e){const t=await e.remove({recursive:i});return Array.isArray(t)?t:[t]}function O(i){if(i.storage)return i;if(i.parent)return O(i.parent)}class u{constructor({name:e,value:t,scope:s}){c(this,"name");c(this,"value");c(this,"scope");this.name=e,this.value=t,this.scope=s}}const Ze={basic:y.BASIC,bas:y.BASIC,markdown:y.DISK_MARKDOWN,md:y.DISK_MARKDOWN,image:y.IMAGE,img:y.IMAGE};function Je(i,e=y.NOTE_BLANK){const t=Ze,s=me(i).toLowerCase();return t[s]||e}class qe extends u{}class v{constructor(e,{type:t,symbol:s=y.NOTE_BLANK}={type:"Unknown",symbol:y.NOTE_BLANK}){c(this,"type");c(this,"events");c(this,"_locked",!1);c(this,"parent");c(this,"createdDate");c(this,"editedDate");c(this,"id");c(this,"_name","");c(this,"meta");c(this,"_data");c(this,"_action");const{locked:r=!1,id:a,name:n=void 0,meta:o=void 0,data:l=void 0,action:h,createdDate:w=Date.now(),editedDate:I=void 0}=e;this.events=_(new B),this.createdDate=w||Date.now(),this.editedDate=I||w,this._locked=r||!1,this.id=a,this._name=n||"",this.type=t||"Unknown",this.meta=new Map([[d.SYMBOL,Je(a||"",s||y.NOTE_BLANK)],[d.VISIBLE,!0],...o||[]]);let S=l;if(typeof l=="string")try{S=JSON.parse(l)}catch($){throw console.log(S),$}this._action=h,this._data=Qe(S||{})}async remove(e={}){var a,n;const{silent:t}=Object.assign({silent:!1},e);let s;const r=this.isLocked();if(!r)s={type:this.type,id:this.id,name:this.name,path:await this.getPath(),size:this.size,storage:O(this)};else if(!t)throw new Error((a=p.get("FileSystemItem_itemLocked",await this.getPath()))==null?void 0:a.join(" "));return(t||!r)&&(this.events.next(new u({name:"remove",value:{item:this}})),this.events.unsubscribe(),(n=this.parent)==null||n.removeItem(this)),s?[s]:[]}isLocked(e=!1){return e?!1:this.parent&&this.parent.locked&&this.parent.id!==se?!0:this._locked}async copy(){const e=this.constructor,t=await this.export({encodeData:!1}),s=new e(t);return Promise.resolve(s)}rename(e,t={}){const{name:s=!1,ignore:r=!1}=Object.assign({name:!1,ignore:!1},t);if(!this.isLocked(r)){if(s)return this.name=e,this;{const a=this.id;this.id=Ge(e||""),this.parent&&a!==this.id&&this.parent.changeItemId(this,a,this.id)}this.events.next(new qe({name:"rename",value:{item:this}}))}return this}save(){this.events.next(new u({name:"save",value:{item:this}}))}getUsedMemory(){return this.size/this.maxSize}async export(e={}){const{encodeData:t}=Object.assign({encodeData:!0},e),s=new Map(this.meta);Array.from(s.keys()).forEach(a=>{s.get(a)instanceof _e&&s.set(a,s.get(a).toJSON())});let r;return t&&typeof this._data=="string"?r=await Ce(this._data):r=this._data,{type:this.type,id:this.id,name:this._name,createdDate:this.createdDate,editedDate:this.editedDate,data:r,meta:Array.from(s)}}get data(){let e=this._data;if(typeof this._data=="string")try{e=JSON.parse(this._data)}catch(t){console.error(t),e={type:"markdown",content:"Cannot parse data",data:this._data}}return e}set data(e){typeof e=="object"&&(e=JSON.stringify(e)),this._data=e}get action(){return this._action}setId(e){this.id=e}setParent(e){this.parent=e}get locked(){var e;return((e=this.parent)==null?void 0:e.locked)||this._locked}get name(){return this._name||this.id}set name(e){this._name=e||""}get extension(){return me(this.id)}get size(){const e=Object.values(this.data||{});return new Blob(e).size}get maxSize(){return new Blob(Object.values(this.data||{})).size}getRealMaxSize(){return new Blob(Object.values(this.data||{})).size}getBase(){return v.getBaseRecursive({item:this},!1)}getPath(){return v.getBaseRecursive({item:this})}static getBaseRecursive({item:e,path:t=[]},s=!0){if(s&&t.push(e.id),e.parent)return v.getBaseRecursive({item:e.parent,path:t});if(t=t.reverse(),t[0]===se&&t.shift(),t.length>0){let r=t[0];return/\./.test(r)||(r+=":"),`${r}${t.slice(1,t.length).join(We)}`}else return se}}p.add([["FileSystemItem_itemLocked",["Item Locked","Item is locked, can't be edit… %1"]]]);function Qe(i){return typeof i=="object"&&(i=JSON.stringify(i)),i}class g extends v{constructor(t,s){t={...t};super(t,s);c(this,"items",new Map);c(this,"_maxSize",He(1));this.addItems(t.items||this.items),this._maxSize=t.maxSize||this._maxSize}async export(t={}){const s={...await super.export(t),items:[]};return Reflect.deleteProperty(s,"data"),s.items=await Promise.all(Array.from(this.items.values()).map(r=>r.export())),s}async addItems(t,s=!1){let r=[];t instanceof Map?r=Array.from(t.values()):Array.isArray(t)&&(r=t),r=r.map(n=>(typeof n.data=="string"&&(n.data=Ne(n.data)),n));const a=this.parseItems(r);return Promise.all(a.map(n=>this.addItem(n,s)))}static normalizeItemData(t){const s={...t},r=[];if("items"in t&&!(t.items instanceof Map)&&(s.items=new Map(t.items.map(a=>[a.id,a]))),"info"in t&&t.info)debugger;return"extension"in s&&(s.id+="."+s.extension,delete s.extension,r.push("extension")),"createTime"in s&&(s.createdDate=s.createTime,delete s.createTime,r.push("createTime")),"editTime"in s&&(s.editedDate=s.editTime,delete s.editTime,r.push("editTime")),"icon"in s&&(delete s.icon,r.push("icon")),r.length&&console.warn("@deprecated TODO: muss weg, hier werden die alten Items angepasst.",s,r),s}parseItems(t){return t.map(s=>{const r=g.normalizeItemData(s);let a;return r.type?a=ie(r.type):"items"in r?a=ie("Directory"):a=ie(),new a(r)})}async addItem(t,s=!1){const r=t.parent;if(!s&&this.hasItem(t.id))throw new Error(`File ${t.id} exists`);if(r&&await r.removeItem(t),s){const a=me(t.id),n=le(t.id);t.setId(ne(ve(n,this,a),a))}return this.items.set(t.id,t),t.setParent(this),t.events.next(new u({name:"move",value:{item:t,lastParent:r}})),this.events.next(new u({name:"addItem",value:{item:t}})),t}removeItem(t){return t.setParent(void 0),this.items.delete(t.id),this.events.next(new u({name:"removeItem",value:{item:t}})),Promise.resolve()}async remove(t={}){var a;const{recursive:s}={recursive:!1,...t},r=[];if(s){const n=await this.getItems();for(const o of n.values())r.push(...await o.remove(t));return r.push(...await super.remove(t)),r}else{if((await this.getItems()).size>0)throw new Error((a=p.get("FileSystemItem_itemContainerNotEmpty",await this.getPath()))==null?void 0:a.join(" "));return await super.remove(t)}}changeItemId(t,s,r){this.items.delete(s),this.items.set(r,t),this.parent&&console.log("changeItemId by parent",s,r,this.parent.items)}getItems(){return Promise.resolve(this.items)}getItem(t){return this.items.get(t)}hasItem(t){return this.items.has(t)}get size(){return Array.from(this.items.values()).reduce(function(t,s){return s instanceof g||(t+=s.size),t},0)}get maxSize(){return t(this);function t(s){return s.parent&&s.getRealMaxSize()?t(s.parent):s.getRealMaxSize()}}}p.add([["FileSystemItem_itemContainerNotEmpty",["ItemWrapp Not Empty","ItemContainer not empty… %1"]]]);class b extends g{constructor(t,s){t={...t,locked:!0};super(t,s);c(this,"storage");this.storage=t.storage}get locked(){return this.storage.locked}mount(...t){return this.storage.mount(...t)}unmount(...t){return this.storage.unmount(...t)}async save(){return this.storage.save(await this.export())}}c(b,"TYPE","Storage");const Q=class Q extends b{constructor(e){super(e,{type:Q.TYPE,symbol:y.CLOUD_DISK})}isLogged(){var e;return((e=this.storage.storage)==null?void 0:e.isLogged())||!1}};c(Q,"TYPE","CloudDisk");let F=Q;class W extends g{constructor(e){super(e,{type:"Directory",symbol:y.DIRECTORY}),[d.WINDOW_SCALE,d.WINDOW_SCROLL_X,d.WINDOW_SCROLL_Y].forEach(t=>{this.meta.has(t)||this.meta.set(t,!0)})}}c(W,"TYPE","Directory");class P extends v{constructor(e){super(e,{type:"File"})}}c(P,"TYPE","File");class G extends g{constructor(e){super(e,{type:"FloppyDisk"})}}c(G,"TYPE","FloppyDisk");class V extends b{constructor(e){super(e,{type:"HardDisk",symbol:y.HARD_DISK})}}c(V,"TYPE","HardDisk");class X extends v{constructor(t){t={refPath:void 0,...t};super(t);c(this,"refPath");this.refPath=t.refPath}}c(X,"TYPE","Link");class Z extends b{constructor(e){super(e,{type:"RamDisk",symbol:y.RAM_DISK})}}c(Z,"TYPE","RamDisk");class Se extends g{constructor(e){e={...e,locked:!0,id:"ROOT",name:"ROOT"},super(e,{type:"Root"})}}c(Se,"TYPE","Root");class J extends b{constructor(e){super(e,{type:"TmpDisk",symbol:y.TMP_DISK}),this.meta.set(d.VISIBLE,!1),this.meta.set(d.IGNORE_SYMBOL_REARRANGE,!0)}}c(J,"TYPE","TmpDisk");class T extends g{constructor(e){super(e,{type:"Trashcan",symbol:y.TRASHCAN})}}c(T,"TYPE","Trashcan");const f=class f{constructor(e){c(this,"name");c(this,"root");c(this,"currentItem");c(this,"storages",new Map);c(this,"events",_(new B));this.name=e,this.root=new Se,this.setup()}setup(){this.currentItem=this.root;const e=[this.addStorage(f.RAM_DISK_TITLE,x.SESSION,{id:f.RAM_DISK_NAME}),this.addStorage(f.HARD_DISK_NAME,x.LOCAL,{trashcan:!0}),this.addStorage(f.TMP_DISK_TITLE,x.TEMP,{id:f.TMP_DISK_NAME,trashcan:!1})];return Promise.all(e).catch(t=>{throw t})}createTmpFile(e,t,s,r){return this.createRootFile(`TMP:${e}`,t,s,r)}createRootDir(e,t,s){const r=`${e}`;return this.makedir(r,t,{override:!0,...s})}createRootFile(e,t,s,r){let a=t,n=s;typeof t=="object"&&(n=t,a=void 0);const o=`${e||"Unknown"}`;return this.makefile(o,a,n,{...r||{},override:!0})}async get(e,t=!1){if(e instanceof v)return e;if(Y(e))try{return await this.parsePath(e)}catch(s){if(t)return new v({id:E(e),name:E(e)});throw s}else throw p.get("FileSystem_pathInvalid",E(e),N(e))}async parsePath(e){var a,n;let t=e,s=this.currentItem;const r=e.match(/^([^:\\/]+):(.*)$/);if(r?(s=(a=this.root)==null?void 0:a.getItem(r[1]),t=r[2]):t[0]==="/"&&this.currentItem?(t=t.slice(1),s=O(this.currentItem)):t==="ROOT"&&(s=this.root,t=""),t&&t.length>0&&(s=oe(t.split("/"),s)),s)return s;throw p.get("FileSystem_pathInvalid",e,await((n=this.currentItem)==null?void 0:n.getBase())||"")}async addFloppyDisk(e){let t;if(typeof e=="function"?(t=await e(),t instanceof Promise&&(t=await t)):t=e,Array.isArray(t))throw new Error('data is an Array, use "defineFloppyDisk" for define a Disk');return this.addStorage(t)}async removeFloppyDisk(e){await e.remove({silent:!0})}async addStorage(e,t,s={}){s=Object.assign({id:null},s);let r;typeof t=="function"&&(r=t,t=x.CLOUD);const a=this.getFreeSlot(f.PREFIX.FLOPPY_DISK),n={id:a,itemClass:G};let o={};if(typeof e=="object"){const l=e;n.name=l.name,l.items&&(n.items=l.items),n.meta=Array.from(new Map([[d.SYMBOL,y.DISK_1],...l.meta||[]]))}else{switch(t){case x.SESSION:n.id=f.PREFIX.RAM,n.itemClass=Z;break;case x.TEMP:n.id=f.PREFIX.TMP,n.itemClass=J;break;case x.LOCAL:n.id=this.getFreeSlot(f.PREFIX.HARD_DISK),n.itemClass=V;break;case x.CLOUD:n.id=this.getFreeSlot(f.PREFIX.CLOUD_DISK),n.itemClass=F;break}n.id=s.id||n.id;let l;r&&typeof r=="function"?l=await this.registerStorageByStorage(n.id,r).mount(s):l=await this.registerStorageByType(n.id,t).mount(s);const h=await l.load();o=g.normalizeItemData(h),n.storage=l,x.NONE!==t&&(n.name=o.name||e)}return(n.meta=n.meta||[]).push(...o.meta||[]),this.addDisk({...n,...o,storage:n.storage||new ae({id:a,name:f.TMP_DISK_TITLE})},s)}removeStorage(e){return e.unmount().then(()=>(this.events.next(new u({name:"removeStorage",value:{itemStorage:e}})),e))}registerStorageByType(e,t){const s=Oe(t),r=`${this.name}_${e}`,a=new s({id:e,name:r});return this.storages.set(r,a),a}registerStorageByStorage(e,t){const s=`${this.name}_${e}`,r=new t({id:e,name:s});return this.storages.set(s,r),r}connect(e,t){return this.addStorage(Be,e,t).then(s=>s).catch(s=>{throw s})}async disconnect(e){return e=await this.removeStorage(e),e.remove({silent:!0,recursive:!0}),e}addDisk({id:e,name:t,meta:s,items:r,itemClass:a,storage:n},o){var w;o={trashcan:!1,...o},r instanceof Map&&o.trashcan&&(!r||r&&!r.has(T.TYPE))&&(r=r||new Map,r.set(T.TYPE,{type:T.TYPE,id:T.TYPE,name:T.TYPE}));const l=a;if(!l)throw new Error("ItemClass is empty!");const h=new l({id:e,name:t||e,meta:s,items:r,storage:n});return(w=this.root)==null||w.addItem(h),this.events.next(new u({name:"addDisk",value:{id:e,item:h}})),h}getFreeSlot(e){var s;let t=0;for(;(s=this.root)!=null&&s.hasItem(`${e}${t}`);)t++;return`${e}${t}`}async exist(e){try{return!!await this.get(e)}catch(t){return console.error(t),!1}}async changeDirectory(e){const t=await this.get(e);return this.currentItem=t,this.events.next(new u({name:"changeDirectory",value:t})),t}async makedir(e,t,s){const{override:r,meta:a}={override:!1,meta:[],...s};let n;e&&je(e)&&e!==t?n=await this.get(N(e)):n=this.currentItem;const o=new W({id:E(e),name:t||"",createdDate:Date.now(),meta:a});if(await A(n),r||!n.getItem(o.id))n.addItem(o,r),this.events.next(new u({name:"writeItem",value:o}));else throw p.get("FileSystem_fileExist",o.id);return await D(n),o}async makefile(e,t,s,r){var S,$,de;const{override:a,meta:n}={...r,meta:r.meta||[]},o=E(e),l=new P({id:o,name:t||o,data:s,meta:n,createdDate:Date.now()});if(!Y(e))throw p.get("FileSystem_invalidPath",e);let h=Ye(e);const w=Ue(e);h===w&&(h=".");let I;if($e(h)?I=await this.get(h):((S=this.currentItem)==null?void 0:S.id)!=="ROOT"?I=await this.get(Ke(await(($=this.currentItem)==null?void 0:$.getPath())||"",h)):I=await this.get(h),I.hasItem(w))if(a)await((de=I.getItem(w))==null?void 0:de.remove()),I.addItem(l);else throw p.get("FileSystem_fileExist",l.id);else I.addItem(l),this.events.next(new u({name:"writeItem",value:l}));return await D(I),l}async editfile(e,t){const s=await this.get(e);return await A(s),await Ve(s),s.data=t,D(s)}async editfileMeta(e,t,s){const r=await this.get(e);return Array.isArray(t)?t.map(a=>({name:a[0],value:a[1]})):r.meta.set(t,s),D(r)}async getItemMetaList(e){const t=await this.get(e);return Array.from(t.meta).map(s=>({name:s[0],value:s[1]}))}async saveItem(e){const t=await this.get(e);return D(t)}async makelink(e,t=null){const s=await this.get(e);await A(s);const r=this.currentItem,a=new X({id:le(s.id)+".ref",name:`${t||s.name}`,refPath:await s.getPath(),createdDate:Date.now()});return await r.addItem(a),await D(s),a}async editlink(e,t){const s=await this.get(e);await A(s);const r=await this.get(t);return s.refPath=await r.getPath(),D(s)}async rename(e,t,{name:s,removeName:r}={name:!1,removeName:!1}){let a;if(e instanceof v)a=e;else if(Y(e)||typeof e=="string")a=await this.get(e);else throw p.get("FileSystem_pathInvalid",N(e),e);return await A(a),r&&(s=!0,t=void 0),await a.rename(t,{ignore:!0,name:s}),D(a)}async copy(e,t,s={ignore:!1}){const{ignore:r}={ignore:!1,...s};let a,n,o;if(e instanceof v?(n=e,a=e.id):(n=await this.get(e),a=E(e)),t instanceof v)t instanceof g||(t=t.parent),o=t;else if(t){a=E(t);const h=await this.get(t,!0);if(h instanceof g?a=E(e):h.parent?o=h.parent:o=await this.get(N(t)),!(o instanceof g))throw new TypeError("no ItemContainer")}else throw new TypeError('"to" is empty!');await A(n);const l=await n.copy();if(o instanceof g&&(r||!o.getItem(a)))l.rename(a),o.addItem(l,r),this.events.next(new u({name:"copyItem",value:l}));else throw p.get("FileSystem_fileExist",a);return D(l)}async move(e,t,{override:s}={}){let r,a,n;if(e instanceof v)a=e,r=e.id;else{if(a=await this.get(e),a instanceof b)throw p.get("FileSystem_cantMoveStorage",a.id);r=E(e)}if(t instanceof v)t instanceof g?n=t:n=t.parent;else{if(r=E(t),n=await this.get(t),n instanceof g)r=E(e);else return this.get(N(t));if(!(n instanceof g))throw new TypeError("no ItemContainer")}let o;if(await A(a),s||!await n.getItem(r))o=O(a),await a.rename(r),await n.addItem(a,s),this.events.next(new u({name:"moveItem",value:a}));else throw p.get("FileSystem_fileExist",a.id,r);return await D(a),o?o.save().then(()=>a):a}async remove(e,t,s={ignore:!1}){var n;const{ignore:r}={ignore:!1,...s},a=await this.get(e);await A(a);try{const o=await Xe(t,a);return o[o.length-1].storage&&await((n=o[o.length-1].storage)==null?void 0:n.save()),o}catch(o){if(!r)throw o}}};c(f,"PREFIX",{FLOPPY_DISK:"DF",TMP:"TMP",RAM:"RAM",HARD_DISK:"HD",CLOUD_DISK:"CD"}),c(f,"TMP_DISK_NAME","TMP"),c(f,"TMP_DISK_TITLE","TMP DISK"),c(f,"RAM_DISK_NAME","RAM"),c(f,"RAM_DISK_TITLE","RAM DISK"),c(f,"HARD_DISK_NAME","HARD DISK");let pe=f;function oe(i,e){const t=i.shift();if(t===void 0)return e;if(t===".."){if(e.parent)return e.parent}else if(t==="."||t==="")return oe(i,e);if(e){const s=e.getItem(t);return i.length>0&&s instanceof g?oe(i,s):s}}function ie(i){switch(i){case W.TYPE:return W;case T.TYPE:return T;case b.TYPE:return b;case J.TYPE:return J;case Z.TYPE:return Z;case V.TYPE:return V;case G.TYPE:return G;case F.TYPE:return F;case X.TYPE:return X;case P.TYPE:return P}return P}p.add([["FileSystem_invalidPath",["Invalid File",'Invalid path "%1"']],["FileSystem_invalidFile",["Invalid File",'Invalid file… "%1"']],["FileSystem_fileExist",["File Ready",'File already exists… "%1"']],["FileSystem_pathInvalid",["Path Invalid",'Path invalid… "%1"; base: "%2"']],["FileSystem_itemInvalid",["Item Invalid",'Item id invalid… "%1" from "%2"']],["FileSystem_cantMoveStorage",["Can't Move",`Can't move BaseStorage "%1"`]],["FileSystem_permissionsNeeded",["Permissions needed","Permissions needed"]]]);class q{constructor({fsItem:e,command:t,model:s,layout:r}){c(this,"fsItem");c(this,"command");c(this,"type");c(this,"id",ee());c(this,"layout",L({position:m(0,0),size:m(0,0)}));c(this,"ignoreRearrange",!1);c(this,"model",L({title:"Item Title",symbol:y.DEFAULT,used:!1,visible:!0,url:"",ignoreRearrange:!1}));if(this.type="default",this.command=t,this.model=L({...this.model,...s||{}}),this.layout=L({...this.layout,...r||{}}),this.fsItem=e,this.fsItem){const a=this.fsItem;this.type=et(a),this.setProperties(a),this.fsItem.events.subscribe(({name:n})=>{n!=="addItem"&&n!=="removeItem"&&e&&this.setProperties(e)})}}setLayout(e){e.position&&(this.layout.position=m(e.position.x,e.position.y)),e.size&&(this.layout.size=m(e.size.x,e.size.y))}setProperties(e){if(this.model.title=e.name||"",this.layout.position=e.meta.get(d.POSITION)&&re(e.meta.get(d.POSITION))||m(0,0),this.model.visible=!!e.meta.get(d.VISIBLE),this.model.symbol=e.meta.get(d.SYMBOL),e.meta.get(d.WEB_URL)&&(this.model.url=String(e.meta.get(d.WEB_URL))),this.model.ignoreRearrange=!!e.meta.get(d.IGNORE_SYMBOL_REARRANGE),e instanceof g){const t=[`openDirectory "${e.getPath()}"`];e.meta.get(d.WINDOW_SYMBOL_REARRANGE)&&t.push("-sort-symbols");const s=e.meta.get(d.WINDOW_POSITION)&&re(e.meta.get(d.WINDOW_POSITION))||m(0,0);s.length>0&&t.push(`--window-position="${m(s.x,s.y).toArray().join(",")}"`);const r=e.meta.get(d.WINDOW_SIZE)&&re(e.meta.get(d.WINDOW_SIZE))||m(0,0);r.length>0&&t.push(`--window-size="${m(r.x,r.y).toArray().join(",")}"`),e.meta.has(d.WINDOW_SCALE)&&t.push(`--window-scale=${e.meta.get(d.WINDOW_SCALE)}`),e.meta.has(d.WINDOW_SCROLL_X)&&t.push(`--window-scroll-x=${e.meta.get(d.WINDOW_SCROLL_X)}`),e.meta.has(d.WINDOW_SCROLL_Y)&&t.push(`--window-scroll-y=${e.meta.get(d.WINDOW_SCROLL_Y)}`),e.meta.has(d.WINDOW_SIDEBAR)&&t.push(`--window-sidebar=${e.meta.get(d.WINDOW_SIDEBAR)}`),e.meta.has(d.WINDOW_FULL_SIZE)&&t.push(`--window-full-size=${e.meta.get(d.WINDOW_FULL_SIZE)}`),this.command=t.join(" ")}else this.model.url||(this.command=`execute "${e.getPath()}"`)}}function ye(i){return i.map(e=>e instanceof q?e:new q(e))}function et(i){return i instanceof g?"container":i.meta.get(d.WEB_URL)?"link":"default"}function re(i){return m(i.x,i.y)}var R=(i=>(i[i.NAME=0]="NAME",i[i.TYPE=1]="TYPE",i[i.CREATED_DATE=2]="CREATED_DATE",i[i.EDITED_DATE=3]="EDITED_DATE",i))(R||{}),U=(i=>(i[i.ASCENDING=0]="ASCENDING",i[i.DESCENDING=1]="DESCENDING",i))(U||{}),j=(i=>(i.SHOW_INVISIBLE_SYMBOLS="symbolWrapper_showInvisibleItems",i.ORDER_TYPE="symbolWrapper_iconsOrderType",i.ORDER_DIRECTION="symbolWrapper_iconsOrderDirection",i))(j||{});class Ie extends u{}class tt{constructor(e,t=[],s=!1){c(this,"id",ee());c(this,"items",ge([]));c(this,"selectedItems",ge([]));c(this,"core");c(this,"root",!1);c(this,"layout",L({size:m(0,0),position:m(0,0)}));c(this,"size",m(0,0));c(this,"parentSize",m(0,0));this.root=s||!1,this.core=e,this.items.value=ye(t||[])}setLayout(e){e.position&&(this.layout.position=m(e.position.x,e.position.y)),e.size&&(this.layout.size=m(e.size.x,e.position.y))}setSize(e){this.size=m(e.x,e.y)}setParentSize(e){this.parentSize=m(e.x,e.y)}rearrangeIcons(e={orderType:R.NAME,orderDirection:U.ASCENDING,onlyVisible:!1,root:!1,margin:10}){e=Object.assign({orderType:this.core.config.get(j.ORDER_TYPE),orderDirection:this.core.config.get(j.ORDER_DIRECTION),onlyVisible:!this.core.config.get(j.SHOW_INVISIBLE_SYMBOLS),root:!1,margin:10},e);let t=this.items.value;switch(e.root&&(e.orderType=R.NAME,e.orderDirection=U.DESCENDING),e.onlyVisible&&(t=t.filter(o=>o.model.visible)),t=t.filter(o=>!o.model.ignoreRearrange),e.orderType){case R.TYPE:t=t.sort((o,l)=>o.type.localeCompare(l.type));break;case R.CREATED_DATE:t=t.sort((o,l)=>{var I,S;const[h,w]=[((I=o.fsItem)==null?void 0:I.createdDate)||0,((S=l.fsItem)==null?void 0:S.createdDate)||0];return h===w?0:h>w?1:-1});break;case R.EDITED_DATE:t=t.sort((o,l)=>{var I,S;const[h,w]=[((I=o.fsItem)==null?void 0:I.editedDate)||0,((S=l.fsItem)==null?void 0:S.editedDate)||0];return h===w?0:h>w?1:-1});break;default:t=t.sort(o=>o.model.title.localeCompare(o.model.title))}switch(e.orderDirection){case U.ASCENDING:t.reverse();break}const s=e.margin||0;let r,a=s;const n=Ae(0,0);return e.root?r=this.size.x:r=s,t.forEach(o=>{e.root?(o.layout.position=m(r-o.layout.size.x,a),o.layout.size.x>n.x&&(n.x=o.layout.size.x),a+o.layout.size.y<this.parentSize.y?a+=o.layout.size.y+s:(r-=n.x+s,a=s)):(o.layout.size.y>n.y&&(n.y=o.layout.size.y),o.layout.position=m(r,a),r+o.layout.size.x<this.parentSize.x||(r=s,a+=n.y+s,o.layout.position=m(r,a)),r+=o.layout.size.x+s)}),Promise.all(t.map(({id:o,layout:l})=>this.savePosition(o,l.position)))}clearSelectedItems(){[...this.selectedItems.value].forEach(e=>this.unselectItem(e))}isSelectedItem(e){return this.selectedItems.value.includes(e)}selectItem(e){return this.isSelectedItem(e)?!1:(this.selectedItems.value.push(e),!0)}unselectItem(e){return this.isSelectedItem(e)?(this.selectedItems.value=this.selectedItems.value.filter(t=>t!==e),!0):!1}async moveItem(e,t){console.warn("Method not implemented.",e,t)}async moveItemToItem(e,t){console.warn("Method not implemented.",t,e)}async savePosition(e,t){console.warn("Method not implemented.",e,t)}get(e){return this.items.value.find(t=>t.id===e)}has(e){return!!this.items.value.find(t=>t.id===e)}add(...e){const t=ye(e);return this.items.value.push(...t),t}remove(e){let t;return typeof e=="string"?t=this.get(e):t=e,t&&(this.unselectItem(t.id),this.items.value.splice(this.items.value.indexOf(t),1)),t}}class st extends tt{constructor(){super(...arguments);c(this,"events",_(new B))}add(...t){const s=super.add(...t);return this.events.next(new Ie({name:"add",value:{wrapper:this,items:Array.from(s)}})),s}remove(t){const s=super.remove(t);return s&&this.events.next(new Ie({name:"remove",value:{wrapper:this,item:s||void 0}})),s}setup(...t){return Promise.resolve()}selectItem(t){return super.selectItem(t)?(this.events.next(new u({name:"selectItem",value:{wrapper:this,id:t}})),!0):!1}unselectItem(t){return super.unselectItem(t)?(this.events.next(new u({name:"unselectItem",value:{wrapper:this,id:t}})),!0):!1}}class M extends st{constructor(){super(...arguments);c(this,"fsItem");c(this,"usedMemory",0)}async setup(t){this.fsItem=t;const s=Array.from((await t.getItems()).values());await Promise.all(s.map(async r=>this.add(await M.fsItemToSymbol(r)))),t.events.subscribe(this.onEventItem.bind(this))}async moveItemToItem(t,s){var r,a;if(t.locked)throw new Error("Items are locked!");if(s.locked)throw new Error("Destination is locked!");t.meta.set(d.POSITION,m(0,0)),await((r=this.core.modules.files)==null?void 0:r.fs.saveItem(t)),await((a=this.core.modules.files)==null?void 0:a.fs.move(t,s,{override:!0}))}async moveItem(t,s){const r=this.get(t);if(r&&(r.fsItem instanceof P||r.fsItem instanceof W))try{if(r!=null&&r.fsItem&&(s!=null&&s.fsItem))await this.moveItemToItem(r.fsItem,s.fsItem);else throw new Error("Item or wrapper not found");return!0}catch(a){return console.warn(a),!1}return!1}async savePosition(t,s){var a;let r;if(typeof t=="string"&&this.get(t)?r=this.get(t):t instanceof q&&(r=t),r)if(r.fsItem)r.fsItem.meta.set(d.POSITION,s),(a=this.core.modules.files)==null||a.fs.saveItem(r.fsItem);else throw new Error(`Item has no fsItem. ${t}`);else throw new Error(`Item not found. ${t}`)}hasFsItem(t){return this.items.value.find(s=>{var r;return((r=s.fsItem)==null?void 0:r.id)===t.id})}async onEventItem({name:t,value:s}){var r;if(s!=null&&s.item){let a;if(t==="addItem")a=await M.fsItemToSymbol(s.item),this.hasFsItem(s.item)||this.add(a);else if(t==="removeItem"){const n=this.items.value.find(o=>o.fsItem===s.item);n?this.remove(n):console.warn("Item not found",s.item)}this.usedMemory=((r=this.fsItem)==null?void 0:r.getUsedMemory())||0}else console.warn("Item event without value",t,s)}static getItemsFromItem(t){return Promise.all(Array.from(t.items.values()).map(M.fsItemToSymbol))}static async fsItemToSymbol(t){const s=await t.getPath(),r=new q({fsItem:t,model:{title:t.name||"Untitled"}});return typeof t.action=="function"&&(r.command=`executeFile "${s}"`),t.meta.get(d.WEB_URL)&&(r.model.url=String(t.meta.get(d.WEB_URL))),r}}const it=m(0,0);class K{constructor({sidebarComponent:e,sidebarComponentData:t,component:s,componentData:r,options:a,wrapper:n,layout:o,parentWindow:l}){c(this,"events",new B);c(this,"id",ee());c(this,"component");c(this,"componentData");c(this,"sidebarComponent");c(this,"sidebarComponentData");c(this,"parentWindow");c(this,"options",L({title:"Unnamed",scaleX:!0,scaleY:!0,scrollX:!0,scrollY:!0,clampX:!0,clampY:!1,freeze:!1,focused:!1,center:!0,close:!0,overlay:!0,embed:!1,borderless:!1,hideRootHeader:!1,sidebar:!0,prompt:!1}));c(this,"group");c(this,"wrapper");c(this,"layout",L({focused:!1,position:m(0,0),size:it,scrollOffset:m(0,0),zIndex:0}));this.parentWindow=l,e&&(this.sidebarComponent=_(e)),t&&(this.sidebarComponentData=_(t)),s&&(this.component=_(s)),this.componentData={window:this,...r||{}},n&&(this.wrapper=_(n)),this.options=Object.assign(this.options,a),this.layout=Object.assign(this.layout,o)}setLayout(e){e.position&&(this.layout.position=m(e.position.x,e.position.y)),e.size&&(this.layout.size=m(e.size.x,e.size.y)),e.scrollOffset&&(this.layout.scrollOffset=m(e.scrollOffset.x,e.scrollOffset.y)),e.focused&&(this.layout.focused=e.focused)}ready(){this.options.ready=!0,this.events.next(new u({name:"ready"}))}focus(){this.options.focused=!0,this.events.next(new u({name:"focus"}))}unfocus(){this.options.focused=!1,this.events.next(new u({name:"unfocus"}))}close(e){this.wrapper&&(this.events.next(new u({name:"close",value:e})),this.wrapper.remove(this.id),this.wrapper=void 0)}setWrapper(e){this.wrapper=_(e)}setGroup(e){this.group=e}awaitClose(){return new Promise(e=>{const t=this.events.pipe(fe(({name:s})=>s==="close")).subscribe(s=>{t.unsubscribe(),e(s)})})}awaitReady(){return new Promise(e=>{if(this.options.ready)e(this);else{const t=this.events.pipe(fe(({name:s})=>s==="ready")).subscribe(()=>{t.unsubscribe(),e(this)})}})}}const rt=20;var at=(i=>(i[i.CENTER=0]="CENTER",i[i.ORDER_HORIZONTAL=1]="ORDER_HORIZONTAL",i[i.ORDER_VERTICAL=2]="ORDER_VERTICAL",i[i.ORDER_DIAGONAL_LEFT=3]="ORDER_DIAGONAL_LEFT",i[i.ORDER_DIAGONAL_RIGHT=4]="ORDER_DIAGONAL_RIGHT",i[i.SPLIT_HORIZONTAL=5]="SPLIT_HORIZONTAL",i[i.SPLIT_VERTICAL=6]="SPLIT_VERTICAL",i[i.FULL=7]="FULL",i))(at||{});class Et{constructor(e,t=[]){c(this,"events",_(new B));c(this,"id",ee());c(this,"core");c(this,"layout",{size:m(0,0),position:m(0,0)});c(this,"groups",new Map);c(this,"modelMap",new Map);c(this,"models",[]);c(this,"_activeWindow");this.core=e,t.forEach(s=>this.add(s))}setLayout(e){e.position&&(this.layout.position=m(e.position.x,e.position.y)),e.size&&(this.layout.size=m(e.size.x,e.size.y))}getActiveWindow(){return this.models.find(e=>e.options.focused)}setActiveWindow(e){this.models.forEach(t=>{t.options.focused=e===t.id,e===t.id&&(this._activeWindow=t,this.events.next(new u({name:"setActiveWindow",value:t})))})}hasEmbbedWindow(){return!!this.models.find(e=>e.options.embed)}isHeaderVsible(){return!this.models.find(e=>e.options.embed&&e.options.hideRootHeader)}add(e,t){const{full:s,maximize:r,active:a,group:n}={full:!1,maximize:!1,active:!0,group:null,...t||{}};let o;if(e instanceof K?o=e:o=new K(e),o.setWrapper(this),r?o.layout.size=m(this.layout.size.x,this.layout.size.y):s&&(o.layout.size=m(()=>m(this.layout.size.x,this.layout.size.y)+m(0,rt))),n){let l;this.groups.has(n)?(l=this.groups.get(n),l.windows.push(o)):(l={primary:o,windows:[],name:n},this.groups.set(n,l)),o.setGroup(l)}return o.layout.zIndex=this.models.length,this.models.push(o),this.events.next(new u({name:"add",value:o})),this.modelMap.set(o.id,o),a&&this.setActiveWindow(o.id),o}remove(e){let t;e instanceof K?t=e:t=this.get(e),t!==void 0&&(t.group&&(t.group.primary===e?(t.group.windows.forEach(s=>s.close()),this.groups.delete(t.group.name)):t.group.primary.focus()),this.models.splice(this.models.indexOf(t),1),this.modelMap.delete(t.id))}get(e){return this.modelMap.get(e)}clear(){this.models=[].splice(0,this.models.length),this.modelMap.clear()}setWindowUpDown(e,t){const s=this.models,r=Array.from(s).filter(n=>!n.options.embed).sort((n,o)=>(n.layout.zIndex||0)-(o.layout.zIndex||0)).map(Te),a=this.get(e);if(a){const n=r.findIndex(({id:l})=>l===a.id),o=r[t?n-1:n+1];if(o){const l=a.layout.zIndex;a.layout.zIndex=o.layout.zIndex,o.layout.zIndex=l}}}centerWindow(e){let t;e instanceof K?t=e:t=this.get(e),t&&ce(t,this.layout)}setWindowPositions(e,t=[],s){const{embed:r}={embed:!1,...s};switch(t.length<1&&t.push(...this.models),r||(t=t.filter(a=>!a.options.embed)),e){case 7:t.forEach(a=>{nt(a,this.layout)});break;case 0:t.forEach(a=>{ce(a,this.layout)});break;case 3:case 4:ot(t,this.layout,e===4);break;case 5:case 6:ct(t,this.layout,e===6);break}}saveSize(e,t){var r,a,n,o;const s=this.get(e);if(s&&(r=s.componentData)!=null&&r.symbolWrapper&&((a=s.componentData)==null?void 0:a.symbolWrapper)instanceof M){const l=(n=s.componentData)==null?void 0:n.symbolWrapper.fsItem;l&&(l.meta.set(d.WINDOW_SIZE,t),(o=this.core.modules.files)==null||o.fs.saveItem(l))}}savePosition(e,t){var r,a,n,o;const s=this.get(e);if(s&&(r=s.componentData)!=null&&r.symbolWrapper&&((a=s.componentData)==null?void 0:a.symbolWrapper)instanceof M){const l=(n=s.componentData)==null?void 0:n.symbolWrapper.fsItem;l&&(l.meta.set(d.WINDOW_POSITION,t),(o=this.core.modules.files)==null||o.fs.saveItem(l))}}}function nt(i,e){i.layout.size=e.size}function ce(i,e){i.layout.position=m(()=>(m(e.size.x,e.size.y)-m(i.layout.size.x,i.layout.size.y))/2)}function ot(i,e,t){const s=1/i.length;i.forEach((r,a)=>{ce(r,e),a=-Math.floor(i.length/2)+a;const n=m(r.layout.position.x+(t?-1:1)*(s*r.layout.size.x)*a,r.layout.position.y+s*r.layout.size.y*a),o=m(()=>m(e.size.x,e.size.y)-m(r.layout.size.x,r.layout.size.y));r.layout.position=m(()=>Math.max(Math.min(n,o),0))})}function ct(i,e,t){let s;const r=i.length;t?(s=m(e.size.x,e.size.y/r),i.forEach((a,n)=>{a.layout.position=m(0,n*s.y),a.layout.size=s})):(s=m(e.size.x/r,e.size.y),i.forEach((a,n)=>{a.layout.position=m(n*s.x,0),a.layout.size=s}))}export{Me as C,W as D,u as E,M as F,rt as H,tt as I,R as O,Se as R,C as S,x as T,Et as W,K as a,at as b,me as c,vt as d,p as e,ne as f,Oe as g,b as h,St as i,g as j,T as k,Ge as l,E as m,Ne as n,pe as o,Ke as p,j as q,U as r,D as s,q as t,wt as u,v,yt as w,It as x,pt as y,Ce as z};
