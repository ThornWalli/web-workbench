import{C as B}from"./BJmh0rUk.js";import{g as Q,c as ee,I as te,C as l}from"./o5_jRgdX.js";import{d as Y}from"./DtRunxS3.js";import{i as x}from"./BGIFtisS.js";import{W as oe}from"./BTliyJ9j.js";import{u as ie,i as ne,M as m}from"./hgdfUW9W.js";import{d as X,j as _,t as h,v as p,x as y,z as k,_ as L,r as M,o as re,Z as $,$ as V,X as O,Y as A,F as N,y as H,g as R,L as I,B as U,O as Z,aa as F,A as se,K as ae,a6 as z,a0 as le,I as P}from"./DepUWdG1.js";import{u as ce}from"./CJrV-oJY.js";import{M as ue,a as de}from"./D1t9NEsb.js";import me from"./DcMfwrs4.js";import{N as he,u as pe}from"./BaLl6BVZ.js";import{N as ye}from"./DApFAwaH.js";import{r as be,c as D}from"./DHfQ7N5I.js";import{T as fe,c as ve}from"./C8H7s2tc.js";import{T as Ce}from"./C44OEkqw.js";import{o as ke,n as _e,S as W}from"./6C4StZv5.js";import{c as j,f as w}from"./CSlkdJUE.js";import{i as Ne}from"./Ce6njBYG.js";import{t as q}from"./C6SzTwG0.js";import"./C5mdboMC.js";import"./DYHHCWM9.js";import"./DN3eHOnZ.js";import"./D4lI5vpz.js";import"./DdQrQ7-5.js";import"./nufkX4jA.js";import"./RAasLaaH.js";import"./BDV1uWkE.js";import"./D5m4u8d2.js";import"./C9SoOunh.js";import"./BVsX1iIx.js";import"./DQWRfqHy.js";import"./ey0azPGz.js";import"./Crnau0sa.js";import"./BG0OyHeb.js";import"./CNkvSXuu.js";import"./CzBXAPyu.js";import"./WL2z-xAH.js";import"./CJLX7oOC.js";function G(e){return ke(function(i,s){var t=!1,n=null,o=null,c=function(){if(o==null||o.unsubscribe(),o=null,t){t=!1;var r=n;n=null,s.next(r)}};i.subscribe(j(s,function(r){o==null||o.unsubscribe(),t=!0,n=r,o=j(s,c,_e),Ne(e(r)).subscribe(o)},function(){c(),s.complete()},void 0,function(){n=o=null}))})}const Te={class:"wb-env-molecule-footer"},ge={ref:"menu",class:"menu"},Re=X({__name:"Footer",props:{parentLayout:{type:Object,default(){return{size:x(window.innerWidth,window.innerHeight)}}},title:{type:String,default:"Web-Workbench release. Version 1.3"},items:{type:Array,default(){}}},emits:["inputContextMenu"],setup(e,{emit:i}){const{core:s}=ie(),t=e,n=i,o=_(()=>{var r,u;return t.items||((u=(r=s.value)==null?void 0:r.modules.windows)==null?void 0:u.contextMenu.activeItems.items)});function c(...r){n("inputContextMenu",...r)}return(r,u)=>(p(),h("footer",Te,[y("nav",ge,[k(oe,{direction:"top",items:o.value,"parent-layout":e.parentLayout,"onUpdate:modelValue":c},null,8,["items","parent-layout"])],512)]))}}),Ee=L(Re,[["__scopeId","data-v-f4a3aed3"]]),we=["disabled"],Ae={class:"keys white"},Se=["onMouseout","onPointerdown","onPointerup"],Me={key:0},Oe={key:0},Ie={class:"keys black"},Pe=["onMouseout","onPointerdown","onPointerup"],De={key:0},xe={key:0},Le=9,Ke=X({__name:"Keyboard",props:{disabled:{type:Boolean,default:!1},selectedNotes:{type:Array,default:null},size:{type:String,validator:e=>["small","medium","large"].includes(e),default:"large"},showNoteLabels:{type:Boolean,default:!1},startOctave:{type:Number,default:4},octaveCount:{type:Number,default:6}},emits:["down","up"],setup(e,{emit:i}){const s=M(),t=e,n=i,o=M([]),c=M(x(0,0)),r=_(()=>Array.from(new Set(t.selectedNotes.map(a=>be(a.getName()||"")).flat()))),u=_(()=>({small:96,medium:96*1.5,large:96*2})[t.size]),b=_(()=>{const a=[],T=["c","c#","d","d#","e","f","f#","g","g#","a","a#","b"];for(let d=0;d<t.octaveCount;d++)a.push(...T.map(f=>{const v=`${f}${t.startOctave+d}`;return{note:v,black:J(v)}}));return t.startOctave+t.octaveCount<=Le&&a.push({note:T[0]+(t.startOctave+t.octaveCount),black:!1}),a}),S=_(()=>({disabled:t.disabled})),C=_(()=>({...c.value.toCSSVars("dimension"),"--height":u.value,"--keys":b.value.filter(({black:a})=>!a).length,"--white-keys":b.value.filter(({black:a})=>!a).length,"--black-keys":b.value.filter(({black:a})=>a).length}));re(()=>{var a;c.value=x(((a=s.value)==null?void 0:a.offsetWidth)||0,0)});function J(a){return/^[a-z]#\d+/.test(a)}function K(a){t.disabled||(o.value.push(a),n("down",a))}function E(a){!t.disabled&&o.value.includes(a)&&(n("up",a),o.value=o.value.filter(T=>T!==a))}return(a,T)=>(p(),h("div",{ref_key:"rootEl",ref:s,style:O(C.value),class:A([S.value,"wb-disks-synthesizer-keyboard"]),disabled:e.disabled},[y("div",null,[y("div",Ae,[(p(!0),h($,null,V(b.value,({note:d,black:f},v)=>(p(),h("div",{key:v,class:A(["key",{black:f,white:!f,selected:r.value.includes(d.toLowerCase())}]),style:O({"--index":v}),onMouseout:g=>E(d),onPointerdown:g=>K(d),onPointerup:g=>E(d)},[f?N("",!0):(p(),h("span",Me,[e.showNoteLabels?(p(),h("i",Oe,H(d),1)):N("",!0)]))],46,Se))),128))]),y("div",Ie,[(p(!0),h($,null,V(b.value,({note:d,black:f},v)=>(p(),h("div",{key:v,class:A(["key",{black:f,white:!f,selected:r.value.includes(d.toLowerCase())}]),style:O({"--index":v}),onMouseout:g=>E(d),onPointerdown:g=>K(d),onPointerup:g=>E(d)},[f?(p(),h("span",De,[e.showNoteLabels?(p(),h("i",xe,H(d),1)):N("",!0)])):N("",!0)],46,Pe))),128))])])],14,we))}}),Be=L(Ke,[["__scopeId","data-v-5b9ecf1b"]]),Ye={components:{TimelineCanvas:Ce,Navigation:he,Metronom:ue,Keyboard:Be,WbEnvMoleculeFooter:Ee},props:{model:{type:Object,default:ee()},trackModel:{type:Object,default:Q()},toneDestination:{type:Object,default:null}},emits:["refresh"],async setup(e){const i=z(e,"model"),s=z(e,"trackModel"),t=ce();le(i,()=>{t.setContextMenu(ve,{model:i.value,trackModel:s.value,preserveContextMenu:t.preserveContextMenu})},{immediate:!0,deep:!0});const n=P(s.value[l.SYNTHESIZER_TRACK]);console.log("track",n);const o=P(new de(n)),c=P(new fe(n));console.log("trackPlayer",c);const r=await pe(),u=new me;await u.start();const b=u.hasInputs;return{...t,...r,metronom:o,track:n,trackPlayer:c,midiController:u,hasMidi:b}},data(){return{windowsModule:ae(this.core.modules.windows),duration:0,subscriptions:new W,midiControllerListener:null,openNotes:new Map,footerModel:{}}},computed:{styleClasses(){return{[`keyboard-align-${this.trackModel[l.SYNTHESIZER_TRACK_KEYBOARD_ALIGN]}`]:!0}},showKeyboard(){return this.trackModel[l.SYNTHESIZER_TRACK_SHOW_KEYBOARD]},inputNote(){return this.trackModel[l.SYNTHESIZER_TRACK_INPUT_NOTE]},bpm(){return Number(this.model[l.SYNTHESIZER_BPM])},trackPlayerIndex(){return Object.values(this.trackPlayer.sequenceNoteIndex).flat()},selectedNotes(){return this.track.notes.filter(e=>Object.values(this.trackPlayer.sequenceNoteIndex).flat().includes(e.index))},timelineCanvasData(){return{track:this.track,duration:this.metronom.getDuration()}},keybordData(){return{size:this.trackModel[l.SYNTHESIZER_TRACK_KEYBOARD_SIZE],showNoteLabels:this.trackModel[l.SYNTHESIZER_TRACK_SHOW_NOTE_LABELS],startOctave:this.trackModel[l.SYNTHESIZER_TRACK_START_OCTAVE],octaveCount:this.trackModel[l.SYNTHESIZER_TRACK_OCTAVE_COUNT],selectedNotes:this.selectedNotes}},metronomNavigation(){return{modelValue:this.metronom,"onUpdate:model-value":({name:e,value:i})=>{debugger;this.metronom[String(e)]=i},items:[[{icon:"skipPrev",label:"Prev Beat",hideLabel:!0,disabled:this.metronom.value===0,action:()=>{this.metronom.reset()}},{icon:"doublePrev",label:"Prev Beat",hideLabel:!0,disabled:Math.floor(this.metronom.currentBeat/2)===0,action:()=>{this.metronom.prevBeat()}},{icon:"prev",label:"Prev",hideLabel:!0,disabled:this.metronom.value===0,action:()=>{this.metronom.prev()}},{icon:"reset",iconAlign:"right",label:"Next",disabled:this.metronom.value/2-Math.floor(this.metronom.currentBeat)===0,hideLabel:!0,action:()=>{this.metronom.setBeat(this.metronom.currentBeat)}},{icon:"next",iconAlign:"right",label:"Next",hideLabel:!0,action:()=>{this.metronom.next()}},{icon:"doubleNext",label:"Next Beat",hideLabel:!0,action:()=>{this.metronom.nextBeat()}},{spacer:!0},{text:`Duration: ${this.metronom.value.toFixed(2)}`},{text:`Beat: ${this.metronom.currentBeat}-${this.metronom.currentBeat+this.metronom.beatCount}`}],[...D().map(([e])=>({label:`1/${e.replace(/(\d+)[nm]/,"$1")} n`,name:"time",value:e})),{spacer:!0}]]}},navigation(){return{model:this.trackModel,items:[[{text:"Input:"},{label:"Note",value:"note",name:l.SYNTHESIZER_TRACK_INPUT},{label:"Pause",value:"pause",name:l.SYNTHESIZER_TRACK_INPUT,disabled:!0},{spacer:!0},{label:"Remove Note",action:()=>{this.track.removeNote(this.track.selectedIndex)}},{label:"Clean Range",action:()=>{this.track.removeNotesByDurationRange(this.metronom.getDuration(),this.metronom.timeDuration)}},{label:"Clean Beat",action:()=>{this.track.removeNotesFromBeat(this.track.getBeatIndex())}},{label:"Reset",action:()=>{this.reset()}}],[{text:"Note:&nbsp;"},{label:"Auto",value:"",name:l.SYNTHESIZER_TRACK_INPUT_NOTE},...D().map(([e])=>({label:`1/${e.replace(/(\d+)[nm]/,"$1")} n`,name:l.SYNTHESIZER_TRACK_INPUT_NOTE,value:e})),{spacer:!0},this.trackPlayer.playing?{selected:!0,label:"Pause",icon:"pause",disabled:!this.trackPlayer.currentSequence||!this.trackPlayer.playing,onClick:()=>this.onClickPlause()}:{label:"Play",icon:"play",disabled:this.trackPlayer.playing||this.track.notes.length===0,onClick:()=>this.onClickPlay()},{label:"Stop",icon:"stop",disabled:!this.trackPlayer.currentSequence,onClick:()=>this.onClickStop()},{label:"Restart",disabled:this.track.selectedIndex>-1,onClick:()=>this.onClickRestart()}]]}},footerData(){const e=this.track,i=this.trackModel,s=e.getDuration().toFixed(2);return{items:ne([{options:{disabled:!this.hasMidi},title:`MIDI (${this.midiController.input?this.midiController.input.name:"OFF"})`,action:async()=>{this.midiControllerListener||await this.registerMidiListener()},items:this.midiController.ready&&this.midiControllerListener?[{title:"Inputs",items:this.midiController.inputs.map((t,n)=>({title:t.name,model:this.midiController,name:"activeInput",type:m.RADIO,value:t.id,action:async()=>{await this.registerMidiListener(this.midiController.listen(n))}}))},{title:"Input Channel",items:Array(16).fill(null).map((t,n)=>({title:String(n+1),value:n+1,type:m.RADIO,model:this.midiController,name:"inputChannel",action:async()=>{await this.registerMidiListener(this.midiController.listen(this.midiController.input))}}))},{title:"Outputs",items:this.midiController.outputs.map(t=>({title:t.name,model:this.midiController,name:"activeOutput",type:m.RADIO,value:t.id,action(){}}))},{type:m.SEPARATOR},{title:"Disconnect",action:()=>{var t;(t=this.midiControllerListener)==null||t.unsubscribe(),this.midiControllerListener=null,this.midiController.unlisten()}}]:[]},{type:m.SEPARATOR},{type:m.DEFAULT,title:`Instr.: ${this.track.type}`,items:Object.entries(te).map(([t,n])=>({type:m.RADIO,title:n,model:e,name:"type",value:t}))},{type:m.SEPARATOR},{title:`Octave: ${i[l.SYNTHESIZER_TRACK_START_OCTAVE]}-${i[l.SYNTHESIZER_TRACK_START_OCTAVE]+i[l.SYNTHESIZER_TRACK_OCTAVE_COUNT]-1}`,items:[{type:m.DEFAULT,title:"Start Octave",items:Array(9).fill({}).map((t,n)=>({type:m.RADIO,title:String(n+1),model:i,name:l.SYNTHESIZER_TRACK_START_OCTAVE,value:n+1,action(o){o=Number(o),o+i[l.SYNTHESIZER_TRACK_OCTAVE_COUNT]>9&&(i[l.SYNTHESIZER_TRACK_OCTAVE_COUNT]=10-o)}}))},{type:m.DEFAULT,title:"Octave Count",items:Array(10-i[l.SYNTHESIZER_TRACK_START_OCTAVE]).fill({}).map((t,n)=>({type:m.RADIO,title:String(n+1),model:i,name:l.SYNTHESIZER_TRACK_OCTAVE_COUNT,value:n+1}))}]},{type:m.SPACER},{type:m.TEXT,text:`BPM: ${this.bpm}`},{type:m.TEXT,text:`Dur.: ${s}`}])}}},watch:{"track.beatCount"(e){this.metronom.beatCount=e}},mounted(){console.log("TRACK",this.track),this.subscriptions.add(Y.keyDown.pipe(G(()=>q(100)),w(e=>e.key==="Enter")).subscribe(()=>{this.onClickActivateMidi()})),this.subscriptions.add(Y.keyDown.pipe(G(()=>q(100))).subscribe(e=>{switch(e.code){case"ArrowLeft":this.metronom.prev();break;case"ArrowRight":this.metronom.next();break;case"ArrowUp":this.metronom.prevBeat();break;case"ArrowDown":this.metronom.nextBeat();break;default:if(/Digit(\d+)/.test(e.code)){const i=e.code.replace(/Digit(\d+)/,"$1"),s=D()[i-1];s&&(this.metronom.time=s[0])}break}console.log(e)})),this.$nextTick(()=>{this.$emit("refresh")})},unmounted(){this.subscriptions.unsubscribe(),this.midiController.destroy()},methods:{async registerMidiListener(e){var i;try{await this.midiController.start();const s=this.midiController.listen(e>-1&&this.midiController.inputs[e]||this.midiController.inputs[0]);(i=this.midiControllerListener)==null||i.unsubscribe(),this.midiControllerListener=new W,this.midiControllerListener.add(s.pipe(w(({type:t})=>t==="noteOn")).subscribe(this.onNoteOn.bind(this)),s.pipe(w(({type:t})=>t==="noteOff")).subscribe(this.onNoteOff.bind(this)),s.pipe(w(({type:t})=>t==="volume")).subscribe(({value:t})=>{console.log("Volume: ",t),this.core.config.set(B.SCREEN_CONFIG,{...this.core.config.get(B.SCREEN_CONFIG),soundVolume:t})}))}catch(s){console.warn(s)}},async setup(){this.tone.ready||(await this.tone.start(),this.trackPlayer.createInstrument())},onReady({render:e}){this._render=e},onRender(e,{position:i,dimension:s}){if(this.inputNote==="auto"){const t=Array.from(this.openNotes.values());for(let n=0;n<t.length;n++){const o=t[Number(n)],r=(this.metronom.now()-o)/1e3/(this.metronom.speed*2)*s.x/this.track.beatCount;e.fillRect(i.x,i.y,r,s.y)}}},async onNoteOn({value:e}){await this.setup();const i=e.identifier;console.log("value.identifier",i,this.metronom.getDuration()),this.startNote(i),this.trackPlayer.triggerAttack(i)},async onNoteOff({value:e}){this.endNote(e.identifier),await this.tone.ready,this.trackPlayer.triggerRelease()},startNote(e){this.animationLoop||(this.animationLoop=$e(()=>{this._render&&this._render()})),this.openNotes.set(e,this.metronom.now())},endNote(e){var c;const i=[1,2,4,8,16,32].map(r=>[`${r}n`,`${r}t`,`${r}n.`]).flat().map(r=>[r,new(this.tone.getTone()).Time(r).toSeconds()]).sort((r,u)=>u[1]-r[1]),s=Math.max((this.metronom.now()-this.openNotes.get(e))/1e3,i[i.length-1][1]);this.openNotes.delete(e);const{Time:t}=this.tone.getTone();let n;this.inputNote?n=new t(this.inputNote):n=new t(i.map(([,r])=>r).find(r=>{const u=r*.2;return r-u<=s&&s<=r+u}));const o=this.metronom.getDuration();console.log({delay:o,name:e,time:n.toNotation()}),this.track.addNote(new ye({delay:o,name:e,time:n.toNotation()})),this.openNotes.size<1&&((c=this.animationLoop)==null||c.stop(),this.animationLoop=null)},async onClickNote({note:e,selected:i}){await this.setup(),i&&e.getName()&&this.trackPlayer.triggerAttackRelease(e)},async onClickPlay(){await this.setup(),this.trackPlayer.play()},onClickPlause(){this.trackPlayer.pause()},onClickStop(){this.trackPlayer.stop()},onClickRestart(){this.trackPlayer.restart()},async onDownKeyboard(e){await this.setup(),this.startNote(e),this.trackPlayer.triggerAttack(e)},async onUpKeyboard(e){await this.tone.awaitReady,this.endNote(e),this.trackPlayer.triggerRelease()},reset(){this.track.reset()},onClickActivateMidi(){this.registerMidiListener()}}};function $e(e){let i=0,s=0,t=!1;const n=o=>{const c=o-i;i=o,s+=c,e(o,s),t||requestAnimationFrame(n)};return requestAnimationFrame(n),{stop:()=>t=!0}}const Ve={key:0,class:"keyboard"},He={class:"sheet"},Ue={class:"panel"};function Ze(e,i,s,t,n,o){const c=R("keyboard"),r=R("navigation"),u=R("timeline-canvas"),b=R("metronom"),S=R("wb-env-molecule-footer");return p(),h("div",{class:A(["wb-disks-extras13-synthesizer-track",o.styleClasses])},[y("div",null,[y("div",null,[o.showKeyboard?(p(),h("div",Ve,[k(c,I({disabled:t.trackPlayer.playing},o.keybordData,{onDown:o.onDownKeyboard,onUp:o.onUpKeyboard}),null,16,["disabled","onDown","onUp"]),t.hasMidi&&!n.midiControllerListener?(p(),h("div",{key:0,class:"midi-message",onClick:i[0]||(i[0]=(...C)=>o.onClickActivateMidi&&o.onClickActivateMidi(...C))},i[2]||(i[2]=[y("div",null,[y("div",null,[y("span",null,[U("Click here, or press "),y("strong",null,"Enter"),U(" to activate the Midi Keyboard!")])])],-1)]))):N("",!0)])):N("",!0)]),k(r,Z(F(o.navigation)),null,16),y("div",He,[k(b,{model:t.metronom,onRender:o.onRender,onReady:o.onReady,onValue:i[1]||(i[1]=C=>t.track.setCurrentDuration(C))},{background:se(({onRefresh:C})=>[k(u,I(o.timelineCanvasData,{clickable:"",onRefresh:C,"onNote:click":o.onClickNote}),null,16,["onRefresh","onNote:click"])]),_:1},8,["model","onRender","onReady"])]),y("div",Ue,[k(r,Z(F(o.metronomNavigation)),null,16)])]),k(S,I(o.footerData,{"parent-layout":n.windowsModule.contentWrapper.layout}),null,16,["parent-layout"])],2)}const St=L(Ye,[["render",Ze],["__scopeId","data-v-29111192"]]);export{St as default};
