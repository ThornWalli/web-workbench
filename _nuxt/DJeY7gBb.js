import{C as E}from"./uY512OOx.js";import{d as A}from"./-XQioQgL.js";import{z as Y,g as R,S}from"./C0_snZds.js";import{c as H}from"./DpYQfsT-.js";import{W as Z}from"./fXOHulMw.js";import{_ as w,g as b,t as m,v as u,x as h,z as y,$ as M,a0 as P,Y as k,Z as v,y as O,F as _,a6 as I,Q as F,V as N,I as $,L as T,B as x,K as D,a9 as L,A as z}from"./CI217tZ_.js";import{u as W,g as j,M as d}from"./CIYo2XrQ.js";import{M as q,a as G}from"./DGvqruhx.js";import X from"./5k3KJYIe.js";import{N as Q,u as J}from"./Dh1w0NNw.js";import{N as ee}from"./Ca2pXi7A.js";import{r as te,f as g,h as oe}from"./Ch88JnIe.js";import{g as ie,b as ne,C as l}from"./CqY9ri8T.js";import{T as se,c as re}from"./C5CmDDFA.js";import{T as ae}from"./Bifp7azt.js";import{o as le}from"./BeevJImz.js";import{c as K,f as C}from"./CMn89ocD.js";import{i as ce}from"./CpQI5kI4.js";import{t as B}from"./DOQRJiqD.js";import"./BhIZyK9R.js";import"./C5mdboMC.js";import"./DCzE-LO6.js";import"./CrQvwhUk.js";import"./Bk_zE6I5.js";import"./BS99UALd.js";import"./Ch9TGLTe.js";import"./Cpj98o6Y.js";import"./DrjeU9O7.js";import"./DQ_s6YoC.js";import"./byCZiRCi.js";import"./B7OE2rZX.js";import"./BrQUI1fL.js";import"./CgsLbS92.js";import"./DCg_kLLl.js";import"./BPi9IPjj.js";import"./DptxkuMs.js";import"./BRT6S-89.js";import"./ByW6ry1A.js";import"./PS8j2qfJ.js";import"./C1Z8QYso.js";import"./CDk6Z4eJ.js";import"./ZA9ggWey.js";function U(e){return le(function(o,s){var i=!1,n=null,t=null,a=function(){if(t==null||t.unsubscribe(),t=null,i){i=!1;var r=n;n=null,s.next(r)}};o.subscribe(K(s,function(r){t==null||t.unsubscribe(),i=!0,n=r,t=K(s,a,Y),ce(e(r)).subscribe(t)},function(){a(),s.complete()},void 0,function(){n=t=null}))})}const de={components:{WbEnvMoleculeContextMenu:Z},props:{parentLayout:{type:Object,default(){return{size:R(window.innerWidth,window.innerHeight)}}},title:{type:String,default:"Web-Workbench release. Version 1.3"},items:{type:Array,default(){return H.modules.windows.contextMenu.activeItems.items}}},emits:["inputContextMenu"],data(){return{cover:!1}},methods:{onUpdateModelValueContextMenu(...e){this.$emit("inputContextMenu",...e)}}},me={class:"wb-env-molecule-footer"},ue={ref:"menu",class:"menu"};function he(e,o,s,i,n,t){const a=b("wb-env-molecule-context-menu");return m(),u("footer",me,[h("nav",ue,[y(a,{direction:"top",items:s.items,"parent-layout":s.parentLayout,"onUpdate:modelValue":t.onUpdateModelValueContextMenu},null,8,["items","parent-layout","onUpdate:modelValue"])],512)])}const pe=w(de,[["render",he],["__scopeId","data-v-f49caf4e"]]),ye=9,be={props:{disabled:{type:Boolean,default:!1},selectedNotes:{type:Array,default:null},size:{type:String,validator:e=>["small","medium","large"].includes(e),default:"large"},showNoteLabels:{type:Boolean,default:!1},startOctave:{type:Number,default:4},octaveCount:{type:Number,default:6}},emits:["down","up"],data:function(){return{pressedKeys:[],dimension:R()}},computed:{noteNames(){return Array.from(new Set(this.selectedNotes.map(e=>te(e.getName())).flat()))},height(){return{small:96,medium:96*1.5,large:96*2}[this.size]},octaveRange(){const e=[],o=["c","c#","d","d#","e","f","f#","g","g#","a","a#","b"];for(let s=0;s<this.octaveCount;s++)e.push(...o.map(i=>{const n=`${i}${this.startOctave+s}`;return{note:n,black:this.isBlackKey(n)}}));return this.startOctave+this.octaveCount<=ye&&e.push({note:o[0]+(this.startOctave+this.octaveCount),black:!1}),e},styleClasses(){return{disabled:this.disabled}},style(){return{...this.dimension.toCSSVars("dimension"),"--height":this.height,"--keys":this.octaveRange.filter(({black:e})=>!e).length,"--white-keys":this.octaveRange.filter(({black:e})=>!e).length,"--black-keys":this.octaveRange.filter(({black:e})=>e).length}}},mounted(){this.dimension=R(this.$el.offsetWidth,0)},methods:{isBlackKey(e){return/^[a-z]#\d+/.test(e)},onPointerDown(e){this.disabled||(this.pressedKeys.push(e),this.$emit("down",e))},onPointerUp(e){!this.disabled&&this.pressedKeys.includes(e)&&(this.$emit("up",e),this.pressedKeys=this.pressedKeys.filter(o=>o!==e))}}},_e=["disabled"],fe={class:"keys white"},Ce=["onMouseout","onPointerdown","onPointerup"],ke={key:0},ve={key:0},Ne={class:"keys black"},Te=["onMouseout","onPointerdown","onPointerup"],ge={key:0},Re={key:0};function we(e,o,s,i,n,t){return m(),u("div",{style:v(t.style),class:k([t.styleClasses,"wb-disks-synthesizer-keyboard"]),disabled:s.disabled},[h("div",null,[h("div",fe,[(m(!0),u(M,null,P(t.octaveRange,({note:a,black:r},c)=>(m(),u("div",{key:c,class:k(["key",{black:r,white:!r,selected:t.noteNames.includes(a.toLowerCase())}]),style:v({"--index":c}),onMouseout:p=>t.onPointerUp(a),onPointerdown:p=>t.onPointerDown(a),onPointerup:p=>t.onPointerUp(a)},[r?_("",!0):(m(),u("span",ke,[s.showNoteLabels?(m(),u("i",ve,O(a),1)):_("",!0)]))],46,Ce))),128))]),h("div",Ne,[(m(!0),u(M,null,P(t.octaveRange,({note:a,black:r},c)=>(m(),u("div",{key:c,class:k(["key",{black:r,white:!r,selected:t.noteNames.includes(a.toLowerCase())}]),style:v({"--index":c}),onMouseout:p=>t.onPointerUp(a),onPointerdown:p=>t.onPointerDown(a),onPointerup:p=>t.onPointerUp(a)},[r?(m(),u("span",ge,[s.showNoteLabels?(m(),u("i",Re,O(a),1)):_("",!0)])):_("",!0)],46,Te))),128))])])],14,_e)}const Ee=w(be,[["render",we],["__scopeId","data-v-60a1b312"]]),Ae={components:{TimelineCanvas:ae,Navigation:Q,Metronom:q,Keyboard:Ee,WbEnvMoleculeFooter:pe},props:{model:{type:Object,default:ie()},trackModel:{type:Object,default:ne()},toneDestination:{type:Object,default:null}},emits:["refresh"],async setup(e){const o=I(e,"model"),s=I(e,"trackModel"),i=W();F(o,()=>{i.setContextMenu(re,{model:o.value,trackModel:s.value,preserveContextMenu:i.preserveContextMenu})},{immediate:!0,deep:!0});const n=N(s.value[l.SYNTHESIZER_TRACK]);console.log("track",n);const t=N(new G(n)),a=N(new se(n));console.log("trackPlayer",a);const r=await J(),c=new X;await c.start();const p=c.hasInputs;return{...i,...r,metronom:t,track:n,trackPlayer:a,midiController:c,hasMidi:p}},data(){return{windowsModule:$(this.core.modules.windows),duration:0,subscriptions:new S,midiControllerListener:null,openNotes:new Map,footerModel:{}}},computed:{styleClasses(){return{[`keyboard-align-${this.trackModel[l.SYNTHESIZER_TRACK_KEYBOARD_ALIGN]}`]:!0}},showKeyboard(){return this.trackModel[l.SYNTHESIZER_TRACK_SHOW_KEYBOARD]},inputNote(){return this.trackModel[l.SYNTHESIZER_TRACK_INPUT_NOTE]},bpm(){return Number(this.model[l.SYNTHESIZER_BPM])},trackPlayerIndex(){return Object.values(this.trackPlayer.sequenceNoteIndex).flat()},selectedNotes(){return this.track.notes.filter(e=>Object.values(this.trackPlayer.sequenceNoteIndex).flat().includes(e.index))},timelineCanvasData(){return{track:this.track,duration:this.metronom.getDuration()}},keybordData(){return{size:this.trackModel[l.SYNTHESIZER_TRACK_KEYBOARD_SIZE],showNoteLabels:this.trackModel[l.SYNTHESIZER_TRACK_SHOW_NOTE_LABELS],startOctave:this.trackModel[l.SYNTHESIZER_TRACK_START_OCTAVE],octaveCount:this.trackModel[l.SYNTHESIZER_TRACK_OCTAVE_COUNT],selectedNotes:this.selectedNotes}},metronomNavigation(){return{model:this.metronom,items:[[{icon:"skipPrev",label:"Prev Beat",hideLabel:!0,disabled:this.metronom.value===0,action:()=>{this.metronom.reset()}},{icon:"doublePrev",label:"Prev Beat",hideLabel:!0,disabled:Math.floor(this.metronom.currentBeat/2)===0,action:()=>{this.metronom.prevBeat()}},{icon:"prev",label:"Prev",hideLabel:!0,disabled:this.metronom.value===0,action:()=>{this.metronom.prev()}},{icon:"reset",iconAlign:"right",label:"Next",disabled:this.metronom.value/2-Math.floor(this.metronom.currentBeat)===0,hideLabel:!0,action:()=>{this.metronom.setBeat(this.metronom.currentBeat)}},{icon:"next",iconAlign:"right",label:"Next",hideLabel:!0,action:()=>{this.metronom.next()}},{icon:"doubleNext",label:"Next Beat",hideLabel:!0,action:()=>{this.metronom.nextBeat()}},{spacer:!0},{text:`Duration: ${this.metronom.value.toFixed(2)}`},{text:`Beat: ${this.metronom.currentBeat}-${this.metronom.currentBeat+this.metronom.beatCount}`}],[...g().map(([e])=>({label:`1/${e.replace(/(\d+)[nm]/,"$1")} n`,name:"time",value:e})),{spacer:!0}]]}},navigation(){return{model:this.trackModel,items:[[{text:"Input:"},{label:"Note",value:"note",name:l.SYNTHESIZER_TRACK_INPUT},{label:"Pause",value:"pause",name:l.SYNTHESIZER_TRACK_INPUT,disabled:!0},{spacer:!0},{label:"Remove Note",action:()=>{this.track.removeNote(this.track.selectedIndex)}},{label:"Clean Range",action:()=>{this.track.removeNotesByDurationRange(this.metronom.getDuration(),this.metronom.timeDuration)}},{label:"Clean Beat",action:()=>{this.track.removeNotesFromBeat(this.track.getBeatIndex())}},{label:"Reset",action:()=>{this.reset()}}],[{text:"Note:&nbsp;"},{label:"Auto",value:"",name:l.SYNTHESIZER_TRACK_INPUT_NOTE},...g().map(([e])=>({label:`1/${e.replace(/(\d+)[nm]/,"$1")} n`,name:l.SYNTHESIZER_TRACK_INPUT_NOTE,value:e})),{spacer:!0},this.trackPlayer.playing?{selected:!0,label:"Pause",icon:"pause",disabled:!this.trackPlayer.currentSequence||!this.trackPlayer.playing,onClick:()=>this.onClickPlause()}:{label:"Play",icon:"play",disabled:this.trackPlayer.playing||this.track.notes.length===0,onClick:()=>this.onClickPlay()},{label:"Stop",icon:"stop",disabled:!this.trackPlayer.currentSequence,onClick:()=>this.onClickStop()},{label:"Restart",disabled:this.track.selectedIndex>-1,onClick:()=>this.onClickRestart()}]]}},footer(){const e=this.track,o=this.trackModel,s=e.getDuration().toFixed(2);return{items:j([{options:{disabled:!this.hasMidi},title:`MIDI (${this.midiController.input?this.midiController.input.name:"OFF"})`,action:async()=>{this.midiControllerListener||await this.registerMidiListener()},items:this.midiController.ready&&this.midiControllerListener?[{title:"Inputs",items:this.midiController.inputs.map((i,n)=>({title:i.name,model:this.midiController,name:"activeInput",type:d.RADIO,value:i.id,action:async()=>{await this.registerMidiListener(this.midiController.listen(n))}}))},{title:"Input Channel",items:Array(16).fill(null).map((i,n)=>({title:String(n+1),value:n+1,type:d.RADIO,model:this.midiController,name:"inputChannel",action:async()=>{await this.registerMidiListener(this.midiController.listen(this.midiController.input))}}))},{title:"Outputs",items:this.midiController.outputs.map(i=>({title:i.name,model:this.midiController,name:"activeOutput",type:d.RADIO,value:i.id,action(){}}))},{type:d.SEPARATOR},{title:"Disconnect",action:()=>{var i;(i=this.midiControllerListener)==null||i.unsubscribe(),this.midiControllerListener=null,this.midiController.unlisten()}}]:[]},{type:d.SEPARATOR},{type:d.DEFAULT,title:`Instr.: ${this.track.type}`,items:Object.entries(oe()).map(([i,n])=>({type:d.RADIO,title:n,model:e,name:"type",value:i}))},{type:d.SEPARATOR},{title:`Octave: ${o[l.SYNTHESIZER_TRACK_START_OCTAVE]}-${o[l.SYNTHESIZER_TRACK_START_OCTAVE]+o[l.SYNTHESIZER_TRACK_OCTAVE_COUNT]-1}`,items:[{type:d.DEFAULT,title:"Start Octave",items:Array(9).fill({}).map((i,n)=>({type:d.RADIO,title:String(n+1),model:o,name:l.SYNTHESIZER_TRACK_START_OCTAVE,value:n+1,action(t){t=Number(t),t+o[l.SYNTHESIZER_TRACK_OCTAVE_COUNT]>9&&(o[l.SYNTHESIZER_TRACK_OCTAVE_COUNT]=10-t)}}))},{type:d.DEFAULT,title:"Octave Count",items:Array(10-o[l.SYNTHESIZER_TRACK_START_OCTAVE]).fill({}).map((i,n)=>({type:d.RADIO,title:String(n+1),model:o,name:l.SYNTHESIZER_TRACK_OCTAVE_COUNT,value:n+1}))}]},{type:d.SPACER},{type:d.TEXT,text:`BPM: ${this.bpm}`},{type:d.TEXT,text:`Dur.: ${s}`}])}}},watch:{"track.beatCount"(e){this.metronom.beatCount=e}},mounted(){console.log("TRACK",this.track),this.subscriptions.add(A.keydown.pipe(U(()=>B(100)),C(e=>e.key==="Enter")).subscribe(()=>{this.onClickActivateMidi()})),this.subscriptions.add(A.keydown.pipe(U(()=>B(100))).subscribe(e=>{switch(e.code){case"ArrowLeft":this.metronom.prev();break;case"ArrowRight":this.metronom.next();break;case"ArrowUp":this.metronom.prevBeat();break;case"ArrowDown":this.metronom.nextBeat();break;default:if(/Digit(\d+)/.test(e.code)){const o=e.code.replace(/Digit(\d+)/,"$1"),s=g()[o-1];s&&(this.metronom.time=s[0])}break}console.log(e)})),this.$nextTick(()=>{this.$emit("refresh")})},unmounted(){this.subscriptions.unsubscribe(),this.midiController.destroy()},methods:{async registerMidiListener(e){var o;try{await this.midiController.start();const s=this.midiController.listen(e>-1&&this.midiController.inputs[e]||this.midiController.inputs[0]);(o=this.midiControllerListener)==null||o.unsubscribe(),this.midiControllerListener=new S,this.midiControllerListener.add(s.pipe(C(({type:i})=>i==="noteOn")).subscribe(this.onNoteOn.bind(this)),s.pipe(C(({type:i})=>i==="noteOff")).subscribe(this.onNoteOff.bind(this)),s.pipe(C(({type:i})=>i==="volume")).subscribe(({value:i})=>{console.log("Volume: ",i),this.core.config.set(E.SCREEN_CONFIG,{...this.core.config.get(E.SCREEN_CONFIG),soundVolume:i})}))}catch(s){console.warn(s)}},async setup(){this.tone.ready||(await this.tone.start(),this.trackPlayer.createInstrument())},onReady({render:e}){this._render=e},onRender(e,{position:o,dimension:s}){if(this.inputNote==="auto"){const i=Array.from(this.openNotes.values());for(let n=0;n<i.length;n++){const t=i[Number(n)],r=(this.metronom.now()-t)/1e3/(this.metronom.speed*2)*s.x/this.track.beatCount;e.fillRect(o.x,o.y,r,s.y)}}},async onNoteOn({value:e}){await this.setup();const o=e.identifier;console.log("value.identifier",o,this.metronom.getDuration()),this.startNote(o),this.trackPlayer.triggerAttack(o)},async onNoteOff({value:e}){this.endNote(e.identifier),await this.tone.ready,this.trackPlayer.triggerRelease()},startNote(e){this.animationLoop||(this.animationLoop=Se(()=>{this._render&&this._render()})),this.openNotes.set(e,this.metronom.now())},endNote(e){var a;const o=[1,2,4,8,16,32].map(r=>[`${r}n`,`${r}t`,`${r}n.`]).flat().map(r=>[r,new(this.tone.getTone()).Time(r).toSeconds()]).sort((r,c)=>c[1]-r[1]),s=Math.max((this.metronom.now()-this.openNotes.get(e))/1e3,o[o.length-1][1]);this.openNotes.delete(e);const{Time:i}=this.tone.getTone();let n;this.inputNote?n=new i(this.inputNote):n=new i(o.map(([,r])=>r).find(r=>{const c=r*.2;return r-c<=s&&s<=r+c}));const t=this.metronom.getDuration();console.log({delay:t,name:e,time:n.toNotation()}),this.track.addNote(new ee({delay:t,name:e,time:n.toNotation()})),this.openNotes.size<1&&((a=this.animationLoop)==null||a.stop(),this.animationLoop=null)},async onClickNote({note:e,selected:o}){await this.setup(),o&&e.getName()&&this.trackPlayer.triggerAttackRelease(e)},async onClickPlay(){await this.setup(),this.trackPlayer.play()},onClickPlause(){this.trackPlayer.pause()},onClickStop(){this.trackPlayer.stop()},onClickRestart(){this.trackPlayer.restart()},async onDownKeyboard(e){await this.setup(),this.startNote(e),this.trackPlayer.triggerAttack(e)},async onUpKeyboard(e){await this.tone.awaitReady,this.endNote(e),this.trackPlayer.triggerRelease()},reset(){this.track.reset()},onClickActivateMidi(){this.registerMidiListener()}}};function Se(e){let o=0,s=0,i=!1;const n=t=>{const a=t-o;o=t,s+=a,e(t,s),i||requestAnimationFrame(n)};return requestAnimationFrame(n),{stop:()=>i=!0}}const Me={key:0,class:"keyboard"},Pe={class:"sheet"},Oe={class:"panel"};function Ie(e,o,s,i,n,t){const a=b("keyboard"),r=b("navigation"),c=b("timeline-canvas"),p=b("metronom"),V=b("wb-env-molecule-footer");return m(),u("div",{class:k(["wb-disks-extras13-synthesizer-track",t.styleClasses])},[h("div",null,[h("div",null,[t.showKeyboard?(m(),u("div",Me,[y(a,T({disabled:i.trackPlayer.playing},t.keybordData,{onDown:t.onDownKeyboard,onUp:t.onUpKeyboard}),null,16,["disabled","onDown","onUp"]),i.hasMidi&&!n.midiControllerListener?(m(),u("div",{key:0,class:"midi-message",onClick:o[0]||(o[0]=(...f)=>t.onClickActivateMidi&&t.onClickActivateMidi(...f))},o[2]||(o[2]=[h("div",null,[h("div",null,[h("span",null,[x("Click here, or press "),h("strong",null,"Enter"),x(" to activate the Midi Keyboard!")])])],-1)]))):_("",!0)])):_("",!0)]),y(r,D(L(t.navigation)),null,16),h("div",Pe,[y(p,{model:i.metronom,onRender:t.onRender,onReady:t.onReady,onValue:o[1]||(o[1]=f=>i.track.currentDuration=f)},{background:z(({onRefresh:f})=>[y(c,T(t.timelineCanvasData,{clickable:"",onRefresh:f,"onNote:click":t.onClickNote}),null,16,["onRefresh","onNote:click"])]),_:1},8,["model","onRender","onReady"])]),h("div",Oe,[y(r,D(L(t.metronomNavigation)),null,16)])]),y(V,T(t.footer,{"parent-layout":n.windowsModule.contentWrapper.layout}),null,16,["parent-layout"])],2)}const Nt=w(Ae,[["render",Ie],["__scopeId","data-v-389ddc9c"]]);export{Nt as default};
