import{C as Y}from"./BJmh0rUk.js";import{p as ne,a as d,b as w,m as c}from"./ClLpnmyR.js";import{d as V}from"./DeEbP9sG.js";import{W as re}from"./BJC40ZHD.js";import{u as ie}from"./JsFOm8c5.js";import{a as ae,M as le}from"./C1NPf192.js";import ce from"./Cva1neKf.js";import{N as ue,u as me}from"./at3Qp1uu.js";import{V as de,a as he,n as pe,h as ye,N as oe}from"./ehWpBOkw.js";import{T as fe,r as ke,c as x}from"./Ds-AH-SM.js";import{g as ge,c as be,I as ve}from"./B1Xgq4rl.js";import{g as Ce,c as Ne}from"./65p4Y1AH.js";import{D as we}from"./Bwr9avpB.js";import{O as B,d as Te,r as D,k as E,o as _e,y as h,z as p,A as f,X as $,Y as H,Z as q,$ as O,I as _,B as Z,_ as se,g as A,C as T,P as L,E as U,S as F,ac as z,D as Se,af as j,a0 as Re,L as K}from"./BkRx7U8b.js";import{T as Ee}from"./CN_ZUaAL.js";import{i as W}from"./OlYXjGCK.js";import{T as G}from"./Bg2SjdcQ.js";import{S as M}from"./B9nPFJJ2.js";import{o as Ae,n as Ie,S as X}from"./Wv4Ty0OG.js";import{f as P}from"./C723tzWh.js";import{c as J}from"./CVx03s7S.js";import{i as Me}from"./OAVrZOa6.js";import{t as Q}from"./CcuCSIbb.js";import"./BTMT_sH9.js";import"./Ds4KxLLa.js";import"./B4rpyJsK.js";import"./CL1V9BUB.js";import"./D4lI5vpz.js";import"./CtlMGvom.js";import"./D4b9WN8K.js";import"./KQEr41HO.js";import"./CuTSLZpO.js";import"./CoWiVqj-.js";import"./BQm3Nqs0.js";import"./CV0dHcg-.js";import"./CaAbksje.js";import"./BoZA8JgY.js";import"./Br3o2oUw.js";import"./CxKYomUj.js";import"./Dql81Gm-.js";import"./B3Wmi0DA.js";import"./D7YMvfqk.js";import"./CNkvSXuu.js";import"./Bjf3RcYt.js";import"./Gl1UmUM-.js";import"./312NxIbt.js";function ee(t){return Ae(function(e,s){var o=!1,r=null,n=null,i=function(){if(n?.unsubscribe(),n=null,o){o=!1;var a=r;r=null,s.next(a)}};e.subscribe(J(s,function(a){n?.unsubscribe(),o=!0,r=a,n=J(s,i,Ie),Me(t(a)).subscribe(n)},function(){i(),s.complete()},void 0,function(){r=n=null}))})}class Pe{track;playing=!1;currentSequence;autoplay;instrument;instruments=[];sequenceNoteIndex={};instrumentIndex=-1;constructor(e,s){const{autoplay:o}=s||{};if(!(e instanceof fe))throw new Error("TrackPlayer requires a Track");this.track=e,this.autoplay=o!==void 0?o:!0}createInstrument(){this.instrument?.dispose(),this.instrument=te(this.track.type)}refresh(){const e=this.track.notes;return this.createSequence(e,()=>{console.log("complete"),this.clearSequence(),this.playing=!1}),e}play(){if(!this.track.type)throw new Error("TrackPlayer requires an instrument");if(this.refresh(),!this.currentSequence)throw new Error("TrackPlayer requires a sequence");return this.autoplay&&(this.currentSequence.start(0),this.playing=!0),this.currentSequence}pause(){this.instruments.forEach(e=>e.context.transport.pause()),this.playing=!1}stop(){this.clearSequence(),this.playing=!1}restart(){this.stop(),this.play()}reset(){this.clearSequence(),this.stop(),this.track.notes=[]}destroy(){this.instrument?.dispose(),this.instruments.forEach(e=>e.dispose()),this.clearSequence()}triggerAttack(e){this.instrumentIndex++,this.getInstrument().triggerAttack(e)}triggerRelease(){this.getInstrument().triggerRelease(),this.instrumentIndex--}triggerAttackRelease(e){this.instrumentIndex++,console.log("triggerAttackRelease",this.instrumentIndex,e.getName(),e.getTime(),e.delay,(e.delay+e.toSeconds())*1e3),window.setTimeout(()=>{console.log("fertig"),this.instrumentIndex--},(e.delay+e.toSeconds())*1e3);const s=e.getName(),o=e.getTime();if(!s)throw new Error("Note name is required");if(!o)throw new Error("Note time is required");this.getInstrument().triggerAttackRelease(s,o,e.delay)}getInstrument(){return this.instrumentIndex>this.instruments.length-1&&this.instruments.push(te(this.track.type)),this.instruments[this.instrumentIndex]}createSequence(e,s){if(!this.currentSequence)this.currentSequence=B(new Oe(e,(o,r,n,i)=>{console.log(o),this.triggerAttackRelease(o),this.sequenceNoteIndex={...this.sequenceNoteIndex,[Number(r)]:i[n].index},n===i.length-1&&Reflect.deleteProperty(this.sequenceNoteIndex,r)},s!==void 0?s:void 0));else throw new Error("TrackPlayer already has a sequence")}clearSequence(){this.currentSequence?.dispose(),this.currentSequence=void 0}}class Oe{startTime=0;sequenceMap=new Map;onTick;onComplete;notes;constructor(e,s,o){this.onTick=s,this.onComplete=o,this.notes=e}async start(e=0){const s=he;s.stop(),s.seconds=0,s.start(),this.startTime=pe();const o=this.sequenceMap,r=Promise.all(Object.entries(xe(this.notes)).map(([,n])=>{const i=n.map((a,k)=>{const m=`${k}_${a.getTime()}`,{notes:N,part:y,complete:I}=o.get(m)||(()=>{const S=[];let b=0;const l=new we,v=new ye((...u)=>{this.onTick(new oe({delay:u[0],note:u[1],time:a.getTime()}),k,b,S),b++,b>v.length-1&&l.resolve()},[]);return{notes:S,part:v,complete:l.promise}})();return o.set(m,{notes:N,part:y,complete:I}),y.add(a.delay,a.getName()),N.push(a),{notes:N,part:y,complete:I}});return Promise.all(i.map(({complete:a})=>a))}));return Array.from(o.values()).forEach(({part:n})=>{n.start(e)}),await r,this.onComplete?.(),r}pause(){Array.from(this.sequenceMap.values()).forEach(({part:e})=>{e.pause()})}cancel(){Array.from(this.sequenceMap.values()).forEach(({part:e})=>{e.cancel()})}stop(){Array.from(this.sequenceMap.values()).forEach(({part:e})=>{e.stop()})}dispose(){Array.from(this.sequenceMap.values()).forEach(({part:e})=>{e.dispose()})}}function te(t){const e=Ce(t),s=new de(-100).toDestination(),o=new e().connect(s).toDestination();return B(o)}function xe(t){return t.reduce((e,s)=>(e[s.delay]=e[s.delay]||[],e[s.delay].push(s),e),{})}const De=["disabled"],qe={class:"keys white"},Le=["onMouseout","onPointerdown","onPointerup"],Ke={key:0},Be={key:0},Ye={class:"keys black"},Ve=["onMouseout","onPointerdown","onPointerup"],$e={key:0},He={key:0},Ze=9,Ue=Te({__name:"Keyboard",props:{disabled:{type:Boolean,default:!1},selectedNotes:{type:Array,default:null},size:{type:String,validator:t=>["small","medium","large"].includes(t),default:"large"},showNoteLabels:{type:Boolean,default:!1},startOctave:{type:Number,default:4},octaveCount:{type:Number,default:6}},emits:["down","up"],setup(t,{emit:e}){const s=D(),o=t,r=e,n=D([]),i=D(W(0,0)),a=E(()=>Array.from(new Set(o.selectedNotes.map(l=>ke(l.getName()||"")).flat()))),k=E(()=>({small:96,medium:96*1.5,large:96*2})[o.size]),m=E(()=>{const l=[],v=["c","c#","d","d#","e","f","f#","g","g#","a","a#","b"];for(let u=0;u<o.octaveCount;u++)l.push(...v.map(g=>{const C=`${g}${o.startOctave+u}`;return{note:C,black:I(C)}}));return o.startOctave+o.octaveCount<=Ze&&l.push({note:v[0]+(o.startOctave+o.octaveCount),black:!1}),l}),N=E(()=>({disabled:o.disabled})),y=E(()=>({...i.value.toCSSVars("dimension"),"--height":k.value,"--keys":m.value.filter(({black:l})=>!l).length,"--white-keys":m.value.filter(({black:l})=>!l).length,"--black-keys":m.value.filter(({black:l})=>l).length}));_e(()=>{i.value=W(s.value?.offsetWidth||0,0)});function I(l){return/^[a-z]#\d+/.test(l)}function S(l){o.disabled||(n.value.push(l),r("down",l))}function b(l){!o.disabled&&n.value.includes(l)&&(r("up",l),n.value=n.value.filter(v=>v!==l))}return(l,v)=>(p(),h("div",{ref_key:"rootEl",ref:s,style:q(y.value),class:O([N.value,"wb-disks-synthesizer-keyboard"]),disabled:t.disabled},[f("div",null,[f("div",qe,[(p(!0),h($,null,H(m.value,({note:u,black:g},C)=>(p(),h("div",{key:C,class:O(["key",{black:g,white:!g,selected:a.value.includes(u.toLowerCase())}]),style:q({"--index":C}),onMouseout:R=>b(u),onPointerdown:R=>S(u),onPointerup:R=>b(u)},[g?_("",!0):(p(),h("span",Ke,[t.showNoteLabels?(p(),h("i",Be,Z(u),1)):_("",!0)]))],46,Le))),128))]),f("div",Ye,[(p(!0),h($,null,H(m.value,({note:u,black:g},C)=>(p(),h("div",{key:C,class:O(["key",{black:g,white:!g,selected:a.value.includes(u.toLowerCase())}]),style:q({"--index":C}),onMouseout:R=>b(u),onPointerdown:R=>S(u),onPointerup:R=>b(u)},[g?(p(),h("span",$e,[t.showNoteLabels?(p(),h("i",He,Z(u),1)):_("",!0)])):_("",!0)],46,Ve))),128))])])],14,De))}}),Fe=se(Ue,[["__scopeId","data-v-6b0fd527"]]),ze={components:{TimelineCanvas:Ee,Navigation:ue,Metronom:ae,Keyboard:Fe,WbEnvFragmentFooter:re},props:{model:{type:Object,default:be()},trackModel:{type:Object,default:ge()},toneDestination:{type:Object,default:null}},emits:["refresh"],async setup(t){const e=j(t,"model"),s=j(t,"trackModel"),o=ie();Re(e,()=>{o.setContextMenu(Ne,{model:e.value,trackModel:s.value,preserveContextMenu:o.preserveContextMenu})},{immediate:!0,deep:!0});const r=K(s.value[c.SYNTHESIZER_TRACK]);console.log("track",r);const n=K(new le(r)),i=K(new Pe(r));console.log("trackPlayer",i);const a=await me(),k=new ce;await k.start();const m=k.hasInputs;return{...o,...a,metronom:n,track:r,trackPlayer:i,midiController:k,hasMidi:m}},data(){return{windowsModule:B(this.core.modules.windows),duration:0,subscriptions:new X,midiControllerListener:null,openNotes:new Map,footerModel:{}}},computed:{styleClasses(){return{[`keyboard-align-${this.trackModel[c.SYNTHESIZER_TRACK_KEYBOARD_ALIGN]}`]:!0}},showKeyboard(){return this.trackModel[c.SYNTHESIZER_TRACK_SHOW_KEYBOARD]},inputNote(){return this.trackModel[c.SYNTHESIZER_TRACK_INPUT_NOTE]},bpm(){return Number(this.model[c.SYNTHESIZER_BPM])},trackPlayerIndex(){return Object.values(this.trackPlayer.sequenceNoteIndex).flat()},selectedNotes(){return this.track.notes.filter(t=>Object.values(this.trackPlayer.sequenceNoteIndex).flat().includes(t.index))},timelineCanvasData(){return{track:this.track,duration:this.metronom.getDuration()}},keybordData(){return{size:this.trackModel[c.SYNTHESIZER_TRACK_KEYBOARD_SIZE],showNoteLabels:this.trackModel[c.SYNTHESIZER_TRACK_SHOW_NOTE_LABELS],startOctave:this.trackModel[c.SYNTHESIZER_TRACK_START_OCTAVE],octaveCount:this.trackModel[c.SYNTHESIZER_TRACK_OCTAVE_COUNT],selectedNotes:this.selectedNotes}},metronomNavigation(){return{modelValue:this.metronom,"onUpdate:model-value":({name:t,value:e})=>{debugger;this.metronom[String(t)]=e},items:[[{icon:"skipPrev",label:"Prev Beat",hideLabel:!0,disabled:this.metronom.value===0,action:()=>{this.metronom.reset()}},{icon:"doublePrev",label:"Prev Beat",hideLabel:!0,disabled:Math.floor(this.metronom.currentBeat/2)===0,action:()=>{this.metronom.prevBeat()}},{icon:"prev",label:"Prev",hideLabel:!0,disabled:this.metronom.value===0,action:()=>{this.metronom.prev()}},{icon:"reset",iconAlign:"right",label:"Next",disabled:this.metronom.value/2-Math.floor(this.metronom.currentBeat)===0,hideLabel:!0,action:()=>{this.metronom.setBeat(this.metronom.currentBeat)}},{icon:"next",iconAlign:"right",label:"Next",hideLabel:!0,action:()=>{this.metronom.next()}},{icon:"doubleNext",label:"Next Beat",hideLabel:!0,action:()=>{this.metronom.nextBeat()}},{spacer:!0},{text:`Duration: ${this.metronom.value.toFixed(2)}`},{text:`Beat: ${this.metronom.currentBeat}-${this.metronom.currentBeat+this.metronom.beatCount}`}],[...x().map(([t])=>({label:`1/${t.replace(/(\d+)[nm]/,"$1")} n`,name:"time",value:t})),{spacer:!0}]]}},navigation(){return{model:this.trackModel,items:[[{text:"Input:"},{label:"Note",value:"note",name:c.SYNTHESIZER_TRACK_INPUT},{label:"Pause",value:"pause",name:c.SYNTHESIZER_TRACK_INPUT,disabled:!0},{spacer:!0},{label:"Remove Note",action:()=>{this.track.removeNote(this.track.selectedIndex)}},{label:"Clean Range",action:()=>{this.track.removeNotesByDurationRange(this.metronom.getDuration(),this.metronom.timeDuration)}},{label:"Clean Beat",action:()=>{this.track.removeNotesFromBeat(this.track.getBeatIndex())}},{label:"Reset",action:()=>{this.reset()}}],[{text:"Note:&nbsp;"},{label:"Auto",value:"",name:c.SYNTHESIZER_TRACK_INPUT_NOTE},...x().map(([t])=>({label:`1/${t.replace(/(\d+)[nm]/,"$1")} n`,name:c.SYNTHESIZER_TRACK_INPUT_NOTE,value:t})),{spacer:!0},this.trackPlayer.playing?{selected:!0,label:"Pause",icon:"pause",disabled:!this.trackPlayer.currentSequence||!this.trackPlayer.playing,onClick:()=>this.onClickPlause()}:{label:"Play",icon:"play",disabled:this.trackPlayer.playing||this.track.notes.length===0,onClick:()=>this.onClickPlay()},{label:"Stop",icon:"stop",disabled:!this.trackPlayer.currentSequence,onClick:()=>this.onClickStop()},{label:"Restart",disabled:this.track.selectedIndex>-1,onClick:()=>this.onClickRestart()}]]}},footerData(){const t=this.track,e=this.trackModel,s=t.getDuration().toFixed(2);return{items:ne([new d({options:{disabled:!this.hasMidi},title:`MIDI (${this.midiController.input?this.midiController.input.name:"OFF"})`,action:async()=>{this.midiControllerListener||await this.registerMidiListener()},items:this.midiController.ready&&this.midiControllerListener?[new d({title:"Inputs",items:this.midiController.inputs.map((o,r)=>({title:o.name,model:this.midiController,name:"activeInput",type:w.RADIO,value:o.id,action:async()=>{await this.registerMidiListener(this.midiController.listen(r))}}))}),new d({title:"Input Channel",items:Array(16).fill(null).map((o,r)=>({title:String(r+1),value:r+1,type:w.RADIO,model:this.midiController,name:"inputChannel",action:async()=>{await this.registerMidiListener(this.midiController.listen(this.midiController.input))}}))}),new d({title:"Outputs",items:this.midiController.outputs.map(o=>({title:o.name,model:this.midiController,name:"activeOutput",type:w.RADIO,value:o.id,action(){}}))}),new M,new d({title:"Disconnect",action:()=>{this.midiControllerListener?.unsubscribe(),this.midiControllerListener=null,this.midiController.unlisten()}})]:[]}),new M,new d({title:`Instr.: ${this.track.type}`,items:Object.values(ve).map(o=>new d({type:w.RADIO,title:o,model:t,name:"type",value:o}))}),new M,new d({title:`Octave: ${e[c.SYNTHESIZER_TRACK_START_OCTAVE]}-${e[c.SYNTHESIZER_TRACK_START_OCTAVE]+e[c.SYNTHESIZER_TRACK_OCTAVE_COUNT]-1}`,items:[new d({title:"Start Octave",items:Array(9).fill({}).map((o,r)=>new d({type:w.RADIO,title:String(r+1),model:e,name:c.SYNTHESIZER_TRACK_START_OCTAVE,value:r+1,action(n){n=Number(n),n+e[c.SYNTHESIZER_TRACK_OCTAVE_COUNT]>9&&(e[c.SYNTHESIZER_TRACK_OCTAVE_COUNT]=10-n)}}))}),new d({title:"Octave Count",items:Array(10-e[c.SYNTHESIZER_TRACK_START_OCTAVE]).fill({}).map((o,r)=>new d({type:w.RADIO,title:String(r+1),model:e,name:c.SYNTHESIZER_TRACK_OCTAVE_COUNT,value:r+1}))})]}),new M,new G({text:`BPM: ${this.bpm}`}),new G({text:`Dur.: ${s}`})])}}},watch:{"track.beatCount"(t){this.metronom.beatCount=t}},mounted(){console.log("TRACK",this.track),this.subscriptions.add(V.keyDown.pipe(ee(()=>Q(100)),P(t=>t.key==="Enter")).subscribe(()=>{this.onClickActivateMidi()})),this.subscriptions.add(V.keyDown.pipe(ee(()=>Q(100))).subscribe(t=>{switch(t.code){case"ArrowLeft":this.metronom.prev();break;case"ArrowRight":this.metronom.next();break;case"ArrowUp":this.metronom.prevBeat();break;case"ArrowDown":this.metronom.nextBeat();break;default:if(/Digit(\d+)/.test(t.code)){const e=t.code.replace(/Digit(\d+)/,"$1"),s=x()[e-1];s&&(this.metronom.time=s[0])}break}console.log(t)})),this.$nextTick(()=>{this.$emit("refresh")})},unmounted(){this.subscriptions.unsubscribe(),this.midiController.destroy()},methods:{async registerMidiListener(t){try{await this.midiController.start();const e=this.midiController.listen(t>-1&&this.midiController.inputs[t]||this.midiController.inputs[0]);this.midiControllerListener?.unsubscribe(),this.midiControllerListener=new X,this.midiControllerListener.add(e.pipe(P(({type:s})=>s==="noteOn")).subscribe(this.onNoteOn.bind(this)),e.pipe(P(({type:s})=>s==="noteOff")).subscribe(this.onNoteOff.bind(this)),e.pipe(P(({type:s})=>s==="volume")).subscribe(({value:s})=>{console.log("Volume: ",s),this.core.config.set(Y.SCREEN_CONFIG,{...this.core.config.get(Y.SCREEN_CONFIG),soundVolume:s})}))}catch(e){console.warn(e)}},async setup(){this.tone.ready||(await this.tone.start(),this.trackPlayer.createInstrument())},onReady({render:t}){this._render=t},onRender(t,{position:e,dimension:s}){if(this.inputNote==="auto"){const o=Array.from(this.openNotes.values());for(let r=0;r<o.length;r++){const n=o[Number(r)],a=(this.metronom.now()-n)/1e3/(this.metronom.speed*2)*s.x/this.track.beatCount;t.fillRect(e.x,e.y,a,s.y)}}},async onNoteOn({value:t}){await this.setup();const e=t.identifier;console.log("value.identifier",e,this.metronom.getDuration()),this.startNote(e),this.trackPlayer.triggerAttack(e)},async onNoteOff({value:t}){this.endNote(t.identifier),await this.tone.ready,this.trackPlayer.triggerRelease()},startNote(t){this.animationLoop||(this.animationLoop=je(()=>{this._render&&this._render()})),this.openNotes.set(t,this.metronom.now())},endNote(t){const e=[1,2,4,8,16,32].map(i=>[`${i}n`,`${i}t`,`${i}n.`]).flat().map(i=>[i,new(this.tone.getTone()).Time(i).toSeconds()]).sort((i,a)=>a[1]-i[1]),s=Math.max((this.metronom.now()-this.openNotes.get(t))/1e3,e[e.length-1][1]);this.openNotes.delete(t);const{Time:o}=this.tone.getTone();let r;this.inputNote?r=new o(this.inputNote):r=new o(e.map(([,i])=>i).find(i=>{const a=i*.2;return i-a<=s&&s<=i+a}));const n=this.metronom.getDuration();console.log({delay:n,name:t,time:r.toNotation()}),this.track.addNote(new oe({delay:n,name:t,time:r.toNotation()})),this.openNotes.size<1&&(this.animationLoop?.stop(),this.animationLoop=null)},async onClickNote({note:t,selected:e}){await this.setup(),e&&t.getName()&&this.trackPlayer.triggerAttackRelease(t)},async onClickPlay(){await this.setup(),this.trackPlayer.play()},onClickPlause(){this.trackPlayer.pause()},onClickStop(){this.trackPlayer.stop()},onClickRestart(){this.trackPlayer.restart()},async onDownKeyboard(t){await this.setup(),this.startNote(t),this.trackPlayer.triggerAttack(t)},async onUpKeyboard(t){await this.tone.awaitReady,this.endNote(t),this.trackPlayer.triggerRelease()},reset(){this.track.reset()},onClickActivateMidi(){this.registerMidiListener()}}};function je(t){let e=0,s=0,o=!1;const r=n=>{const i=n-e;e=n,s+=i,t(n,s),o||requestAnimationFrame(r)};return requestAnimationFrame(r),{stop:()=>o=!0}}const We={key:0,class:"keyboard"},Ge={class:"sheet"},Xe={class:"panel"};function Je(t,e,s,o,r,n){const i=A("keyboard"),a=A("navigation"),k=A("timeline-canvas"),m=A("metronom"),N=A("wb-env-fragment-footer");return p(),h("div",{class:O(["wb-disks-extras13-synthesizer-track",n.styleClasses])},[f("div",null,[f("div",null,[n.showKeyboard?(p(),h("div",We,[T(i,L({disabled:o.trackPlayer.playing},n.keybordData,{onDown:n.onDownKeyboard,onUp:n.onUpKeyboard}),null,16,["disabled","onDown","onUp"]),o.hasMidi&&!r.midiControllerListener?(p(),h("div",{key:0,class:"midi-message",onClick:e[0]||(e[0]=(...y)=>n.onClickActivateMidi&&n.onClickActivateMidi(...y))},e[2]||(e[2]=[f("div",null,[f("div",null,[f("span",null,[U("Click here, or press "),f("strong",null,"Enter"),U(" to activate the Midi Keyboard!")])])],-1)]))):_("",!0)])):_("",!0)]),T(a,F(z(n.navigation)),null,16),f("div",Ge,[T(m,{model:o.metronom,onRender:n.onRender,onReady:n.onReady,onValue:e[1]||(e[1]=y=>o.track.setCurrentDuration(y))},{background:Se(({onRefresh:y})=>[T(k,L(n.timelineCanvasData,{clickable:"",onRefresh:y,"onNote:click":n.onClickNote}),null,16,["onRefresh","onNote:click"])]),_:1},8,["model","onRender","onReady"])]),f("div",Xe,[T(a,F(z(n.metronomNavigation)),null,16)])]),T(N,L(n.footerData,{"parent-layout":r.windowsModule.contentWrapper.layout}),null,16,["parent-layout"])],2)}const Ut=se(ze,[["render",Je],["__scopeId","data-v-78cd972e"]]);export{Ut as default};
