var e=Object.defineProperty,__publicField=(t,n,o)=>((t,n,o)=>n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[n]=o)(t,"symbol"!=typeof n?n+"":n,o);import{I as t,a as n,C as o}from"./BdLbwnUH.js";import{T as l,C as a}from"./CJFEEUyp.js";import{m as r,n as s,u}from"./BSzGBLGV.js";import{E as i}from"./CEDL6M7l.js";import{K as m}from"./Cy0zoxeo.js";import{u as c}from"./Dkhtr-D7.js";import{d,r as p,O as v,L as f,k as h,a0 as y,o as C,U as g,a1 as w,W as j,y as A,z as I,A as S,C as O,G as R,$ as b,_ as T}from"./BfpYGSxR.js";import"./C98WWl5r.js";import"./CVVDEXDJ.js";import"./D1WZfvAb.js";import"./jSR9Z_uS.js";import"./BHmTNEz3.js";import"./D3MPJlJW.js";import"./B-meQdOw.js";import"./D7Us3e3D.js";import"./CrNGlbV0.js";import"./CxZzHJhT.js";import"./DdO-3S9B.js";import"./B1k18Rg6.js";import"./CIasQYz1.js";import"./Caivkp23.js";import"./DL1FsYWj.js";import"./tbUmQ5LT.js";import"./D3xLGof4.js";import"./N5kgPtk_.js";import"./B15fucc8.js";import"./CJYzpMQ6.js";import"./I81pZH22.js";import"./CV0dHcg-.js";class ConsoleLogger extends t{constructor(e={}){const{onAdd:t}={onAdd:null,...e};super(e),__publicField(this,"onAdd"),this.onAdd=t||(()=>{})}add(e,t){let n="",o=!1;"string"==typeof e&&r(e)?o=!0:(e instanceof l&&(n=e.toColumnify().split(/\n/g)),"string"==typeof e&&s(e)&&(n=u(e))),"string"==typeof e&&/^> \w+/.test(e)?this.onAdd(e,t):(o||n.length)&&this.onAdd(n,t)}}const E={class:"wrapper"},L={class:"input"},_=["innerHTML"],N=T(d({__name:"Console",props:{rootElement:{type:HTMLElement,default:()=>null},showIntroduction:{type:Boolean,default:()=>!1},delimiterPrefix:{type:String,default:"1.SYS"},readonly:{type:Boolean,default:!1},startCommands:{type:[Array,String],default:null},preRows:{type:Array,default:()=>[]}},emits:["freeze","unfreeze","startCommandsComplete","refresh"],setup(e,{emit:t}){const{window:l,core:r,parentFocused:s,parentLayout:u}=c();let d=1;const T=p(null),N=p(null),k=p(null),M=p(null),U=e,x=t,D=v(new n);D.add([new a({name:["CLS","CLEAR"],action(){!function clearConsole(){H.value=K.value.length,render()}()}})]);const P=p(v(new ConsoleLogger({core:r,consoleInterface:new o,onAdd:onAdd}))),W=p({value:"",focused:!1}),z=p([]),B=p(0),H=p(0),K=p([`[CLI ${d}]`]),$=p(-1),V=p(18),F=p({value:U.delimiterPrefix,prompt:!1,confirm:!1}),G=p(null),J=p(null),Y=p(null),q=p(!1),Q=f({show:!0,logger:P,showCommand:!0,commandBucket:D}),X=h(()=>({"js--prompt":Y.value,"js--focused":s.value})),Z=h(()=>{let e=F.value.value;const{confirm:t,prompt:n}=F.value;return t?e="(y/n) ?":n?e="?":e&&(e=`${e}:&gt`),e&&(e=`${e}&nbsp;`),e}),ee=h(()=>u.value.size);let te;function onUpdateModelValue(e){W.value.value=e}async function enter(e,t){$.value=-1,B.value=0,H.value=0,x("freeze");const n=await r.executeCommand(e,{...Q,...t});!n||"number"!=typeof n&&"string"!=typeof n||onAdd(n),x("unfreeze"),render(),refresh(!0)}function render(){if(T.value&&N.value){N.value.innerHTML="";const e=Math.floor(T.value.offsetHeight/V.value)-2;let t=0;for(;B.value+t<B.value+e;){const n=K.value[Math.max(K.value.length-e-B.value,0)+t];if(void 0===n)break;{const e=document.createElement("li");e.innerHTML=String(n).replace(/[\\]?\\n/,"<br>")+"\n",N.value.appendChild(e)}t++}}}function refresh(e){w(()=>{e&&(q.value={scroll:!0},x("refresh",q.value),w(()=>{q.value=null}))})}function setDelimiter(e,t=!1,n=!1){F.value={...F,value:e,prompt:t,confirm:n}}function onAdd(e){const t=[];Array.isArray(e)?t.push(...e):t.push(String(e)),K.value.push(...t),render()}function onClick(){W.value.focused=!0}function onInputEnter(e){return z.value[z.value.length-1]!==e&&z.value.push(e),W.value.value="",enter(e)}function onInputBlur(){W.value.focused=!1,refresh(),l.unfocus()}function onInputKeydown(e){var t,n;const o=e.code;let l=!1;if(!(null==(t=M.value)?void 0:t.controlCapsLockActive)&&!(null==(n=M.value)?void 0:n.controlShiftActive)||o!==m.ARROW_UP&&o!==m.ARROW_DOWN){switch(o){case m.ARROW_UP:$.value++,$.value=Math.min($.value,z.value.length-1),l=!0;break;case m.ARROW_DOWN:$.value--,$.value=Math.max($.value,-1),l=!0}if(l&&z.value.length>0){let e;e=$.value<0?"":z.value[z.value.length-1-$.value],W.value.value=e}refresh()}else e.preventDefault(),function moveRows(e){let t=!1;e?H.value>0?(H.value=0,t=!0):B.value<K.value.length&&(B.value++,t=!0):B.value>0&&(B.value--,t=!0),t&&render()}(o===m.ARROW_UP)}return y(()=>ee.value,()=>{window.clearTimeout(te),te=window.setTimeout(()=>{render()},200)}),y(()=>G.value,()=>{setDelimiter({value:""})}),y(()=>J.value,()=>{setDelimiter({value:U.delimiterPrefix,confirm:J.value})}),y(()=>Y.value,()=>{setDelimiter({value:U.delimiterPrefix,prompt:Y.value})}),K.value.unshift(...U.preRows),C(async()=>{const e=g();if(e&&e.parent&&"console"in e.parent&&(e.parent.console=this),d++,U.showIntroduction){const e=function createInstruction(){var e;const t=["#basic","CLS",'PRINT "Scroll (Up/Down): <strong>Shift+Up</strong> / <strong>Shift+Down</strong>"','PRINT "Enter <strong>commands</strong> to show all commands."'];return null==(e=r.modules.files)?void 0:e.fs.createTmpFile("CONSOLE_INSTRUCTIONS.basic","CONSOLE_INSTRUCTIONS.basic",{type:"basic",content:t})}();e&&await e.then(()=>enter('basic "TMP:CONSOLE_INSTRUCTIONS.basic"',{showCommand:!1}))}w(async()=>{if(U.startCommands){const e=Array().concat(U.startCommands),run=e=>enter(e.shift()||"",{showCommand:!1}).then(()=>{if(e.length>0)return run(e)});await run(e),x("startCommandsComplete")}})}),j(()=>{d--}),(t,n)=>(I(),A("div",{ref_key:"rootEl",ref:T,class:b(["wb-env-console",X.value]),onClick:onClick},[S("div",E,[S("ul",{ref_key:"consoleOutputEl",ref:N,class:"output typo-style"},null,512),S("div",L,[S("span",{ref_key:"consoleCommandDelimiterEl",ref:k,class:"prefix",innerHTML:Z.value},null,8,_),O(i,{ref_key:"inputEl",ref:M,"root-element":e.rootElement||t.$el,class:"element",multiline:!1,"override-focused":R(s),readonly:e.readonly,"model-value":W.value.value,onBlur:onInputBlur,"onUpdate:modelValue":onUpdateModelValue,onEnter:onInputEnter,onKeydown:onInputKeydown},null,8,["root-element","override-focused","readonly","model-value"])])])],2))}}),[["__scopeId","data-v-20124ac2"]]);export{N as default};
