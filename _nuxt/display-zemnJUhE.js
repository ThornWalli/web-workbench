var po=Object.defineProperty;var yo=(I,k,W)=>k in I?po(I,k,{enumerable:!0,configurable:!0,writable:!0,value:W}):I[k]=W;var S=(I,k,W)=>yo(I,typeof k!="symbol"?k+"":k,W);(function(){"use strict";var I=function(e,t){return I=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,n){r.__proto__=n}||function(r,n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(r[o]=n[o])},I(e,t)};function k(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");I(e,t);function r(){this.constructor=e}e.prototype=t===null?Object.create(t):(r.prototype=t.prototype,new r)}function W(e,t,r,n){function o(i){return i instanceof r?i:new r(function(s){s(i)})}return new(r||(r=Promise))(function(i,s){function a(l){try{c(n.next(l))}catch(f){s(f)}}function u(l){try{c(n.throw(l))}catch(f){s(f)}}function c(l){l.done?i(l.value):o(l.value).then(a,u)}c((n=n.apply(e,t||[])).next())})}function pe(e,t){var r={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},n,o,i,s=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return s.next=a(0),s.throw=a(1),s.return=a(2),typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function a(c){return function(l){return u([c,l])}}function u(c){if(n)throw new TypeError("Generator is already executing.");for(;s&&(s=0,c[0]&&(r=0)),r;)try{if(n=1,o&&(i=c[0]&2?o.return:c[0]?o.throw||((i=o.return)&&i.call(o),0):o.next)&&!(i=i.call(o,c[1])).done)return i;switch(o=0,i&&(c=[c[0]&2,i.value]),c[0]){case 0:case 1:i=c;break;case 4:return r.label++,{value:c[1],done:!1};case 5:r.label++,o=c[1],c=[0];continue;case 7:c=r.ops.pop(),r.trys.pop();continue;default:if(i=r.trys,!(i=i.length>0&&i[i.length-1])&&(c[0]===6||c[0]===2)){r=0;continue}if(c[0]===3&&(!i||c[1]>i[0]&&c[1]<i[3])){r.label=c[1];break}if(c[0]===6&&r.label<i[1]){r.label=i[1],i=c;break}if(i&&r.label<i[2]){r.label=i[2],r.ops.push(c);break}i[2]&&r.ops.pop(),r.trys.pop();continue}c=t.call(e,r)}catch(l){c=[6,l],o=0}finally{n=i=0}if(c[0]&5)throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}function ft(e){var t=typeof Symbol=="function"&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&typeof e.length=="number")return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function ht(e,t){var r=typeof Symbol=="function"&&e[Symbol.iterator];if(!r)return e;var n=r.call(e),o,i=[],s;try{for(;(t===void 0||t-- >0)&&!(o=n.next()).done;)i.push(o.value)}catch(a){s={error:a}}finally{try{o&&!o.done&&(r=n.return)&&r.call(n)}finally{if(s)throw s.error}}return i}function vt(e,t,r){if(r||arguments.length===2)for(var n=0,o=t.length,i;n<o;n++)(i||!(n in t))&&(i||(i=Array.prototype.slice.call(t,0,n)),i[n]=t[n]);return e.concat(i||Array.prototype.slice.call(t))}function K(e){return this instanceof K?(this.v=e,this):new K(e)}function Ye(e,t,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=r.apply(e,t||[]),o,i=[];return o=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),a("next"),a("throw"),a("return",s),o[Symbol.asyncIterator]=function(){return this},o;function s(y){return function(E){return Promise.resolve(E).then(y,f)}}function a(y,E){n[y]&&(o[y]=function(h){return new Promise(function(R,$){i.push([y,h,R,$])>1||u(y,h)})},E&&(o[y]=E(o[y])))}function u(y,E){try{c(n[y](E))}catch(h){w(i[0][3],h)}}function c(y){y.value instanceof K?Promise.resolve(y.value.v).then(l,f):w(i[0][2],y)}function l(y){u("next",y)}function f(y){u("throw",y)}function w(y,E){y(E),i.shift(),i.length&&u(i[0][0],i[0][1])}}function tr(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t=e[Symbol.asyncIterator],r;return t?t.call(e):(e=typeof ft=="function"?ft(e):e[Symbol.iterator](),r={},n("next"),n("throw"),n("return"),r[Symbol.asyncIterator]=function(){return this},r);function n(i){r[i]=e[i]&&function(s){return new Promise(function(a,u){s=e[i](s),o(a,u,s.done,s.value)})}}function o(i,s,a,u){Promise.resolve(u).then(function(c){i({value:c,done:a})},s)}}typeof SuppressedError=="function"&&SuppressedError;function m(e){return typeof e=="function"}function ye(e){var t=function(n){Error.call(n),n.stack=new Error().stack},r=e(t);return r.prototype=Object.create(Error.prototype),r.prototype.constructor=r,r}var Ft=ye(function(e){return function(r){e(this),this.message=r?r.length+` errors occurred during unsubscription:
`+r.map(function(n,o){return o+1+") "+n.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=r}});function de(e,t){if(e){var r=e.indexOf(t);0<=r&&e.splice(r,1)}}var It=function(){function e(t){this.initialTeardown=t,this.closed=!1,this._parentage=null,this._finalizers=null}return e.prototype.unsubscribe=function(){var t,r,n,o,i;if(!this.closed){this.closed=!0;var s=this._parentage;if(s)if(this._parentage=null,Array.isArray(s))try{for(var a=ft(s),u=a.next();!u.done;u=a.next()){var c=u.value;c.remove(this)}}catch(h){t={error:h}}finally{try{u&&!u.done&&(r=a.return)&&r.call(a)}finally{if(t)throw t.error}}else s.remove(this);var l=this.initialTeardown;if(m(l))try{l()}catch(h){i=h instanceof Ft?h.errors:[h]}var f=this._finalizers;if(f){this._finalizers=null;try{for(var w=ft(f),y=w.next();!y.done;y=w.next()){var E=y.value;try{ge(E)}catch(h){i=i??[],h instanceof Ft?i=vt(vt([],ht(i)),ht(h.errors)):i.push(h)}}}catch(h){n={error:h}}finally{try{y&&!y.done&&(o=w.return)&&o.call(w)}finally{if(n)throw n.error}}}if(i)throw new Ft(i)}},e.prototype.add=function(t){var r;if(t&&t!==this)if(this.closed)ge(t);else{if(t instanceof e){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._finalizers=(r=this._finalizers)!==null&&r!==void 0?r:[]).push(t)}},e.prototype._hasParent=function(t){var r=this._parentage;return r===t||Array.isArray(r)&&r.includes(t)},e.prototype._addParent=function(t){var r=this._parentage;this._parentage=Array.isArray(r)?(r.push(t),r):r?[r,t]:t},e.prototype._removeParent=function(t){var r=this._parentage;r===t?this._parentage=null:Array.isArray(r)&&de(r,t)},e.prototype.remove=function(t){var r=this._finalizers;r&&de(r,t),t instanceof e&&t._removeParent(this)},e.EMPTY=function(){var t=new e;return t.closed=!0,t}(),e}();It.EMPTY;function me(e){return e instanceof It||e&&"closed"in e&&m(e.remove)&&m(e.add)&&m(e.unsubscribe)}function ge(e){m(e)?e():e.unsubscribe()}var er={Promise:void 0},rr={setTimeout:function(e,t){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];return setTimeout.apply(void 0,vt([e,t],ht(r)))},clearTimeout:function(e){return clearTimeout(e)},delegate:void 0};function Se(e){rr.setTimeout(function(){throw e})}function we(){}function nr(e){e()}var Vt=function(e){k(t,e);function t(r){var n=e.call(this)||this;return n.isStopped=!1,r?(n.destination=r,me(r)&&r.add(n)):n.destination=sr,n}return t.create=function(r,n,o){return new Pt(r,n,o)},t.prototype.next=function(r){this.isStopped||this._next(r)},t.prototype.error=function(r){this.isStopped||(this.isStopped=!0,this._error(r))},t.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this),this.destination=null)},t.prototype._next=function(r){this.destination.next(r)},t.prototype._error=function(r){try{this.destination.error(r)}finally{this.unsubscribe()}},t.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},t}(It),or=function(){function e(t){this.partialObserver=t}return e.prototype.next=function(t){var r=this.partialObserver;if(r.next)try{r.next(t)}catch(n){bt(n)}},e.prototype.error=function(t){var r=this.partialObserver;if(r.error)try{r.error(t)}catch(n){bt(n)}else bt(t)},e.prototype.complete=function(){var t=this.partialObserver;if(t.complete)try{t.complete()}catch(r){bt(r)}},e}(),Pt=function(e){k(t,e);function t(r,n,o){var i=e.call(this)||this,s;return m(r)||!r?s={next:r??void 0,error:n??void 0,complete:o??void 0}:s=r,i.destination=new or(s),i}return t}(Vt);function bt(e){Se(e)}function ir(e){throw e}var sr={closed:!0,next:we,error:ir,complete:we},Ht=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}();function ve(e){return e}function cr(e){return e.length===0?ve:e.length===1?e[0]:function(r){return e.reduce(function(n,o){return o(n)},r)}}var T=function(){function e(t){t&&(this._subscribe=t)}return e.prototype.lift=function(t){var r=new e;return r.source=this,r.operator=t,r},e.prototype.subscribe=function(t,r,n){var o=this,i=ar(t)?t:new Pt(t,r,n);return nr(function(){var s=o,a=s.operator,u=s.source;i.add(a?a.call(i,u):u?o._subscribe(i):o._trySubscribe(i))}),i},e.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(r){t.error(r)}},e.prototype.forEach=function(t,r){var n=this;return r=be(r),new r(function(o,i){var s=new Pt({next:function(a){try{t(a)}catch(u){i(u),s.unsubscribe()}},error:i,complete:o});n.subscribe(s)})},e.prototype._subscribe=function(t){var r;return(r=this.source)===null||r===void 0?void 0:r.subscribe(t)},e.prototype[Ht]=function(){return this},e.prototype.pipe=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return cr(t)(this)},e.prototype.toPromise=function(t){var r=this;return t=be(t),new t(function(n,o){var i;r.subscribe(function(s){return i=s},function(s){return o(s)},function(){return n(i)})})},e.create=function(t){return new e(t)},e}();function be(e){var t;return(t=e??er.Promise)!==null&&t!==void 0?t:Promise}function ur(e){return e&&m(e.next)&&m(e.error)&&m(e.complete)}function ar(e){return e&&e instanceof Vt||ur(e)&&me(e)}function lr(e){return m(e==null?void 0:e.lift)}function Y(e){return function(t){if(lr(t))return t.lift(function(r){try{return e(r,this)}catch(n){this.error(n)}});throw new TypeError("Unable to lift unknown Observable type")}}function pt(e,t,r,n,o){return new fr(e,t,r,n,o)}var fr=function(e){k(t,e);function t(r,n,o,i,s,a){var u=e.call(this,r)||this;return u.onFinalize=s,u.shouldUnsubscribe=a,u._next=n?function(c){try{n(c)}catch(l){r.error(l)}}:e.prototype._next,u._error=i?function(c){try{i(c)}catch(l){r.error(l)}finally{this.unsubscribe()}}:e.prototype._error,u._complete=o?function(){try{o()}catch(c){r.error(c)}finally{this.unsubscribe()}}:e.prototype._complete,u}return t.prototype.unsubscribe=function(){var r;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var n=this.closed;e.prototype.unsubscribe.call(this),!n&&((r=this.onFinalize)===null||r===void 0||r.call(this))}},t}(Vt);function hr(e){return e&&m(e.schedule)}function pr(e){return e[e.length-1]}function yr(e){return hr(pr(e))?e.pop():void 0}var $t=function(e){return e&&typeof e.length=="number"&&typeof e!="function"};function Ee(e){return m(e==null?void 0:e.then)}function _e(e){return m(e[Ht])}function ze(e){return Symbol.asyncIterator&&m(e==null?void 0:e[Symbol.asyncIterator])}function xe(e){return new TypeError("You provided "+(e!==null&&typeof e=="object"?"an invalid object":"'"+e+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}function dr(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var Ce=dr();function Me(e){return m(e==null?void 0:e[Ce])}function Oe(e){return Ye(this,arguments,function(){var r,n,o,i;return pe(this,function(s){switch(s.label){case 0:r=e.getReader(),s.label=1;case 1:s.trys.push([1,,9,10]),s.label=2;case 2:return[4,K(r.read())];case 3:return n=s.sent(),o=n.value,i=n.done,i?[4,K(void 0)]:[3,5];case 4:return[2,s.sent()];case 5:return[4,K(o)];case 6:return[4,s.sent()];case 7:return s.sent(),[3,2];case 8:return[3,10];case 9:return r.releaseLock(),[7];case 10:return[2]}})})}function Le(e){return m(e==null?void 0:e.getReader)}function tt(e){if(e instanceof T)return e;if(e!=null){if(_e(e))return mr(e);if($t(e))return gr(e);if(Ee(e))return Sr(e);if(ze(e))return ke(e);if(Me(e))return wr(e);if(Le(e))return vr(e)}throw xe(e)}function mr(e){return new T(function(t){var r=e[Ht]();if(m(r.subscribe))return r.subscribe(t);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function gr(e){return new T(function(t){for(var r=0;r<e.length&&!t.closed;r++)t.next(e[r]);t.complete()})}function Sr(e){return new T(function(t){e.then(function(r){t.closed||(t.next(r),t.complete())},function(r){return t.error(r)}).then(null,Se)})}function wr(e){return new T(function(t){var r,n;try{for(var o=ft(e),i=o.next();!i.done;i=o.next()){var s=i.value;if(t.next(s),t.closed)return}}catch(a){r={error:a}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(r)throw r.error}}t.complete()})}function ke(e){return new T(function(t){br(e,t).catch(function(r){return t.error(r)})})}function vr(e){return ke(Oe(e))}function br(e,t){var r,n,o,i;return W(this,void 0,void 0,function(){var s,a;return pe(this,function(u){switch(u.label){case 0:u.trys.push([0,5,6,11]),r=tr(e),u.label=1;case 1:return[4,r.next()];case 2:if(n=u.sent(),!!n.done)return[3,4];if(s=n.value,t.next(s),t.closed)return[2];u.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return a=u.sent(),o={error:a},[3,11];case 6:return u.trys.push([6,,9,10]),n&&!n.done&&(i=r.return)?[4,i.call(r)]:[3,8];case 7:u.sent(),u.label=8;case 8:return[3,10];case 9:if(o)throw o.error;return[7];case 10:return[7];case 11:return t.complete(),[2]}})})}function N(e,t,r,n,o){n===void 0&&(n=0),o===void 0&&(o=!1);var i=t.schedule(function(){r(),o?e.add(this.schedule(null,n)):this.unsubscribe()},n);if(e.add(i),!o)return i}function Te(e,t){return t===void 0&&(t=0),Y(function(r,n){r.subscribe(pt(n,function(o){return N(n,e,function(){return n.next(o)},t)},function(){return N(n,e,function(){return n.complete()},t)},function(o){return N(n,e,function(){return n.error(o)},t)}))})}function Ae(e,t){return t===void 0&&(t=0),Y(function(r,n){n.add(e.schedule(function(){return r.subscribe(n)},t))})}function Er(e,t){return tt(e).pipe(Ae(t),Te(t))}function _r(e,t){return tt(e).pipe(Ae(t),Te(t))}function zr(e,t){return new T(function(r){var n=0;return t.schedule(function(){n===e.length?r.complete():(r.next(e[n++]),r.closed||this.schedule())})})}function xr(e,t){return new T(function(r){var n;return N(r,t,function(){n=e[Ce](),N(r,t,function(){var o,i,s;try{o=n.next(),i=o.value,s=o.done}catch(a){r.error(a);return}s?r.complete():r.next(i)},0,!0)}),function(){return m(n==null?void 0:n.return)&&n.return()}})}function De(e,t){if(!e)throw new Error("Iterable cannot be null");return new T(function(r){N(r,t,function(){var n=e[Symbol.asyncIterator]();N(r,t,function(){n.next().then(function(o){o.done?r.complete():r.next(o.value)})},0,!0)})})}function Cr(e,t){return De(Oe(e),t)}function Mr(e,t){if(e!=null){if(_e(e))return Er(e,t);if($t(e))return zr(e,t);if(Ee(e))return _r(e,t);if(ze(e))return De(e,t);if(Me(e))return xr(e,t);if(Le(e))return Cr(e,t)}throw xe(e)}function Ue(e,t){return t?Mr(e,t):tt(e)}function Et(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=yr(e);return Ue(e,r)}var Or=ye(function(e){return function(){e(this),this.name="EmptyError",this.message="no elements in sequence"}});function Lr(e,t){return new Promise(function(r,n){var o=!1,i;e.subscribe({next:function(s){i=s,o=!0},error:n,complete:function(){o?r(i):n(new Or)}})})}function _(e,t){return Y(function(r,n){var o=0;r.subscribe(pt(n,function(i){n.next(e.call(t,i,o++))}))})}var kr=Array.isArray;function Tr(e,t){return kr(t)?e.apply(void 0,vt([],ht(t))):e(t)}function Ar(e){return _(function(t){return Tr(e,t)})}function Dr(e,t,r,n,o,i,s,a){var u=[],c=0,l=0,f=!1,w=function(){f&&!u.length&&!c&&t.complete()},y=function(h){return c<n?E(h):u.push(h)},E=function(h){c++;var R=!1;tt(r(h,l++)).subscribe(pt(t,function($){t.next($)},function(){R=!0},void 0,function(){if(R)try{c--;for(var $=function(){var x=u.shift();s||E(x)};u.length&&c<n;)$();w()}catch(x){t.error(x)}}))};return e.subscribe(pt(t,y,function(){f=!0,w()})),function(){}}function et(e,t,r){return r===void 0&&(r=1/0),m(t)?et(function(n,o){return _(function(i,s){return t(n,i,o,s)})(tt(e(n,o)))},r):(typeof t=="number"&&(r=t),Y(function(n,o){return Dr(n,o,e,r)}))}function Ur(e){return et(ve,e)}function Fr(){return Ur(1)}var Ir=["addListener","removeListener"],Vr=["addEventListener","removeEventListener"],Pr=["on","off"];function qt(e,t,r,n){if(m(r)&&(n=r,r=void 0),n)return qt(e,t,r).pipe(Ar(n));var o=ht(qr(e)?Vr.map(function(a){return function(u){return e[a](t,u,r)}}):Hr(e)?Ir.map(Fe(e,t)):$r(e)?Pr.map(Fe(e,t)):[],2),i=o[0],s=o[1];if(!i&&$t(e))return et(function(a){return qt(a,t,r)})(tt(e));if(!i)throw new TypeError("Invalid event target");return new T(function(a){var u=function(){for(var c=[],l=0;l<arguments.length;l++)c[l]=arguments[l];return a.next(1<c.length?c:c[0])};return i(u),function(){return s(u)}})}function Fe(e,t){return function(r){return function(n){return e[r](t,n)}}}function Hr(e){return m(e.addListener)&&m(e.removeListener)}function $r(e){return m(e.on)&&m(e.off)}function qr(e){return m(e.addEventListener)&&m(e.removeEventListener)}function Br(e,t,r,n,o){return function(i,s){var a=r,u=t,c=0;i.subscribe(pt(s,function(l){var f=c++;u=a?e(u,l,f):(a=!0,l)},function(){a&&s.next(u),s.complete()}))}}function Jr(e,t){return Y(Br(e,t,arguments.length>=2,!1,!0))}var Nr=function(e,t){return e.push(t),e};function Zr(){return Y(function(e,t){Jr(Nr,[])(e).subscribe(t)})}function Bt(e,t){return m(t)?et(e,t,1):et(e,1)}function _t(e){return Array.isArray(e)||ArrayBuffer.isView(e)}function Ie(e,t){const{x:r,y:n,z:o}=t,{x:i,y:s,z:a,w:u}=e,c=u*r+s*o-a*n,l=u*n+a*r-i*o,f=u*o+i*n-s*r,w=-i*r-s*n-a*o,y=c*u+w*-i+l*-a-f*-s,E=l*u+w*-s+f*-i-c*-a,h=f*u+w*-a+c*-s-l*-i;return new t.constructor(y,E,h)}const Jt=Math.PI,Nt=Math.PI*2;function yt(e){let t=e%Nt;return t<-Jt?t+=Nt:t>Jt&&(t-=Nt),t}function jr(e){return e>-1?e<1?Math.acos(e):0:Jt}function Gr(e,[t,r,n]){const[o,i,s]=e;return new e.constructor(new o.constructor(o.x*t.x+i.x*t.y+s.x*t.z,o.y*t.x+i.y*t.y+s.y*t.z,o.z*t.x+i.z*t.y+s.z*t.z),new o.constructor(o.x*r.x+i.x*r.y+s.x*r.z,o.y*r.x+i.y*r.y+s.y*r.z,o.z*r.x+i.z*r.y+s.z*r.z),new o.constructor(o.x*n.x+i.x*n.y+s.x*n.z,o.y*n.x+i.y*n.y+s.y*n.z,o.z*n.x+i.z*n.y+s.z*n.z))}function Xr(e,{x:t,y:r,z:n}){const[o,i,s]=e;return new o.constructor(o.x*t+i.x*r+s.x*n,o.y*t+i.y*r+s.y*n,o.z*t+i.z*r+s.z*n)}function Rr(e,[t,r,n]){return new e.constructor(e.dot(t),e.dot(r),e.dot(n))}function q(e){return typeof e=="number"||(e==null?void 0:e.constructor)===Number}const Qr=e=>{try{nt(e),gt(e,4)}catch(t){console.error("error while hijackDOMPoint"),console.error(t)}},dt=0,Zt=1,jt=2,Gt=3,zt=9999999999999,xt=void 0,Ve=Symbol("vector length"),Ct=Symbol("get source"),Pe=Symbol("checked");let L=xt,B,rt;const Wr=[0,1,2,6,24,120,720,5760,51840,518400,5702400,68428800,889574400,12454041600,186810624e3],Xt=[];let V=-1,Rt=!1;const Mt=[];function Qt(e,t,r){L=e,V=-1,rt=1;const n=t(r);if(!q(n))throw new Error(`
      your assigned progress did not not return a primitive!
      calc() does not support logical operators (|| && ==) directly

      instead of calc(() => v1 || v2);
      use        calc(() => +v1 || +v2);

      instead of calc(() => v1);
      use        calc(v1);
      `);return n}function Ot(e){const t=e[Ct];return t?t(e).length:e[Ve]||3}function Kr(e,t){return Ot(e)>Ot(t)?e:t}function Yr(e,t){if(rt+=1,t===zt)return rt;if(t>=Ot(e))return 0;const r=e[Ct];if(r)return 1*r(e)[t];if(t===dt)return 1*e.x;if(t===Zt)return 1*e.y;if(t===jt)return 1*e.z;if(t===Gt)return 1*e.w}function He(e,t,r){const n=e[Ct];if(n){n(e)[t]=r;return}if(t===dt){e.x=r;return}if(t===Zt){e.y=r;return}t===jt&&(e.z=r),t===Gt&&(e.w=r)}function mt(e,t=void 0){if(typeof e!="function")throw new Error("no function assigned");if(L!==xt)throw new Error("something wrong, do you use calc() inside calc?");try{const r=typeof t>"u",n=typeof t=="function",o=!n&&!r?t:void 0,i=Qt(dt,e,o);if(r&&typeof B>"u")return i;const s=B?Ot(B):0;if(s===zt){if(!e[Pe]){const l=Qt(zt,e),f=Wr[rt];if(Math.abs(l-f)>Number.EPSILON)throw new Error(`
            algebraic multiplication works only in calls with *

            calc(() => v * m);
            calc(() => m * v);
            calc(() => m * m);
            calc(() => m * m * v);

            `);e[Pe]=!0}let c=Xt[0];for(let l=1;l<rt-1;l+=1){const f=Xt[l];if(!c.multiply)throw new Error(`cannot find method multiply() on ${c}`);c=c.multiply(f)}return c}let a=n?t.length:s;if(a||(a=s),a<s)throw new Error("Your assigned result Vector cant use higher space Operands than it has");const u=new Array(a);u[0]=i,o&&He(o,L,u[0]);for(let c=1;c<a;c+=1){const l=Qt(c,e,o);u[c]=l,o&&He(o,L,l)}return r?new B.constructor(...u):n?t(...u):o}finally{L=xt,B=void 0}}function nt(e,t){const r=e.prototype;r[Ct]=t;const n=r[Symbol.toPrimitive]||function(o){return o==="string"?this.toString():this.valueOf()};r[Symbol.toPrimitive]=function(o){return L===dt&&(B=B?Kr(B,this):this,Xt[rt-1]=this),L===xt?n.call(this,o):Yr(this,L)}}function Wt(e){return function(...t){if(L===dt){if(Rt)return e.apply(this,t);try{Rt=!0,V+=1;const r=e.apply(this,t);return Mt[V]=r,r}finally{Rt=!1}}return L===Zt||L===jt||L===Gt?(V+=1,Mt[V]):e.apply(this,t)}}function C(e,t){const r=e.prototype,n=r[t];r[t]=Wt(n)}function Lt(e,t){const r=e.prototype,n=Object.getOwnPropertyDescriptor(r,t);Object.defineProperty(r,t,{get:Wt(function(){return n.get.call(this)})})}function gt(e,t){const r=e.prototype;Object.defineProperty(r,Ve,{value:t})}function $e(e){gt(e,zt)}function Kt(e){return Wt(e)}typeof DOMPoint<"u"&&Qr(DOMPoint);function tn(e){let t="";return e&&(t=`${e}-`),t}function St(e,t,r={}){const n=tn(e);return Object.entries(t).forEach(([o,i])=>{r[`--${n}${o}`]=i}),r}const Yt=0,te=1,A=Symbol("axes");function en(e,t,r,n){const o=Math.atan2(e,t),i=Math.atan2(r,n);return yt(o-i)}function qe(e){return e*e}class D{constructor(...t){typeof t[0]=="function"?mt(t[0],(r,n)=>{this[A]=[r,n]}):_t(t[0])?this[A]=[...t[0]]:t[0]&&q(t[0].x)?this[A]=[t[0].x||0,t[0].y||0]:this[A]=[t[0]||0,t[1]||0]}valueOf(){throw new Error("valueOf() not implemented, looks like you try to calculate outside of calc")}normalize(){const{length:t}=this;return new this.constructor(this.x/t,this.y/t)}norm(){return this.normalize()}dot(t){return this.x*t.x+this.y*t.y}getRad(){return yt(Math.atan2(this.y,this.x))}angleTo(t){return en(this.y,this.x,t.y,t.x)}rotate(t){const r=Math.sin(t),n=Math.cos(t),o=this.x*n-this.y*r,i=this.x*r+this.y*n;return new this.constructor(o,i)}distance(t){return Math.sqrt(qe(this.x-t.x)+qe(this.y-t.y))}dist(t){return this.distance(t)}toArray(){return[this.x,this.y]}calc(t){throw new Error("calc() not implemented")}clone(){throw new Error("clone() not implemented")}equals(t){return this.x===t.x&&this.y===t.y}toJSON(){return{x:this.x,y:this.y}}toString(){return JSON.stringify(this.toJSON())}toCSSVars(t,r={}){return St(t,this.toJSON(),r)}get lengthSq(){return this.dot(this)}get length(){return Math.sqrt(this.lengthSq)}get lensq(){return this.lengthSq}get len(){return this.length}get x(){return this[A][Yt]}set x(t){throw new Error("set x() not implemented")}get y(){return this[A][te]}set y(t){throw new Error("set y() not implemented")}get z(){throw new Error("get z() not implemented")}set z(t){throw new Error("set z() not implemented")}[Symbol.iterator](){return this[A].values()}}nt(D),gt(D,2),C(D,"dot"),C(D,"angleTo"),C(D,"distance"),C(D,"toArray"),C(D,"getRad"),Lt(D,"length"),Lt(D,"lengthSq");class ee extends D{set x(t){this[A][Yt]=t}set y(t){this[A][te]=t}get x(){return this[A][Yt]}get y(){return this[A][te]}calc(t){return mt(t,this)}clone(){return new ee(this.x,this.y)}}class ot extends D{toPoint(){return new ee(this.x,this.y)}}const rn=Kt((e,t)=>new ot(e,t)),p=(e,t)=>rn(e,t);p(0,0),p(0,-1),p(-1,0);const it=0,st=1,ct=2,g=Symbol("axes");function re(e){return e*e}class M{constructor(...t){typeof t[0]=="function"?mt(t[0],(r,n,o)=>{this[g]=[r,n,o]}):_t(t[0])?this[g]=[...t[0]]:t[0]&&q(t[0].x)?this[g]=[t[0].x||0,t[0].y||0,t[0].z||0]:this[g]=[t[0]||0,t[1]||0,t[2]||0]}valueOf(){throw new Error("valueOf() not implemented, looks like you try to calculate outside of calc")}normalize(){const{length:t}=this;return new this.constructor(this.x/t,this.y/t,this.z/t)}norm(){return this.normalize()}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}cross(t){return new this.constructor(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)}crossNormalize(t){const r=this.cross(t),{length:n}=r;return r[g][it]/=n,r[g][st]/=n,r[g][ct]/=n,r}cn(t){return this.crossNormalize(t)}toAngles(){return{theta:Math.atan2(this.z,this.x),phi:Math.asin(this.y/this.length)}}angleTo(t){return yt(jr(this.dot(t)/(this.length*t.length)))}multiply(t){return t.x===void 0?this.multiplyMat3(t):t.w===void 0?this.multiplyVec3(t):Ie(t,this)}multiplyMat3(t){return Rr(this,t)}multiplyVec3({x:t,y:r,z:n}){return new this.constructor(this.x*t,this.y*r,this.z*n)}distance(t){return Math.sqrt(re(this.x-t.x)+re(this.y-t.y)+re(this.z-t.z))}dist(t){return this.distance(t)}toArray(){return[this.x,this.y,this.z]}swizzle(t){const r=t.split("").map(n=>this[n]);return r.length===2?new ot(r[0],r[1]):new this.constructor(r[0],r[1],r[2])}calc(t){throw new Error("calc() not implemented")}clone(){throw new Error("clone() not implemented")}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z}toJSON(){return{x:this.x,y:this.y,z:this.z}}toString(){return JSON.stringify(this.toJSON())}toCSSVars(t,r={}){return St(t,this.toJSON(),r)}get lengthSq(){return this.dot(this)}set lengthSq(t){throw new Error("set lengthSq() not implemented")}get length(){return Math.sqrt(this.lengthSq)}set length(t){throw new Error("set length() not implemented")}get lensq(){return this.lengthSq}set lensq(t){throw new Error("set lensq() not implemented")}get len(){return this.length}set len(t){throw new Error("set len() not implemented")}get x(){return this[g][it]}set x(t){throw new Error("set x() not implemented")}get y(){return this[g][st]}set y(t){throw new Error("set y() not implemented")}get z(){return this[g][ct]}set z(t){throw new Error("set z() not implemented")}get xy(){return new ot(this[g][it],this[g][st])}set xy(t){throw new Error("set xz() not implemented")}get xz(){return new ot(this[g][it],this[g][ct])}set xz(t){throw new Error("set xz() not implemented")}get yz(){return new ot(this[g][st],this[g][ct])}set yz(t){throw new Error("set yz() not implemented")}[Symbol.iterator](){return this[g].values()}}nt(M),gt(M,3),C(M,"dot"),C(M,"cross"),C(M,"crossNormalize"),C(M,"toAngles"),C(M,"angleTo"),C(M,"rotate"),C(M,"distance"),C(M,"toArray"),Lt(M,"length"),Lt(M,"lengthSq");class ne extends M{set x(t){this[g][it]=t}set y(t){this[g][st]=t}set z(t){this[g][ct]=t}get x(){return this[g][it]}get y(){return this[g][st]}get z(){return this[g][ct]}calc(t){return mt(t,this)}clone(){return new ne(this.x,this.y,this.z)}}class nn extends M{toVector(){return new ne(this.x,this.y,this.z)}clone(){return this}}const on=Kt((e,t,r)=>new nn(e,t,r)),J=(e,t,r)=>on(e,t,r);J(0,0,0);const Be=J(0,0,-1);J(0,0,1);const oe=J(-1,0,0);J(1,0,0);const Je=J(0,1,0);J(0,-1,0),J(1,1,1);const P=Symbol("angle rad"),Ne=Math.PI/180;class ut{constructor(t){t instanceof ut?this[P]=t[P]:this[P]=yt(t*Ne)}valueOf(){return this[P]}toJSON(){return{angle:this[P]}}toString(){return JSON.stringify(this.toJSON())}toCSSVars(t,r={}){return St(t,this.toJSON(),r)}}class Ze extends ut{set(t){t instanceof ut?this[P]=t[P]:this[P]=yt((t||0)*Ne)}}class sn extends ut{toDegree(){return new Ze(this[P])}}new sn(0);function cn(e){return new Ze(e)}function un(e){return q(e)||e instanceof ut}const Z=0,j=1,G=2,X=3,at=Symbol("axes"),an=Symbol("forward cache"),ln=Symbol("left cache"),fn=Symbol("up cache"),hn=Symbol("inverse cache");function pn([e,t,r,n]){return Math.sqrt(e*e+t*t+r*r+n*n)}function yn(e){const t=pn(e);e[Z]/=t,e[j]/=t,e[G]/=t,e[X]/=t}function dn(e,t){const r=e.normalize(),n=t.crossNormalize(r),o=r.crossNormalize(n),i=n.x,s=n.y,a=n.z,u=o.x,c=o.y,l=o.z,f=r.x,w=r.y,y=r.z,E=i+c+y,h=new Array(4);if(E>0){let x=Math.sqrt(E+1);return h[X]=x*.5,x=.5/x,h[Z]=(l-w)*x,h[j]=(f-a)*x,h[G]=(s-u)*x,h}if(i>=c&&i>=y){const x=Math.sqrt(1+i-c-y),Q=.5/x;return h[Z]=.5*x,h[j]=(s+u)*Q,h[G]=(a+f)*Q,h[X]=(l-w)*Q,h}if(c>y){const x=Math.sqrt(1+c-i-y),Q=.5/x;return h[Z]=(u+s)*Q,h[j]=.5*x,h[G]=(w+l)*Q,h[X]=(f-a)*Q,h}const R=Math.sqrt(1+y-i-c),$=.5/R;return h[Z]=(f+a)*$,h[j]=(w+l)*$,h[G]=.5*R,h[X]=(s-u)*$,h}function mn(e,t){const r=new Array(4),n=t*.5,o=Math.sin(n),i=Math.cos(n);return r[Z]=o*e.x,r[j]=o*e.y,r[G]=o*e.z,r[X]=i,r}function ie(e,t,r,n){if(q(e))return[e,t,r,n];if(_t(e))return[...e];if(un(t))return mn(e,t);if(e&&t)return dn(e,t)}function gn(e,t,r,n){return e&&q(e.w)?ie(e.x,e.y,e.z,e.w):ie(e,t,r,n)||[0,0,0,1]}class se{constructor(t,r,n,o){this[at]=gn(t,r,n,o),yn(this[at])}set(t,r,n,o){throw new Error("set x() not implemented")}multiply(t,r,n,o){if(q(t.w))return this.multiplyQuaternion(t);const i=ie(t,r,n,o);return i?this.multiplyQuaternion(new this.constructor(i)):this.multiplyVector(t)}multiplyVector(t){return Ie(this,t)}multiplyQuaternion(t){const r=this.x,n=this.y,o=this.z,i=this.w,s=t.x,a=t.y,u=t.z,c=t.w,l=i*s+r*c+n*u-o*a,f=i*a+n*c+o*s-r*u,w=i*u+o*c+r*a-n*s,y=i*c-r*s-n*a-o*u;return new this.constructor(l,f,w,y)}mul(t,r,n,o){return this.multiply(t,r,n,o)}get inverse(){const{x:t,y:r,z:n,w:o}=this;return this.constructor(t*-1,r*-1,n*-1,o)}get inv(){return this.inverse}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w}get left(){return this.multiplyVector(oe)}get dir(){return this.multiplyVector(Be)}get up(){return this.multiplyVector(Je)}get 0(){return this.left}get 1(){return this.dir}get 2(){return this.up}get x(){return this[at][Z]}set x(t){throw new Error("set x() not implemented")}get y(){return this[at][j]}set y(t){throw new Error("set y() not implemented")}get z(){return this[at][G]}set z(t){throw new Error("set z() not implemented")}get w(){return this[at][X]}set w(t){throw new Error("set w() not implemented")}toJSON(){const{x:t,y:r,z:n,w:o}=this;return{x:t,y:r,z:n,w:o,a1:1-r*r*2-n*n*2,a2:t*r*2-n*o*2,a3:t*n*2+r*o*2,b1:t*r*2+n*o*2,b2:1-t*t*2-n*n*2,b3:r*n*2-t*o*2,c1:t*n*2-r*o*2,c2:r*n*2+t*o*2,c3:1-t*t*2-r*r*2}}toString(){return JSON.stringify(this.toJSON())}toCSSVars(t,r={}){return St(t,this.toJSON(),r)}}nt(se),$e(se);function kt(e,t,r){let n=e[t];return n||(n=r(),e[t]=n),n}class je extends se{get left(){return kt(this,ln,()=>this.multiplyVector(oe))}get dir(){return kt(this,an,()=>this.multiplyVector(Be))}get up(){return kt(this,fn,()=>this.multiplyVector(Je))}get inverse(){return kt(this,hn,()=>{const{x:t,y:r,z:n,w:o}=this;return this.constructor(t*-1,r*-1,n*-1,o)})}}const Sn=Kt((e,t,r,n)=>new je(e,t,r,n)),wn=(e,t,r,n)=>Sn(e,t,r,n);new je(oe,cn(90)),wn(0,0,0,1);const vn=0,bn=1,En=2,_n=3,H=Symbol("axes");class ce{constructor(t,r,n,o){typeof t=="function"?mt(t,(i,s,a,u)=>{this[H]=[i,s,a,u]}):_t(t)?this[H]=[...t]:t&&q(t.x)?this[H]=[t.x||0,t.y||0,t.z||0,t.w||0]:this[H]=[t||0,r||0,n||0,o||0]}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}valueOf(){throw new Error("valueOf() not implemented, looks like you try to calculate outside of calc")}toArray(){return[this.x,this.y,this.z,this.w]}calc(t){throw new Error("calc() not implemented")}clone(){throw new Error("clone() not implemented")}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w}toJSON(){return{x:this.x,y:this.y,z:this.z,w:this.w}}toString(){return JSON.stringify(this.toJSON())}toCSSVars(t,r={}){return St(t,this.toJSON(),r)}get x(){return this[H][vn]}set x(t){throw new Error("set x() not implemented")}get y(){return this[H][bn]}set y(t){throw new Error("set y() not implemented")}get z(){return this[H][En]}set z(t){throw new Error("set z() not implemented")}get w(){return this[H][_n]}set w(t){throw new Error("set w() not implemented")}[Symbol.iterator](){return this[H].values()}}nt(ce),gt(ce,4),C(ce,"toArray");const wt=Symbol("data");class Tt{constructor(...t){this[wt]=t}get 0(){return this[wt][0]}set 0(t){throw new Error("set [0] not implemented")}get 1(){return this[wt][1]}set 1(t){throw new Error("set [1] not implemented")}get 2(){return this[wt][2]}set 2(t){throw new Error("set [2] not implemented")}multiplyMat(t){return Gr(this,t)}multiplyVec(t){return Xr(this,t)}multiply(t){if(t instanceof Tt)return this.multiplyMat(t);const{x:r,y:n,z:o}=t;if(r===void 0||n===void 0||o===void 0)throw new Error(`multiply only works with mat3 and vec3, not supported ${t}`);return this.multiplyVec(t)}[Symbol.iterator](){return this[wt].values()}}nt(Tt),$e(Tt);const zn=[{validator:()=>!0,handler:()=>e=>e.pipe(_(t=>t))}];class U{constructor(t,r){S(this,"validator");S(this,"handler");this.validator=t,this.handler=r}}const xn=(e=[])=>[...e,...zn],Cn=[{validator:()=>!0,handler:()=>e=>e.pipe(_(t=>t))}],Mn=(e=[])=>[...e,...Cn],Ge={[Object.prototype.constructor.name]:e=>t=>t.pipe(_(Object.entries),lt(e),_(Object.fromEntries)),[Array.prototype.constructor.name]:e=>t=>t.pipe(Fr(),lt(e),Zr()),[Promise.prototype.constructor.name]:e=>t=>t.pipe(Bt(r=>Ue(r)),lt(e)),[T.prototype.constructor.name]:e=>t=>t.pipe(Bt(r=>r),lt(e)),[void 0]:()=>e=>e};function On(e=[]){return t=>t.pipe(lt(xn(e)))}function Ln(e=[]){return t=>t.pipe(lt(Mn(e)))}function lt(e){return t=>t.pipe(et(r=>{const n=kn(r),o=n&&Ge[n];return o?Et(r).pipe(o(e)):Et(r)}),Tn(e))}function kn(e){if(e==null)return;const t=e.constructor;if(t){const r=t.name;if(Object.prototype.hasOwnProperty.call(Ge,r))return r}}function Tn(e){return t=>t.pipe(Bt(r=>Et(r).pipe(An(e,r).handler())))}const An=(e,t)=>{const r=e.find(({validator:n})=>n(t));return r||{validator:()=>!0,handler:n=>n}};function Dn(e,t,r){let n,o,i;if(t===0)n=o=i=r;else{const s=(c,l,f)=>(f<0&&(f+=1),f>1&&(f-=1),f<.16666666666666666?c+(l-c)*6*f:f<.5?l:f<.6666666666666666?c+(l-c)*(.6666666666666666-f)*6:c),a=r<.5?r*(1+t):r+t-r*t,u=2*r-a;n=s(u,a,e/360+1/3),o=s(u,a,e/360),i=s(u,a,e/360-1/3)}return{r:Math.round(n*255),g:Math.round(o*255),b:Math.round(i*255)}}class v{constructor(t,r=0,n=0,o=255){S(this,"r");if(this.g=r,this.b=n,this.a=o,Array.isArray(t))[this.r,this.g,this.b,this.a]=t;else if(typeof t=="string"){const i=v.fromHex(t);this.r=i.r,this.g=i.g,this.b=i.b,this.a=i.a}else typeof t=="object"?(this.r=t.r||0,this.g=t.g||0,this.b=t.b||0,this.a=t.a!==void 0?t.a:255):(this.r=t,this.g=r||0,this.b=n||0,this.a=o===void 0?255:o);this.r=Math.min(Math.max(this.r,0),255),this.g=Math.min(Math.max(this.g,0),255),this.b=Math.min(Math.max(this.b,0),255),this.a=Math.min(Math.max(this.a,0),255)}static fromHex(t){t.length===4&&(t=`#${t[1]}${t[1]}${t[2]}${t[2]}${t[3]}${t[3]}`);const r=parseInt(t.slice(1,3),16),n=parseInt(t.slice(3,5),16),o=parseInt(t.slice(5,7),16),i=parseInt(t.slice(7,9),16);return new v(r,n,o,isNaN(i)?255:i)}static fromHsl(t,r,n,o=255){const{r:i,g:s,b:a}=Dn(t,r,n);return new v(i,s,a,o)}static isValidHex(t){return/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6}|[0-9a-fA-F]{8})$/.test(t)}toInverted(){return new v(255-this.r,255-this.g,255-this.b,this.a)}toJSON(){return{_type:this.constructor.name,r:this.r,g:this.g,b:this.b,a:this.a}}toHex(){return`#${this.toRGBA().map(t=>t.toString(16).padStart(2,"0")).join("")}`}toRGB(){return[this.r,this.g,this.b]}toRGBA(){return[...this.toRGB(),this.a]}toCSSRGBA(){return[...this.toRGB(),this.a/255]}toHsl(){const t=this.r/255,r=this.g/255,n=this.b/255,o=Math.max(t,r,n),i=Math.min(t,r,n);let s=0,a=0;const u=(o+i)/2;if(o===i)s=a=0;else{const c=o-i;switch(a=u>.5?c/(2-o-i):c/(o+i),o){case t:s=(r-n)/c+(r<n?6:0);break;case r:s=(n-t)/c+2;break;case n:s=(t-r)/c+4;break}s/=6}return[Math.round(s*360),a,u]}toHsla(){const[t,r,n]=this.toHsl();return[t,r,n,this.a]}toHsv(){const t=this.r/255,r=this.g/255,n=this.b/255,o=Math.max(t,r,n),i=Math.min(t,r,n);let s=0,a=0;const u=o,c=o-i;if(o!==0)a=c/o;else return[0,0,0];if(o===i)s=0;else{switch(o){case t:s=(r-n)/c+(r<n?6:0);break;case r:s=(n-t)/c+2;break;case n:s=(t-r)/c+4;break}s/=6}return[Math.round(s*360),a,u]}toHsva(){const[t,r,n]=this.toHsv();return[t,r,n,this.a]}getHslaHue(){const[t]=this.toHsl();return t}getHslaSaturation(){const[t]=this.toHsl();return t}getHslaLightness(){const[t]=this.toHsl();return t}setHslaHue(t){const[r,n,o]=this.toHsl();return v.fromHsl(r+t,n,o,this.a)}setHslaSaturation(t){const[r,n,o]=this.toHsl();return v.fromHsl(r,n+t,o,this.a)}setHslaLightness(t){const[r,n,o]=this.toHsl();return v.fromHsl(r,n,o+t,this.a)}equals(t){return this.r===t.r&&this.g===t.g&&this.b===t.b&&this.a===t.a}}var b=(e=>(e.DEFAULT="default",e.REFRESH="refresh",e.REFRESH_SUCCESS="refreshSuccess",e.DEBUG="debug",e.INIT="init",e.INIT_SUCCESS="initSuccess",e.SYNC_STATE="syncState",e.SYNC_STATE_SUCCESS="syncStateSuccess",e.ADD_RENDER_WORKER_PORT="addRenderWorkerPort",e.ADD_RENDER_WORKER_PORT_SUCCESS="addRenderWorkerPortSuccess",e.LOAD_IMAGE="loadImage",e.LOAD_IMAGE_SUCCESS="loadImageSuccess",e.UPDATE_CANVAS="updateCanvas",e.UPDATE_BUFFER="updateBuffer",e.UPDATE_BUFFER_SUCCESS="updateBufferSuccess",e.STACK="stack",e.STACK_SUCCESS="stackSuccess",e.UNDO_STACK="undoStack",e.UNDO_STACK_SUCCESS="undoStackSuccess",e.REDO_STACK="redoStack",e.REDO_STACK_SUCCESS="redoStackSuccess",e.CLEAR="clear",e.CLEAR_SUCCESS="clearSuccess",e.SET_ZOOM="setZoom",e.SET_ZOOM_SUCCESS="setZoomSuccess",e.ZOOM_FIT="zoomFit",e.ZOOM_FIT_SUCCESS="zoomFitSuccess",e.SET_POSITION="setPosition",e.SET_POSITION_SUCCESS="setPositionSuccess",e.USE_TOOL="useTool",e.USE_TOOL_SUCCESS="useToolSuccess",e.SET_SELECT_OPTIONS="setSelectOptions",e.SET_SELECT_OPTIONS_SUCCESS="setSelectOptionsSuccess",e.GET_DATA="getData",e.GET_DATA_SUCCESS="getDataSuccess",e.RESIZE="resize",e.RESIZE_SUCCESS="resizeSuccess",e.RESIZE_CANVAS="resizeCanvas",e.RESIZE_CANVAS_SUCCESS="resizeCanvasSuccess",e.GET_COLORS="getColors",e.GET_COLORS_SUCCESS="getColorsSuccess",e.IMAGE_OPERATION="imageOperation",e.IMAGE_OPERATION_SUCCESS="imageOperationSuccess",e.COLOR_PICKER="colorPicker",e.COLOR_PICKER_SUCCESS="colorPickerSuccess",e.SET_OPTIONS="setOptions",e.SET_OPTIONS_SUCCESS="setOptionsSuccess",e.DRAW_RECTANGLE="drawRectangle",e.DRAW_RECTANGLE_SUCCESS="drawRectangleSuccess",e.DRAW_BRUSH="drawBrush",e))(b||{}),F=(e=>(e.TOP_LEFT="top_left",e.TOP_CENTER="top_center",e.TOP_RIGHT="top_right",e.CENTER_LEFT="center_left",e.CENTER="center",e.CENTER_RIGHT="center_right",e.BOTTOM_LEFT="bottom_left",e.BOTTOM_CENTER="bottom_center",e.BOTTOM_RIGHT="bottom_right",e))(F||{});p(-1,-1),p(0,-1),p(1,-1),p(-1,0),p(0,0),p(1,0),p(-1,1),p(0,1),p(1,1);class At{constructor(t){S(this,"origin");S(this,"position");S(this,"colors");S(this,"zoomLevel");S(this,"precision");const{origin:r,position:n,colors:o,zoomLevel:i}=t||{};this.origin=r||"center",this.position=n?p(n.x,n.y):p(0,0),this.colors={background:o!=null&&o.background?new v(o.background):new v(0,0,0),foreground:o!=null&&o.foreground?new v(o.foreground):new v(255,255,255),grid:o!=null&&o.grid?new v(o.grid):new v(0,0,0,.2)},this.zoomLevel=i||1,this.precision=3}toJSON(){return{_type:this.constructor.name,origin:this.origin,position:this.position.toJSON(),colors:{background:this.colors.background.toJSON(),foreground:this.colors.foreground.toJSON(),grid:this.colors.grid.toJSON()},zoomLevel:this.zoomLevel,precision:this.precision}}}class Dt{constructor(t){S(this,"id");S(this,"color");const{id:r,color:n}=t||{};this.id=r||crypto.randomUUID(),this.color=n?new v(n):new v(0,0,0)}setColor(t){this.color=t}equal(t){return this.id===(t==null?void 0:t.id)}toJSON(){return{_type:this.constructor.name,id:this.id,color:this.color.toJSON()}}}class ue{constructor(t){S(this,"id");S(this,"name");S(this,"description");S(this,"colors");S(this,"locked");const{id:r,name:n,description:o,colors:i,locked:s}=t||{};this.id=r||crypto.randomUUID(),this.name=n||"",this.description=o,this.colors=(i||[]).map(a=>new Dt(a)),this.locked=s}toJSON(){return{_type:this.constructor.name,id:this.id,name:this.name,description:this.description,colors:this.colors.map(t=>t.toJSON()),locked:this.locked}}}const Un=[new U(e=>e&&e instanceof ot,()=>e=>e.pipe(_(t=>t.toJSON()))),new U(e=>e&&e instanceof At,()=>e=>e.pipe(_(t=>t.toJSON()))),new U(e=>e&&e instanceof v,()=>e=>e.pipe(_(t=>t.toJSON()))),new U(e=>e&&e instanceof Dt,()=>e=>e.pipe(_(t=>t.toJSON()))),new U(e=>e&&e instanceof ue,()=>e=>e.pipe(_(t=>t.toJSON())))],Fn=[new U(e=>typeof e=="object"&&"x"in e&&"y"in e,()=>e=>e.pipe(_(t=>p(t.x,t.y)))),new U(e=>e&&At.prototype.constructor.name===e._type,()=>e=>e.pipe(_(t=>new At(t)))),new U(e=>e&&v.prototype.constructor.name===e._type,()=>e=>e.pipe(_(t=>new v(t)))),new U(e=>e&&Dt.prototype.constructor.name===e._type,()=>e=>e.pipe(_(t=>new Dt(t)))),new U(e=>e&&ue.prototype.constructor.name===e._type,()=>e=>e.pipe(_(t=>new ue(t))))];function In(){return e=>e.pipe(On(Un))}function Vn(){return e=>e.pipe(Ln(Fn))}const O={fatal:0,error:0,warn:1,log:2,info:3,success:3,fail:3,debug:4,trace:5,verbose:Number.POSITIVE_INFINITY},Xe={silent:{level:-1},fatal:{level:O.fatal},error:{level:O.error},warn:{level:O.warn},log:{level:O.log},info:{level:O.info},success:{level:O.success},fail:{level:O.fail},ready:{level:O.info},start:{level:O.info},box:{level:O.info},debug:{level:O.debug},trace:{level:O.trace},verbose:{level:O.verbose}};function ae(e){if(e===null||typeof e!="object")return!1;const t=Object.getPrototypeOf(e);return t!==null&&t!==Object.prototype&&Object.getPrototypeOf(t)!==null||Symbol.iterator in e?!1:Symbol.toStringTag in e?Object.prototype.toString.call(e)==="[object Module]":!0}function le(e,t,r=".",n){if(!ae(t))return le(e,{},r);const o=Object.assign({},t);for(const i in e){if(i==="__proto__"||i==="constructor")continue;const s=e[i];s!=null&&(Array.isArray(s)&&Array.isArray(o[i])?o[i]=[...s,...o[i]]:ae(s)&&ae(o[i])?o[i]=le(s,o[i],(r?`${r}.`:"")+i.toString()):o[i]=s)}return o}function Pn(e){return(...t)=>t.reduce((r,n)=>le(r,n,""),{})}const Hn=Pn();function $n(e){return Object.prototype.toString.call(e)==="[object Object]"}function qn(e){return!(!$n(e)||!e.message&&!e.args||e.stack)}let fe=!1;const Re=[];class z{constructor(t={}){S(this,"options");S(this,"_lastLog");S(this,"_mockFn");const r=t.types||Xe;this.options=Hn({...t,defaults:{...t.defaults},level:he(t.level,r),reporters:[...t.reporters||[]]},{types:Xe,throttle:1e3,throttleMin:5,formatOptions:{date:!0,colors:!1,compact:!0}});for(const n in r){const o={type:n,...this.options.defaults,...r[n]};this[n]=this._wrapLogFn(o),this[n].raw=this._wrapLogFn(o,!0)}this.options.mockFn&&this.mockTypes(),this._lastLog={}}get level(){return this.options.level}set level(t){this.options.level=he(t,this.options.types,this.options.level)}prompt(t,r){if(!this.options.prompt)throw new Error("prompt is not supported!");return this.options.prompt(t,r)}create(t){const r=new z({...this.options,...t});return this._mockFn&&r.mockTypes(this._mockFn),r}withDefaults(t){return this.create({...this.options,defaults:{...this.options.defaults,...t}})}withTag(t){return this.withDefaults({tag:this.options.defaults.tag?this.options.defaults.tag+":"+t:t})}addReporter(t){return this.options.reporters.push(t),this}removeReporter(t){if(t){const r=this.options.reporters.indexOf(t);if(r!==-1)return this.options.reporters.splice(r,1)}else this.options.reporters.splice(0);return this}setReporters(t){return this.options.reporters=Array.isArray(t)?t:[t],this}wrapAll(){this.wrapConsole(),this.wrapStd()}restoreAll(){this.restoreConsole(),this.restoreStd()}wrapConsole(){for(const t in this.options.types)console["__"+t]||(console["__"+t]=console[t]),console[t]=this[t].raw}restoreConsole(){for(const t in this.options.types)console["__"+t]&&(console[t]=console["__"+t],delete console["__"+t])}wrapStd(){this._wrapStream(this.options.stdout,"log"),this._wrapStream(this.options.stderr,"log")}_wrapStream(t,r){t&&(t.__write||(t.__write=t.write),t.write=n=>{this[r].raw(String(n).trim())})}restoreStd(){this._restoreStream(this.options.stdout),this._restoreStream(this.options.stderr)}_restoreStream(t){t&&t.__write&&(t.write=t.__write,delete t.__write)}pauseLogs(){fe=!0}resumeLogs(){fe=!1;const t=Re.splice(0);for(const r of t)r[0]._logFn(r[1],r[2])}mockTypes(t){const r=t||this.options.mockFn;if(this._mockFn=r,typeof r=="function")for(const n in this.options.types)this[n]=r(n,this.options.types[n])||this[n],this[n].raw=this[n]}_wrapLogFn(t,r){return(...n)=>{if(fe){Re.push([this,t,n,r]);return}return this._logFn(t,n,r)}}_logFn(t,r,n){if((t.level||0)>this.level)return!1;const o={date:new Date,args:[],...t,level:he(t.level,this.options.types)};!n&&r.length===1&&qn(r[0])?Object.assign(o,r[0]):o.args=[...r],o.message&&(o.args.unshift(o.message),delete o.message),o.additional&&(Array.isArray(o.additional)||(o.additional=o.additional.split(`
`)),o.args.push(`
`+o.additional.join(`
`)),delete o.additional),o.type=typeof o.type=="string"?o.type.toLowerCase():"log",o.tag=typeof o.tag=="string"?o.tag:"";const i=(a=!1)=>{const u=(this._lastLog.count||0)-this.options.throttleMin;if(this._lastLog.object&&u>0){const c=[...this._lastLog.object.args];u>1&&c.push(`(repeated ${u} times)`),this._log({...this._lastLog.object,args:c}),this._lastLog.count=1}a&&(this._lastLog.object=o,this._log(o))};clearTimeout(this._lastLog.timeout);const s=this._lastLog.time&&o.date?o.date.getTime()-this._lastLog.time.getTime():0;if(this._lastLog.time=o.date,s<this.options.throttle)try{const a=JSON.stringify([o.type,o.tag,o.args]),u=this._lastLog.serialized===a;if(this._lastLog.serialized=a,u&&(this._lastLog.count=(this._lastLog.count||0)+1,this._lastLog.count>this.options.throttleMin)){this._lastLog.timeout=setTimeout(i,this.options.throttle);return}}catch{}i(!0)}_log(t){for(const r of this.options.reporters)r.log(t,{options:this.options})}}function he(e,t={},r=3){return e===void 0?r:typeof e=="number"?e:t[e]&&t[e].level!==void 0?t[e].level:r}z.prototype.add=z.prototype.addReporter,z.prototype.remove=z.prototype.removeReporter,z.prototype.clear=z.prototype.removeReporter,z.prototype.withScope=z.prototype.withTag,z.prototype.mock=z.prototype.mockTypes,z.prototype.pause=z.prototype.pauseLogs,z.prototype.resume=z.prototype.resumeLogs;function Bn(e={}){return new z(e)}class Jn{constructor(t){S(this,"options");S(this,"defaultColor");S(this,"levelColorMap");S(this,"typeColorMap");this.options={...t},this.defaultColor="#7f8c8d",this.levelColorMap={0:"#c0392b",1:"#f39c12",3:"#00BCD4"},this.typeColorMap={success:"#2ecc71"}}_getLogFn(t){return t<1?console.__error||console.error:t===1?console.__warn||console.warn:console.__log||console.log}log(t){const r=this._getLogFn(t.level),n=t.type==="log"?"":t.type,o=t.tag||"",s=`
      background: ${this.typeColorMap[t.type]||this.levelColorMap[t.level]||this.defaultColor};
      border-radius: 0.5em;
      color: white;
      font-weight: bold;
      padding: 2px 0.5em;
    `,a=`%c${[o,n].filter(Boolean).join(":")}`;typeof t.args[0]=="string"?r(`${a}%c ${t.args[0]}`,s,"",...t.args.slice(1)):r(a,s,...t.args)}}function Nn(e={}){return Bn({reporters:e.reporters||[new Jn({})],prompt(r,n={}){return n.type==="confirm"?Promise.resolve(confirm(r)):Promise.resolve(prompt(r))},...e})}const Ut=Nn().withTag("webPaint");Ut.withTag("workerManager");const Zn=Ut.withTag("display"),Qe=Ut.withTag("worker");Qe.withTag("main"),Qe.withTag("display");const jn="[RenderWorker]";function Gn(e){throw e instanceof Error&&(e=e.message||e.toString()),new Error(`${jn}: ${e}`)}async function Xn(e,t){const{debug:r,canvas:n,port:o,options:i}=t.payload;return e.debug=r,e.options=i,e.canvas=n,e.ctx=e.canvas.getContext("2d",{willReadFrequently:!0}),e.ctx.imageSmoothingEnabled=!1,e.mainWorkerPort=o,e.mainWorkerPort?e.mainWorkerPort.onmessage=Rn(e):Gn("mainWorkerPort not received in init message!"),{type:b.INIT_SUCCESS}}function Rn(e){return t=>{We(e,t.data.data)}}async function Qn(e,t){const{dimension:r}=t.payload;return e.canvas&&(e.canvas.width=r.x,e.canvas.height=r.y,e.ctx.imageSmoothingEnabled=!1,e.draw()),{type:b.REFRESH_SUCCESS}}function Wn(e,t){return e.canvas&&(e.canvas.height=405),e.draw(),console.log("DEBUG"),Promise.resolve({type:t.type})}async function Kn(e,t){const{sharedBuffer:r}=t.payload;return e.setSharedBuffer(r),e.updateCanvas(),{type:b.UPDATE_BUFFER_SUCCESS}}async function Yn(e,t){const{options:r}=t.payload;return e.options=r,e.updateCanvas(),{type:b.SET_OPTIONS_SUCCESS}}async function to(e,t){return e.setZoom(t.payload.position,t.payload.zoomLevel),e.updateCanvas(),{type:b.SET_ZOOM_SUCCESS,payload:{position:e.options.position,currentZoomLevel:e.currentZoomLevel}}}async function eo(e){return ro(e,e.getDimensionImageData()),e.updateCanvas(),{type:b.ZOOM_FIT_SUCCESS}}function ro(e,t){const r=e.getDimensionOffscreenCanvas(),n=Math.min(r.x/t.x,r.y/t.y);n!==1&&(e.setZoom(p(0,0),n,!0),e.updateCanvas(),e.action({id:crypto.randomUUID(),data:{type:b.SET_ZOOM_SUCCESS,payload:{position:e.options.position,currentZoomLevel:e.currentZoomLevel}}}))}function no(e,t){return e.setPosition(t.payload.position),e.updateCanvas(),{type:b.SET_POSITION_SUCCESS,payload:{}}}async function oo(e,t){return e.updateCanvas(),{type:t.type}}async function We(e,t){const{type:r}=t,n=Zn.withTag("Incoming").withTag("action");switch(e.debug&&n.withTag(r).start(t),r){case b.INIT:return Xn(e,t);case b.UPDATE_BUFFER:return Kn(e,t);case b.UPDATE_CANVAS:return oo(e,t);case b.REFRESH:return Qn(e,t);case b.SET_OPTIONS:return Yn(e,t);case b.SET_ZOOM:return to(e,t);case b.ZOOM_FIT:return eo(e);case b.SET_POSITION:return no(e,t);case b.DEBUG:return Wn(e,t);default:e.debug&&n.warn("Unknown message type from Creator Thread:",r)}}const io={[F.TOP_LEFT]:p(-.5,-.5),[F.TOP_CENTER]:p(0,-.5),[F.TOP_RIGHT]:p(.5,-.5),[F.CENTER_LEFT]:p(-.5,0),[F.CENTER]:p(0,0),[F.CENTER_RIGHT]:p(.5,0),[F.BOTTOM_LEFT]:p(-.5,.5),[F.BOTTOM_CENTER]:p(0,.5),[F.BOTTOM_RIGHT]:p(.5,.5)},so=10;function co(e,t,r,n=new v(0,0,0,.2)){const o=e.options.zoomLevel,i=e.getDimensionImageData(!0),s=p(()=>i/o),a=p(()=>i/s),u=p(()=>r.position*o*-1);if(t.lineWidth=1,t.strokeRect(u.x,u.y,i.x,i.y),a.x<so)return;const c=new Path2D;for(let l=0;l<=s.x;l++)c.moveTo(u.x+a.x*l,u.y),c.lineTo(u.x+a.x*l,u.y+i.y);for(let l=0;l<=s.y;l++)c.moveTo(u.x,u.y+a.y*l),c.lineTo(u.x+i.x,u.y+a.y*l);t.strokeStyle=`rgba(${n.toCSSRGBA()})`,t.stroke(c),t.globalCompositeOperation="source-over"}function uo(e){const t=new OffscreenCanvas(e.width,e.height),r=t.getContext("2d",{willReadFrequently:!0});return r&&(r.imageSmoothingEnabled=!1,r.putImageData(e,0,0)),t}function Ke(e,t=e.lastImageData){if(e.canvas&&e.ctx&&t){e.lastImageData=t;const r=uo(t);e.ctx.clearRect(0,0,e.canvas.width,e.canvas.height);const n=e.getDimensionOffscreenCanvas(),o=e.getDimensionImageData(),i=e.getDimensionImageData(!0),s=p(()=>((n-i)/2+(n-i)*io[e.options.origin])/i);let a=p(()=>o*s*-1);const u=p(()=>n/i*o),c=p(()=>e.options.position*o);a=p(()=>c+a);const l={position:a,dimension:u},f={position:p(0,0),dimension:n};e.ctx.drawImage(r,l.position.x,l.position.y,l.dimension.x,l.dimension.y,f.position.x,f.position.y,f.dimension.x,f.dimension.y),co(e,e.ctx,l,e.options.colors.grid)}else throw new Error("Display render failed: Offscreen canvas or context is not available.")}function ao(e,t=2){const r=Math.pow(10,t);return Math.round(e*r)/r}const d={debug:!1,options:new At,currentZoomLevel:1,lastImageData:void 0,canvas:void 0,ctx:void 0,view:void 0,sharedBuffer:void 0,mainWorkerPort:void 0,setOptions:e=>d.options=e,setSharedBuffer:e=>{d.sharedBuffer=e,d.view=new Uint8ClampedArray(e.buffer)},setZoom:ho,setPosition:fo,getDimensionImageData:e=>{var r,n;const t=e?d.options.zoomLevel:1;return p((((r=d.lastImageData)==null?void 0:r.width)||0)*t,(((n=d.lastImageData)==null?void 0:n.height)||0)*t)},getDimensionOffscreenCanvas:()=>{var e,t;return p(((e=d.canvas)==null?void 0:e.width)||0,((t=d.canvas)==null?void 0:t.height)||0)},precisionNumber(e){return ao(e,d.options.precision)},updateCanvas(){if(!d.view)throw new Error("View is not set.");const e=new Uint8ClampedArray(d.view.length);e.set(d.view);const t=new ImageData(e,d.sharedBuffer.dimension.x,d.sharedBuffer.dimension.y);Ke(d,t)},action:(e,t)=>lo(self,e,t),draw:(e=d.lastImageData)=>Ke(d,e)};async function lo(e,t,r){const n=await Lr(Et(t).pipe(In()));e.postMessage(n,r||[])}function fo(e){d.options.position=p(()=>d.precisionNumber(e))}function ho(e,t,r=!1){let n;const o=d.options.zoomLevel;if(r?n=t:t===0?n=1:n=o*t,d.currentZoomLevel=n,d.canvas&&d.lastImageData){const i=d.getDimensionOffscreenCanvas(),s=d.getDimensionImageData(),a=p(()=>e/o*i/s/2);d.options.zoomLevel=n,d.options.position=p(()=>d.precisionNumber(d.options.position+a))}}qt(self,"message").pipe(_(e=>e.data),Vn()).subscribe(async({id:e,data:t})=>{try{const r=await We(d,t);r&&d.action({id:e,data:r})}catch(r){Ut.error("Error processing action:",r)}})})();
