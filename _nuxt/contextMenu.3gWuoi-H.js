var R=Object.defineProperty;var _=(o,t,s)=>t in o?R(o,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):o[t]=s;var u=(o,t,s)=>(_(o,typeof t!="symbol"?t+"":t,s),s);import{n as O,P as b,N as k,V as q,a as D,b as P}from"./NoteDescription.B3_63kT9.js";import{D as j}from"./Navigation.Dae1JD5I.js";import{T as K,a as C,b as B,c as Y,d as H}from"./Track.BjZKC-se.js";import{K as N,_ as L,i as Z,t as z,v as $,z as U}from"./entry.CpSyzEib.js";import{Z as F,j as x,k as V,u as W,q as i,al as X}from"./index.pPIpAzmo.js";import{C as h,r as A}from"./index.BT3TFeHx.js";class ct{constructor(t,s){u(this,"track");u(this,"playing",!1);u(this,"currentSequence");u(this,"autoplay");u(this,"instrument");u(this,"instruments",[]);u(this,"sequenceNoteIndex",{});u(this,"instrumentIndex",-1);const{autoplay:e}=s||{};if(!(t instanceof K))throw new Error("TrackPlayer requires a Track");this.track=t,this.autoplay=e!==void 0?e:!0}createInstrument(){var t;(t=this.instrument)==null||t.dispose(),this.instrument=I(this.track.type)}refresh(){const t=this.track.notes;return this.createSequence(t,()=>{console.log("complete"),this.clearSequence(),this.playing=!1}),t}play(){if(!this.track.type)throw new Error("TrackPlayer requires an instrument");return this.refresh(),this.autoplay&&(this.currentSequence.start(0),this.playing=!0),this.currentSequence}pause(){this.instruments.forEach(t=>t.context.transport.pause()),this.playing=!1}stop(){this.clearSequence(),this.playing=!1}restart(){this.stop(),this.play()}reset(){this.clearSequence(),this.stop(),this.track.notes=[]}destroy(){var t;(t=this.instrument)==null||t.dispose(),this.instruments.forEach(s=>s.dispose()),this.clearSequence()}triggerAttack(t){this.instrumentIndex++,this.getInstrument().triggerAttack(t)}triggerRelease(){this.getInstrument().triggerRelease(),this.instrumentIndex--}triggerAttackRelease(t){this.instrumentIndex++,console.log("triggerAttackRelease",this.instrumentIndex,t.getName(),t.getTime(),t.delay,(t.delay+t.toSeconds())*1e3),window.setTimeout(()=>{console.log("fertig"),this.instrumentIndex--},(t.delay+t.toSeconds())*1e3),this.getInstrument().triggerAttackRelease(t.getName(),t.getTime(),t.delay)}getInstrument(){return this.instrumentIndex>this.instruments.length-1&&this.instruments.push(I(this.track.type)),this.instruments[this.instrumentIndex]}createSequence(t,s){var e;this.currentSequence||((e=this.currentSequence)==null||e.dispose(),this.currentSequence=N(new G(t,(n,r,m,y)=>{console.log(n),this.triggerAttackRelease(n),this.sequenceNoteIndex={...this.sequenceNoteIndex,[Number(r)]:y[Number(m)].index},m===y.length-1&&delete this.sequenceNoteIndex[Number(r)]},s!==void 0?s:void 0)))}clearSequence(){var t;(t=this.currentSequence)==null||t.dispose(),this.currentSequence=null}}class G{constructor(t,s,e){u(this,"startTime",0);u(this,"sequenceMap",new Map);this.onTick=s,this.onComplete=e,this.notes=t}async start(t=0){const s=D;s.stop(),s.seconds=0,s.start(),this.startTime=O();const e=this.sequenceMap,n=Promise.all(Object.entries(J(this.notes)).map(([r,m])=>{const y=m.map((l,p)=>{const a=`${p}_${l.getTime()}`;let{notes:c,part:d,complete:g}=e.get(a)||(()=>{const S=[];let f=0;const w=new j,T=new b((...E)=>{this.onTick(new k({delay:E[0],note:E[1],time:l.getTime()}),p,f,S),f++,f>T.length-1&&w.resolve()},[],l.getTime());return{notes:S,part:T,complete:w.promise}})();return e.set(a,{notes:c,part:d,complete:g}),d.add(l.delay,l.getName()),c.push(l),{notes:c,part:d,complete:g}});return Promise.all(y.map(({complete:l})=>l))}));return Array.from(e.values()).forEach(({part:r})=>{r.start(t)}),await n,this.onComplete(),n}pause(){Array.from(this.sequenceMap.values()).forEach(({part:t})=>{t.pause()})}cancel(){Array.from(this.sequenceMap.values()).forEach(({part:t})=>{t.cancel()})}stop(){Array.from(this.sequenceMap.values()).forEach(({part:t})=>{t.stop()})}dispose(){Array.from(this.sequenceMap.values()).forEach(({part:t})=>{t.dispose()})}}function I(o){const t=P[String(o)],s=new q(-100).toDestination(),e=new t().connect(s).toDestination();return N(e)}function J(o){return o.reduce((t,s)=>(t[s.delay]=t[s.delay]||[],t[s.delay].push(s),t),{})}const Q={components:{AtomMarkdown:F},props:{...x,model:{type:Object,required:!0}},emits:[...V],setup(o,t){return{windowContext:W(o,t)}},data(){return{content:["# Synthesizer","Simple synthesizer with notes view and midi api support.","",`Version: **0.1**  
Created by **Thorn-Welf Walli**`,"","Thanks to:","- [Tone.js](https://tonejs.github.io/)","- [WEBMIDI.js](https://webmidijs.org/)"].join(`
`)}}},M={class:"wb-disks-debug-synthesizer-info"};function v(o,t,s,e,n,r){const m=Z("atom-markdown");return z(),$("div",M,[U(m,{content:n.content},null,8,["content"])])}const tt=L(Q,[["render",v],["__scopeId","data-v-4615a7e8"]]),lt=({core:o,mainWindow:t,parentWindow:s,preserveContextMenu:e,model:n,trackModel:r})=>{const{windows:m}=o.modules;function y(){return(s||t).close()}const l=n[h.SYNTHESIZER_PROJECT],p=r&&r[h.SYNTHESIZER_TRACK];return[{title:"Synthesizer",items:[{hotKey:"I",keyCode:73,title:"Info",async action(){e(!0),await m.addWindow({title:"Info",component:tt,componentData:{model:n},options:{prompt:!1,scaleX:!1,scaleY:!1,scrollX:!1,scrollY:!1}},{group:"extras13Synthesizer"}).awaitClose(),e(!1),t.focus()}},{type:i.SEPARATOR},{title:"Debug",items:[{title:"Notes",async action(){e(!0);const{window:a}=n.actions.openDebugNotes();await a.awaitClose(),e(!1),t.focus()}},{title:"Midi",async action(){e(!0);const{window:a}=n.actions.openDebugMidi();await a.awaitClose(),e(!1),t.focus()}},{title:"Timeline",async action(){e(!0);const{window:a}=n.actions.openDebugTimeline();await a.awaitClose(),e(!1),t.focus()}}]},{type:i.SEPARATOR},{title:"Close",action:y}]},...r?[]:[{title:"Project",items:[{title:"New…",action:async()=>{e(!0),await n.actions.newProject(),e(!1),t.focus()}},{title:"Edit Name…",action:async()=>{e(!0);const a=await A(o,"Project renaming:",l.name);a&&(l.name=a),e(!1),t.focus()}},{title:"Open…",hotKey:"O",keyCode:79,action:async()=>{await n.actions.openProject()}},{title:"Save…",hotKey:"S",keyCode:83,action:async()=>await n.actions.saveProject()},{type:i.SEPARATOR},{title:"Import… (JSON)",hotKey:"S",keyCode:83,type:i.UPLOAD,async action(a){return await n.actions.importProject(a[0])}},{title:"Export (JSON)",action:async()=>await n.actions.exportProject()}]},{title:"Track",items:[{title:"New…",action:async()=>{e(!0),await n.actions.newTrack(),e(!1),t.focus()}},{type:i.SEPARATOR},{title:"Clear",async action(){e(!0),await n.actions.clearTracks(),e(!1),t.focus()}}]}],...r&&[{title:"Track Options",items:[{type:i.CHECKBOX,title:"Show Note Labels",name:h.SYNTHESIZER_TRACK_SHOW_NOTE_LABELS,model:r},{type:i.CHECKBOX,title:"Show Keyboard",name:h.SYNTHESIZER_TRACK_SHOW_KEYBOARD,model:r},{type:i.DEFAULT,title:"Keyboard Size",items:Object.entries(C()).map(([a,c])=>({type:i.RADIO,title:c,model:r,name:h.SYNTHESIZER_TRACK_KEYBOARD_SIZE,value:a}))},{type:i.DEFAULT,title:"Keyboard Alignment",items:Object.entries(B()).map(([a,c])=>({type:i.RADIO,title:c,model:r,name:h.SYNTHESIZER_TRACK_KEYBOARD_ALIGN,value:a}))},{type:i.SEPARATOR},{title:"Edit Name…",action:async()=>{e(!0);const a=await A(o,"Track renaming:",p.name);a&&(p.name=a,t.options.title=p.name),e(!1),t.focus()}},{type:i.DEFAULT,title:"Note Count",items:Object.entries(Y()).map(([a,c])=>({type:i.RADIO,title:`${a} (${c})`,model:p,name:"noteCount",value:c}))},{type:i.DEFAULT,title:"Base Note",items:Object.entries(H()).map(([a,c])=>({type:i.RADIO,title:a,model:p,name:"baseNote",value:c}))},{type:i.SEPARATOR},{type:i.DEFAULT,title:"Beat Count",items:Array(9).fill({}).map((a,c)=>({type:i.RADIO,title:String(c+1),model:p,name:"beatCount",value:c+1}))}]}]||[],{title:"Options",items:[{type:i.DEFAULT,title:`BPM (${n[h.SYNTHESIZER_BPM]})`,items:[30,60,120,240,480].map(a=>({type:i.RADIO,title:String(a),model:n,name:h.SYNTHESIZER_BPM,value:a}))}]},...X({core:o})].filter(Boolean)};export{ct as T,lt as c};
