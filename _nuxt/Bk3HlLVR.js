var e=Object.defineProperty,__publicField=(t,o,s)=>((t,o,s)=>o in t?e(t,o,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[o]=s)(t,"symbol"!=typeof o?o+"":o,s);import{N as t,T as o}from"./G8w6tKzW.js";import{G as s,I as n}from"./CybH7Zs2.js";var r,i={};var a=function requireLib(){return r||(r=1,Object.defineProperty(i,"__esModule",{value:!0}),i.isRangeOverlap=void 0,i.isRangeOverlap=function isRangeOverlap(e,t,o,s,n){var r,i,a,c,d=!1;return Array.isArray(e)&&Array.isArray(t)?(r=e[0],i=e[1],a=t[0],c=t[1],d=!0===o):void 0===o?(r=e.start,i=e.end,a=t.start,c=t.end,d=!0===o):(r=e,i=t,a=o||e,c=s||t,d=!0===n),d?r<c&&a<i:r<=c&&a<=i}),i}();class TimelineNoteDescription extends t{constructor(e={}){super(e),__publicField(this,"octavePosition"),__publicField(this,"origin");const{selected:t,octavePosition:o,origin:s}=e||{};this.selected=void 0!==t&&t,this.octavePosition=void 0!==o?o:0,this.origin=s}resolvedIndex(){return void 0!==this.origin?this.origin.index:this.index}toJSON(){return{...super.toJSON(),selected:this.selected,octavePosition:this.octavePosition,index:this.index}}}function getBaseNotes(){return Object.fromEntries([2,4,8,12,16].map(e=>[String(e),e]))}function getDecibelFromValue(e){return Math.max(Math.min(30*(e/.5-1),30),-30)}const c=9;function getNotePosition(e,t){let o=t.name;if(o){const t=o.match(/(.+)(\d+)/)||[];o=t[1];const s=Number(t[2]);let n=o;o.length&&(n=o[0]);const r=s-e,i={c:3,d:2.5,e:2,f:1.5,g:1,a:.5,b:0}[n.toLowerCase()];if(void 0===i)throw new Error(`Unknown note name: ${n}`);return-1*i+r+2.5*r}return-1.25}const d={cbbb:-3,cbb:-2,cb:-1,c:0,"c#":1,cx:2,"c##":2,"c###":3,"cx#":3,"c#x":3,dbbb:-1,dbb:0,db:1,d:2,"d#":3,dx:4,"d##":4,"d###":5,"dx#":5,"d#x":5,ebbb:1,ebb:2,eb:3,e:4,"e#":5,ex:6,"e##":6,"e###":7,"ex#":7,"e#x":7,fbbb:2,fbb:3,fb:4,f:5,"f#":6,fx:7,"f##":7,"f###":8,"fx#":8,"f#x":8,gbbb:4,gbb:5,gb:6,g:7,"g#":8,gx:9,"g##":9,"g###":10,"gx#":10,"g#x":10,abbb:6,abb:7,ab:8,a:9,"a#":10,ax:11,"a##":11,"a###":12,"ax#":12,"a#x":12,bbbb:8,bbb:9,bb:10,b:11,"b#":12,bx:13,"b##":13,"b###":14,"bx#":14,"b#x":14};function getOctaveRangeFromNotes(e){const{min:t,max:o}=e.filter(e=>e.octave).reduce((e,t)=>(void 0!==t.octave&&(e.min=Math.min(t.octave,e.min),e.max=Math.max(t.octave,e.max)),e),{min:1/0,max:-1/0});return{max:o,min:t,length:Math.max(Math.ceil(o-t),1)}}Object.values(d).reduce((e,t)=>Math.min(e,t),1/0),Object.values(d).reduce((e,t)=>Math.max(e,t),-1/0);const u={"A#":["A","C#","E"],"B#":["B","D#","F#"],"C#":["C","E","G"],"D#":["D","F#","A"],"E#":["E","G#","B"],"F#":["F","A","C"],"G#":["G","B","D"],"Ab#":["Ab","C","Eb"],"Bb#":["Bb","D","F"],"Cb#":["Cb","Eb","Gb"],"Db#":["Db","F","Ab"],"Eb#":["Eb","G","Bb"],"A#2":["A","C#","E","B"],"B#2":["B","D#","F#","C#"],"C#2":["C","E","G","D"],"D#2":["D","F#","A","E"],"F#2":["F","A","C","D"],"G#2":["G","B","D","A"],"Ab#2":["Ab","C","Eb","Bb"],"Bb#2":["Bb","D","F","C"],"Cb#2":["Cb","Eb","Gb","Db"],"Db#2":["Db","F","Ab","Eb"],"Eb#2":["Eb","G","Bb","F"]};function resolveChord(e){var t;if(/^([A-Za-z]+[#xb]{,2})(\d)+$/.test(e)){const[,o,s]=e.match(/^([A-Za-z]+[#xb]{,2})(\d)+$/)||[];return Array.from(new Set((null==(t=u[o])?void 0:t.map(resolveChord).flat())||[e])).map(e=>`${e}${s||""}`)}return[e]}function getNoteTimes({triplet:e=!1,dotted:t=!1,natural:s=!0}={}){return[1,2,4,8,16,32].map(o=>[s?`${o}n`:void 0,e?`${o}t`:void 0,t?`${o}n.`:void 0].filter(Boolean)).flat().map(e=>[e,o(e).toSeconds()])}class Beat{constructor({noteGroups:e,index:t}){__publicField(this,"noteGroups"),__publicField(this,"index"),this.noteGroups=e,this.index=t}get empty(){return!Object.values(this.noteGroups).length}get selected(){return Object.values(this.noteGroups).some(e=>e.some(e=>e.notes.some(e=>e.selected)))}}class NoteGroup{constructor({align:e,notes:t}){__publicField(this,"notes"),__publicField(this,"align"),this.notes=t,this.align=e}get startSeconds(){return this.notes[0].delay}get endSeconds(){const e=this.notes[this.notes.length-1];return e.delay+e.toSeconds()}get selected(){return this.notes.some(({selected:e})=>e)}getNote(e){return this.notes[Number(e)]}}function prepareNotes(e){const{min:t}=getOctaveRangeFromNotes(e);return Array().concat(e).sort((e,t)=>e.delay-t.delay).map((e,o)=>new TimelineNoteDescription({...e,index:o,octavePosition:getNotePosition(t,e)}))}function beatsFromGroupedNotes(e,t=1){const o=Object.entries(e),s=2*t,n=function getDurationFromGroupedNotes(e){return e.reduce((e,[,t])=>Math.max(t.reduce((e,{notes:t})=>Math.max(t.reduce((e,t)=>Math.max(t.delay+t.toSeconds(),e),0),e),0),e),0)}(o),r=Math.ceil(n/s),i=[];for(let a=0;a<r;a++){const e=[];for(let t=0;t<o.length;t++){const[n,r]=o[Number(t)],i=r.filter(({startSeconds:e,endSeconds:t})=>e>=a*s&&t<=(a+1)*s);i.length&&e.push([n,i])}i.push(new Beat({noteGroups:Object.fromEntries(e),index:a}))}return i}function groupedByInterest(e){const t=[];for(;e.length;){const o=e.shift();let n=[];n=e.reduce((e,t)=>(t.delay>=o.delay+o.toSeconds()&&e.push(t),e),[]),n=n.reduce((e,t)=>((!e.length||e.length&&e[e.length-1].delay<=t.delay+t.toSeconds())&&e.push(t),e),[]),n=n.reduce((e,t,s)=>{var r;return n[0].delay-o.delay<=.5&&(!(null==(r=o.time)?void 0:r.triplet)||o.time.triplet&&s<2)&&e.push(t),e},[]),n=n.reduce((e,t)=>(t.delay-o.delay%2+t.toSeconds()<=o.delay-o.delay%2+2-o.delay%2&&e.push(t),e),[]);let r=!1,i=o;n=n.reduce((e,t)=>(r&&r!==getAlign(t.octavePosition-i.octavePosition)||e.push(t),r=getAlign(t.octavePosition-i.octavePosition),i=t,e),[]);const a=1;let c;n=n.reduce((e,t)=>{const s=(c||o).octavePosition-t.octavePosition;return s>-a&&s<a&&e.push(t),c=t,e},[]);let d=0;n.length&&(d=n[0].octavePosition-o.octavePosition);let u=s.ASCENDING;u=getAlign(d),e=e.filter(e=>!n.includes(e)),n.unshift(o),t.push(new NoteGroup({notes:n,align:u}))}return t}function getAlign(e){return e<0?s.DESCENDING:e>0?s.ASCENDING:s.EQUAL}class TimeNotation{constructor(e){__publicField(this,"number"),__publicField(this,"baseCharacter"),__publicField(this,"dot"),__publicField(this,"triplet");const{number:t,character:o,dot:s}=function splitNotation(e){if(e instanceof TimeNotation)return e;if("number"==typeof e)return e;try{const[,t,o,s]=e.match(/^(\d+)([a-z])(\.?)$/i)||[];return{number:Number(t),character:o,dot:!!s,triplet:"t"===o}}catch(t){throw console.error(t),t}}(e);this.number=t,this.baseCharacter=o,this.dot=s||!1,this.triplet="t"===o}get character(){return this.triplet?"t":this.baseCharacter}toString(){return`${this.number}${this.character}${this.dot?".":""}`}static parse(e){return new TimeNotation(e)}}class Track{constructor(e={}){__publicField(this,"id"),__publicField(this,"type"),__publicField(this,"name"),__publicField(this,"notes"),__publicField(this,"baseNote"),__publicField(this,"beatCount"),__publicField(this,"noteCount"),__publicField(this,"speed",1),__publicField(this,"selectedIndex",-1),__publicField(this,"currentDuration",0);const{id:o,type:s,name:r,notes:i,baseNote:a,beatCount:c,noteCount:d,speed:u}=e;this.id=o||crypto.randomUUID(),this.type=s||n.SYNTH,this.name=r||"Track",this.notes=(i||[]).map(e=>new t(e)),this.refreshNotes(),this.beatCount=Number(c||1),this.baseNote=Number(a||4),this.noteCount=Number(d||4),this.speed=Number(u||1)}setSelectedIndex(e){this.selectedIndex=e}setCurrentDuration(e){this.currentDuration=e}getOctaveRange(){const{min:e,length:t}=getOctaveRangeFromNotes(this.notes);return{start:e,count:t}}reset(){this.selectedIndex=-1,this.notes=[]}addNote(e){if(e=new t(e),!this.notes.find(t=>t.getName()===e.getName()&&a.isRangeOverlap(t.delay,t.toSeconds(),e.delay,e.delay+e.toSeconds())))return this.notes.push(e),this.refreshNotes(),e}addNoteTo(e,o){return this.notes=[...this.notes.slice(0,e+1),new t(o),...this.notes.slice(e+1)],this.refreshNotes(),o}getNote(e){return this.notes[Number(e)]}replaceNote(e,o){return this.notes[Number(e)]=new t(o),this.refreshNotes(),this.notes[Number(e)]}removeNote(e){this.notes=this.notes.filter((t,o)=>e!==o),this.refreshNotes()}refreshNotes(){this.notes=[...this.notes].sort((e,t)=>e.delay-t.delay).map((e,t)=>(e.index=t,e))}removeNotesByDurationRange(e,t){this.getNotesByDurationRange(e,t).forEach(({index:e})=>this.removeNote(e))}removeNotesFromBeat(e){const t=2*e;this.removeNotesByDurationRange(t,2)}getDuration(){return function getDurationFromNotes(e){return e.reduce((e,t)=>e+t.toSeconds(),0)}(this.notes)}getNotesByDurationRange(e,t){return this.notes.filter(o=>a.isRangeOverlap(e,e+t,o.delay,o.delay+o.toSeconds()))}getVisibleBeatsByDuration(e,t=this.notes){e=void 0!==e?e:this.currentDuration;const o=this.getBeatIndex(e);t=t.filter(e=>e.delay>=2*o&&e.delay+e.toSeconds()<2*o+2*this.beatCount);const s=this.getBeats({selectedIndex:this.selectedIndex,speed:this.speed},t);return console.log("slice",t.length),s.slice(o,o+this.beatCount)}getVisibleBeats(){var e;const t=this.getBeats({selectedIndex:this.selectedIndex,speed:this.speed});let o=(null==(e=t.find(e=>e.selected))?void 0:e.index)||0;return o=Math.floor(o/this.beatCount)*this.beatCount,t.slice(o,o+this.beatCount)}getNotationFromNoteCount(){return new TimeNotation(`${this.noteCount}n`)}getBeats(e={},t=this.notes){const{selectedIndex:o,speed:s}={selectedIndex:-1,speed:1,...e};o>-1&&t.find(({index:e})=>o===e)&&t.filter(({index:e})=>o===e).forEach(e=>e.selected=!0);const n=t.filter(e=>e instanceof TimelineNoteDescription);if(n.length!==t.length)throw new Error("TimelineNoteDesciptions and notes not equal.");const r=function groupedNotesFromNotes(e){const t=e.reduce((e,t)=>{const{time:o}=t,s=null==o?void 0:o.toString();return e[s||"pause"]||(e[s||"pause"]=[]),e[s||"pause"].push(t),e},{}),o=Object.entries(t).map(([e,t])=>[e,t.sort((e,t)=>e.octave-t.octave||e.delay-t.delay)]).map(([e,t])=>[e,groupedByInterest(t)]).sort((e,t)=>e.toString()[0].localeCompare(t.toString()[0]));return Object.fromEntries(o)}(n);return beatsFromGroupedNotes(r,s)}getBeatIndex(e=this.currentDuration){return(e/(2*this.beatCount)-e%(2*this.beatCount)/(2*this.beatCount))*this.beatCount}getCurrentNote(){return this.getNote(this.selectedIndex)}selectPrevNote(){this.selectedIndex=Math.max(this.selectedIndex-1,-1)}selectNextNote(){this.selectedIndex=Math.min(this.selectedIndex+1,this.notes.length-1)}}const h=Object.freeze(Object.defineProperty({__proto__:null,default:Track},Symbol.toStringTag,{value:"Module"}));export{c as B,Track as T,getBaseNotes as a,getOctaveRangeFromNotes as b,getNoteTimes as c,h as d,getDecibelFromValue as g,prepareNotes as p,resolveChord as r};
