var L=Object.defineProperty;var F=(o,t,e)=>t in o?L(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var l=(o,t,e)=>F(o,typeof t!="symbol"?t+"":t,e);import{g as f,h as _}from"./BxO05Tpb.js";import{B as u,p as H,h as V,T as W}from"./C8JtUr3H.js";import{f as q,p as j}from"./C1Z8QYso.js";import{a as k,N as U}from"./AEwztriR.js";import{G as A}from"./DWxMEIfg.js";import{_ as Q,t as P,v as I,x as O,$ as X,a0 as Y,Y as Z,Z as J,y as K}from"./wBwW-Gex.js";const tt=4;class et{constructor(t,e){l(this,"beatCount",1);l(this,"gutter",27);l(this,"count",1);l(this,"height",36);l(this,"outerMargin",[10,0,10,0]);l(this,"innerMargin",[0,48,0,48]);l(this,"innerPadding",[20,0,10,0]);l(this,"color","#ffaa55");this.setOptions(e),this.canvas=t,this.ctx=t.getContext("2d")}setOptions(t){const{gutter:e,height:i,margin:n,color:r,outerMargin:a,innerMargin:x,innerPadding:d}=t||{};this.gutter=e||this.gutter,this.height=i||this.height,this.margin=n||this.margin,this.color=r||this.color,this.outerMargin=a||this.outerMargin,this.innerMargin=x||this.innerMargin,this.innerPadding=d||this.innerPadding}render({beatCount:t,count:e}){this.count=e,this.beatCount=t;const i=this.ctx;i.clearRect(0,0,i.canvas.width,i.canvas.height);for(let n=0;n<this.count;n++)this.renderGridRow(this.getGridBoundingBox(n),this.getInnerGridBoundingBox(n))}getInnerGridRowBoundingBox(t){const{position:e,dimension:i}=this.getInnerGridBoundingBox(t);return{position:e,dimension:f(i.x,i.y*this.beatGrid.y+1)}}get firstRowIndex(){return 0}get lastRowIndex(){return this.count-1}get innerBoundingBox(){return{position:f(this.outerMargin[0],this.outerMargin[1]),dimension:f(this.ctx.canvas.width-(this.outerMargin[0]+this.outerMargin[2]),this.ctx.canvas.height-(this.outerMargin[1]+this.outerMargin[3]))}}get beatGrid(){return f(this.beatCount,tt)}get dimension(){return f(this.canvas.width,this.canvas.height)}get mergedMargin(){return[this.outerMargin[0]+this.innerMargin[0],this.outerMargin[1]+this.innerMargin[1],this.outerMargin[2]+this.innerMargin[2],this.outerMargin[3]+this.innerMargin[3]]}getGridBoundingBox(t){const e=this.mergedMargin,i=e[0]+0,n=e[1]+t*this.height+t*this.gutter,r=-(e[0]+e[2])+this.dimension.x,a=this.height/this.beatGrid.y;return{position:f(i,n),dimension:f(r,a)}}getInnerGridBoundingBox(t){const{position:e,dimension:i}=this.getGridBoundingBox(t);return{position:f(e.x+this.innerPadding[0],e.y+this.innerPadding[1]),dimension:f(i.x-this.innerPadding[0]-this.innerPadding[2],(this.height-this.innerPadding[1]-this.innerPadding[3])/this.beatGrid.y)}}renderGridRow(t,e){const i=this.ctx;i.fillStyle=i.strokeStyle=this.color;let n=new Path2D;nt(n,this.beatGrid,t),i.fill(n),n=new Path2D,it(n,this.beatGrid,e,{first:!0,last:!0}),i.fill(n),i.fillRect(t.position.x+t.dimension.x-5,t.position.y,5,t.dimension.y*this.beatGrid.y)}}function it(o,t,{position:e,dimension:i},n={}){const{first:r,last:a}={first:!1,last:!1,...n};for(let x=r?0:1;x<t.x+a||!1;x++)o.rect(e.x+0+x*Math.floor(i.x/t.x),e.y,1,i.y*t.y)}function nt(o,t,{position:e,dimension:i}){for(let n=0;n<=t.y;n++)o.rect(e.x,n*i.y+e.y,i.x,1)}class st{constructor(t,e={}){l(this,"padding",10);l(this,"flipActive",!1);l(this,"colors",{background:"#0055aa",foreground:"#ffffff",highlight:"#ffaa55"});l(this,"baseNote",4);l(this,"noteCount",4);const{colors:i,gridRenderer:n,noteRenderer:r}={gridRenderer:null,noteRenderer:null,...e};this.colors={...this.colors,...i},this.gridRenderer=n,this.noteRenderer=r,this.canvas=t,this.ctx=t.getContext("2d")}async render({baseNote:t,noteCount:e,beats:i,flipActive:n}){this.flipActive=n||!1,this.baseNote=t,this.noteCount=e,this.beats=i;const r=this.gridRenderer.beatCount,{position:a,dimension:x}=this.gridRenderer.getInnerGridRowBoundingBox(this.gridRenderer.lastRowIndex),d=[];for(let m=0;m<this.beats.length;m++){const y=this.beats[Number(m)],w=x.x/r-this.padding*2,R=a.x+this.padding+m*w+m*this.padding*2;d.push(await this.renderBeat(y,R,w))}return d.flat()}async renderBeat(t,e,i){const n=this.baseNote,r=this.noteCount,a=[],{position:x,dimension:d}=this.gridRenderer.getInnerGridRowBoundingBox(this.gridRenderer.lastRowIndex),m=Object.entries(t.noteGroups);for(let y=0;y<m.length;y++){const[,w]=m[Number(y)];for(let R=0;R<w.length;R++){const{notes:v,align:M}=w[Number(R)];let g;for(let p=0;p<v.length;p++){const G=p===0,D=p===v.length-1,$=v[Number(p)].bindingCount&&(G||g),C=this.flipActive&&v[Number(p)].bindingCount>0&&R%2===1&&v[Number(p)].name,S=await this.resolveNote(v,p,{baseNote:n,noteCount:r,align:M,flip:C,binding:$}),{position:E,note:B,canvas:T}=S;let h=S.firstPixel;C&&(h=[T.width-h.x-1,T.height-h.y-1-u]);let s=_(e,x.y);s.x=s.x+i*(B.delay-t.index*2)/2,s.y+=(d.y-T.height)/2,s.y-=T.height/2,s.y+=k,s.y+=u/2,s.y-=E.y,s=_(()=>Math.round(s));let N=T;if(C&&(N=q(T,!0,!0),s.y+=k+N.height-u*2),this.ctx.drawImage(N,s.x,s.y),a.push({dimension:f(N.width,N.height),position:s,note:B}),!B.isPause){if(this.ctx.fillStyle=this.getNoteColors(B).primary,p===0&&p===v.length-1){const b=[5,2];for(let c=0;c<B.bindingCount;c++)C?(this.ctx.fillRect(s.x+h.x,s.y+u+h.y+c*-6,...b),this.ctx.fillRect(s.x+h.x+b[0]-2,s.y+u+h.y+c*-6-2,2,2)):(this.ctx.fillRect(s.x+h.x,s.y+h.y+c*6,...b),this.ctx.fillRect(s.x+h.x+b[0]-2,2+s.y+h.y+c*6,2,2))}else if(G)g=f(s.x+h.x,s.y+h.y);else if(D){this.ctx.lineWidth=1;const b=4;this.ctx.beginPath();for(let c=0;c<B.bindingCount;c++)C?(this.ctx.moveTo(g.x,g.y+u-c*6),this.ctx.lineTo(s.x+h.x+1,s.y+h.y+u-c*6),this.ctx.lineTo(s.x+h.x+1,s.y+h.y+u-c*6+b),this.ctx.lineTo(g.x,g.y+u-c*6+b),this.ctx.lineTo(g.x,g.y+u-c*6)):(this.ctx.moveTo(g.x,g.y+c*6),this.ctx.lineTo(s.x+h.x+1,s.y+h.y+c*6),this.ctx.lineTo(s.x+h.x+1,s.y+h.y+c*6+b),this.ctx.lineTo(g.x,g.y+c*6+b),this.ctx.lineTo(g.x,g.y+c*6));this.ctx.fill(),g=null}}}}}return a}async resolveNote(t,e,{align:i,flip:n,binding:r}){const a=t[Number(e)],x=f(0,a.octavePosition*u);let d=0;const m=i===A.ASCENDING,y=i===A.EQUAL?0:3,w=t[t.length-1],R=t[0];r&&(n?m?d=Math.floor((a.octavePosition-R.octavePosition)*u-y*e):d=Math.floor((a.octavePosition-w.octavePosition)*u-y*(t.length-1-e)):m?d=Math.floor((w.octavePosition-a.octavePosition)*u-y*(t.length-1-e)):d=Math.floor((R.octavePosition-a.octavePosition)*u-y*e));const{canvas:v,...M}=await this.noteRenderer.render(a,{colors:this.getNoteColors(a)},d);return{offsetHeight:d,position:x,note:a,canvas:v,...M}}getNoteColors(t){return{primary:t.selected?this.colors.highlight:this.colors.foreground,secondary:this.colors.background}}}class rt{constructor(t,e){l(this,"colors",{background:"#0055aa",foreground:"#ffffff",highlight:"#ffaa55"});l(this,"gridInnerPadding",[20,0,10,0]);const{colors:i}=e||{};this.colors={...this.colors,...i},this.canvas=t,this.ctx=t.getContext("2d",{willReadFrequently:!0}),this.noteRenderer=new U,this.gridRenderer=new et(this.canvas,{innerPadding:this.gridInnerPadding}),this.beatRenderer=new st(this.canvas,{gridRenderer:this.gridRenderer,noteRenderer:this.noteRenderer})}async render(t,e={}){e={selectedIndex:[],flipActive:!1,...e},this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.gridRenderer.render({beatCount:t.beatCount,count:this.getOctaveLength(t)});let i=[];try{const n=t.getVisibleBeatsByDuration(void 0,H(t.notes));i=await this.beatRenderer.render({flipActive:e.flipActive,baseNote:t.baseNote,noteCount:t.noteCount,beats:n})}catch(n){console.error(n)}for(let n=0;n<this.gridRenderer.count;n++){const{position:r}=this.gridRenderer.getGridBoundingBox(n);this.renderTimeSignature(t,r.x+(this.gridInnerPadding[0]-6)/2,r.y+3)}return j(this.ctx,["#000000","#ffffff",...Object.values(this.colors)]),{notes:i}}renderTimeSignature(t,e,i){const r=this.ctx;r.fillStyle=this.colors.foreground,r.textBaseline="top",r.font='16px "Amiga Topaz 13", sans-serif',r.fillText(t.baseNote,e,i),r.fillText(t.noteCount,e,i+16*1+1)}getOctaveLength(t){const{length:e}=V(t.notes);return Math.max(Math.floor(e*.8),1)}getDimension(t){const{height:e,gutter:i,outerMargin:n,innerMargin:r}=this.gridRenderer,a=this.getOctaveLength(t);return f(void 0,e*a+i*(a-1)+n[1]+n[3]+r[1]+r[3])}}const ot={props:{flipActive:{type:Boolean,default:!1},track:{type:W,required:!0},clickable:{type:Boolean,default:!1},static:{type:Boolean,default:!1},selectedNotes:{type:Array,default:()=>[]}},emits:["note:click","refresh","ready"],data(){return{colors:{background:"#ffffff",foreground:"#000000",highlight:"#ffaa55"},renderResult:null,timelineRenderer:null,dimension:f(0,0),renderTimeout:null,renderTimeoutB:null,ready:!1}},computed:{buttons(){var o;return this.clickable?((o=this.renderResult)==null?void 0:o.notes)||[]:[]},notes(){return this.track.notes}},watch:{track:{handler(){this.static||(window.clearTimeout(this.renderTimeoutB),this.renderTimeoutB=window.setTimeout(async()=>{await this.render(),this.renderTimeoutB=null},250))},deep:!0}},async mounted(){await this.createRenderer(),this.$emit("ready"),this.ready=!0},methods:{refresh(){return new Promise(o=>{const t=e=>{window.requestAnimationFrame(()=>{this.$nextTick(async()=>{await this.render(),this.$emit("refresh"),e()})})};this.ready?(window.clearTimeout(this.renderTimeout),this.renderTimeout=window.setTimeout(async()=>{await t(o),this.renderTimeout=null},100)):t(o)})},async render(){this.dimension=this.timelineRenderer.getDimension(this.track),this.$refs.canvas.width=this.$refs.canvas.offsetWidth,this.$refs.canvas.height=this.dimension.y,this.renderResult=await this.timelineRenderer.render(this.track,{flipActive:this.flipActive})},async createRenderer(){this.timelineRenderer=new rt(this.$refs.canvas),await this.refresh()},onClickNote(o){this.track.selectedIndex===o.index?this.track.selectedIndex=-1:this.track.selectedIndex=o.index,this.$emit("note:click",{note:o,selected:this.track.selectedIndex===o.index})}}},at={class:"synthesizer-timeline-canvas"},ht={ref:"canvas",width:"0",height:"0"},dt=["data-note","data-time","onClick"];function ct(o,t,e,i,n,r){return P(),I("div",at,[O("canvas",ht,null,512),(P(!0),I(X,null,Y(r.buttons,({position:a,dimension:x,note:d})=>(P(),I("button",{key:d.index,"data-note":d.note.toString(),"data-time":d.time.toString(),class:Z({selected:d.index===e.track.selectedIndex}),style:J({...a.toCSSVars("position"),...x.toCSSVars("dimension")}),onClick:m=>r.onClickNote(d)},[O("span",null,"Note "+K(d.index),1)],14,dt))),128))])}const pt=Q(ot,[["render",ct],["__scopeId","data-v-a69c797c"]]);export{pt as T};
