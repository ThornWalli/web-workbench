var e=Object.defineProperty,__publicField=(t,s,o)=>((t,s,o)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[s]=o)(t,"symbol"!=typeof s?s+"":s,o);import{P as t,D as s,a as o}from"./Cah-phv7.js";import{C as n}from"./g1R7VqXM.js";import{i as l,p as i}from"./BHmTNEz3.js";import{r as a,I as r,C as u}from"./BlFo7Aw2.js";import{d as c}from"./DdO-3S9B.js";import{d as m}from"./BSzGBLGV.js";import{n as d,d as p}from"./B1k18Rg6.js";import{u as v,S as f}from"./D1WZfvAb.js";import{S as h}from"./CrNGlbV0.js";import{f as y}from"./N5kgPtk_.js";import{d as w,k as g,r as b,L as S,a0 as E,o as C,W as I,F as z,z as x,R as _,P,D as M,A as W,a9 as T,_ as F,a7 as L,O as R,a1 as O,y as D,X as N,Y as A,Z as B,$ as j,G as k}from"./BfpYGSxR.js";import{c as H}from"./BdLbwnUH.js";import{g as V,d as G,A as U}from"./CJFEEUyp.js";import{C as q}from"./Dkhtr-D7.js";import{C as Y,a as X,W as $,b as K,P as Q}from"./CB0fCJMd.js";const Z=2e3;function getConfigDefaults(){return{[n.SCREEN_1084_FRAME]:!0,[n.SCREEN_REAL_LOOK]:!0,[n.SCREEN_SCAN_LINES]:!0,[n.SCREEN_ACTIVE_ANIMATION]:!0,[n.BOOT_WITH_SEQUENCE]:!0,[n.BOOT_WITH_WEBDOS]:!0,[n.THEME]:t[s],[n.FILE_EXTENSION_ASSIGNMENT]:[["md","DF0:DocumentReader.app"],["bas","DF1:WebBasic.app"],["basic","DF1:WebBasic.app"]],[n.SCREEN_CONFIG]:{contrast:.5,brightness:.5,color:.5,sharpness:0,horizontalCentering:.5,soundVolume:.5}}}const J="web_workbench_CONFIG";class Module{constructor({name:e,core:t,config:s={},commands:o,contextMenu:n}){__publicField(this,"config"),__publicField(this,"commands"),__publicField(this,"name"),__publicField(this,"core"),__publicField(this,"contextMenu"),this.name=e||"Module",this.core=t,this.config=s,this.commands=o,this.contextMenu=n}beforeSetup(){var e,t;const s=this.core;s.config.setDefaults(this.config),"function"==typeof this.commands&&(this.commands=V(this.commands({core:s,module:this})),H.add(this.commands)),"function"==typeof this.contextMenu&&(this.contextMenu=new q(this.contextMenu,{core:s,module:this}),null==(t=null==(e=this.core.modules.windows)?void 0:e.contextMenu)||t.addDefaultItems(this.contextMenu))}setup(){this.log(this.name)}destroy(){Array.isArray(this.commands)&&H.remove(this.commands)}log(e){this.core.logger.add(e,{namespace:this.name})}}const ee=["innerHTML"],te=F(w({__name:"Item",props:{parentLayout:{},clampGlobal:{type:Boolean},container:{type:Boolean},item:{},scrollOffset:{},wrapper:{}},emits:["click"],setup(e,{emit:t}){var s,o;const n=l(0,0),i=e,r=g(()=>{var e,t;const s=(null==(e=null==j?void 0:j.symbols.get(V.value.symbol||f.DEFAULT))?void 0:e.component)||(null==(t=null==j?void 0:j.symbols.get(f.DEFAULT))?void 0:t.component);return s?T(s):void 0}),{core:u}=v(),p=t,w=b(i.wrapper.selectedItems),F=b(!1),L=b(null),R=b(!1),O=S({start:l(0,0),move:l(0,0),lastPosition:l(0,0),offset:l(0,0),scrollOffset:l(0,0)}),D=new h,N=b(null),A=b(null),B=null==(s=u.value)?void 0:s.modules.screen,j=null==(o=u.value)?void 0:o.modules.symbols,k=g(()=>i.item.command),H=g(()=>i.item.id),V=g(()=>i.item.model),G=g(()=>i.item.layout),U=g(()=>V.value.url?"a":"button"),q=g(()=>V.value.url?{href:V.value.url,target:V.value.url?"_blank":null,title:V.value.title}:{}),Y=g(()=>(null==B?void 0:B.contentLayout)||{position:l(0,0),size:l(0,0)}),X=g(()=>w.value.includes(H.value)),$=g(()=>({moving:R.value,selected:X.value||F.value,"symbol-used":V.value.used}));function setLayout(e){var t;null==(t=i.item)||t.setLayout(e)}let K;function onRefresh(){setLayout({size:l(200,200)}),window.cancelAnimationFrame(K),K=window.requestAnimationFrame(()=>{var e;const t=null==(e=N.value)?void 0:e.children[0];t&&t instanceof HTMLElement&&setLayout({size:l(t.offsetWidth||0,t.offsetHeight||0)})})}E(()=>V.value,()=>{onRefresh()},{deep:!0}),C(()=>{var e;A.value=null==(e=N.value)?void 0:e.parentElement,onRefresh()}),I(()=>{D.unsubscribe(),i.wrapper.unselectItem(H.value)});let Q=!1;function onClick(e){var t;if(!Q){const s=H.value;if(V.value.url&&X.value)return!0;if(e.preventDefault(),V.value.used)return!0;if(k.value&&X.value){const e=a(k.value);if(e){const o={showCommand:!1,show:!0};return i.wrapper.unselectItem(s),V.value.used=!0,null==(t=u.value)?void 0:t.executeCommand(e,o).then(()=>V.value.used=!1)}}c.shiftActive?i.wrapper.isSelectedItem(s)?i.wrapper.unselectItem(s):i.wrapper.selectItem(s):(j&&j.getSelectedItems().length>0&&j.clearSelectedItems(),i.wrapper.selectItem(s)),p("click")}Q=!1}function onPointerDown(e){e=d(e),Q=!1,onClick(e)?Q=!0:(Q=!0,function startMove(e){if(A.value){const t=function getBounds(e){const{width:t,height:s,left:o,top:n}=e.getBoundingClientRect();return{position:l(o,n),size:l(t,s)}}(A.value);O.lastPosition=l(G.value.position.x,G.value.position.y),O.scrollOffset=l(Z.value.x,Z.value.y),O.start=e,O.offset=l(()=>O.start-G.value.position),setPosition(e,t,!0),R.value=!0;let s=e;const o=c.pointerMove.subscribe(e=>{s=l(e.x,e.y),setPosition(l(e.x,e.y),t,!0)});D.add(c.pointerUp.pipe(y()).subscribe(()=>(o.unsubscribe(),j&&j.getSecondaryWrapper().id!==i.wrapper.id?i.wrapper.moveItem(H.value,j.getSecondaryWrapper()).then(e=>{var t,s;return e||setLayout({position:l(null==(t=O.lastPosition)?void 0:t.x,null==(s=O.lastPosition)?void 0:s.y)}),L.value=null,R.value=!1,e}):(R.value=!1,setPosition(s,t),G.value.position.equals(l(()=>O.start-O.offset))?void 0:i.wrapper.savePosition(H.value,G.value.position)))))}}(l(e.x,e.y)))}function onPointerUp(){if(j){const e=j.getSelectedItems().filter(e=>e.id!==H.value),t=i.wrapper.get(H.value);t&&e.length>0&&t.fsItem instanceof m&&e.forEach(e=>i.wrapper.moveItemToItem(e.fsItem,t.fsItem))}}const Z=g(()=>i.scrollOffset||n);function setPosition(e,t,s=!1){const o={min:l(0,0),max:l(()=>t.size-G.value.size)};O.move=l(()=>e-O.start);let n=l(()=>Math.round(O.start+O.move-O.offset));s?(o.min=t.position,o.max=l(()=>o.max+Y.value.position),n=l(()=>Math.round(n+o.min)),i.clampGlobal?L.value=l(()=>Math.max(Math.min(n,Y.value.position+i.wrapper.size-G.value.size),o.min)):L.value=n):(i.wrapper.root?setLayout({position:l(()=>Math.max(Math.min(n,i.wrapper.size-G.value.size),0))}):setLayout({position:l(()=>Math.max(n,0))}),L.value=null)}return(e,t)=>(x(),z(_(U.value),P(q.value,{ref_key:"rootEl",ref:N,"data-id":H.value,class:["wb-env-element-symbol-wrapper-item",$.value],style:[G.value.size.toCSSVars("item-size"),(L.value||G.value.position).toCSSVars("item-position")],"touch-action":"none",onFocus:t[0]||(t[0]=e=>F.value=!0),onBlur:t[1]||(t[1]=e=>F.value=!1),onClick:onClick,onPointerdown:onPointerDown,onPointerup:onPointerUp}),{default:M(()=>[W("div",null,[W("i",null,[(x(),z(_(r.value)))]),W("span",{class:"label",innerHTML:V.value.title},null,8,ee)])]),_:1},16,["data-id","class","style"]))}}),[["__scopeId","data-v-0eaeb899"]]),se=F(w({__name:"SymbolWrapper",props:{clampSymbols:{type:Boolean},wrapperId:{}},emits:["ready","refresh"],setup(e,{emit:t}){var s;const o=b(null),n=b(null),a=b(null),c=e,m=L("window",void 0),d=g(()=>!!m),p=L("parentLayout",g(()=>({position:l(0,0),size:l(null==window?void 0:window.innerWidth,null==window?void 0:window.innerHeight)}))),v=L("parentFocused",!1),f=L("core");if(!f)throw new Error("Core not found");const h=b(null==(s=null==f?void 0:f.modules.symbols)?void 0:s.get(c.wrapperId))||b(new r(f)),y=t,w=g(()=>h.value.items.value),S=b(h.value.selectedItems),_=R(f.config.observable),P=g(()=>h.value.layout),M=g(()=>{var e;return{"parent-scrollable":d.value,active:((null==(e=f.modules.symbols)?void 0:e.primaryWrapper)||{}).id===h.value.id}}),T=g(()=>(null==p?void 0:p.value)&&"scrollOffset"in p.value?null==p?void 0:p.value.scrollOffset:l(0,0)),F=g(()=>{var e;const t=[null==(e=T.value)?void 0:e.toCSSVars("symbol-wrapper-scroll-offset")];return d.value?t.push(H.value.toCSSVars("symbol-wrapper-size")):t.push(P.value.size.toCSSVars("symbol-wrapper-size")),t}),H=g(()=>w.value.map(e=>({item:e,index:S.value.indexOf(e.id)+1})).sort((e,t)=>e.index>t.index?1:e.index<t.index?-1:0).reduce((e,{item:t})=>{const s=t.layout.position.x+t.layout.size.x,o=t.layout.position.y+t.layout.size.y;return e.x=e.x<s?s:e.x,e.y=e.y<o?o:e.y,e},i(0,0))),V=g(()=>_[u.SHOW_INVISIBLE_SYMBOLS]),G=g(()=>w.value.filter(isItemVisible)),U=g(()=>{var e;return(null==(e=null==p?void 0:p.value)?void 0:e.size)||l(0,0)});function setFocused(e=!1){f&&f.modules.symbols&&(e?h.value instanceof r&&f.modules.symbols.setPrimaryWrapper(h.value):f.modules.symbols.getPrimaryWrapper()&&f.modules.symbols.getPrimaryWrapper().id===h.value.id&&f.modules.symbols.setPrimaryWrapper(null))}function onResize(){if(o.value&&(null==p?void 0:p.value)){const{left:e,top:t}=o.value.getBoundingClientRect();h.value.setLayout({position:l(e,t),size:p.value.size}),h.value.setSize(l(o.value.offsetWidth,o.value.offsetHeight)),h.value.setParentSize(p.value.size)}}function isItemVisible(e){return V.value||!V.value&&e.model.visible}function onPointerMove(){var e;h.value instanceof r&&(null==(e=null==f?void 0:f.modules.symbols)||e.setSecondaryWrapper(h.value))}function onPointerDown(e){e.target!==n.value&&e.target!==a.value||h.value.clearSelectedItems()}return E(()=>v,e=>{setFocused(e)}),E(()=>c.wrapperId,e=>{var t;null==(t=f.modules.symbols)||t.get(e),onResize()}),E(()=>U,()=>{onResize()}),E(()=>H,()=>{O(()=>{y("refresh",{scroll:!0})})}),C(()=>{O(()=>{onResize(),setFocused(v),y("ready")})}),I(()=>{var e,t,s,o,n,l;(null==(e=f.modules.symbols)?void 0:e.getPrimaryWrapper())&&(null==(t=f.modules.symbols)?void 0:t.getPrimaryWrapper().id)===h.value.id&&(null==(s=f.modules.symbols)||s.setPrimaryWrapper(null)),(null==(o=f.modules.symbols)?void 0:o.getSecondaryWrapper())&&(null==(n=f.modules.symbols)?void 0:n.getSecondaryWrapper().id)===h.value.id&&(null==(l=f.modules.symbols)||l.setSecondaryWrapper(null))}),(e,t)=>(x(),D("div",{ref_key:"rootEl",ref:o,class:j(["wb-env-symbol-wrapper",M.value]),style:B(F.value),onPointerdown:onPointerDown,onPointermove:onPointerMove},[W("div",{ref_key:"helperEl",ref:n,class:"helper"},null,512),W("div",{ref_key:"itemsEl",ref:a,class:"items"},[(x(!0),D(N,null,A(G.value,(t,s)=>(x(),z(te,{key:s,item:t,"clamp-global":e.clampSymbols,wrapper:k(h),"parent-layout":P.value,"scroll-offset":T.value},null,8,["item","clamp-global","wrapper","parent-layout","scroll-offset"]))),128))],512)],38))}}),[["__scopeId","data-v-e8ab0599"]]);function toggleFullscreen(e,t=void 0){e=e||document.body,t||void 0===t&&!isFullscreen()?function requestFullscreen(e){(e=e||document.body).requestFullscreen()}(e):function closeFullscreen(){document.exitFullscreen()}()}function isFullscreen(){return!!document.fullscreenElement}const oe=G(({core:e})=>[{name:["fullscreen"],description:"Toggle Fullscreen",args:[new U({name:"set",description:"Set Fullscreen"}),new U({name:"toggle",description:"Toggle Fullscreen",flag:!0}),new U({name:"is",description:"check fullscreen",flag:!0})],async action({is:t,fullscreen:s,toggle:o}){if(t)return isFullscreen();if(s||o){let t="Enter Fullscreen?";isFullscreen()&&(t="Leave Fullscreen?");await e.executeCommand(`openDialog "${t}" -confirm`)&&toggleFullscreen(document.body)}}}]);class CursorWrapper{constructor(){__publicField(this,"cursors"),__publicField(this,"current"),this.cursors={wait:this.getCursor(Y.WAIT),default:this.getCursor(Y.POINTER_1)},this.current=this.cursors.default}setWait(e){this.current=e?this.cursors.wait:this.cursors.default}getCursor(e){return new{[Y.POINTER_1]:Q,[Y.POINTER_MOONCITY]:K,[Y.WAIT]:$,[Y.CROSSHAIR]:X}[e]}setCurrent(e){var t;(null==(t=this.current)?void 0:t.name)!==e&&(this.current=e?this.getCursor(e):this.cursors.default)}}class Screen extends Module{constructor(e){const{core:t,contentEl:s}={contentEl:void 0,...e};if(super({name:"Screen",commands:oe,core:t}),__publicField(this,"defaultTheme"),__publicField(this,"currentTheme"),__publicField(this,"cursor",new CursorWrapper),__publicField(this,"contentEl"),__publicField(this,"sizes",{content:l(0,0)}),__publicField(this,"positions",{content:l(0,0)}),__publicField(this,"screenLayout",{size:l(0,0),position:l(0,0)}),__publicField(this,"contentLayout",{size:l(0,0),position:l(0,0)}),this.contentEl=s,this.defaultTheme=this.currentTheme=this.getDefaultTheme(),void 0===window)throw new Error("ScreenControl is only for Browser");p.then(this.onReady.bind(this)).catch(e=>{throw e}),t.executionCounter>0&&this.cursor.setWait(!0)}destroy(){window.removeEventListener("resize",this.onResize.bind(this),!1)}updateContentLayout(e){const{x:t,y:s,width:o,height:n}=e.getBoundingClientRect();this.contentLayout={size:l(o,n),position:l(t,s)}}updateScreenLayout(e){const{x:t,y:s,width:o,height:n}=e.getBoundingClientRect();this.screenLayout={size:l(o,n),position:l(t,s)}}getDefaultTheme(){const e=this.core.config.get(n.THEME)||t[s];return new o("current",e)}setTheme(e){return this.currentTheme=e||this.getDefaultTheme()}onReady(){window.addEventListener("resize",this.onResize.bind(this),!1),this.onResize()}onResize(){if(this.contentEl){const{x:e,y:t,width:s,height:o}=this.contentEl.getBoundingClientRect();this.positions.content=l(e,t),this.sizes.content=l(s,o)}}}__publicField(Screen,"NAME","Screen"),window.oncontextmenu=e=>{e.preventDefault()};export{Z as B,CursorWrapper as C,Module as M,Screen as S,se as W,J as a,getConfigDefaults as g};
