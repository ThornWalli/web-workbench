var L=Object.defineProperty;var F=(s,t,e)=>t in s?L(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var l=(s,t,e)=>F(s,typeof t!="symbol"?t+"":t,e);import{am as H,g as x,h as _}from"./BiF59RFn.js";import{B as f,p as V,e as W,T as q}from"./BLq4dM3U.js";import{S as k,N as j}from"./D8pF2hyX.js";import{G as A}from"./BLrsB9nY.js";import{_ as U,t as P,v as I,x as O,$ as Q,a0 as X,Y,Z,y as J}from"./CP7cO40b.js";function K(s,t=["#000000"],e=!1){const i=s.getImageData(0,0,s.canvas.width,s.canvas.height),n=i.data;for(let r=0;r<n.length;r+=4){const a=n[Number(r)],g=n[r+1],h=n[r+2];(!t.includes(H(`#${a.toString(16)}${g.toString(16)}${h.toString(16)}`))||n[r+3]!==255)&&(n[r+3]=0)}return e&&(s=new OffscreenCanvas(i.width,i.height).getContext("2d")),s.putImageData(i,0,0),s.canvas}const tt=(s,t,e)=>{const i=new OffscreenCanvas(s.width,s.height),n=i.getContext("2d"),r=1-t*2,a=1-e*2;return n.translate(t*s.width,e*s.height),n.scale(r,a),n.drawImage(s,0,0,s.width,s.height),i},et=4;class it{constructor(t,e){l(this,"beatCount",1);l(this,"gutter",27);l(this,"count",1);l(this,"height",36);l(this,"outerMargin",[10,0,10,0]);l(this,"innerMargin",[0,48,0,48]);l(this,"innerPadding",[20,0,10,0]);l(this,"color","#ffaa55");this.setOptions(e),this.canvas=t,this.ctx=t.getContext("2d")}setOptions(t){const{gutter:e,height:i,margin:n,color:r,outerMargin:a,innerMargin:g,innerPadding:h}=t||{};this.gutter=e||this.gutter,this.height=i||this.height,this.margin=n||this.margin,this.color=r||this.color,this.outerMargin=a||this.outerMargin,this.innerMargin=g||this.innerMargin,this.innerPadding=h||this.innerPadding}render({beatCount:t,count:e}){this.count=e,this.beatCount=t;const i=this.ctx;i.clearRect(0,0,i.canvas.width,i.canvas.height);for(let n=0;n<this.count;n++)this.renderGridRow(this.getGridBoundingBox(n),this.getInnerGridBoundingBox(n))}getInnerGridRowBoundingBox(t){const{position:e,dimension:i}=this.getInnerGridBoundingBox(t);return{position:e,dimension:x(i.x,i.y*this.beatGrid.y+1)}}get firstRowIndex(){return 0}get lastRowIndex(){return this.count-1}get innerBoundingBox(){return{position:x(this.outerMargin[0],this.outerMargin[1]),dimension:x(this.ctx.canvas.width-(this.outerMargin[0]+this.outerMargin[2]),this.ctx.canvas.height-(this.outerMargin[1]+this.outerMargin[3]))}}get beatGrid(){return x(this.beatCount,et)}get dimension(){return x(this.canvas.width,this.canvas.height)}get mergedMargin(){return[this.outerMargin[0]+this.innerMargin[0],this.outerMargin[1]+this.innerMargin[1],this.outerMargin[2]+this.innerMargin[2],this.outerMargin[3]+this.innerMargin[3]]}getGridBoundingBox(t){const e=this.mergedMargin,i=e[0]+0,n=e[1]+t*this.height+t*this.gutter,r=-(e[0]+e[2])+this.dimension.x,a=this.height/this.beatGrid.y;return{position:x(i,n),dimension:x(r,a)}}getInnerGridBoundingBox(t){const{position:e,dimension:i}=this.getGridBoundingBox(t);return{position:x(e.x+this.innerPadding[0],e.y+this.innerPadding[1]),dimension:x(i.x-this.innerPadding[0]-this.innerPadding[2],(this.height-this.innerPadding[1]-this.innerPadding[3])/this.beatGrid.y)}}renderGridRow(t,e){const i=this.ctx;i.fillStyle=i.strokeStyle=this.color;let n=new Path2D;st(n,this.beatGrid,t),i.fill(n),n=new Path2D,nt(n,this.beatGrid,e,{first:!0,last:!0}),i.fill(n),i.fillRect(t.position.x+t.dimension.x-5,t.position.y,5,t.dimension.y*this.beatGrid.y)}}function nt(s,t,{position:e,dimension:i},n={}){const{first:r,last:a}={first:!1,last:!1,...n};for(let g=r?0:1;g<t.x+a||!1;g++)s.rect(e.x+0+g*Math.floor(i.x/t.x),e.y,1,i.y*t.y)}function st(s,t,{position:e,dimension:i}){for(let n=0;n<=t.y;n++)s.rect(e.x,n*i.y+e.y,i.x,1)}class rt{constructor(t,e={}){l(this,"padding",10);l(this,"flipActive",!1);l(this,"colors",{background:"#0055aa",foreground:"#ffffff",highlight:"#ffaa55"});l(this,"baseNote",4);l(this,"noteCount",4);const{colors:i,gridRenderer:n,noteRenderer:r}={gridRenderer:null,noteRenderer:null,...e};this.colors={...this.colors,...i},this.gridRenderer=n,this.noteRenderer=r,this.canvas=t,this.ctx=t.getContext("2d")}async render({baseNote:t,noteCount:e,beats:i,flipActive:n}){this.flipActive=n||!1,this.baseNote=t,this.noteCount=e,this.beats=i;const r=this.gridRenderer.beatCount,{position:a,dimension:g}=this.gridRenderer.getInnerGridRowBoundingBox(this.gridRenderer.lastRowIndex),h=[];for(let m=0;m<this.beats.length;m++){const y=this.beats[Number(m)],v=g.x/r-this.padding*2,R=a.x+this.padding+m*v+m*this.padding*2;h.push(await this.renderBeat(y,R,v))}return h.flat()}async renderBeat(t,e,i){const n=this.baseNote,r=this.noteCount,a=[],{position:g,dimension:h}=this.gridRenderer.getInnerGridRowBoundingBox(this.gridRenderer.lastRowIndex),m=Object.entries(t.noteGroups);for(let y=0;y<m.length;y++){const[,v]=m[Number(y)];for(let R=0;R<v.length;R++){const{notes:w,align:M}=v[Number(R)];let u;for(let p=0;p<w.length;p++){const S=p===0,D=p===w.length-1,$=w[Number(p)].bindingCount&&(S||u),T=this.flipActive&&w[Number(p)].bindingCount>0&&R%2===1&&w[Number(p)].name,G=await this.resolveNote(w,p,{baseNote:n,noteCount:r,align:M,flip:T,binding:$}),{position:E,note:C,canvas:B}=G;let d=G.firstPixel;T&&(d=[B.width-d.x-1,B.height-d.y-1-f]);let o=_(e,g.y);o.x=o.x+i*(C.delay-t.index*2)/2,o.y+=(h.y-B.height)/2,o.y-=B.height/2,o.y+=k,o.y+=f/2,o.y-=E.y,o=_(()=>Math.round(o));let N=B;if(T&&(N=tt(B,!0,!0),o.y+=k+N.height-f*2),this.ctx.drawImage(N,o.x,o.y),a.push({dimension:x(N.width,N.height),position:o,note:C}),!C.isPause){if(this.ctx.fillStyle=this.getNoteColors(C).primary,p===0&&p===w.length-1){const b=[5,2];for(let c=0;c<C.bindingCount;c++)T?(this.ctx.fillRect(o.x+d.x,o.y+f+d.y+c*-6,...b),this.ctx.fillRect(o.x+d.x+b[0]-2,o.y+f+d.y+c*-6-2,2,2)):(this.ctx.fillRect(o.x+d.x,o.y+d.y+c*6,...b),this.ctx.fillRect(o.x+d.x+b[0]-2,2+o.y+d.y+c*6,2,2))}else if(S)u=x(o.x+d.x,o.y+d.y);else if(D){this.ctx.lineWidth=1;const b=4;this.ctx.beginPath();for(let c=0;c<C.bindingCount;c++)T?(this.ctx.moveTo(u.x,u.y+f-c*6),this.ctx.lineTo(o.x+d.x+1,o.y+d.y+f-c*6),this.ctx.lineTo(o.x+d.x+1,o.y+d.y+f-c*6+b),this.ctx.lineTo(u.x,u.y+f-c*6+b),this.ctx.lineTo(u.x,u.y+f-c*6)):(this.ctx.moveTo(u.x,u.y+c*6),this.ctx.lineTo(o.x+d.x+1,o.y+d.y+c*6),this.ctx.lineTo(o.x+d.x+1,o.y+d.y+c*6+b),this.ctx.lineTo(u.x,u.y+c*6+b),this.ctx.lineTo(u.x,u.y+c*6));this.ctx.fill(),u=null}}}}}return a}async resolveNote(t,e,{align:i,flip:n,binding:r}){const a=t[Number(e)],g=x(0,a.octavePosition*f);let h=0;const m=i===A.ASCENDING,y=i===A.EQUAL?0:3,v=t[t.length-1],R=t[0];r&&(n?m?h=Math.floor((a.octavePosition-R.octavePosition)*f-y*e):h=Math.floor((a.octavePosition-v.octavePosition)*f-y*(t.length-1-e)):m?h=Math.floor((v.octavePosition-a.octavePosition)*f-y*(t.length-1-e)):h=Math.floor((R.octavePosition-a.octavePosition)*f-y*e));const{canvas:w,...M}=await this.noteRenderer.render(a,{colors:this.getNoteColors(a)},h);return{offsetHeight:h,position:g,note:a,canvas:w,...M}}getNoteColors(t){return{primary:t.selected?this.colors.highlight:this.colors.foreground,secondary:this.colors.background}}}class ot{constructor(t,e){l(this,"colors",{background:"#0055aa",foreground:"#ffffff",highlight:"#ffaa55"});l(this,"gridInnerPadding",[20,0,10,0]);const{colors:i}=e||{};this.colors={...this.colors,...i},this.canvas=t,this.ctx=t.getContext("2d",{willReadFrequently:!0}),this.noteRenderer=new j,this.gridRenderer=new it(this.canvas,{innerPadding:this.gridInnerPadding}),this.beatRenderer=new rt(this.canvas,{gridRenderer:this.gridRenderer,noteRenderer:this.noteRenderer})}async render(t,e={}){e={selectedIndex:[],flipActive:!1,...e},this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.gridRenderer.render({beatCount:t.beatCount,count:this.getOctaveLength(t)});let i=[];try{const n=t.getVisibleBeatsByDuration(void 0,V(t.notes));i=await this.beatRenderer.render({flipActive:e.flipActive,baseNote:t.baseNote,noteCount:t.noteCount,beats:n})}catch(n){console.error(n)}for(let n=0;n<this.gridRenderer.count;n++){const{position:r}=this.gridRenderer.getGridBoundingBox(n);this.renderTimeSignature(t,r.x+(this.gridInnerPadding[0]-6)/2,r.y+3)}return K(this.ctx,["#000000","#ffffff",...Object.values(this.colors)]),{notes:i}}renderTimeSignature(t,e,i){const r=this.ctx;r.fillStyle=this.colors.foreground,r.textBaseline="top",r.font='16px "Amiga Topaz 13", sans-serif',r.fillText(t.baseNote,e,i),r.fillText(t.noteCount,e,i+16*1+1)}getOctaveLength(t){const{length:e}=W(t.notes);return Math.max(Math.floor(e*.8),1)}getDimension(t){const{height:e,gutter:i,outerMargin:n,innerMargin:r}=this.gridRenderer,a=this.getOctaveLength(t);return x(void 0,e*a+i*(a-1)+n[1]+n[3]+r[1]+r[3])}}const at={props:{flipActive:{type:Boolean,default:!1},track:{type:q,required:!0},clickable:{type:Boolean,default:!1},static:{type:Boolean,default:!1},selectedNotes:{type:Array,default:()=>[]}},emits:["note:click","refresh","ready"],data(){return{colors:{background:"#ffffff",foreground:"#000000",highlight:"#ffaa55"},renderResult:null,timelineRenderer:null,dimension:x(0,0),renderTimeout:null,renderTimeoutB:null,ready:!1}},computed:{buttons(){var s;return this.clickable?((s=this.renderResult)==null?void 0:s.notes)||[]:[]},notes(){return this.track.notes}},watch:{track:{handler(){this.static||(window.clearTimeout(this.renderTimeoutB),this.renderTimeoutB=window.setTimeout(async()=>{await this.render(),this.renderTimeoutB=null},250))},deep:!0}},async mounted(){await this.createRenderer(),this.$emit("ready"),this.ready=!0},methods:{refresh(){return new Promise(s=>{const t=e=>{window.requestAnimationFrame(()=>{this.$nextTick(async()=>{await this.render(),this.$emit("refresh"),e()})})};this.ready?(window.clearTimeout(this.renderTimeout),this.renderTimeout=window.setTimeout(async()=>{await t(s),this.renderTimeout=null},100)):t(s)})},async render(){this.dimension=this.timelineRenderer.getDimension(this.track),this.$refs.canvas.width=this.$refs.canvas.offsetWidth,this.$refs.canvas.height=this.dimension.y,this.renderResult=await this.timelineRenderer.render(this.track,{flipActive:this.flipActive})},async createRenderer(){this.timelineRenderer=new ot(this.$refs.canvas),await this.refresh()},onClickNote(s){this.track.selectedIndex===s.index?this.track.selectedIndex=-1:this.track.selectedIndex=s.index,this.$emit("note:click",{note:s,selected:this.track.selectedIndex===s.index})}}},ht={class:"synthesizer-timeline-canvas"},dt={ref:"canvas",width:"0",height:"0"},ct=["data-note","data-time","onClick"];function lt(s,t,e,i,n,r){return P(),I("div",ht,[O("canvas",dt,null,512),(P(!0),I(Q,null,X(r.buttons,({position:a,dimension:g,note:h})=>(P(),I("button",{key:h.index,"data-note":h.note.toString(),"data-time":h.time.toString(),class:Y({selected:h.index===e.track.selectedIndex}),style:Z({...a.toCSSVars("position"),...g.toCSSVars("dimension")}),onClick:m=>r.onClickNote(h)},[O("span",null,"Note "+J(h.index),1)],14,ct))),128))])}const pt=U(at,[["render",lt],["__scopeId","data-v-570ac18b"]]);export{pt as T};
