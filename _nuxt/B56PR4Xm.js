var d=(t,e,s)=>{if(!e.has(t))throw TypeError("Cannot "+s)};var p=(t,e,s)=>(d(t,e,"read from private field"),s?s.call(t):e.get(t)),f=(t,e,s)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,s)},m=(t,e,s,i)=>(d(t,e,"write to private field"),i?i.call(t,s):e.set(t,s),s);import{I as y,v as C,x as v,y as g,w as R,g as x,z as I,E as b,F as H}from"./BUHgHOJF.js";import{A as S}from"./B4CUMntn.js";import{_ as O,K as w,i as T,t as _,v as k,x as u,z as A,Y as E}from"./DX0JcNNQ.js";var l;class L extends y{constructor(s){const{onAdd:i}=Object.assign({debug:!1,onAdd:null},s);super(s);f(this,l,void 0);m(this,l,i)}add(s,i){s instanceof C&&(s=s.toColumnify().split(/\n/g)),v(s)&&(s=g(s)),p(this,l).call(this,s,i)}}l=new WeakMap;let c=1;const M={components:{WbEnvAtomInputText:S},props:{core:{type:Object,required:!1,default(){return R}},rootElement:{type:HTMLElement,default(){return null}},options:{type:Object,default(){return{focused:!1}}},parentFocused:{type:Boolean,default(){return!1}},showIntroduction:{type:Boolean,default(){return!1}},parentLayout:{type:Object,default(){return{size:x(0,0)}}},delimiterPrefix:{type:String,default:"1.SYS"},readonly:{type:Boolean,default:!1},startCommands:{type:[Array,String],default:null},preRows:{type:[Array],default(){return[]}}},emits:["freeze","unfreeze","refresh","startCommandsComplete"],data(){const t=w(new L({core:this.core,consoleInterface:new I,onAdd:this.onAdd})),e=w(new b),s=this;return e.add([new H({name:["CLS","CLEAR"],action(){s.clearConsole()}})]),{logger:t,inputModel:{value:"",focused:!1},inputHistory:[],currentRow:0,startRow:0,rows:[`[CLI ${c}]`],inputHistoryIndex:-1,lineHeight:18,maxRows:10,delimiterOptions:{value:this.delimiterPrefix,prompt:!1,confirm:!1},executeOptions:{show:!0,logger:t,showCommand:!0,commandBucket:e},activeSleepResolve:null,activeConfirmResolve:null,activePromptResolve:null,triggerRefresh:!1,resizeTimeout:null}},computed:{styleClasses(){return{"js--prompt":this.activePromptResolve,"js--focsued":this.options.focused}},delimiter(){let t=this.delimiterOptions.value;const{confirm:e,prompt:s}=this.delimiterOptions;return e?t="(y/n) ?":s?t="?":t&&(t=`${t}:&gt`),t&&(t=`${t}&nbsp;`),t},parentLayoutSize(){return this.parentLayout.size}},watch:{parentFocused(t){this.inputModel.focused=t.focused},parentLayoutSize(){window.clearTimeout(this.resizeTimeout),this.resizeTimeout=window.setTimeout(()=>{this.render()},200)},activeSleepResolve(){this.setDelimiter({value:""})},activeConfirmResolve(){this.setDelimiter({value:this.delimiterPrefix,confirm:this.activeConfirmResolve})},activePromptResolve(){this.setDelimiter({value:this.delimiterPrefix,prompt:this.activePromptResolve})}},created(){this.rows.unshift(...this.preRows)},unmounted(){c--},async mounted(){"console"in this.$parent&&(this.$parent.console=this),c++,this.showIntroduction&&await this.createInstruction().then(()=>this.enter('basic "TMP:CONSOLE_INSTRUCTIONS.basic"',{showCommand:!1})).catch(t=>{throw t}),this.$nextTick(async()=>{if(this.startCommands){const t=[].concat(this.startCommands),e=s=>this.enter(s.shift(),{showCommand:!1}).then(()=>s.length>0?e(s):null);await e(t),this.$emit("startCommandsComplete")}})},methods:{async enter(t,e){this.inputHistoryIndex=-1,this.currentRow=0,this.startRow=0,this.$emit("freeze"),await this.core.executeCommand(t,Object.assign({},this.executeOptions,e)),this.$emit("unfreeze"),this.render(),this.refresh(!0)},createInstruction(){const t=["#basic","CLS",'PRINT "Scroll (Up/Down): <strong>Shift+Up</strong> / <strong>Shift+Down</strong>"','PRINT "Enter <strong>commands</strong> to show all commands."'];return this.core.modules.files.fs.createTmpFile("CONSOLE_INSTRUCTIONS.basic",{type:"basic",content:t})},clearConsole(){this.startRow=this.rows.length,this.render()},render(){this.$refs.consoleOutput.innerHTML="",this.maxRows=Math.ceil(this.$el.offsetHeight/this.lineHeight)-2;const t=this.rows.length-1;let e=0;const s=0+this.currentRow,i=t;for(let o=i-this.startRow;o>=s;o--){const n=this.rows[t-o],r=document.createElement("li");r.innerHTML=String(n).replace(/[\\]?\\n/,"<br>")+`
`,this.$refs.consoleOutput.appendChild(r);const a=parseInt(r.offsetHeight/this.lineHeight);if(r.setAttribute("data-rows",a),e+=a,o===s){for(e=e-this.maxRows;e>0&&this.$refs.consoleOutput.childElementCount>1;){const h=this.$refs.consoleOutput.firstElementChild;e-=h.getAttribute("data-rows"),this.$refs.consoleOutput.removeChild(h)}continue}}},refresh(t){this.$nextTick(()=>{t&&(this.triggerRefresh={scroll:!0},this.$emit("refresh",this.triggerRefresh),this.$nextTick(()=>{this.triggerRefresh=null}))})},moveRows(t){let e=!1;t?this.startRow>0?(this.startRow=0,e=!0):this.currentRow<this.rows.length&&(this.currentRow++,e=!0):this.currentRow>0&&(this.currentRow--,e=!0),e&&this.render()},onAdd(t){const e=[];Array.isArray(t)?e.push(...t):e.push(String(t)),this.rows.push(...e),this.render()},setDelimiter(t,e=!1,s=!1){Object.assign(this.delimiterOptions,{value:t,prompt:e,confirm:s})},onClick(){this.inputModel.focused=!0},onInputEnter(t){return this.inputHistory.push(t),this.inputModel.value="",this.enter(t)},onInputKeydown(t){const e=t.keyCode;let s=!1;if((this.$refs.input.controlCapsLockActive||this.$refs.input.controlShiftActive)&&(e===38||e===40))t.preventDefault(),this.moveRows(e===38);else{switch(e){case 38:this.inputHistoryIndex++,this.inputHistoryIndex=Math.min(this.inputHistoryIndex,this.inputHistory.length-1),s=!0;break;case 40:this.inputHistoryIndex--,this.inputHistoryIndex=Math.max(this.inputHistoryIndex,-1),s=!0;break}if(s&&this.inputHistory.length>0){let i;this.inputHistoryIndex<0?i="":i=this.inputHistory[this.inputHistory.length-1-this.inputHistoryIndex],this.inputModel.value=i}this.refresh()}}}},$={class:"wrapper"},z={ref:"consoleOutput",class:"output typo-style"},P={class:"input"},N=["innerHTML"];function j(t,e,s,i,o,n){const r=T("wb-env-atom-input-text");return _(),k("div",{class:E(["wb-env-console",n.styleClasses]),onClick:e[0]||(e[0]=(...a)=>n.onClick&&n.onClick(...a))},[u("div",$,[u("ul",z,null,512),u("div",P,[u("span",{ref:"consoleCommandDelimiter",class:"prefix",innerHTML:n.delimiter},null,8,N),A(r,{ref:"input","root-element":s.rootElement||t.$el,class:"element",multiline:!1,options:s.options,readonly:s.readonly,model:o.inputModel,onEnter:n.onInputEnter,onKeydown:n.onInputKeydown},null,8,["root-element","options","readonly","model","onEnter","onKeydown"])])])],2)}const U=O(M,[["render",j],["__scopeId","data-v-ec399f06"]]);export{U as W};
