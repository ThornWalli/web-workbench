var De=Object.defineProperty;var de=s=>{throw TypeError(s)};var xe=(s,e,t)=>e in s?De(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var o=(s,e,t)=>xe(s,typeof e!="symbol"?e+"":e,t),_e=(s,e,t)=>e.has(s)||de("Cannot "+t);var N=(s,e,t)=>(_e(s,e,"read from private field"),t?t.call(s):e.get(s)),he=(s,e,t)=>e.has(s)?de("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t);import{I as Ae,i as m}from"./CpIyErmU.js";import{S as $}from"./RAasLaaH.js";import{f as ue}from"./DNvW6rqi.js";import{O as L,L as b,r as fe,a9 as Le}from"./CotJlvW-.js";import{S as p,I as d}from"./DOMGF9Hs.js";class H{constructor(e){o(this,"id");o(this,"_locked",!1);o(this,"storage");o(this,"name");o(this,"_data",[]);this.id=e.id,this._locked=e.locked||this._locked,this.storage=e.storage,this.name=e.name}get locked(){return this._locked}get data(){return this._data}set data(e){this._data=e}async mount(...e){return this}async unmount(...e){return this}getItem(e){throw new Error("not implemented")}setItem(e,t){throw new Error("not implemented")}async load(){if(!this.storage)throw new Error("no storage");return this._data}async save(e){if(!this.storage)throw new Error("no storage");return this._data=e||this._data,this._data}}class F{isLogged(){throw new Error("Method not implemented.")}getItem(e){throw new Error("Method not implemented.")}setItem(e,t){throw new Error("Method not implemented.")}removeItem(e){throw new Error("Method not implemented.")}clear(){throw new Error("Method not implemented.")}}var z;class Te extends F{constructor(){super(...arguments);he(this,z,new Map)}isLogged(){return!0}getItem(t){return N(this,z).get(t)||null}setItem(t,i){N(this,z).set(t,i)}removeItem(t){N(this,z).delete(t)}clear(){N(this,z).clear()}}z=new WeakMap;class ie extends H{constructor(e){super({...e,storage:new Te})}}class Re extends F{isLogged(){return!0}getItem(e){return localStorage.getItem(e)}setItem(e,t){localStorage.setItem(e,JSON.stringify(t))}removeItem(e){localStorage.removeItem(e)}clear(){localStorage.clear()}}class Ee extends H{async mount(){let e;if(this.storage instanceof H){const t=this.storage;try{if(e=t.getItem(this.name),e){if(e=JSON.parse(e),!e||!(e instanceof Object))throw new Error("json invalid")}else throw new Error("json invalid")}catch(i){console.error(i),e={}}this.storage.setItem(this.name,e)}return this}async load(){return this.storage&&this.storage instanceof F&&(this.data=JSON.parse(this.storage.getItem(this.name)||"[]")),this.data}async save(e){return this.storage&&this.storage instanceof F&&(this.data=e||this.data,this.storage.setItem(this.name,this.data)),this.data}}class be extends Ee{constructor(e){super({...e,storage:new Re})}}class ze extends F{isLogged(){return!0}getItem(e){return sessionStorage.getItem(e)}setItem(e,t){sessionStorage.setItem(e,JSON.stringify(t))}removeItem(e){sessionStorage.removeItem(e)}clear(){sessionStorage.clear()}}class Me extends Ee{constructor(e){super({...e,storage:new ze})}}class Oe extends H{constructor(e){super({...e})}isLogged(){throw new Error("Not implemented")}}var _=(s=>(s[s.NONE=0]="NONE",s[s.AUTO=1]="AUTO",s[s.TEMP=3]="TEMP",s[s.LOCAL=4]="LOCAL",s[s.SESSION=5]="SESSION",s[s.CLOUD=6]="CLOUD",s))(_||{});function Pe(s){switch(s){case 3:return ie;case 4:return be;case 5:return Me;case 6:return Oe;default:return ie}}function ft(s){return typeof s=="string"&&ee(s.trim())}const ke=['"',"'"];function gt(s,e='"'){return ee(s)?s:(s=s.replace(/"/g,'\\"'),`${e}${s}${e}`)}function pt(s){return s.length===2&&s[0]===s[s.length-1]&&ee(s)}function ee(s){return s[0]===s[s.length-1]&&ke.includes(s[0])}function It(s){if(typeof s=="string"){const e=s.trim();if(ee(e))return e.slice(1,s.length-1).replace(/\\"/g,'"')}return s}function yt(s){return typeof s=="boolean"||s==="true"||s==="false"}function wt(s){return!isNaN(s)&&!isNaN(parseFloat(s))}function Ne(s){return decodeURIComponent(globalThis.atob(s))}function Ce(s){return globalThis.btoa(encodeURIComponent(s))}class Fe{constructor(){o(this,"items",new Map)}add(e,t){Array.isArray(e)?e.forEach(([i,r])=>{this.add(i,r)}):t&&(Array.isArray(t)||(t=[t]),this.items.set(e,t))}get(...e){var i;const t=e.shift()||"";return(i=this.items.get(t))==null?void 0:i.map(r=>e.reduce((a,n)=>a.replace(/%\d+/,n),r))}}const I=new Fe;I.add("bad_args","Bad args");I.add("cant_find","Can't find %1");const We="/",te="ROOT",Be="CLOUD";function x(s){return typeof s=="object"&&"id"in s?s.id:s.replace(/.*[\\/:]{1,1}([^:\\/]+)$/,"$1")}function $e(s){return/^[a-zA-Z0-9_-]+:/.test(s)}function Ue(...s){return s.reduce((e,t)=>(e.push(...t.replace(/[\\/]+/,"/").replace(/^\//,"").replace(/\/$/,"").split("/")),e),[]).join("/").replace(/:\//,":").replace(/\/$/,"")}function Ke(s){return s.replace(/(.*)[:/]([^\\/:]+)/,"$1")}function Ye(s){return s.replace(/^(.*)[\\/:]([^\\/:]+)$/,"$2")}function C(s){return s.replace(/(.*[\\/:]{1,1})[^:\\/]+$/,"$1")}function K(s){return s.length&&/^[\w .\\/:-]+$/.test(s)}function je(s){return K(s)&&!!(s.includes("/")||s.match(/^([^:]+):.*/))}function He(s){return s*1e3}function ce(s){return s.replace(/^(.*)\.[^.]+$/,"$1")}function le(s){const e=s.match(/^.*\.([^.]*)$/);return e?e[1]:""}function Ge(s){return s.replace(/[^.a-zA-Z0-9_-]/g,"_")}function re(s,e){return e?`${ce(s)}.${e}`:s}function ve(s,e,t){let i=s;return e.hasItem(re(i,t))?(i=`copy_${s}`,e.hasItem(re(i,t))?ve(i,e,t):i):i}async function Ve(s){var e;if(s.locked)throw new Error((e=I.get("FileSystemItem_itemLocked",await s.getPath()))==null?void 0:e.join(" "));return s}function A(s){var t;const e=k(s);if(e){if(e!=null&&e.locked)throw new Error((t=I.get("FileSystem_permissionsNeeded"))==null?void 0:t.join(" "));return s}return s}async function S(s,e){return e=e||k(s),e&&(await s.save(),await e.save()),s}async function Xe(s,e){const t=await e.remove({recursive:s});return Array.isArray(t)?t:[t]}function k(s){if(s.storage)return s;if(s.parent)return k(s.parent)}class u{constructor({name:e,value:t,scope:i}){o(this,"name");o(this,"value");o(this,"scope");this.name=e,this.value=t,this.scope=i}}const Ze={basic:p.BASIC,bas:p.BASIC,markdown:p.DISK_MARKDOWN,md:p.DISK_MARKDOWN,image:p.IMAGE,img:p.IMAGE};function Je(s,e=p.NOTE_BLANK){const t=Ze,i=le(s).toLowerCase();return t[i]||e}class qe extends u{}class E{constructor(e,{type:t,symbol:i=p.NOTE_BLANK}={type:"Unknown",symbol:p.NOTE_BLANK}){o(this,"type");o(this,"events");o(this,"_locked",!1);o(this,"parent");o(this,"createdDate");o(this,"editedDate");o(this,"id");o(this,"_name","");o(this,"meta");o(this,"_data");o(this,"_action");const{locked:r=!1,id:a,name:n=void 0,meta:c=void 0,data:l=void 0,action:h,createdDate:f=Date.now(),editedDate:w=void 0}=e;this.events=L(new $),this.createdDate=f||Date.now(),this.editedDate=w||f,this._locked=r||!1,this.id=a,this._name=n||"",this.type=t||"Unknown",this.meta=new Map([[d.SYMBOL,Je(a||"",i||p.NOTE_BLANK)],[d.VISIBLE,!0],...c||[]]);let v=l;if(typeof l=="string")try{v=JSON.parse(l)}catch(D){throw console.log(v),D}this._action=h,this._data=Qe(v||{})}async remove(e={}){var a,n;const{silent:t}=Object.assign({silent:!1},e);let i;const r=this.isLocked();if(!r)i={type:this.type,id:this.id,name:this.name,path:await this.getPath(),size:this.size,storage:k(this)};else if(!t)throw new Error((a=I.get("FileSystemItem_itemLocked",await this.getPath()))==null?void 0:a.join(" "));return(t||!r)&&(this.events.next(new u({name:"remove",value:{item:this}})),this.events.unsubscribe(),(n=this.parent)==null||n.removeItem(this)),i?[i]:[]}isLocked(e=!1){return e?!1:this.parent&&this.parent.locked&&this.parent.id!==te?!0:this._locked}async copy(){const e=this.constructor,t=await this.export({encodeData:!1}),i=new e(t);return Promise.resolve(i)}rename(e,t={}){const{name:i=!1,ignore:r=!1}=Object.assign({name:!1,ignore:!1},t);if(!this.isLocked(r)){if(i)return this.name=e,this;{const a=this.id;this.id=Ge(e||""),this.parent&&a!==this.id&&this.parent.changeItemId(this,a,this.id)}this.events.next(new qe({name:"rename",value:{item:this}}))}return this}save(){this.events.next(new u({name:"save",value:{item:this}}))}getUsedMemory(){return this.size/this.maxSize}async export(e={}){const{encodeData:t}=Object.assign({encodeData:!0},e),i=new Map(this.meta);Array.from(i.keys()).forEach(a=>{i.get(a)instanceof Ae&&i.set(a,i.get(a).toJSON())});let r;return t&&typeof this._data=="string"?r=await Ce(this._data):r=this._data,{type:this.type,id:this.id,name:this._name,createdDate:this.createdDate,editedDate:this.editedDate,data:r,meta:Array.from(i)}}get data(){let e=this._data;if(typeof this._data=="string")try{e=JSON.parse(this._data)}catch(t){console.error(t),e={type:"markdown",content:"Cannot parse data"}}return e}set data(e){typeof e=="object"&&(e=JSON.stringify(e)),this._data=e}get action(){return this._action}setId(e){this.id=e}setParent(e){this.parent=e}get locked(){var e;return((e=this.parent)==null?void 0:e.locked)||this._locked}get name(){return this._name||this.id}set name(e){this._name=e||""}get extension(){return le(this.id)}get size(){const e=Object.values(this.data||{});return new Blob(e).size}get maxSize(){return new Blob(Object.values(this.data||{})).size}getRealMaxSize(){return new Blob(Object.values(this.data||{})).size}getBase(){return E.getBaseRecursive({item:this},!1)}getPath(){return E.getBaseRecursive({item:this})}static getBaseRecursive({item:e,path:t=[]},i=!0){if(i&&t.push(e.id),e.parent)return E.getBaseRecursive({item:e.parent,path:t});if(t=t.reverse(),t[0]===te&&t.shift(),t.length>0){let r=t[0];return/\./.test(r)||(r+=":"),`${r}${t.slice(1,t.length).join(We)}`}else return te}}I.add([["FileSystemItem_itemLocked",["Item Locked","Item is locked, can't be edit… %1"]]]);function Qe(s){return typeof s=="object"&&(s=JSON.stringify(s)),s}class y extends E{constructor(t,i){t={...t};super(t,i);o(this,"items",new Map);o(this,"_maxSize",He(1));this.addItems(t.items||this.items),this._maxSize=t.maxSize||this._maxSize}async export(t={}){const i={...await super.export(t),items:[]};return Reflect.deleteProperty(i,"data"),i.items=await Promise.all(Array.from(this.items.values()).map(r=>r.export())),i}async addItems(t,i=!1){let r=[];t instanceof Map?r=Array.from(t.values()):Array.isArray(t)&&(r=t),r=r.map(n=>(typeof n.data=="string"&&(n.data=Ne(n.data)),n));const a=this.parseItems(r);return Promise.all(a.map(n=>this.addItem(n,i)))}static normalizeItemData(t){const i={...t},r=[];if("items"in t&&!(t.items instanceof Map)&&(i.items=new Map(t.items.map(a=>[a.id,a]))),"info"in t&&t.info)debugger;return"extension"in i&&(i.id+="."+i.extension,delete i.extension,r.push("extension")),"createTime"in i&&(i.createdDate=i.createTime,delete i.createTime,r.push("createTime")),"editTime"in i&&(i.editedDate=i.editTime,delete i.editTime,r.push("editTime")),"icon"in i&&(delete i.icon,r.push("icon")),r.length&&console.warn("@deprecated TODO: muss weg, hier werden die alten Items angepasst.",i,r),i}parseItems(t){return t.map(i=>{const r=y.normalizeItemData(i);let a;return r.type?a=se(r.type):"items"in r?a=se("Directory"):a=se(),new a(r)})}async addItem(t,i=!1){const r=t.parent;if(!i&&this.hasItem(t.id))throw new Error(`File ${t.id} exists`);if(r&&await r.removeItem(t),i){const a=le(t.id),n=ce(t.id);t.setId(re(ve(n,this,a),a))}return this.items.set(t.id,t),t.setParent(this),t.events.next(new u({name:"move",value:{item:t,lastParent:r}})),this.events.next(new u({name:"addItem",value:{item:t}})),t}removeItem(t){return t.setParent(void 0),this.items.delete(t.id),this.events.next(new u({name:"removeItem",value:{item:t}})),Promise.resolve()}async remove(t={}){var a;const{recursive:i}={recursive:!1,...t},r=[];if(i){const n=await this.getItems();for(const c of n.values())r.push(...await c.remove(t));return r.push(...await super.remove(t)),r}else{if((await this.getItems()).size>0)throw new Error((a=I.get("FileSystemItem_itemContainerNotEmpty",await this.getPath()))==null?void 0:a.join(" "));return await super.remove(t)}}changeItemId(t,i,r){this.items.delete(i),this.items.set(r,t),this.parent&&console.log("changeItemId by parent",i,r,this.parent.items)}getItems(){return Promise.resolve(this.items)}getItem(t){return this.items.get(t)}hasItem(t){return this.items.has(t)}get size(){return Array.from(this.items.values()).reduce(function(t,i){return i instanceof y||(t+=i.size),t},0)}get maxSize(){return t(this);function t(i){return i.parent&&i.getRealMaxSize()?t(i.parent):i.getRealMaxSize()}}}I.add([["FileSystemItem_itemContainerNotEmpty",["ItemWrapp Not Empty","ItemContainer not empty… %1"]]]);class R extends y{constructor(t,i){t={...t,locked:!0};super(t,i);o(this,"storage");this.storage=t.storage}get locked(){return this.storage.locked}mount(...t){return this.storage.mount(...t)}unmount(...t){return this.storage.unmount(...t)}async save(){return this.storage.save(await this.export())}}o(R,"TYPE","Storage");const Q=class Q extends R{constructor(e){super(e,{type:Q.TYPE,symbol:p.CLOUD_DISK})}isLogged(e=!1){var t;return e||((t=this.storage.storage)==null?void 0:t.isLogged())||!1}isLocked(e){return this.isLogged(e)&&super.isLocked(e)}};o(Q,"TYPE","CloudDisk");let W=Q;class B extends y{constructor(e){super(e,{type:"Directory",symbol:p.DIRECTORY}),[d.WINDOW_SCALE,d.WINDOW_SCROLL_X,d.WINDOW_SCROLL_Y].forEach(t=>{this.meta.has(t)||this.meta.set(t,!0)})}}o(B,"TYPE","Directory");class O extends E{constructor(e){super(e,{type:"File"})}}o(O,"TYPE","File");class G extends y{constructor(e){super(e,{type:"FloppyDisk"})}}o(G,"TYPE","FloppyDisk");class V extends R{constructor(e){super(e,{type:"HardDisk",symbol:p.HARD_DISK})}}o(V,"TYPE","HardDisk");class X extends E{constructor(t){t={refPath:void 0,...t};super(t);o(this,"refPath");this.refPath=t.refPath}}o(X,"TYPE","Link");class Z extends R{constructor(e){super(e,{type:"RamDisk",symbol:p.RAM_DISK})}}o(Z,"TYPE","RamDisk");class Se extends y{constructor(e){e={...e,locked:!0,id:"ROOT",name:"ROOT"},super(e,{type:"Root"})}}o(Se,"TYPE","Root");class J extends R{constructor(e){super(e,{type:"TmpDisk",symbol:p.TMP_DISK}),this.meta.set(d.VISIBLE,!1),this.meta.set(d.IGNORE_SYMBOL_REARRANGE,!0)}}o(J,"TYPE","TmpDisk");class T extends y{constructor(e){super(e,{type:"Trashcan",symbol:p.TRASHCAN})}}o(T,"TYPE","Trashcan");const g=class g{constructor(e){o(this,"name");o(this,"root");o(this,"currentItem");o(this,"storages",new Map);o(this,"events",L(new $));this.name=e,this.root=new Se,this.setup()}setup(){this.currentItem=this.root;const e=[this.addStorage(g.RAM_DISK_TITLE,_.SESSION,{id:g.RAM_DISK_NAME}),this.addStorage(g.HARD_DISK_NAME,_.LOCAL,{trashcan:!0}),this.addStorage(g.TMP_DISK_TITLE,_.TEMP,{id:g.TMP_DISK_NAME,trashcan:!1})];return Promise.all(e).catch(t=>{throw t})}createTmpFile(e,t,i,r){return this.createRootFile(`TMP:${e}`,t,i,r)}createRootDir(e,t,i){const r=`${e}`;return this.makedir(r,t,{override:!0,...i})}createRootFile(e,t,i,r){let a=t,n=i;typeof t=="object"&&(n=t,a=void 0);const c=`${e||"Unknown"}`;return this.makeFile(c,a,n,{...r||{},override:!0})}async get(e,t=!1){if(e instanceof E)return e;if(K(e))try{return await this.parsePath(e)}catch(i){if(t)return new E({id:x(e),name:x(e)});throw i}else throw I.get("FileSystem_pathInvalid",x(e),C(e))}async parsePath(e){var a,n;let t=e,i=this.currentItem;const r=e.match(/^([^:\\/]+):(.*)$/);if(r?(i=(a=this.root)==null?void 0:a.getItem(r[1]),t=r[2]):t[0]==="/"&&this.currentItem?(t=t.slice(1),i=k(this.currentItem)):t==="ROOT"?(i=this.root,t=""):t&&!t.includes("/")&&!/^\.+$/.test(t.trim())&&(i=this.root.getItem(t),t=""),t&&t.length>0&&(i=ae(t.split("/"),i)),i)return i;throw I.get("FileSystem_pathInvalid",e,await((n=this.currentItem)==null?void 0:n.getBase())||"")}async addFloppyDisk(e){let t;if(typeof e=="function"?(t=await e(),t instanceof Promise&&(t=await t)):t=e,Array.isArray(t))throw new Error('data is an Array, use "defineFloppyDisk" for define a Disk');return this.addStorage(t)}async removeFloppyDisk(e){await e.remove({silent:!0})}async addStorage(e,t,i={}){i=Object.assign({id:null},i);let r;typeof t=="function"&&(r=t,t=_.CLOUD);const a=this.getFreeSlot(g.PREFIX.FLOPPY_DISK),n={id:a,itemClass:G,items:new Map};let c={};if(typeof e=="object"){const l=e;n.name=l.name||l.id,l.items&&(n.items=l.items),n.meta=Array.from(new Map([[d.SYMBOL,p.DISK_1],...l.meta||[]]))}else{switch(t){case _.SESSION:n.id=g.PREFIX.RAM,n.itemClass=Z;break;case _.TEMP:n.id=g.PREFIX.TMP,n.itemClass=J;break;case _.LOCAL:n.id=this.getFreeSlot(g.PREFIX.HARD_DISK),n.itemClass=V;break;case _.CLOUD:n.id=this.getFreeSlot(g.PREFIX.CLOUD_DISK),n.itemClass=W;break}n.id=i.id||n.id;let l;r&&typeof r=="function"?l=await this.registerStorageByStorage(n.id,r).mount(i):l=await this.registerStorageByType(n.id,t).mount(i);const h=await l.load();c=y.normalizeItemData(h),n.storage=l,_.NONE!==t&&(n.name=c.name||c.id||e)}return(n.meta=n.meta||[]).push(...c.meta||[]),this.addDisk({...n,...c,storage:n.storage||new ie({id:a,name:g.TMP_DISK_TITLE})},i)}removeStorage(e){return e.unmount().then(()=>(this.events.next(new u({name:"removeStorage",value:{itemStorage:e}})),e))}registerStorageByType(e,t){const i=Pe(t),r=`${this.name}_${e}`,a=new i({id:e,name:r});return this.storages.set(r,a),a}registerStorageByStorage(e,t){const i=`${this.name}_${e}`,r=new t({id:e,name:i});return this.storages.set(i,r),r}connect(e,t){return this.addStorage(Be,e,t).then(i=>i).catch(i=>{throw i})}async disconnect(e){return e=await this.removeStorage(e),e.remove({silent:!0,recursive:!0}),e}addDisk({id:e,name:t,meta:i,items:r,itemClass:a,storage:n},c){var f;c={trashcan:!1,...c},r instanceof Map&&c.trashcan&&(!r||r&&!r.has(T.TYPE))&&(r=r||new Map,r.set(T.TYPE,{type:T.TYPE,id:T.TYPE,name:T.TYPE}));const l=a;if(!l)throw new Error("ItemClass is empty!");const h=new l({id:e,name:t||e,meta:i,items:r,storage:n});return(f=this.root)==null||f.addItem(h),this.events.next(new u({name:"addDisk",value:{id:e,item:h}})),h}getFreeSlot(e){var i;let t=0;for(;(i=this.root)!=null&&i.hasItem(`${e}${t}`);)t++;return`${e}${t}`}async exist(e){try{return!!await this.get(e)}catch(t){return console.error(t),!1}}async changeDirectory(e){const t=await this.get(e);return this.currentItem=t,this.events.next(new u({name:"changeDirectory",value:t})),t}async makedir(e,t,i){const{override:r,meta:a}={override:!1,meta:[],...i};let n;e&&je(e)&&e!==t?n=await this.get(C(e)):n=this.currentItem;const c=new B({id:x(e),name:t||"",createdDate:Date.now(),meta:a});if(await A(n),r||!n.getItem(c.id))n.addItem(c,r),this.events.next(new u({name:"writeItem",value:c}));else throw I.get("FileSystem_fileExist",c.id);return await S(n),c}async makeFile(e,t,i,r){var v,D,me;const{override:a,meta:n}={...r,meta:r.meta||[]},c=x(e),l=new O({id:c,name:t||c,data:i,meta:n,createdDate:Date.now()});if(!K(e))throw I.get("FileSystem_invalidPath",e);let h=Ke(e);const f=Ye(e);h===f&&(h=".");let w;if($e(h)?w=await this.get(h):((v=this.currentItem)==null?void 0:v.id)!=="ROOT"?w=await this.get(Ue(await((D=this.currentItem)==null?void 0:D.getPath())||"",h)):w=await this.get(h),w.hasItem(f))if(a)await((me=w.getItem(f))==null?void 0:me.remove()),w.addItem(l);else throw I.get("FileSystem_fileExist",l.id);else w.addItem(l),this.events.next(new u({name:"writeItem",value:l}));return await S(w),l}async editFile(e,t){const i=await this.get(e);return await A(i),await Ve(i),i.data=t,S(i)}async editFileMeta(e,t,i){const r=await this.get(e);return Array.isArray(t)?t.map(a=>({name:a[0],value:a[1]})):r.meta.set(t,i),S(r)}async cleanFileMeta(e,{force:t}={}){const i=await this.get(e);return await A(i),i.meta=t?new Map:new Map(Array.from(i.meta.entries()).filter(([,r])=>r!==void 0)),S(i)}async getItemMetaList(e){const t=await this.get(e);return Array.from(t.meta).map(i=>({name:i[0],value:i[1]}))}async saveItem(e){const t=await this.get(e);return S(t)}async makelink(e,t=null){const i=await this.get(e);await A(i);const r=this.currentItem,a=new X({id:ce(i.id)+".ref",name:`${t||i.name}`,createdDate:Date.now(),meta:[[d.REFERENCE,await i.getPath()]]});return await r.addItem(a),await S(i),a}async editlink(e,t){const i=await this.get(e);await A(i);const r=await this.get(t);return i.refPath=await r.getPath(),S(i)}async rename(e,t,{name:i,removeName:r}={name:!1,removeName:!1}){let a;if(e instanceof E)a=e;else if(K(e)||typeof e=="string")a=await this.get(e);else throw I.get("FileSystem_pathInvalid",C(e),e);return await A(a),r&&(i=!0,t=void 0),await a.rename(t,{ignore:!0,name:i}),S(a)}async copy(e,t,i={ignore:!1}){const{ignore:r}={ignore:!1,...i};let a,n,c;if(e instanceof E?(n=e,a=e.id):(n=await this.get(e),a=x(e)),t instanceof E)t instanceof y||(t=t.parent),c=t;else if(t){a=x(t);const h=await this.get(t,!0);if(h.parent?c=h.parent:c=await this.get(C(t)),!(c instanceof y))throw new Error("no ItemContainer")}else throw new Error('"to" is empty!');await A(n);const l=await n.copy();if(c instanceof y&&(r||!c.getItem(a)))l.rename(a),c.addItem(l,r),this.events.next(new u({name:"copyItem",value:l}));else throw I.get("FileSystem_fileExist",a);return S(l)}async move(e,t,{override:i}={}){let r,a,n;if(e instanceof E)a=e,r=e.id;else{if(a=await this.get(e),a instanceof R)throw I.get("FileSystem_cantMoveStorage",a.id);r=x(e)}if(t instanceof E)t instanceof y?n=t:n=t.parent;else{if(r=x(t),n=await this.get(t),n instanceof y)r=x(e);else return this.get(C(t));if(!(n instanceof y))throw new Error("no ItemContainer")}let c;if(await A(a),i||!await n.getItem(r))c=k(a),await a.rename(r),await n.addItem(a,i),this.events.next(new u({name:"moveItem",value:a}));else throw I.get("FileSystem_fileExist",a.id,r);return await S(a),c?c.save().then(()=>a):a}async remove(e,t,i={ignore:!1}){var n;const{ignore:r}={ignore:!1,...i},a=await this.get(e);await A(a);try{const c=await Xe(t,a);return c[c.length-1].storage&&await((n=c[c.length-1].storage)==null?void 0:n.save()),c}catch(c){if(!r)throw c}}};o(g,"PREFIX",{FLOPPY_DISK:"DF",TMP:"TMP",RAM:"RAM",HARD_DISK:"HD",CLOUD_DISK:"CD"}),o(g,"TMP_DISK_NAME","TMP"),o(g,"TMP_DISK_TITLE","TMP DISK"),o(g,"RAM_DISK_NAME","RAM"),o(g,"RAM_DISK_TITLE","RAM DISK"),o(g,"HARD_DISK_NAME","HARD DISK");let ge=g;function ae(s,e){const t=s.shift();if(t===void 0)return e;if(t===".."){if(e.parent)return e.parent}else if(t==="."||t==="")return ae(s,e);if(e){const i=e.getItem(t);return s.length>0&&i instanceof y?ae(s,i):i}}function se(s){switch(s){case B.TYPE:return B;case T.TYPE:return T;case R.TYPE:return R;case J.TYPE:return J;case Z.TYPE:return Z;case V.TYPE:return V;case G.TYPE:return G;case W.TYPE:return W;case X.TYPE:return X;case O.TYPE:return O}return O}I.add([["FileSystem_invalidPath",["Invalid File",'Invalid path "%1"']],["FileSystem_invalidFile",["Invalid File",'Invalid file… "%1"']],["FileSystem_fileExist",["File Ready",'File already exists… "%1"']],["FileSystem_pathInvalid",["Path Invalid",'Path invalid… "%1"; base: "%2"']],["FileSystem_itemInvalid",["Item Invalid",'Item id invalid… "%1" from "%2"']],["FileSystem_cantMoveStorage",["Can't Move",`Can't move BaseStorage "%1"`]],["FileSystem_permissionsNeeded",["Permissions needed","Permissions needed"]]]);class q{constructor({fsItem:e,command:t,model:i,layout:r}){o(this,"ready",!1);o(this,"fsItem");o(this,"command");o(this,"type","default");o(this,"id",crypto.randomUUID());o(this,"layout",b({position:m(0,0),size:m(0,0)}));o(this,"ignoreRearrange",!1);o(this,"model",b({title:"Item Title",symbol:p.DEFAULT,used:!1,visible:!0,url:void 0,ignoreRearrange:!1}));this.type="default",this.command=t,this.model=b({...this.model,...i||{}}),this.layout=b({...this.layout,...r||{}}),this.fsItem=e}async setup({core:e}){try{const t=this.fsItem;if(!t||this.ready)return;this.type=et(t),await pe(this,e),t.events.subscribe(async({name:i})=>{i!=="addItem"&&i!=="removeItem"&&t&&await pe(this,e)})}catch(t){console.warn(t),this.model.symbol=p.DISALLOW_1}this.ready=!0}setLayout(e){e.position&&(this.layout.position=m(e.position.x,e.position.y)),e.size&&(this.layout.size=m(e.size.x,e.size.y))}}async function pe(s,e){var i;const t=s.fsItem;if(t)if(s.model.title=t.name||"",s.layout.position=t.meta.get(d.POSITION)&&ne(t.meta.get(d.POSITION))||m(0,0),s.model.visible=!!t.meta.get(d.VISIBLE),s.model.symbol=t.meta.get(d.SYMBOL),t.meta.get(d.WEB_URL)&&(s.model.url=String(t.meta.get(d.WEB_URL))),s.model.ignoreRearrange=!!t.meta.get(d.IGNORE_SYMBOL_REARRANGE),t.meta.get(d.REFERENCE)){const r=await((i=e.modules.files)==null?void 0:i.fileSystem.get(String(t.meta.get(d.REFERENCE))));if(!r)throw new Error("Reference item not found");r.meta.get(d.WEB_URL)&&(s.model.url=String(r.meta.get(d.WEB_URL))),s.command=()=>Ie(r,s.model)}else s.command=()=>Ie(t,s.model)}function Ie(s,e){if(s instanceof y){const t=[`openDirectory "${s.getPath()}"`];s.meta.get(d.WINDOW_SYMBOL_REARRANGE)&&t.push("-sort-symbols");const i=s.meta.get(d.WINDOW_POSITION)&&ne(s.meta.get(d.WINDOW_POSITION))||m(0,0);i.length>0&&t.push(`--window-position="${m(i.x,i.y).toArray().join(",")}"`);const r=s.meta.get(d.WINDOW_SIZE)&&ne(s.meta.get(d.WINDOW_SIZE))||m(0,0);return r.length>0&&t.push(`--window-size="${m(r.x,r.y).toArray().join(",")}"`),s.meta.has(d.WINDOW_SCALE)&&t.push(`--window-scale=${s.meta.get(d.WINDOW_SCALE)}`),s.meta.has(d.WINDOW_SCROLL_X)&&t.push(`--window-scroll-x=${s.meta.get(d.WINDOW_SCROLL_X)}`),s.meta.has(d.WINDOW_SCROLL_Y)&&t.push(`--window-scroll-y=${s.meta.get(d.WINDOW_SCROLL_Y)}`),s.meta.has(d.WINDOW_SIDEBAR)&&t.push(`--window-sidebar=${s.meta.get(d.WINDOW_SIDEBAR)}`),s.meta.has(d.WINDOW_FULL_SIZE)&&t.push(`--window-full-size=${s.meta.get(d.WINDOW_FULL_SIZE)}`),t.join(" ")}else if(!e.url)return`execute "${s.getPath()}"`}function ye(s,e){return s.map(t=>{const i=t instanceof q?t:new q({...t});return i.setup({core:e}),i})}function et(s){return s instanceof y?"container":s.meta.get(d.WEB_URL)?"link":"default"}function ne(s){return m(s.x,s.y)}function Et(s){return typeof s=="function"?s():s}var M=(s=>(s[s.NAME=0]="NAME",s[s.TYPE=1]="TYPE",s[s.CREATED_DATE=2]="CREATED_DATE",s[s.EDITED_DATE=3]="EDITED_DATE",s))(M||{}),Y=(s=>(s[s.ASCENDING=0]="ASCENDING",s[s.DESCENDING=1]="DESCENDING",s))(Y||{}),j=(s=>(s.SHOW_INVISIBLE_SYMBOLS="symbolWrapper_showInvisibleItems",s.ORDER_TYPE="symbolWrapper_iconsOrderType",s.ORDER_DIRECTION="symbolWrapper_iconsOrderDirection",s))(j||{});class we extends u{}class tt{constructor(e,t=[],i=!1){o(this,"id",crypto.randomUUID());o(this,"items",fe([]));o(this,"selectedItems",fe([]));o(this,"core");o(this,"root",!1);o(this,"layout",b({size:m(0,0),position:m(0,0)}));o(this,"size",m(0,0));o(this,"parentSize",m(0,0));this.root=i||!1,this.core=e,this.items.value=ye(t||[],this.core)}setLayout(e){e.position&&(this.layout.position=m(e.position.x,e.position.y)),e.size&&(this.layout.size=m(e.size.x,e.position.y))}setSize(e){this.size=m(e.x,e.y)}setParentSize(e){this.parentSize=m(e.x,e.y)}rearrangeIcons(e={align:"left",axis:"horizontal",force:!1,root:!1,margin:10}){e=Object.assign({orderType:this.core.config.get(j.ORDER_TYPE)||M.NAME,orderDirection:this.core.config.get(j.ORDER_DIRECTION)||Y.ASCENDING,onlyVisible:!this.core.config.get(j.SHOW_INVISIBLE_SYMBOLS)||!1,align:"left",axis:"horizontal",root:!1,margin:10},e);let t=this.items.value;switch(e.root&&(e.orderType=M.NAME,e.orderDirection=Y.DESCENDING,e.force||(e.axis="vertical",e.align="right")),e.onlyVisible&&(t=t.filter(l=>l.model.visible)),e.force||(t=t.filter(l=>!l.model.ignoreRearrange)),e.orderType){case M.TYPE:t=t.sort((l,h)=>l.type.localeCompare(h.type));break;case M.CREATED_DATE:t=t.sort((l,h)=>{var v,D;const[f,w]=[((v=l.fsItem)==null?void 0:v.createdDate)||0,((D=h.fsItem)==null?void 0:D.createdDate)||0];return f===w?0:f>w?1:-1});break;case M.EDITED_DATE:t=t.sort((l,h)=>{var v,D;const[f,w]=[((v=l.fsItem)==null?void 0:v.editedDate)||0,((D=h.fsItem)==null?void 0:D.editedDate)||0];return f===w?0:f>w?1:-1});break;default:t=t.sort(l=>l.model.title.localeCompare(l.model.title))}switch(e.orderDirection){case Y.ASCENDING:t.reverse();break}const i=e.margin||0;let r,a=i,n=0,c=0;return e.align==="right"?r=this.size.x:r=i,t.forEach(l=>{e.axis==="horizontal"?((e.align==="left"&&r+(l.layout.size.x+i)>=this.parentSize.x||e.align==="right"&&r-(l.layout.size.x+i)<=0)&&(e.align==="right"?r=this.size.x:r=i,a+=n+i,n=0),l.layout.position=m(r,a),r+=(l.layout.size.x+i)*(e.align==="right"?-1:1),n=Math.max(n,l.layout.size.y)):(a+l.layout.size.y>this.parentSize.y-i*2&&(r+=(c+i)*(e.align==="right"?-1:1),a=i,c=0),e.align==="right"?l.layout.position=m(r-(l.layout.size.x+i),a):l.layout.position=m(r,a),a=a+(l.layout.size.y+i),c=Math.max(c,l.layout.size.x))}),t.reduce((l,{id:h,layout:f})=>l.then(()=>this.savePosition(h,f.position)),Promise.resolve())}clearSelectedItems(){[...this.selectedItems.value].forEach(e=>this.unselectItem(e))}isSelectedItem(e){return this.selectedItems.value.includes(e)}selectItem(e){return this.isSelectedItem(e)?!1:(this.selectedItems.value.push(e),!0)}unselectItem(e){return this.isSelectedItem(e)?(this.selectedItems.value=this.selectedItems.value.filter(t=>t!==e),!0):!1}async moveItem(e,t){console.warn("Method not implemented.",e,t)}async moveItemToItem(e,t){console.warn("Method not implemented.",t,e)}async savePosition(e,t){console.warn("Method not implemented.",e,t)}get(e){return this.items.value.find(t=>t.id===e)}has(e){return!!this.items.value.find(t=>t.id===e)}add(...e){const t=ye(e,this.core);return this.items.value.push(...t),t}remove(e){let t;return typeof e=="string"?t=this.get(e):t=e,t&&(this.unselectItem(t.id),this.items.value.splice(this.items.value.indexOf(t),1)),t}}class st extends tt{constructor(){super(...arguments);o(this,"events",L(new $))}add(...t){const i=super.add(...t);return this.events.next(new we({name:"add",value:{wrapper:this,items:Array.from(i)}})),i}remove(t){const i=super.remove(t);return i&&this.events.next(new we({name:"remove",value:{wrapper:this,item:i||void 0}})),i}setup(...t){return Promise.resolve()}selectItem(t){return super.selectItem(t)?(this.events.next(new u({name:"selectItem",value:{wrapper:this,id:t}})),!0):!1}unselectItem(t){return super.unselectItem(t)?(this.events.next(new u({name:"unselectItem",value:{wrapper:this,id:t}})),!0):!1}}class P extends st{constructor(){super(...arguments);o(this,"fsItem");o(this,"usedMemory",0)}async setup(t){this.fsItem=t;const i=Array.from((await t.getItems()).values());await Promise.all(i.map(async r=>this.add(await P.fsItemToSymbol(r)))),t.events.subscribe(this.onEventItem.bind(this))}async moveItemToItem(t,i){var r,a;if(t.locked)throw new Error("Items are locked!");if(i.locked)throw new Error("Destination is locked!");t.meta.set(d.POSITION,m(0,0)),await((r=this.core.modules.files)==null?void 0:r.fs.saveItem(t)),await((a=this.core.modules.files)==null?void 0:a.fs.move(t,i,{override:!0}))}async moveItem(t,i){const r=this.get(t);if(r&&(r.fsItem instanceof O||r.fsItem instanceof B))try{if(r!=null&&r.fsItem&&(i!=null&&i.fsItem))await this.moveItemToItem(r.fsItem,i.fsItem);else throw new Error("Item or wrapper not found");return!0}catch(a){return console.warn(a),!1}return!1}async savePosition(t,i){var a;let r;if(typeof t=="string"&&this.get(t)?r=this.get(t):t instanceof q&&(r=t),r)if(r.fsItem)r.fsItem.meta.set(d.POSITION,i),(a=this.core.modules.files)==null||a.fs.saveItem(r.fsItem);else throw new Error(`Item has no fsItem. ${t}`);else throw new Error(`Item not found. ${t}`)}hasFsItem(t){return this.items.value.find(i=>{var r;return((r=i.fsItem)==null?void 0:r.id)===t.id})}async onEventItem({name:t,value:i}){var r,a;if(i!=null&&i.item){let n;if(t==="addItem")n=await P.fsItemToSymbol(i.item),this.hasFsItem(i.item)||this.add(n);else if(t==="removeItem"){const c=this.items.value.find(l=>{var h,f;return((h=l.fsItem)==null?void 0:h.id)===((f=i.item)==null?void 0:f.id)});if(c)this.remove(c);else throw new Error(`Item not found in symbol wrapper. ${(r=i.item)==null?void 0:r.id}`)}this.usedMemory=((a=this.fsItem)==null?void 0:a.getUsedMemory())||0}else console.warn("Item event without value",t,i)}static getItemsFromItem(t){return Promise.all(Array.from(t.items.values()).map(P.fsItemToSymbol))}static async fsItemToSymbol(t){const i=await t.getPath(),r=new q({fsItem:t,model:{title:t.name||"Untitled"}});return typeof t.action=="function"&&(r.command=`executeFile "${i}"`),t.meta.get(d.WEB_URL)&&(r.model.url=String(t.meta.get(d.WEB_URL))),r}}const it=m(0,0);class U{constructor({sidebarComponent:e,sidebarComponentData:t,component:i,componentData:r,options:a,wrapper:n,layout:c,parentWindow:l}){o(this,"events",new $);o(this,"id",crypto.randomUUID());o(this,"component");o(this,"componentData");o(this,"sidebarComponent");o(this,"sidebarComponentData");o(this,"parentWindow");o(this,"options",b({title:void 0,scale:!1,scaleX:!1,scaleY:!1,scroll:!1,scrollX:!1,scrollY:!1,clamp:!1,clampX:!0,clampY:!1,freeze:!1,focused:!1,center:!0,close:!0,overlay:!0,embed:!1,fillHeader:!1,filled:!1,borderless:!1,hideRootHeader:!1,sidebar:!0,prompt:!1}));o(this,"group");o(this,"wrapper");o(this,"layout",b({focused:!1,position:m(0,0),size:it,scrollOffset:m(0,0),zIndex:0}));this.parentWindow=l,e&&(this.sidebarComponent=L(e)),t&&(this.sidebarComponentData=L(t)),i&&(this.component=L(i)),this.componentData={...r||{}},n&&(this.wrapper=L(n)),this.options=Object.assign(this.options,a),this.layout=Object.assign(this.layout,c)}setLayout(e){e.position&&(this.layout.position=m(e.position.x,e.position.y)),e.size&&(this.layout.size=m(e.size.x,e.size.y)),e.scrollOffset&&(this.layout.scrollOffset=m(e.scrollOffset.x,e.scrollOffset.y)),e.focused&&(this.layout.focused=e.focused)}ready(){this.options.ready=!0,this.events.next(new u({name:"ready"}))}focus(){this.options.focused=!0,this.events.next(new u({name:"focus"}))}unfocus(){this.options.focused=!1,this.events.next(new u({name:"unfocus"}))}close(e){this.wrapper&&(this.events.next(new u({name:"close",value:e})),this.wrapper.remove(this.id),this.wrapper=void 0)}setWrapper(e){this.wrapper=L(e)}setGroup(e){this.group=e}awaitClose(){return new Promise(e=>{const t=this.events.pipe(ue(({name:i})=>i==="close")).subscribe(i=>{t.unsubscribe(),e(i)})})}awaitReady(){return new Promise(e=>{if(this.options.ready)e(this);else{const t=this.events.pipe(ue(({name:i})=>i==="ready")).subscribe(()=>{t.unsubscribe(),e(this)})}})}}var rt=(s=>(s[s.CENTER=0]="CENTER",s[s.ORDER_HORIZONTAL=1]="ORDER_HORIZONTAL",s[s.ORDER_VERTICAL=2]="ORDER_VERTICAL",s[s.ORDER_DIAGONAL_LEFT=3]="ORDER_DIAGONAL_LEFT",s[s.ORDER_DIAGONAL_RIGHT=4]="ORDER_DIAGONAL_RIGHT",s[s.SPLIT_HORIZONTAL=5]="SPLIT_HORIZONTAL",s[s.SPLIT_VERTICAL=6]="SPLIT_VERTICAL",s[s.FULL=7]="FULL",s))(rt||{});class vt{constructor(e,t=[]){o(this,"events",L(new $));o(this,"id",crypto.randomUUID());o(this,"core");o(this,"layout",{size:m(0,0),position:m(0,0)});o(this,"groups",new Map);o(this,"modelMap",new Map);o(this,"models",[]);o(this,"_activeWindow");this.core=e,t.forEach(i=>this.add(i))}setLayout(e){e.position&&(this.layout.position=m(e.position.x,e.position.y)),e.size&&(this.layout.size=m(e.size.x,e.size.y))}getActiveWindow(){return this.models.find(e=>e.options.focused)}setActiveWindow(e){this.models.forEach(t=>{t.options.focused=e===t.id,e===t.id&&(this._activeWindow=t,this.events.next(new u({name:"setActiveWindow",value:t})))})}hasEmbbedWindow(){return!!this.models.find(e=>e.options.embed)}isHeaderVsible(){return!this.models.find(e=>e.options.embed&&e.options.hideRootHeader)}add(e,t){const{full:i,maximize:r,active:a,group:n}={full:!1,maximize:!1,active:!0,group:null,...t||{}};let c;if(e instanceof U?c=e:c=new U(e),c.setWrapper(this),r?c.layout.size=m(this.layout.size.x,this.layout.size.y):i&&(c.layout.size=m(()=>m(this.layout.size.x,this.layout.size.y)+m(0,0))),n){let l;this.groups.has(n)?(l=this.groups.get(n),l.windows.push(c)):(l={primary:c,windows:[],name:n},this.groups.set(n,l)),c.setGroup(l)}return c.layout.zIndex=this.models.length,this.models.push(c),this.events.next(new u({name:"add",value:c})),this.modelMap.set(c.id,c),a&&this.setActiveWindow(c.id),c}remove(e){let t;e instanceof U?t=e:t=this.get(e),t!==void 0&&(t.group&&(t.group.primary===e?(t.group.windows.forEach(i=>i.close()),this.groups.delete(t.group.name)):t.group.primary.focus()),this.models.splice(this.models.indexOf(t),1),this.modelMap.delete(t.id))}get(e){return this.modelMap.get(e)}clear(){this.models=[].splice(0,this.models.length),this.modelMap.clear()}setWindowUpDown(e,t){const i=this.models,r=Array.from(i).filter(n=>!n.options.embed).sort((n,c)=>(n.layout.zIndex||0)-(c.layout.zIndex||0)).map(Le),a=this.get(e);if(a){const n=r.findIndex(({id:l})=>l===a.id),c=r[t?n-1:n+1];if(c){const l=a.layout.zIndex;a.layout.zIndex=c.layout.zIndex,c.layout.zIndex=l}}}centerWindow(e){let t;e instanceof U?t=e:t=this.get(e),t&&oe(t,this.layout)}setWindowPositions(e,t=[],i){const{embed:r}={embed:!1,...i};switch(t.length<1&&t.push(...this.models),r||(t=t.filter(a=>!a.options.embed)),e){case 7:t.forEach(a=>{at(a,this.layout)});break;case 0:t.forEach(a=>{oe(a,this.layout)});break;case 3:case 4:nt(t,this.layout,e===4);break;case 5:case 6:ot(t,this.layout,e===6);break}}saveSize(e,t){var r,a,n,c;const i=this.get(e);if(i&&(r=i.componentData)!=null&&r.symbolWrapper&&((a=i.componentData)==null?void 0:a.symbolWrapper)instanceof P){const l=(n=i.componentData)==null?void 0:n.symbolWrapper.fsItem;l&&(l.meta.set(d.WINDOW_SIZE,t),(c=this.core.modules.files)==null||c.fs.saveItem(l))}}savePosition(e,t){var r,a,n,c;const i=this.get(e);if(i&&(r=i.componentData)!=null&&r.symbolWrapper&&((a=i.componentData)==null?void 0:a.symbolWrapper)instanceof P){const l=(n=i.componentData)==null?void 0:n.symbolWrapper.fsItem;l&&(l.meta.set(d.WINDOW_POSITION,t),(c=this.core.modules.files)==null||c.fs.saveItem(l))}}}function at(s,e){s.layout.position=m(0,0),s.layout.size=e.size}function oe(s,e){s.layout.position=m(()=>(m(e.size.x,e.size.y)-m(s.layout.size.x,s.layout.size.y))/2)}function nt(s,e,t){const i=1/s.length;s.forEach((r,a)=>{oe(r,e),a=-Math.floor(s.length/2)+a;const n=m(r.layout.position.x+(t?-1:1)*(i*r.layout.size.x)*a,r.layout.position.y+i*r.layout.size.y*a),c=m(()=>m(e.size.x,e.size.y)-m(r.layout.size.x,r.layout.size.y));r.layout.position=m(()=>Math.max(Math.min(n,c),0))})}function ot(s,e,t){let i;const r=s.length;t?(i=m(e.size.x,e.size.y/r),s.forEach((a,n)=>{a.layout.position=m(0,n*i.y),a.layout.size=i})):(i=m(e.size.x/r,e.size.y),s.forEach((a,n)=>{a.layout.position=m(n*i.x,0),a.layout.size=i}))}export{Oe as C,B as D,u as E,P as F,tt as I,M as O,Se as R,F as S,_ as T,vt as W,U as a,le as b,yt as c,T as d,I as e,R as f,Pe as g,Ge as h,wt as i,ge as j,y as k,j as l,Y as m,rt as n,x as o,Ue as p,Ne as q,Et as r,S as s,re as t,It as u,pt as v,gt as w,ft as x,E as y,Ce as z};
