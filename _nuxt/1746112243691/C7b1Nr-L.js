import{u as A,N as y}from"./DjFHHCzp.js";import{a as D,M as L}from"./YMO6fn__.js";import{c as _,T as P}from"./dhpcBTH2.js";import{d as S}from"./DtRunxS3.js";import q from"./DcMfwrs4.js";import{N as F}from"./Ca7CGhde.js";import{T as U}from"./CFSs6vdx.js";import{f as C}from"./CSlkdJUE.js";import{S as V}from"./6C4StZv5.js";import{d as W,r as m,j as I,o as G,W as H,t as M,v as w,z as v,A as T,O as x,aa as $,C as J,_ as K,g as Q}from"./DkuDmdD7.js";import{u as X}from"./slE1xHV0.js";import"./BGIFtisS.js";import"./6BwnFfZN.js";import"./BRK4loV1.js";import"./BTOsj3aW.js";import"./BwLK_scU.js";import"./C5mdboMC.js";import"./DYHHCWM9.js";import"./DN3eHOnZ.js";import"./D4lI5vpz.js";import"./Ce6njBYG.js";import"./DdQrQ7-5.js";import"./nufkX4jA.js";import"./RAasLaaH.js";import"./BVsX1iIx.js";import"./BG0OyHeb.js";import"./CNkvSXuu.js";import"./CzBXAPyu.js";import"./DCDZkvx_.js";const Y=W({__name:"Editor",props:{track:{}},setup(c){const{tone:N}=A(),b=c,g=m({input:"note",inputType:""}),r=m(new D),p=m(new V),d=m(new q),f=m(new Map),k=m(),h=I(()=>({model:g.value,items:[[],[{text:"Input:"},{label:"Note",value:"note",name:"input"},{label:"Pause",value:"pause",name:"input",disabled:!0}],[{text:"Note:&nbsp;"},{label:"Auto",value:"",name:"inputType"},..._().map(([e])=>({label:`1/${e.replace(/(\d+)[nm]/,"$1")} n`,name:"inputType",value:e}))]]}));G(()=>{d.value.start();const e=d.value.listen();p.value.add(S.keyDown.subscribe(t=>{switch(t.code){case"ArrowLeft":r.value.prev();break;case"ArrowRight":r.value.next();break;case"ArrowUp":r.value.prevBeat();break;case"ArrowDown":r.value.nextBeat();break;default:if(/Digit(\d+)/.test(t.code)){const o=Number(t.code.replace(/Digit(\d+)/,"$1")),a=_()[o-1];a&&(r.value.time=a[0])}break}})),p.value.add(e.pipe(C(({type:t})=>t==="noteOn")).subscribe(B)),p.value.add(e.pipe(C(({type:t})=>t==="noteOff")).subscribe(E))}),H(()=>{p.value.unsubscribe(),d.value.destroy()});function O({render:e}){k.value=e}function R(e,{position:t,dimension:o}){const a=Array.from(f.value.values());for(let i=0;i<a.length;i++){const s=a[Number(i)],l=(r.value.now()-s)/1e3/(r.value.speed*2)*o.x;e.fillRect(t.x,t.y,l,o.y)}}let u;function B({value:e}){e&&typeof e=="object"&&(u||(u=z(()=>{k.value&&k.value()})),f.value.set(e.identifier,r.value.now()))}function E({value:e}){if(e&&typeof e=="object"){const t=N.getTone(),o=[1,2,4,8,16,32].map(n=>[`${n}n`,`${n}t`,`${n}n.`]).flat().map(n=>[n,t.Time(n).toSeconds()]).sort((n,l)=>Number(l[1])-Number(n[1])),a=Math.max((r.value.now()-f.value.get(e.identifier))/1e3,Number(o[o.length-1][1]));f.value.delete(e.identifier);const i=t.Time(o.map(([,n])=>Number(n)).find(n=>{const l=n*.2;return n-l<=a&&a<=n+l})),s=r.value.getDuration();console.log({delay:s,name:e.identifier,time:i.toNotation()}),b.track.addNote(new F({delay:s,name:e.identifier,time:i.toNotation()})),console.log("notes",b.track.notes),f.value.size<1&&(u==null||u.stop(),u=void 0)}else console.warn("onNoteOff",e)}function j(e){console.log("onClickNote",e)}function z(e){let t=0,o=0,a=!1;const i=s=>{const n=s-t;t=s,o+=n,e(s,o),a||requestAnimationFrame(i)};return requestAnimationFrame(i),{stop:()=>a=!0}}return(e,t)=>(w(),M("div",null,[v(L,{model:r.value,onRender:R,onReady:O,onValue:t[0]||(t[0]=o=>e.track.setCurrentDuration(o))},{background:T(({onRefresh:o})=>[(w(),J(U,{key:r.value.value,track:e.track,duration:r.value.getDuration(),clickable:"",onRefresh:o,"onNote:click":j},null,8,["track","duration","onRefresh"]))]),navigation:T(({navigation:o})=>[v(y,x($(o)),null,16),v(y,x($(h.value)),null,16)]),_:1},8,["model"])]))}}),Z={components:{Editor:Y},async setup(){return{...X(),...await A()}},data(){const c=new D;return{track:new P({beatCount:1,speed:c.speed,notes:[{name:"C4",time:"2n",delay:4}]})}}};function ee(c,N,b,g,r,p){const d=Q("editor");return w(),M("div",null,[v(d,{track:r.track},null,8,["track"])])}const he=K(Z,[["render",ee]]);export{he as default};
