var L=Object.defineProperty;var F=(x,t,e)=>t in x?L(x,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):x[t]=e;var o=(x,t,e)=>F(x,typeof t!="symbol"?t+"":t,e);import{i as R,p as k}from"./BGIFtisS.js";import{B as p,p as H,b as V,T as W}from"./dhpcBTH2.js";import{f as $,p as j,g as q}from"./BG0OyHeb.js";import{S as A,N as U}from"./CzBXAPyu.js";import{G as O}from"./6BwnFfZN.js";import{d as X,r as N,a0 as Q,j as Y,o as Z,t as E,v as _,x as D,Z as J,$ as K,X as tt,Y as et,y as it,a1 as nt,_ as st}from"./DkuDmdD7.js";const rt=4;class ot{constructor(t,e={}){o(this,"canvas");o(this,"ctx");o(this,"margin",0);o(this,"beatCount",1);o(this,"gutter",27);o(this,"count",1);o(this,"height",36);o(this,"outerMargin",[10,0,10,0]);o(this,"innerMargin",[0,48,0,48]);o(this,"innerPadding",[20,0,10,0]);o(this,"color","#ffaa55");this.setOptions(e),this.canvas=t;const i=t.getContext("2d");if(!i)throw new Error("Canvas context is not available");this.ctx=i}setOptions(t){const{gutter:e,height:i,margin:n,color:a,outerMargin:r,innerMargin:u,innerPadding:l}=t||{};this.gutter=e||this.gutter,this.height=i||this.height,this.margin=n||this.margin,this.color=a||this.color,this.outerMargin=r||this.outerMargin,this.innerMargin=u||this.innerMargin,this.innerPadding=l||this.innerPadding}render({beatCount:t,count:e}){this.count=e,this.beatCount=t;const i=this.ctx;i.clearRect(0,0,i.canvas.width,i.canvas.height);for(let n=0;n<this.count;n++)this.renderGridRow(this.getGridBoundingBox(n),this.getInnerGridBoundingBox(n))}getInnerGridRowBoundingBox(t){const{position:e,dimension:i}=this.getInnerGridBoundingBox(t);return{position:e,dimension:R(i.x,i.y*this.beatGrid.y+1)}}get firstRowIndex(){return 0}get lastRowIndex(){return this.count-1}get innerBoundingBox(){return{position:R(this.outerMargin[0],this.outerMargin[1]),dimension:R(this.ctx.canvas.width-(this.outerMargin[0]+this.outerMargin[2]),this.ctx.canvas.height-(this.outerMargin[1]+this.outerMargin[3]))}}get beatGrid(){return R(this.beatCount,rt)}get dimension(){return R(this.canvas.width,this.canvas.height)}get mergedMargin(){return[this.outerMargin[0]+this.innerMargin[0],this.outerMargin[1]+this.innerMargin[1],this.outerMargin[2]+this.innerMargin[2],this.outerMargin[3]+this.innerMargin[3]]}getGridBoundingBox(t){const e=this.mergedMargin,i=e[0]+0,n=e[1]+t*this.height+t*this.gutter,a=-(e[0]+e[2])+this.dimension.x,r=this.height/this.beatGrid.y;return{position:R(i,n),dimension:R(a,r)}}getInnerGridBoundingBox(t){const{position:e,dimension:i}=this.getGridBoundingBox(t);return{position:R(e.x+this.innerPadding[0],e.y+this.innerPadding[1]),dimension:R(i.x-this.innerPadding[0]-this.innerPadding[2],(this.height-this.innerPadding[1]-this.innerPadding[3])/this.beatGrid.y)}}renderGridRow(t,e){const i=this.ctx;i.fillStyle=i.strokeStyle=this.color;let n=new Path2D;dt(n,this.beatGrid,t),i.fill(n),n=new Path2D,at(n,this.beatGrid,e,{first:!0,last:!0}),i.fill(n),i.fillRect(t.position.x+t.dimension.x-5,t.position.y,5,t.dimension.y*this.beatGrid.y)}}function at(x,t,{position:e,dimension:i},n={}){const{first:a,last:r}={first:!1,last:!1,...n};for(let u=a?0:1;u<t.x+r||!1;u++)x.rect(e.x+0+u*Math.floor(i.x/t.x),e.y,1,i.y*t.y)}function dt(x,t,{position:e,dimension:i}){for(let n=0;n<=t.y;n++)x.rect(e.x,n*i.y+e.y,i.x,1)}class ct{constructor(t,e){o(this,"canvas");o(this,"ctx");o(this,"gridRenderer");o(this,"noteRenderer");o(this,"padding",10);o(this,"flipActive",!1);o(this,"colors",{primary:"#000000",secondary:"#000000",background:"#0055aa",foreground:"#ffffff",highlight:"#ffaa55"});o(this,"baseNote",4);o(this,"noteCount",4);o(this,"beats",[]);const{colors:i,gridRenderer:n,noteRenderer:a}={...e};this.colors={...this.colors,...i},this.gridRenderer=n,this.noteRenderer=a,this.canvas=t;const r=t.getContext("2d");if(!r)throw new Error("Canvas context is not available");this.ctx=r}async render({baseNote:t,noteCount:e,beats:i,flipActive:n}){this.flipActive=n||!1,this.baseNote=t,this.noteCount=e,this.beats=i;const a=this.gridRenderer.beatCount,{position:r,dimension:u}=this.gridRenderer.getInnerGridRowBoundingBox(this.gridRenderer.lastRowIndex),l=[];for(let v=0;v<this.beats.length;v++){const w=this.beats[Number(v)],c=u.x/a-this.padding*2,M=r.x+this.padding+v*c+v*this.padding*2;l.push(await this.renderBeat(w,M,c))}return l.flat()}async renderBeat(t,e,i){const n=[],{position:a,dimension:r}=this.gridRenderer.getInnerGridRowBoundingBox(this.gridRenderer.lastRowIndex),u=Object.entries(t.noteGroups);for(let l=0;l<u.length;l++){const[,v]=u[Number(l)];for(let w=0;w<v.length;w++){const{notes:c,align:M}=v[Number(w)];let h;for(let y=0;y<c.length;y++){const T=y===0,S=y===c.length-1,f=c[Number(y)].bindingCount&&(T||h),m=this.flipActive&&c[Number(y)].bindingCount>0&&w%2===1&&c[Number(y)].name,I=await this.resolveNote(c,y,{align:M,flip:!!m,binding:!!f}),{position:G,note:b,canvas:B}=I;let d=I.firstPixel;m&&(d=[B.width-d.x-1,B.height-d.y-1-p]);let s=k(e,a.y);s.x=s.x+i*(b.delay-t.index*2)/2,s.y+=(r.y-B.height)/2,s.y-=B.height/2,s.y+=A,s.y+=p/2,s.y-=G.y,s=k(()=>Math.round(s));let P=B;if(m&&(P=$(B),s.y+=A+P.height-p*2),this.ctx.drawImage(P,s.x,s.y),n.push({dimension:R(P.width,P.height),position:s,note:b}),!b.isPause){if(this.ctx.fillStyle=this.getNoteColors(b).primary||"#000000",y===0&&y===c.length-1){const C={width:5,height:2};for(let g=0;g<b.bindingCount;g++)m?(this.ctx.fillRect(s.x+d.x,s.y+p+d.y+g*-6,C.width,C.height),this.ctx.fillRect(s.x+d.x+C.width-2,s.y+p+d.y+g*-6-2,2,2)):(this.ctx.fillRect(s.x+d.x,s.y+d.y+g*6,C.width,C.height),this.ctx.fillRect(s.x+d.x+C.width-2,2+s.y+d.y+g*6,2,2))}else if(T)h=R(s.x+d.x,s.y+d.y);else if(S){if(!h)throw new Error("startNote is not defined");this.ctx.lineWidth=1;const C=4;this.ctx.beginPath();for(let g=0;g<b.bindingCount;g++)m?(this.ctx.moveTo(h.x,h.y+p-g*6),this.ctx.lineTo(s.x+d.x+1,s.y+d.y+p-g*6),this.ctx.lineTo(s.x+d.x+1,s.y+d.y+p-g*6+C),this.ctx.lineTo(h.x,h.y+p-g*6+C),this.ctx.lineTo(h.x,h.y+p-g*6)):(this.ctx.moveTo(h.x,h.y+g*6),this.ctx.lineTo(s.x+d.x+1,s.y+d.y+g*6),this.ctx.lineTo(s.x+d.x+1,s.y+d.y+g*6+C),this.ctx.lineTo(h.x,h.y+g*6+C),this.ctx.lineTo(h.x,h.y+g*6));this.ctx.fill(),h=null}}}}}return n}async resolveNote(t,e,{align:i,flip:n,binding:a}){const r=t[Number(e)],u=R(0,r.octavePosition*p);let l=0;const v=i===O.ASCENDING,w=i===O.EQUAL?0:3,c=t[t.length-1],M=t[0];a&&(n?v?l=Math.floor((r.octavePosition-M.octavePosition)*p-w*e):l=Math.floor((r.octavePosition-c.octavePosition)*p-w*(t.length-1-e)):v?l=Math.floor((c.octavePosition-r.octavePosition)*p-w*(t.length-1-e)):l=Math.floor((M.octavePosition-r.octavePosition)*p-w*e));const{canvas:h,...y}=await this.noteRenderer.render(r,{colors:this.getNoteColors(r)},l);return{offsetHeight:l,position:u,note:r,canvas:h,...y}}getNoteColors(t){return{primary:t.selected?this.colors.highlight:this.colors.foreground,secondary:this.colors.background}}}class ht{constructor(t,e={colors:{}}){o(this,"canvas");o(this,"ctx");o(this,"noteRenderer");o(this,"gridRenderer");o(this,"beatRenderer");o(this,"colors",{background:"#0055aa",foreground:"#ffffff",highlight:"#ffaa55"});o(this,"gridInnerPadding",[20,0,10,0]);const{colors:i}=e||{};if(this.colors={...this.colors,...i},!t)throw new Error("Canvas is not available");this.canvas=t;const n=t.getContext("2d",{willReadFrequently:!0});if(!n)throw new Error("Canvas context is not available");this.ctx=n,this.noteRenderer=new U,this.gridRenderer=new ot(this.canvas,{innerPadding:this.gridInnerPadding}),this.beatRenderer=new ct(this.canvas,{gridRenderer:this.gridRenderer,noteRenderer:this.noteRenderer})}async render(t,e={}){e={selectedIndex:[],flipActive:!1,...e},this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.gridRenderer.render({beatCount:t.beatCount,count:this.getOctaveLength(t)});let i=[];try{const n=t.getVisibleBeatsByDuration(void 0,H(t.notes));i=await this.beatRenderer.render({flipActive:e.flipActive,baseNote:t.baseNote,noteCount:t.noteCount,beats:n})}catch(n){console.error(n)}for(let n=0;n<this.gridRenderer.count;n++){const{position:a}=this.gridRenderer.getGridBoundingBox(n);this.renderTimeSignature(t,a.x+(this.gridInnerPadding[0]-6)/2,a.y+3)}return j(this.ctx,["#000000","#ffffff",...Object.values(this.colors)]),{notes:i}}renderTimeSignature(t,e,i){const a=this.ctx;a.fillStyle=this.colors.foreground,a.textBaseline="top",a.font='16px "Amiga Topaz 13", sans-serif',a.fillText(String(t.baseNote),e,i),a.fillText(String(t.noteCount),e,i+16*1+1)}getOctaveLength(t){const{length:e}=V(t.notes);return Math.max(Math.floor(e*.8),1)}getDimension(t){const{height:e,gutter:i,outerMargin:n,innerMargin:a}=this.gridRenderer,r=this.getOctaveLength(t);return R(0,e*r+i*(r-1)+n[1]+n[3]+a[1]+a[3])}}const lt={class:"synthesizer-timeline-canvas"},gt=["data-note","data-time","onClick"],ut=X({__name:"TimelineCanvas",props:{flipActive:{type:Boolean,default:!1},track:{type:W,required:!0},clickable:{type:Boolean,default:!1},static:{type:Boolean,default:!1},selectedNotes:{type:Array,default:()=>[]},density:{type:Number,default(){return window.devicePixelRatio||1}}},emits:["note:click","refresh","ready"],setup(x,{emit:t}){const e=N(),i=x,n=t,a=N(),r=N(),u=N(R(0,0));let l,v;const w=N(!1),c=N();Q(()=>i.track,()=>{i.static||(window.clearTimeout(v),v=window.setTimeout(async()=>{await y(),v=void 0},250))},{deep:!0});const M=Y(()=>{var f;return i.clickable?((f=a.value)==null?void 0:f.notes)||[]:[]}),h=()=>{const f=m=>{window.requestAnimationFrame(()=>{nt(async()=>{await y(),n("refresh"),m()})})};return new Promise(m=>{w.value?(window.clearTimeout(l),l=window.setTimeout(async()=>{await f(m),l=void 0},100)):f(m)})},y=async()=>{var f;if(r.value&&e.value&&c.value){u.value=r.value.getDimension(i.track),e.value.width=e.value.offsetWidth*i.density,e.value.height=u.value.y*i.density,c.value.width=e.value.offsetWidth,c.value.height=u.value.y,a.value=await r.value.render(i.track,{flipActive:i.flipActive});const m=q(c.value,e.value.width);(f=e.value.getContext("2d"))==null||f.drawImage(m,0,0,m.width,m.height,0,0,e.value.width,e.value.height)}};Z(()=>{c.value=c.value||document.createElement("canvas"),T(),n("ready"),w.value=!0});const T=async()=>{if(!c.value)throw new Error("Canvas not found");r.value=new ht(c.value),await h()},S=f=>{i.track.selectedIndex===f.index?i.track.setSelectedIndex(-1):i.track.setSelectedIndex(f.index),n("note:click",{note:f,selected:i.track.selectedIndex===f.index})};return(f,m)=>(_(),E("div",lt,[D("canvas",{ref_key:"canvasEl",ref:e,width:"0",height:"0"},null,512),(_(!0),E(J,null,K(M.value,({position:I,dimension:G,note:b})=>{var B,d;return _(),E("button",{key:b.index,"data-note":(B=b.note)==null?void 0:B.toString(),"data-time":(d=b.time)==null?void 0:d.toString(),class:et({selected:b.index===x.track.selectedIndex}),style:tt({...I.toCSSVars("position"),...G.toCSSVars("dimension")}),onClick:s=>S(b)},[D("span",null,"Note "+it(b.index),1)],14,gt)}),128))]))}}),Rt=st(ut,[["__scopeId","data-v-9e1f5eaf"]]);export{Rt as T};
