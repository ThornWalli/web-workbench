var d=(t,s,e)=>{if(!s.has(t))throw TypeError("Cannot "+e)};var p=(t,s,e)=>(d(t,s,"read from private field"),e?e.call(t):s.get(t)),f=(t,s,e)=>{if(s.has(t))throw TypeError("Cannot add the same private member more than once");s instanceof WeakSet?s.add(t):s.set(t,e)},m=(t,s,e,n)=>(d(t,s,"write to private field"),n?n.call(t,e):s.set(t,e),e);import{Z as y,$ as C,a0 as v,a1 as g,w as R,g as _,a2 as x,a3 as I,a4 as b}from"./index.f331e757.js";import{A as H}from"./InputText.c38c0748.js";import{_ as S,D as w,f as O,k as T,l as k,m as u,q as A,K as L}from"./entry.8cd6c9a7.js";var l;class E extends y{constructor(e){const{onAdd:n}=Object.assign({debug:!1,onAdd:null},e);super(e);f(this,l,void 0);m(this,l,n)}add(e,n){e instanceof C&&(e=e.toColumnify().split(/\n/g)),v(e)&&(e=g(e)),p(this,l).call(this,e,n)}}l=new WeakMap;let c=1;const $={components:{WbEnvAtomInputText:H},props:{core:{type:Object,required:!1,default(){return R}},rootElement:{type:HTMLElement,default(){return null}},options:{type:Object,default(){return{focused:!1}}},parentFocused:{type:Boolean,default(){return!1}},showIntroduction:{type:Boolean,default(){return!1}},parentLayout:{type:Object,default(){return{size:_(0,0)}}},delimiterPrefix:{type:String,default:"1.SYS"},readonly:{type:Boolean,default:!1},startCommands:{type:[Array,String],default:null},preRows:{type:[Array],default(){return[]}}},emits:["freeze","unfreeze","refresh","startCommandsComplete"],data(){const t=w(new E({core:this.core,consoleInterface:new x,onAdd:this.onAdd})),s=w(new I),e=this;return s.add([new b({name:["CLS","CLEAR"],action(){e.clearConsole()}})]),{logger:t,inputModel:{value:"",focused:!1},inputHistory:[],currentRow:0,startRow:0,rows:[`[CLI ${c}]`],inputHistoryIndex:-1,lineHeight:18,maxRows:10,delimiterOptions:{value:this.delimiterPrefix,prompt:!1,confirm:!1},executeOptions:{show:!0,logger:t,showCommand:!0,commandBucket:s},activeSleepResolve:null,activeConfirmResolve:null,activePromptResolve:null,triggerRefresh:!1,resizeTimeout:null}},computed:{styleClasses(){return{"js--prompt":this.activePromptResolve,"js--focsued":this.options.focused}},delimiter(){let t=this.delimiterOptions.value;const{confirm:s,prompt:e}=this.delimiterOptions;return s?t="(y/n) ?":e?t="?":t&&(t=`${t}:&gt`),t&&(t=`${t}&nbsp;`),t},parentLayoutSize(){return this.parentLayout.size}},watch:{parentFocused(t){this.inputModel.focused=t.focused},parentLayoutSize(t){window.clearTimeout(this.resizeTimeout),this.resizeTimeout=window.setTimeout(()=>{this.render()},200)},activeSleepResolve(){this.setDelimiter({value:""})},activeConfirmResolve(){this.setDelimiter({value:this.delimiterPrefix,confirm:this.activeConfirmResolve})},activePromptResolve(){this.setDelimiter({value:this.delimiterPrefix,prompt:this.activePromptResolve})}},created(){this.rows.unshift(...this.preRows)},unmounted(){c--},async mounted(){"console"in this.$parent&&(this.$parent.console=this),c++,this.showIntroduction&&await this.createInstruction().then(()=>this.enter('basic "TMP:CONSOLE_INSTRUCTIONS.basic"',{showCommand:!1})).catch(t=>{throw t}),this.$nextTick(async()=>{if(this.startCommands){const t=[].concat(this.startCommands),s=e=>this.enter(e.shift(),{showCommand:!1}).then(()=>e.length>0?s(e):null);await s(t),this.$emit("startCommandsComplete")}})},methods:{async enter(t,s){this.inputHistoryIndex=-1,this.currentRow=0,this.startRow=0,this.$emit("freeze"),await this.core.executeCommand(t,Object.assign({},this.executeOptions,s)),this.$emit("unfreeze"),this.render(),this.refresh(!0)},createInstruction(){const t=["#basic","CLS",'PRINT "Scroll (Up/Down): <strong>Shift+Up</strong> / <strong>Shift+Down</strong>"','PRINT "Enter <strong>commands</strong> to show all commands."'];return this.core.modules.files.fs.createTmpFile("CONSOLE_INSTRUCTIONS.basic",{type:"basic",content:t})},clearConsole(){this.startRow=this.rows.length,this.render()},render(){this.$refs.consoleOutput.innerHTML="",this.maxRows=Math.ceil(this.$el.offsetHeight/this.lineHeight)-2;const t=this.rows.length-1;let s=0;const e=0+this.currentRow,n=t;for(let o=n-this.startRow;o>=e;o--){const i=this.rows[t-o],r=document.createElement("li");r.innerHTML=String(i).replace(/[\\]?\\n/,"<br>")+`
`,this.$refs.consoleOutput.appendChild(r);const a=parseInt(r.offsetHeight/this.lineHeight);if(r.setAttribute("data-rows",a),s+=a,o===e){for(s=s-this.maxRows;s>0&&this.$refs.consoleOutput.childElementCount>1;){const h=this.$refs.consoleOutput.firstElementChild;s-=h.getAttribute("data-rows"),this.$refs.consoleOutput.removeChild(h)}continue}}},refresh(t){this.$nextTick(()=>{t&&(this.triggerRefresh={scroll:!0},this.$emit("refresh",this.triggerRefresh),this.$nextTick(()=>{this.triggerRefresh=null}))})},moveRows(t){let s=!1;t?this.startRow>0?(this.startRow=0,s=!0):this.currentRow<this.rows.length&&(this.currentRow++,s=!0):this.currentRow>0&&(this.currentRow--,s=!0),s&&this.render()},onAdd(t,s){const e=[];Array.isArray(t)?e.push(...t):e.push(String(t)),this.rows.push(...e),this.render()},setDelimiter(t,s=!1,e=!1){Object.assign(this.delimiterOptions,{value:t,prompt:s,confirm:e})},onClick(){this.inputModel.focused=!0},onInputEnter(t){return this.inputHistory.push(t),this.inputModel.value="",this.enter(t)},onInputKeydown(t){const s=t.keyCode;let e=!1;if((this.$refs.input.controlCapsLockActive||this.$refs.input.controlShiftActive)&&(s===38||s===40))t.preventDefault(),this.moveRows(s===38);else{switch(s){case 38:this.inputHistoryIndex++,this.inputHistoryIndex=Math.min(this.inputHistoryIndex,this.inputHistory.length-1),e=!0;break;case 40:this.inputHistoryIndex--,this.inputHistoryIndex=Math.max(this.inputHistoryIndex,-1),e=!0;break}if(e&&this.inputHistory.length>0){let n;this.inputHistoryIndex<0?n="":n=this.inputHistory[this.inputHistory.length-1-this.inputHistoryIndex],this.inputModel.value=n}this.refresh()}}}},M={class:"wrapper"},z={ref:"consoleOutput",class:"output typo-style"},P={class:"input"},N=["innerHTML"];function j(t,s,e,n,o,i){const r=O("wb-env-atom-input-text");return T(),k("div",{class:L(["wb-env-console",i.styleClasses]),onClick:s[0]||(s[0]=(...a)=>i.onClick&&i.onClick(...a))},[u("div",M,[u("ul",z,null,512),u("div",P,[u("span",{ref:"consoleCommandDelimiter",class:"input__prefix",innerHTML:i.delimiter},null,8,N),A(r,{ref:"input","root-element":e.rootElement||t.$el,class:"input__element",multiline:!1,options:e.options,readonly:e.readonly,model:o.inputModel,onEnter:i.onInputEnter,onKeydown:i.onInputKeydown},null,8,["root-element","options","readonly","model","onEnter","onKeydown"])])])],2)}const W=S($,[["render",j],["__scopeId","data-v-913bafa2"]]);export{W};
