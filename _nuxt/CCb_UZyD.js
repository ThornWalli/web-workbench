import{u as e,N as t}from"./EG9l7Kw2.js";import{M as o,a}from"./dA2AK5Yb.js";import{c as n,T as r}from"./Bk3HlLVR.js";import{d as s}from"./DdO-3S9B.js";import i from"./ChrLlhgG.js";import{N as l}from"./G8w6tKzW.js";import{T as u}from"./Bx78nj95.js";import{f as m}from"./D3xLGof4.js";import{S as p}from"./CrNGlbV0.js";import{d as c,r as d,k as f,o as v,W as j,y as b,z as k,C as N,D as y,S as w,ac as g,F as R,_ as A,g as D}from"./BfpYGSxR.js";import{u as h}from"./Dkhtr-D7.js";import"./mZmTw9Uu.js";import"./BHmTNEz3.js";import"./CybH7Zs2.js";import"./D1WZfvAb.js";import"./jSR9Z_uS.js";import"./BKiSbNd3.js";import"./C98WWl5r.js";import"./B1k18Rg6.js";import"./Cy0zoxeo.js";import"./CIasQYz1.js";import"./B-meQdOw.js";import"./Caivkp23.js";import"./D7Us3e3D.js";import"./D3MPJlJW.js";import"./DL1FsYWj.js";import"./tbUmQ5LT.js";import"./D6fwdpc8.js";import"./CV0dHcg-.js";import"./BteAwo4N.js";import"./BVLmgizW.js";import"./Ci-h6nfG.js";const x=A({components:{Editor:c({__name:"Editor",props:{track:{}},setup(r){const{tone:c}=e(),A=r,D=d({input:"note",inputType:""}),h=d(new o),x=d(new p),C=d(new i),T=d(new Map),O=d(),$=f(()=>({model:D.value,items:[[],[{text:"Input:"},{label:"Note",value:"note",name:"input"},{label:"Pause",value:"pause",name:"input",disabled:!0}],[{text:"Note:&nbsp;"},{label:"Auto",value:"",name:"inputType"},...n().map(([e])=>({label:`1/${e.replace(/(\d+)[nm]/,"$1")} n`,name:"inputType",value:e}))]]}));function onReady({render:e}){O.value=e}function onRender(e,{position:t,dimension:o}){const a=Array.from(T.value.values());for(let n=0;n<a.length;n++){const r=a[Number(n)],s=(h.value.now()-r)/1e3/(2*h.value.speed)*o.x;e.fillRect(t.x,t.y,s,o.y)}}let _;function onNoteOn({value:e}){e&&"object"==typeof e&&(_||(_=function startAnimationLoop(e){let t=0,o=0,a=!1;const loop=n=>{const r=n-t;t=n,o+=r,e(n,o),a||requestAnimationFrame(loop)};return requestAnimationFrame(loop),{stop:()=>a=!0}}(()=>{O.value&&O.value()})),T.value.set(e.identifier,h.value.now()))}function onNoteOff({value:e}){if(e&&"object"==typeof e){const t=c.getTone(),o=[1,2,4,8,16,32].map(e=>[`${e}n`,`${e}t`,`${e}n.`]).flat().map(e=>[e,t.Time(e).toSeconds()]).sort((e,t)=>Number(t[1])-Number(e[1])),a=Math.max((h.value.now()-T.value.get(e.identifier))/1e3,Number(o[o.length-1][1]));T.value.delete(e.identifier);const n=t.Time(o.map(([,e])=>Number(e)).find(e=>{const t=.2*e;return e-t<=a&&a<=e+t})),r=h.value.getDuration();console.log({delay:r,name:e.identifier,time:n.toNotation()}),A.track.addNote(new l({delay:r,name:e.identifier,time:n.toNotation()})),console.log("notes",A.track.notes),T.value.size<1&&(null==_||_.stop(),_=void 0)}else console.warn("onNoteOff",e)}function onClickNote({note:e,selected:t}){console.log("onClickNote",{note:e,selected:t})}return v(()=>{C.value.start();const e=C.value.listen();x.value.add(s.keyDown.subscribe(e=>{switch(e.code){case"ArrowLeft":h.value.prev();break;case"ArrowRight":h.value.next();break;case"ArrowUp":h.value.prevBeat();break;case"ArrowDown":h.value.nextBeat();break;default:if(/Digit(\d+)/.test(e.code)){const t=Number(e.code.replace(/Digit(\d+)/,"$1")),o=n()[t-1];o&&(h.value.time=o[0])}}})),x.value.add(e.pipe(m(({type:e})=>"noteOn"===e)).subscribe(onNoteOn)),x.value.add(e.pipe(m(({type:e})=>"noteOff"===e)).subscribe(onNoteOff))}),j(()=>{x.value.unsubscribe(),C.value.destroy()}),(e,o)=>(k(),b("div",null,[N(a,{model:h.value,onRender:onRender,onReady:onReady,onValue:o[0]||(o[0]=t=>e.track.setCurrentDuration(t))},{background:y(({onRefresh:t})=>[(k(),R(u,{key:h.value.value,track:e.track,duration:h.value.getDuration(),clickable:"",onRefresh:t,"onNote:click":onClickNote},null,8,["track","duration","onRefresh"]))]),navigation:y(({navigation:e})=>[N(t,w(g(e)),null,16),N(t,w(g($.value)),null,16)]),_:1},8,["model"])]))}})},setup:async()=>({...h(),...await e()}),data(){const e=new o;return{track:new r({beatCount:1,speed:e.speed,notes:[{name:"C4",time:"2n",delay:4}]})}}},[["render",function _sfc_render(e,t,o,a,n,r){const s=D("editor");return k(),b("div",null,[N(s,{track:n.track},null,8,["track"])])}]]);export{x as default};
