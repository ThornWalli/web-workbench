import{u as D,N as y}from"./CmqCxocH.js";import{M as A,a as F}from"./D9GPTbtE.js";import{c as _,T as L}from"./DoNaWeEl.js";import{d as P}from"./On0xenC3.js";import j from"./Bfcs4GJR.js";import{N as q}from"./C-XkkxZa.js";import{T as U}from"./7TS2X-Kp.js";import{f as C}from"./DNvW6rqi.js";import{S as V}from"./6C4StZv5.js";import{d as W,r as m,k as I,o as G,W as H,y as M,z as w,C as v,D as T,S as x,ac as $,F as J,_ as K,g as Q}from"./oWuEt9Fj.js";import{u as X}from"./CpPkMkLR.js";import"./Cc_Og2B_.js";import"./CpIyErmU.js";import"./CAtFBGOo.js";import"./CFct_F1V.js";import"./fnd6_Gtj.js";import"./CaAbksje.js";import"./9V19AFUE.js";import"./CZZPvNTk.js";import"./B2exwp0w.js";import"./djI3_XgP.js";import"./D4lI5vpz.js";import"./Ce6njBYG.js";import"./DdQrQ7-5.js";import"./RAasLaaH.js";import"./BE-N3i2n.js";import"./6jpuwjT2.js";import"./BH9FFkim.js";import"./CV0dHcg-.js";import"./D9awfk1U.js";import"./CNkvSXuu.js";import"./B0Lefq6F.js";const Y=W({__name:"Editor",props:{track:{}},setup(c){const{tone:N}=D(),b=c,g=m({input:"note",inputType:""}),r=m(new A),p=m(new V),d=m(new j),f=m(new Map),k=m(),h=I(()=>({model:g.value,items:[[],[{text:"Input:"},{label:"Note",value:"note",name:"input"},{label:"Pause",value:"pause",name:"input",disabled:!0}],[{text:"Note:&nbsp;"},{label:"Auto",value:"",name:"inputType"},..._().map(([e])=>({label:`1/${e.replace(/(\d+)[nm]/,"$1")} n`,name:"inputType",value:e}))]]}));G(()=>{d.value.start();const e=d.value.listen();p.value.add(P.keyDown.subscribe(t=>{switch(t.code){case"ArrowLeft":r.value.prev();break;case"ArrowRight":r.value.next();break;case"ArrowUp":r.value.prevBeat();break;case"ArrowDown":r.value.nextBeat();break;default:if(/Digit(\d+)/.test(t.code)){const o=Number(t.code.replace(/Digit(\d+)/,"$1")),a=_()[o-1];a&&(r.value.time=a[0])}break}})),p.value.add(e.pipe(C(({type:t})=>t==="noteOn")).subscribe(O)),p.value.add(e.pipe(C(({type:t})=>t==="noteOff")).subscribe(E))}),H(()=>{p.value.unsubscribe(),d.value.destroy()});function R({render:e}){k.value=e}function B(e,{position:t,dimension:o}){const a=Array.from(f.value.values());for(let i=0;i<a.length;i++){const s=a[Number(i)],l=(r.value.now()-s)/1e3/(r.value.speed*2)*o.x;e.fillRect(t.x,t.y,l,o.y)}}let u;function O({value:e}){e&&typeof e=="object"&&(u||(u=z(()=>{k.value&&k.value()})),f.value.set(e.identifier,r.value.now()))}function E({value:e}){if(e&&typeof e=="object"){const t=N.getTone(),o=[1,2,4,8,16,32].map(n=>[`${n}n`,`${n}t`,`${n}n.`]).flat().map(n=>[n,t.Time(n).toSeconds()]).sort((n,l)=>Number(l[1])-Number(n[1])),a=Math.max((r.value.now()-f.value.get(e.identifier))/1e3,Number(o[o.length-1][1]));f.value.delete(e.identifier);const i=t.Time(o.map(([,n])=>Number(n)).find(n=>{const l=n*.2;return n-l<=a&&a<=n+l})),s=r.value.getDuration();console.log({delay:s,name:e.identifier,time:i.toNotation()}),b.track.addNote(new q({delay:s,name:e.identifier,time:i.toNotation()})),console.log("notes",b.track.notes),f.value.size<1&&(u==null||u.stop(),u=void 0)}else console.warn("onNoteOff",e)}function S({note:e,selected:t}){console.log("onClickNote",{note:e,selected:t})}function z(e){let t=0,o=0,a=!1;const i=s=>{const n=s-t;t=s,o+=n,e(s,o),a||requestAnimationFrame(i)};return requestAnimationFrame(i),{stop:()=>a=!0}}return(e,t)=>(w(),M("div",null,[v(F,{model:r.value,onRender:B,onReady:R,onValue:t[0]||(t[0]=o=>e.track.setCurrentDuration(o))},{background:T(({onRefresh:o})=>[(w(),J(U,{key:r.value.value,track:e.track,duration:r.value.getDuration(),clickable:"",onRefresh:o,"onNote:click":S},null,8,["track","duration","onRefresh"]))]),navigation:T(({navigation:o})=>[v(y,x($(o)),null,16),v(y,x($(h.value)),null,16)]),_:1},8,["model"])]))}}),Z={components:{Editor:Y},async setup(){return{...X(),...await D()}},data(){const c=new A;return{track:new L({beatCount:1,speed:c.speed,notes:[{name:"C4",time:"2n",delay:4}]})}}};function ee(c,N,b,g,r,p){const d=Q("editor");return w(),M("div",null,[v(d,{track:r.track},null,8,["track"])])}const Oe=K(Z,[["render",ee]]);export{Oe as default};
