var d=(e,s,t)=>{if(!s.has(e))throw TypeError("Cannot "+t)};var p=(e,s,t)=>(d(e,s,"read from private field"),t?t.call(e):s.get(e)),f=(e,s,t)=>{if(s.has(e))throw TypeError("Cannot add the same private member more than once");s instanceof WeakSet?s.add(e):s.set(e,t)},m=(e,s,t,n)=>(d(e,s,"write to private field"),n?n.call(e,t):s.set(e,t),t);import{I as y,q as C,r as v,v as g,w as R,g as x,x as I,y as _,z as b}from"./index.5f82f913.js";import{A as H}from"./InputText.5788fd6d.js";import{_ as S,D as w,f as O,k as T,l as k,m as u,q as A,K as L}from"./entry.5be8c6c0.js";var l;class E extends y{constructor(t){const{onAdd:n}=Object.assign({debug:!1,onAdd:null},t);super(t);f(this,l,void 0);m(this,l,n)}add(t,n){t instanceof C&&(t=t.toColumnify().split(/\n/g)),v(t)&&(t=g(t)),p(this,l).call(this,t,n)}}l=new WeakMap;let c=1;const M={components:{WbEnvAtomInputText:H},props:{core:{type:Object,required:!1,default(){return R}},rootElement:{type:HTMLElement,default(){return null}},options:{type:Object,default(){return{focused:!1}}},parentFocused:{type:Boolean,default(){return!1}},showIntroduction:{type:Boolean,default(){return!1}},parentLayout:{type:Object,default(){return{size:x(0,0)}}},delimiterPrefix:{type:String,default:"1.SYS"},readonly:{type:Boolean,default:!1},startCommands:{type:[Array,String],default:null},preRows:{type:[Array],default(){return[]}}},emits:["freeze","unfreeze","refresh","startCommandsComplete"],data(){const e=w(new E({core:this.core,consoleInterface:new I,onAdd:this.onAdd})),s=w(new _),t=this;return s.add([new b({name:["CLS","CLEAR"],action(){t.clearConsole()}})]),{logger:e,inputModel:{value:"",focused:!1},inputHistory:[],currentRow:0,startRow:0,rows:[`[CLI ${c}]`],inputHistoryIndex:-1,lineHeight:18,maxRows:10,delimiterOptions:{value:this.delimiterPrefix,prompt:!1,confirm:!1},executeOptions:{show:!0,logger:e,showCommand:!0,commandBucket:s},activeSleepResolve:null,activeConfirmResolve:null,activePromptResolve:null,triggerRefresh:!1,resizeTimeout:null}},computed:{styleClasses(){return{"js--prompt":this.activePromptResolve,"js--focsued":this.options.focused}},delimiter(){let e=this.delimiterOptions.value;const{confirm:s,prompt:t}=this.delimiterOptions;return s?e="(y/n) ?":t?e="?":e&&(e=`${e}:&gt`),e&&(e=`${e}&nbsp;`),e},parentLayoutSize(){return this.parentLayout.size}},watch:{parentFocused(e){this.inputModel.focused=e.focused},parentLayoutSize(e){window.clearTimeout(this.resizeTimeout),this.resizeTimeout=window.setTimeout(()=>{this.render()},200)},activeSleepResolve(){this.setDelimiter({value:""})},activeConfirmResolve(){this.setDelimiter({value:this.delimiterPrefix,confirm:this.activeConfirmResolve})},activePromptResolve(){this.setDelimiter({value:this.delimiterPrefix,prompt:this.activePromptResolve})}},created(){this.rows.unshift(...this.preRows)},unmounted(){c--},async mounted(){"console"in this.$parent&&(this.$parent.console=this),c++,this.showIntroduction&&await this.createInstruction().then(()=>this.enter('basic "TMP:CONSOLE_INSTRUCTIONS.basic"',{showCommand:!1})).catch(e=>{throw e}),this.$nextTick(async()=>{if(this.startCommands){const e=[].concat(this.startCommands),s=t=>this.enter(t.shift(),{showCommand:!1}).then(()=>t.length>0?s(t):null);await s(e),this.$emit("startCommandsComplete")}})},methods:{async enter(e,s){this.inputHistoryIndex=-1,this.currentRow=0,this.startRow=0,this.$emit("freeze"),await this.core.executeCommand(e,Object.assign({},this.executeOptions,s)),this.$emit("unfreeze"),this.render(),this.refresh(!0)},createInstruction(){const e=["#basic","CLS",'PRINT "Scroll (Up/Down): <strong>Shift+Up</strong> / <strong>Shift+Down</strong>"','PRINT "Enter <strong>commands</strong> to show all commands."'];return this.core.modules.files.fs.createTmpFile("CONSOLE_INSTRUCTIONS.basic",{type:"basic",content:e})},clearConsole(){this.startRow=this.rows.length,this.render()},render(){this.$refs.consoleOutput.innerHTML="",this.maxRows=Math.ceil(this.$el.offsetHeight/this.lineHeight)-2;const e=this.rows.length-1;let s=0;const t=0+this.currentRow,n=e;for(let o=n-this.startRow;o>=t;o--){const i=this.rows[e-o],r=document.createElement("li");r.innerHTML=String(i).replace(/[\\]?\\n/,"<br>")+`
`,this.$refs.consoleOutput.appendChild(r);const a=parseInt(r.offsetHeight/this.lineHeight);if(r.setAttribute("data-rows",a),s+=a,o===t){for(s=s-this.maxRows;s>0&&this.$refs.consoleOutput.childElementCount>1;){const h=this.$refs.consoleOutput.firstElementChild;s-=h.getAttribute("data-rows"),this.$refs.consoleOutput.removeChild(h)}continue}}},refresh(e){this.$nextTick(()=>{e&&(this.triggerRefresh={scroll:!0},this.$emit("refresh",this.triggerRefresh),this.$nextTick(()=>{this.triggerRefresh=null}))})},moveRows(e){let s=!1;e?this.startRow>0?(this.startRow=0,s=!0):this.currentRow<this.rows.length&&(this.currentRow++,s=!0):this.currentRow>0&&(this.currentRow--,s=!0),s&&this.render()},onAdd(e,s){const t=[];Array.isArray(e)?t.push(...e):t.push(String(e)),this.rows.push(...t),this.render()},setDelimiter(e,s=!1,t=!1){Object.assign(this.delimiterOptions,{value:e,prompt:s,confirm:t})},onClick(){this.inputModel.focused=!0},onInputEnter(e){return this.inputHistory.push(e),this.inputModel.value="",this.enter(e)},onInputKeydown(e){const s=e.keyCode;let t=!1;if((this.$refs.input.controlCapsLockActive||this.$refs.input.controlShiftActive)&&(s===38||s===40))e.preventDefault(),this.moveRows(s===38);else{switch(s){case 38:this.inputHistoryIndex++,this.inputHistoryIndex=Math.min(this.inputHistoryIndex,this.inputHistory.length-1),t=!0;break;case 40:this.inputHistoryIndex--,this.inputHistoryIndex=Math.max(this.inputHistoryIndex,-1),t=!0;break}if(t&&this.inputHistory.length>0){let n;this.inputHistoryIndex<0?n="":n=this.inputHistory[this.inputHistory.length-1-this.inputHistoryIndex],this.inputModel.value=n}this.refresh()}}}},$={class:"wrapper"},z={ref:"consoleOutput",class:"output typo-style"},P={class:"input"},N=["innerHTML"];function j(e,s,t,n,o,i){const r=O("wb-env-atom-input-text");return T(),k("div",{class:L(["wb-env-console",i.styleClasses]),onClick:s[0]||(s[0]=(...a)=>i.onClick&&i.onClick(...a))},[u("div",$,[u("ul",z,null,512),u("div",P,[u("span",{ref:"consoleCommandDelimiter",class:"prefix",innerHTML:i.delimiter},null,8,N),A(r,{ref:"input","root-element":t.rootElement||e.$el,class:"element",multiline:!1,options:t.options,readonly:t.readonly,model:o.inputModel,onEnter:i.onInputEnter,onKeydown:i.onInputKeydown},null,8,["root-element","options","readonly","model","onEnter","onKeydown"])])])],2)}const W=S(M,[["render",j],["__scopeId","data-v-acbf643d"]]);export{W};
