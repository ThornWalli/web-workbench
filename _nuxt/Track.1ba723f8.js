import{g as A,w as D,j as x,k as K,u as L,C as U,r as H,q as l}from"./index.faf1b937.js";import{N as M,r as Y,i as Z,j as F,k as v,l as P,M as V,m as R}from"./Track.b965352d.js";import{W as B}from"./ContextMenu.0ab45338.js";import{_ as S,f as p,k as c,l as d,m as h,q as k,N as f,O as b,L as y,M as I,t as O,C as N,S as g,Z as $,W as w,E as z,I as E,H as W,a3 as j,z as q}from"./entry.7783902a.js";import{g as G,b as X,C as a,I as T,N as m}from"./index.64b4a7f6.js";import{N as J,T as Q,u as ee,c as te}from"./Navigation.2c95efb7.js";import se from"./MidiController.408fcab5.js";import{T as ie}from"./TimelineCanvas.c22cbf02.js";import"./index.56665add.js";import"./viewport.f3ae7a6b.js";import"./math.693619eb.js";import"./async.0270444a.js";const ae={components:{WbEnvMoleculeContextMenu:B},props:{parentLayout:{type:Object,default(){return{size:A(window.innerWidth,window.innerHeight)}}},title:{type:String,default:"Web-Workbench release. Version 1.3"},items:{type:Array,default(){return D.modules.windows.contextMenu.activeItems.items}}},emits:["inputContextMenu"],data(){return{cover:!1}},methods:{onUpdateModelValueContextMenu(...e){this.$emit("inputContextMenu",...e)}}},ne={class:"wb-env-molecule-footer"},oe={ref:"menu",class:"menu"};function re(e,s,n,t,o,i){const r=p("wb-env-molecule-context-menu");return c(),d("footer",ne,[h("nav",oe,[k(r,{direction:"top",items:n.items,"parent-layout":n.parentLayout,"onUpdate:modelValue":i.onUpdateModelValueContextMenu},null,8,["items","parent-layout","onUpdate:modelValue"])],512)])}const le=S(ae,[["render",re],["__scopeId","data-v-f49caf4e"]]);const ce=9,de={props:{disabled:{type:Boolean,default:!1},selectedNote:{type:M,default:null},size:{type:String,validator:e=>["small","medium","large"].includes(e),default:"large"},showNoteLabels:{type:Boolean,default:!1},startOctave:{type:Number,default:4},octaveCount:{type:Number,default:6}},emits:["down","up"],data:function(){return{keys:[],dimension:A()}},computed:{selectedNotes(){var e;return this.selectedNote&&Y((e=this.selectedNote)==null?void 0:e.getName())||[]},height(){return{small:96,medium:96*1.5,large:96*2}[this.size]},octaveRange(){const e=[],s=["c","c#","d","d#","e","f","f#","g","g#","a","a#","b"];for(let n=0;n<this.octaveCount;n++)e.push(...s.map(t=>{const o=`${t}${this.startOctave+n}`;return{note:o,black:this.isBlackKey(o)}}));return this.startOctave+this.octaveCount<=ce&&e.push({note:s[0]+(this.startOctave+this.octaveCount),black:!1}),e},styleClasses(){return{disabled:this.disabled}},style(){return{...this.dimension.toCSSVars("dimension"),"--height":this.height,"--keys":this.octaveRange.filter(({black:e})=>!e).length,"--white-keys":this.octaveRange.filter(({black:e})=>!e).length,"--black-keys":this.octaveRange.filter(({black:e})=>e).length}}},mounted(){this.dimension=A(this.$el.offsetWidth,0)},methods:{isBlackKey(e){return/^[a-z]#\d+/.test(e)},onPointerDown(e){this.disabled||this.$emit("down",e)},onPointerUp(e){this.disabled||this.$emit("up",e)}}},ue=["disabled"],me={class:"keys white"},he=["onPointerdown","onPointerup"],_e={key:0},Te={key:0},Ne={class:"keys black"},Ce=["onPointerdown","onPointerup"],pe={key:0},ke={key:0};function ye(e,s,n,t,o,i){return c(),d("div",{style:I(i.style),class:y([i.styleClasses,"wb-disks-synthesizer-keyboard"]),disabled:n.disabled},[h("div",null,[h("div",me,[(c(!0),d(f,null,b(i.octaveRange,({note:r,black:u},_)=>(c(),d("div",{key:_,class:y(["key",{black:u,white:!u,selected:i.selectedNotes.includes(r.toLowerCase())}]),style:I({"--index":_}),onPointerdown:C=>i.onPointerDown(r),onPointerup:C=>i.onPointerUp(r)},[u?N("",!0):(c(),d("span",_e,[n.showNoteLabels?(c(),d("i",Te,O(r),1)):N("",!0)]))],46,he))),128))]),h("div",Ne,[(c(!0),d(f,null,b(i.octaveRange,({note:r,black:u},_)=>(c(),d("div",{key:_,class:y(["key",{black:u,white:!u,selected:i.selectedNotes.includes(r.toLowerCase())}]),style:I({"--index":_}),onPointerdown:C=>i.onPointerDown(r),onPointerup:C=>i.onPointerUp(r)},[u?(c(),d("span",pe,[n.showNoteLabels?(c(),d("i",ke,O(r),1)):N("",!0)])):N("",!0)],46,Ce))),128))])])],14,ue)}const Re=S(de,[["render",ye],["__scopeId","data-v-10c8f2b1"]]);const Ie={components:{WbEnvMoleculeFooter:le,Navigation:J,Keyboard:Re,SynthesizerTimelineCanvas:ie},props:{...x,model:{type:Object,default:G()},trackModel:{type:Object,default:X()},toneDestination:{type:Object,default:null}},emits:[...K],async setup(e,s){const n=g(e,"model"),t=g(e,"trackModel"),o=L(e,s);$(n,()=>{o.setContextMenu(te,{model:n.value,trackModel:t.value,preserveContextMenu:o.preserveContextMenu})},{immediate:!0,deep:!0});const i=w(t.value[a.SYNTHESIZER_TRACK]),r=w(new Q(i));return{...o,...await ee(),track:i,trackPlayer:r}},data(){return{CONFIG_NAMES:a,currentSequence:null,synth:null,maxLength:11,playing:!1,footerModel:{},midiControllerListener:null,midiController:new se,windowsModule:z(this.core.modules.windows)}},computed:{timelineRefreshKey(){return`timeline-${this.bpm}`},selectedNoteIndex(){return this.track.selectedIndex},styleClasses(){return{[`keyboard-align-${this.trackModel[a.SYNTHESIZER_TRACK_KEYBOARD_ALIGN]}`]:!0}},notes:{get(){return this.track.notes},set(e){this.track.notes=e}},showKeyboard(){return this.trackModel[a.SYNTHESIZER_TRACK_SHOW_KEYBOARD]},keybordData(){return{size:this.trackModel[a.SYNTHESIZER_TRACK_KEYBOARD_SIZE],showNoteLabels:this.trackModel[a.SYNTHESIZER_TRACK_SHOW_NOTE_LABELS],selectedNote:this.notes[this.selectedNoteIndex],startOctave:this.trackModel[a.SYNTHESIZER_TRACK_START_OCTAVE],octaveCount:this.trackModel[a.SYNTHESIZER_TRACK_OCTAVE_COUNT]}},bpm(){return Number(this.model[a.SYNTHESIZER_BPM])},masterVolume(){return this.core.config.observable[U.SCREEN_CONFIG].soundVolume},decibelValue(){return Z(this.masterVolume)},isMaxLength(){return this.track.octaveCount>=this.maxLength},duration(){return this.trackModel[a.SYNTHESIZER_TRACK_DURATION]},noteDiagramControlNavigation(){var e;return{model:this.trackModel,items:[[this.trackPlayer.playing?{selected:!0,title:"Pause",disabled:!this.trackPlayer.currentSequence||!this.trackPlayer.playing,onClick:()=>this.onClickPlause()}:{title:"Play",disabled:this.trackPlayer.playing||this.track.notes.length===0,onClick:()=>this.onClickPlay()},{title:"Stop",disabled:!this.trackPlayer.currentSequence,onClick:()=>this.onClickStop()},{title:"Restart",disabled:this.selectedNoteIndex<0,onClick:()=>this.onClickRestart()},{title:"Reset",disabled:this.track.notes.length===0,onClick:()=>this.onClickReset()}],[{disabled:!((e=this.track.getCurrentNote())!=null&&e.isPaused),title:"Duration",onClick:async()=>{const s=this.track.getCurrentNote();this.preserveContextMenu(!0);const n="Set Duration:",t=await this.core.executeCommand(`openDialog -title="${n}" -prompt -prompt-type=number -prompt-step=0.01 -prompt-value="${s.toSeconds()/2}" -apply="Save" -abort="Cancel"`);t&&(s.duration=Number(t*2),s.time=null),this.preserveContextMenu(!1),this.window.focus()}},{disabled:this.selectedNoteIndex===-1,title:"Replace",name:a.SYNTHESIZER_TRACK_INPUT_OPERATION,value:T.REPLACE},{disabled:this.selectedNoteIndex===-1,title:"Add",name:a.SYNTHESIZER_TRACK_INPUT_OPERATION,value:T.ADD},{disabled:this.selectedNoteIndex===-1,title:"Remove",onClick:()=>{this.track.removeNote(this.selectedNoteIndex)}},{spacer:!0},{title:"Prev",disabled:this.selectedNoteIndex<0,onClick:()=>{this.track.selectPrevNote()}},{title:"Next",disabled:this.selectedNoteIndex>=this.track.notes.length-1,onClick:()=>{this.track.selectNextNote()}}]]}},footer(){const e=this.track,s=this.trackModel,n=e.getDuration().toFixed(2);return{items:H([...this.midiController?[{title:`MIDI (${this.midiController.input?this.midiController.input.name:"OFF"})`,action:async()=>{const t=this.midiController;this.midiControllerListener||(await t.start(),t.inputs[0]&&(this.midiControllerListener=t.listen(t.inputs[0]).subscribe(this.onMidiControllerListen)))},items:this.midiController.ready&&this.midiControllerListener?[{title:"Inputs",items:this.midiController.inputs.map(t=>({title:t.name,model:this.midiController,name:"activeInput",type:l.RADIO,value:t.id,action:()=>{var o;(o=this.midiControllerListener)==null||o.unsubscribe(),this.midiControllerListener=null,this.midiController.listen(t).subscribe(this.onMidiControllerListen)}}))},{title:"Outputs",items:this.midiController.outputs.map(t=>({title:t.name,model:this.midiController,name:"activeOutput",type:l.RADIO,value:t.id,action(){}}))},{type:l.SEPARATOR},{title:"Disconnect",action:()=>{var t;(t=this.midiControllerListener)==null||t.unsubscribe(),this.midiControllerListener=null,this.midiController.unlisten()}}]:[]}]:[],{type:l.TEXT,text:`${this.track.selectedIndex}/${this.notes.length}`},{type:l.SEPARATOR},{type:l.DEFAULT,title:`Instr.: ${this.track.type}`,items:Object.entries(F()).map(([t,o])=>({type:l.RADIO,title:o,model:e,name:"type",value:t}))},{type:l.SEPARATOR},{title:`Octave: ${s[a.SYNTHESIZER_TRACK_START_OCTAVE]}-${s[a.SYNTHESIZER_TRACK_START_OCTAVE]+s[a.SYNTHESIZER_TRACK_OCTAVE_COUNT]-1}`,items:[{type:l.DEFAULT,title:"Start Octave",items:Array(9).fill({}).map((t,o)=>({type:l.RADIO,title:String(o+1),model:s,name:a.SYNTHESIZER_TRACK_START_OCTAVE,value:o+1,action(i){i=Number(i),i+s[a.SYNTHESIZER_TRACK_OCTAVE_COUNT]>9&&(s[a.SYNTHESIZER_TRACK_OCTAVE_COUNT]=10-i)}}))},{type:l.DEFAULT,title:"Octave Count",items:Array(10-s[a.SYNTHESIZER_TRACK_START_OCTAVE]).fill({}).map((t,o)=>({type:l.RADIO,title:String(o+1),model:s,name:a.SYNTHESIZER_TRACK_OCTAVE_COUNT,value:o+1}))}]},{type:l.SPACER},{type:l.TEXT,text:`BPM: ${this.bpm}`},{type:l.TEXT,text:`Dur.: ${n}`}])}},currentNoteTimeName(){var e;return(e=this.track.notes[this.selectedNoteIndex])==null?void 0:e.time.toString()},noteNavigation(){const e=this.trackModel,s=this.selectedNoteIndex>-1?this.track.getCurrentNote():this.trackModel,n=this.trackModel[a.SYNTHESIZER_TRACK_INPUT_OPERATION]===T.REPLACE&&this.selectedNoteIndex>-1;return{model:e,items:[n?[{fill:!0,title:"Pause",onClick:()=>this.addPause()},...Object.entries(v(!0,s.time.triplet)).map(([t,o])=>({title:`${o} Note`,selected:this.currentNoteTimeName===t,action(){s.time=new P(t)}}))]:[{fill:!0,title:"Pause",onClick:()=>this.addPause()},...Object.entries(v(!0,this.trackModel[a.SYNTHESIZER_TRACK_INPUT_TRIPLET])).map(([t,o])=>({title:`${o} Note`,name:a.SYNTHESIZER_TRACK_DURATION,value:t}))],n?[{title:"Dot",name:"dot",model:s.time},{title:"Triplet",name:"triplet",model:s.time},{fill:!0,title:"Auto",name:"modification",model:s.note,value:m.NATURAL},{fill:!0,title:"Flat",name:"modification",model:s.note,value:m.FLAT},{fill:!0,title:"2x Flat",name:"modification",model:s.note,value:m.DOUBLE_FLAT},{fill:!0,title:"Sharp",name:"modification",model:s.note,value:m.SHARP},{fill:!0,title:"2x Sharp",name:"modification",model:s.note,value:m.DOUBLE_SHARP}]:[{title:"Dot",name:a.SYNTHESIZER_TRACK_INPUT_DOT},{title:"Triplet",name:a.SYNTHESIZER_TRACK_INPUT_TRIPLET},{fill:!0,title:"Auto",name:a.SYNTHESIZER_TRACK_INPUT_MODIFICATION,value:m.NATURAL},{fill:!0,title:"Flat",name:a.SYNTHESIZER_TRACK_INPUT_MODIFICATION,value:m.FLAT},{fill:!0,title:"2x Flat",name:a.SYNTHESIZER_TRACK_INPUT_MODIFICATION,value:m.DOUBLE_FLAT},{fill:!0,title:"Sharp",name:a.SYNTHESIZER_TRACK_INPUT_MODIFICATION,value:m.SHARP},{fill:!0,title:"2x Sharp",name:a.SYNTHESIZER_TRACK_INPUT_MODIFICATION,value:m.DOUBLE_SHARP}]]}}},watch:{"trackPlayer.noteIndex"(e){this.track.selectedIndex=e},bpm(){var e;(e=this.trackPlayer)==null||e.stop()},masterVolume:{handler(){V.volume.value=this.decibelValue},immediate:!0},"track.type":{handler(){this.trackPlayer.createInstrument(this.track.type)},immediate:!0}},mounted(){console.log("TRACK",this.track)},unmounted(){var e;(e=this.midiControllerListener)==null||e.unsubscribe(),this.midiController.destroy(),this.trackPlayer.destroy()},methods:{async setup(){this.tone.ready||(await this.tone.start(),this.trackPlayer.createInstrument(this.track.type))},onClickReset(){this.trackModel[a.SYNTHESIZER_TRACK_INPUT_OPERATION]=T.ADD,this.trackPlayer.reset(),this.track.selectedIndex=-1},async onClickPlay(){await this.setup(),this.trackPlayer.play(this.selectedNoteIndex)},onMidiControllerListen(e){const{name:s,accidental:n,octave:t}=e.note,o=new R(`${s}${n||""}${Math.max(t,1)}`);this.trackPlayer.instrument.triggerAttackRelease(o.toString(),this.trackModel[a.SYNTHESIZER_TRACK_DURATION]),this.noteInput(this.trackModel[a.SYNTHESIZER_TRACK_INPUT_OPERATION],o)},onClickPlause(){this.trackPlayer.pause()},onClickStop(){this.trackPlayer.stop()},onClickRestart(){this.trackPlayer.restart()},async onClickNote({note:e,selected:s}){await this.setup(),s&&e.name&&this.trackPlayer.instrument.triggerAttackRelease(e.name,e.time)},addPause(){this.noteInput()},noteInput(e,s,n){const t=this.track.selectedIndex;if(e===T.REPLACE){const r=this.track.getCurrentNote(),{name:u,octave:_}=R.parse(s);return r.note.name=u,r.note.octave=_,this.track.replaceNote(t,r)}n=n||this.trackModel[a.SYNTHESIZER_TRACK_INPUT_MODIFICATION],typeof s=="string"?(n=n===m.NATURAL?null:n,s=new R(s,{modification:n})):(n=n===m.NATURAL?s.modification:n,s=new R(s,{modification:n}));const o=new P(this.duration);o.dot=this.trackModel[a.SYNTHESIZER_TRACK_INPUT_DOT],o.triplet=this.trackModel[a.SYNTHESIZER_TRACK_INPUT_TRIPLET];const i=new M({note:s,time:o});if(t>-1)switch(e){case T.ADD:return this.track.addNoteTo(t,i);case T.REPLACE:return this.track.replaceNote(t,i)}return this.track.addNote(i)},async onDownKeyboard(e){await this.setup(),this.noteInput(this.trackModel[a.SYNTHESIZER_TRACK_INPUT_OPERATION],e),this.trackPlayer.instrument.triggerAttack(e)},async onUpKeyboard(){await this.tone.awaitReady,this.trackPlayer.instrument.triggerRelease()}}},Ee={key:0,class:"keyboard"},Ae={class:"panel"},Se={key:0,class:"test"},ve={class:"sheet"};function Pe(e,s,n,t,o,i){const r=p("keyboard"),u=p("navigation"),_=p("synthesizer-timeline-canvas"),C=p("wb-env-molecule-footer");return c(),d("div",{class:y(["wb-disks-extras13-synthesizer-track",i.styleClasses])},[h("div",null,[h("div",null,[i.showKeyboard?(c(),d("div",Ee,[k(r,E({disabled:t.trackPlayer.playing},i.keybordData,{onDown:i.onDownKeyboard,onUp:i.onUpKeyboard}),null,16,["disabled","onDown","onUp"]),h("span",{class:y(["message",{show:i.isMaxLength}])},"Octave length is to largeâ€¦",2)])):N("",!0),k(u,E({disabled:t.trackPlayer.playing},i.noteNavigation),null,16,["disabled"])]),h("div",Ae,[i.showKeyboard?(c(),d("div",Se)):N("",!0),k(u,W(j(i.noteDiagramControlNavigation)),null,16),h("div",ve,[h("div",null,[(c(),q(_,{key:i.timelineRefreshKey,clickable:"",track:t.trackPlayer.track,"onNote:click":i.onClickNote},null,8,["track","onNote:click"]))])])])]),k(C,E(i.footer,{"parent-layout":o.windowsModule.contentWrapper.layout}),null,16,["parent-layout"])],2)}const Ye=S(Ie,[["render",Pe],["__scopeId","data-v-8f332c28"]]);export{Ye as default};
