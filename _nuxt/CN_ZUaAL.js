import{i as m,p as E}from"./OlYXjGCK.js";import{B as x,p as D,b as L,T as F}from"./Ds-AH-SM.js";import{j as H,p as V,r as W}from"./D7YMvfqk.js";import{S as _,N as $}from"./Bjf3RcYt.js";import{G as A}from"./B1Xgq4rl.js";import{d as j,r as M,a0 as q,k as U,o as X,y as G,z as k,A as O,X as Q,Y,Z,$ as J,B as K,a1 as tt,_ as et}from"./BkRx7U8b.js";const it=4;class nt{canvas;ctx;margin=0;beatCount=1;gutter=27;count=1;height=36;outerMargin=[10,0,10,0];innerMargin=[0,48,0,48];innerPadding=[20,0,10,0];color="#ffaa55";constructor(t,e={}){this.setOptions(e),this.canvas=t;const i=t.getContext("2d");if(!i)throw new Error("Canvas context is not available");this.ctx=i}setOptions(t){const{gutter:e,height:i,margin:n,color:o,outerMargin:r,innerMargin:g,innerPadding:h}=t||{};this.gutter=e||this.gutter,this.height=i||this.height,this.margin=n||this.margin,this.color=o||this.color,this.outerMargin=r||this.outerMargin,this.innerMargin=g||this.innerMargin,this.innerPadding=h||this.innerPadding}render({beatCount:t,count:e}){this.count=e,this.beatCount=t;const i=this.ctx;i.clearRect(0,0,i.canvas.width,i.canvas.height);for(let n=0;n<this.count;n++)this.renderGridRow(this.getGridBoundingBox(n),this.getInnerGridBoundingBox(n))}getInnerGridRowBoundingBox(t){const{position:e,dimension:i}=this.getInnerGridBoundingBox(t);return{position:e,dimension:m(i.x,i.y*this.beatGrid.y+1)}}get firstRowIndex(){return 0}get lastRowIndex(){return this.count-1}get innerBoundingBox(){return{position:m(this.outerMargin[0],this.outerMargin[1]),dimension:m(this.ctx.canvas.width-(this.outerMargin[0]+this.outerMargin[2]),this.ctx.canvas.height-(this.outerMargin[1]+this.outerMargin[3]))}}get beatGrid(){return m(this.beatCount,it)}get dimension(){return m(this.canvas.width,this.canvas.height)}get mergedMargin(){return[this.outerMargin[0]+this.innerMargin[0],this.outerMargin[1]+this.innerMargin[1],this.outerMargin[2]+this.innerMargin[2],this.outerMargin[3]+this.innerMargin[3]]}getGridBoundingBox(t){const e=this.mergedMargin,i=e[0]+0,n=e[1]+t*this.height+t*this.gutter,o=-(e[0]+e[2])+this.dimension.x,r=this.height/this.beatGrid.y;return{position:m(i,n),dimension:m(o,r)}}getInnerGridBoundingBox(t){const{position:e,dimension:i}=this.getGridBoundingBox(t);return{position:m(e.x+this.innerPadding[0],e.y+this.innerPadding[1]),dimension:m(i.x-this.innerPadding[0]-this.innerPadding[2],(this.height-this.innerPadding[1]-this.innerPadding[3])/this.beatGrid.y)}}renderGridRow(t,e){const i=this.ctx;i.fillStyle=i.strokeStyle=this.color;let n=new Path2D;rt(n,this.beatGrid,t),i.fill(n),n=new Path2D,st(n,this.beatGrid,e,{first:!0,last:!0}),i.fill(n),i.fillRect(t.position.x+t.dimension.x-5,t.position.y,5,t.dimension.y*this.beatGrid.y)}}function st(R,t,{position:e,dimension:i},n={}){const{first:o,last:r}={first:!1,last:!1,...n};for(let g=o?0:1;g<t.x+r||!1;g++)R.rect(e.x+0+g*Math.floor(i.x/t.x),e.y,1,i.y*t.y)}function rt(R,t,{position:e,dimension:i}){for(let n=0;n<=t.y;n++)R.rect(e.x,n*i.y+e.y,i.x,1)}class ot{canvas;ctx;gridRenderer;noteRenderer;padding=10;flipActive=!1;colors={primary:"#000000",secondary:"#000000",background:"#0055aa",foreground:"#ffffff",highlight:"#ffaa55"};baseNote=4;noteCount=4;beats=[];constructor(t,e){const{colors:i,gridRenderer:n,noteRenderer:o}={...e};this.colors={...this.colors,...i},this.gridRenderer=n,this.noteRenderer=o,this.canvas=t;const r=t.getContext("2d");if(!r)throw new Error("Canvas context is not available");this.ctx=r}async render({baseNote:t,noteCount:e,beats:i,flipActive:n}){this.flipActive=n||!1,this.baseNote=t,this.noteCount=e,this.beats=i;const o=this.gridRenderer.beatCount,{position:r,dimension:g}=this.gridRenderer.getInnerGridRowBoundingBox(this.gridRenderer.lastRowIndex),h=[];for(let u=0;u<this.beats.length;u++){const v=this.beats[Number(u)],a=g.x/o-this.padding*2,C=r.x+this.padding+u*a+u*this.padding*2;h.push(await this.renderBeat(v,C,a))}return h.flat()}async renderBeat(t,e,i){const n=[],{position:o,dimension:r}=this.gridRenderer.getInnerGridRowBoundingBox(this.gridRenderer.lastRowIndex),g=Object.entries(t.noteGroups);for(let h=0;h<g.length;h++){const[,u]=g[Number(h)];for(let v=0;v<u.length;v++){const{notes:a,align:C}=u[Number(v)];let c;for(let f=0;f<a.length;f++){const P=f===0,I=f===a.length-1,y=a[Number(f)].bindingCount&&(P||c),w=this.flipActive&&a[Number(f)].bindingCount>0&&v%2===1&&a[Number(f)].name,T=await this.resolveNote(a,f,{align:C,flip:!!w,binding:!!y}),{position:S,note:p,canvas:B}=T;let d=T.firstPixel;w&&(d=[B.width-d.x-1,B.height-d.y-1-x]);let s=E(e,o.y);s.x=s.x+i*(p.delay-t.index*2)/2,s.y+=(r.y-B.height)/2,s.y-=B.height/2,s.y+=_,s.y+=x/2,s.y-=S.y,s=E(()=>Math.round(s));let N=B;if(w&&(N=H(B),s.y+=_+N.height-x*2),this.ctx.drawImage(N,s.x,s.y),n.push({dimension:m(N.width,N.height),position:s,note:p}),!p.isPause){if(this.ctx.fillStyle=this.getNoteColors(p).primary||"#000000",f===0&&f===a.length-1){const b={width:5,height:2};for(let l=0;l<p.bindingCount;l++)w?(this.ctx.fillRect(s.x+d.x,s.y+x+d.y+l*-6,b.width,b.height),this.ctx.fillRect(s.x+d.x+b.width-2,s.y+x+d.y+l*-6-2,2,2)):(this.ctx.fillRect(s.x+d.x,s.y+d.y+l*6,b.width,b.height),this.ctx.fillRect(s.x+d.x+b.width-2,2+s.y+d.y+l*6,2,2))}else if(P)c=m(s.x+d.x,s.y+d.y);else if(I){if(!c)throw new Error("startNote is not defined");this.ctx.lineWidth=1;const b=4;this.ctx.beginPath();for(let l=0;l<p.bindingCount;l++)w?(this.ctx.moveTo(c.x,c.y+x-l*6),this.ctx.lineTo(s.x+d.x+1,s.y+d.y+x-l*6),this.ctx.lineTo(s.x+d.x+1,s.y+d.y+x-l*6+b),this.ctx.lineTo(c.x,c.y+x-l*6+b),this.ctx.lineTo(c.x,c.y+x-l*6)):(this.ctx.moveTo(c.x,c.y+l*6),this.ctx.lineTo(s.x+d.x+1,s.y+d.y+l*6),this.ctx.lineTo(s.x+d.x+1,s.y+d.y+l*6+b),this.ctx.lineTo(c.x,c.y+l*6+b),this.ctx.lineTo(c.x,c.y+l*6));this.ctx.fill(),c=null}}}}}return n}async resolveNote(t,e,{align:i,flip:n,binding:o}){const r=t[Number(e)],g=m(0,r.octavePosition*x);let h=0;const u=i===A.ASCENDING,v=i===A.EQUAL?0:3,a=t[t.length-1],C=t[0];o&&(n?u?h=Math.floor((r.octavePosition-C.octavePosition)*x-v*e):h=Math.floor((r.octavePosition-a.octavePosition)*x-v*(t.length-1-e)):u?h=Math.floor((a.octavePosition-r.octavePosition)*x-v*(t.length-1-e)):h=Math.floor((C.octavePosition-r.octavePosition)*x-v*e));const{canvas:c,...f}=await this.noteRenderer.render(r,{colors:this.getNoteColors(r)},h);return{offsetHeight:h,position:g,note:r,canvas:c,...f}}getNoteColors(t){return{primary:t.selected?this.colors.highlight:this.colors.foreground,secondary:this.colors.background}}}class at{canvas;ctx;noteRenderer;gridRenderer;beatRenderer;colors={background:"#0055aa",foreground:"#ffffff",highlight:"#ffaa55"};gridInnerPadding=[20,0,10,0];constructor(t,e={colors:{}}){const{colors:i}=e||{};if(this.colors={...this.colors,...i},!t)throw new Error("Canvas is not available");this.canvas=t;const n=t.getContext("2d",{willReadFrequently:!0});if(!n)throw new Error("Canvas context is not available");this.ctx=n,this.noteRenderer=new $,this.gridRenderer=new nt(this.canvas,{innerPadding:this.gridInnerPadding}),this.beatRenderer=new ot(this.canvas,{gridRenderer:this.gridRenderer,noteRenderer:this.noteRenderer})}async render(t,e={}){e={selectedIndex:[],flipActive:!1,...e},this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.gridRenderer.render({beatCount:t.beatCount,count:this.getOctaveLength(t)});let i=[];try{const n=t.getVisibleBeatsByDuration(void 0,D(t.notes));i=await this.beatRenderer.render({flipActive:e.flipActive,baseNote:t.baseNote,noteCount:t.noteCount,beats:n})}catch(n){console.error(n)}for(let n=0;n<this.gridRenderer.count;n++){const{position:o}=this.gridRenderer.getGridBoundingBox(n);this.renderTimeSignature(t,o.x+(this.gridInnerPadding[0]-6)/2,o.y+3)}return V(this.ctx,["#000000","#ffffff",...Object.values(this.colors)]),{notes:i}}renderTimeSignature(t,e,i){const o=this.ctx;o.fillStyle=this.colors.foreground,o.textBaseline="top",o.font='16px "Amiga Topaz 13", sans-serif',o.fillText(String(t.baseNote),e,i),o.fillText(String(t.noteCount),e,i+16*1+1)}getOctaveLength(t){const{length:e}=L(t.notes);return Math.max(Math.floor(e*.8),1)}getDimension(t){const{height:e,gutter:i,outerMargin:n,innerMargin:o}=this.gridRenderer,r=this.getOctaveLength(t);return m(0,e*r+i*(r-1)+n[1]+n[3]+o[1]+o[3])}}const dt={class:"synthesizer-timeline-canvas"},ct=["data-note","data-time","onClick"],ht=j({__name:"TimelineCanvas",props:{flipActive:{type:Boolean,default:!1},track:{type:F,required:!0},clickable:{type:Boolean,default:!1},static:{type:Boolean,default:!1},selectedNotes:{type:Array,default:()=>[]},density:{type:Number,default(){return window.devicePixelRatio||1}}},emits:["refresh","ready","note:click"],setup(R,{emit:t}){const e=M(),i=R,n=t,o=M(),r=M(),g=M(m(0,0));let h,u;const v=M(!1),a=M();q(()=>i.track,()=>{i.static||(window.clearTimeout(u),u=window.setTimeout(async()=>{await f(),u=void 0},250))},{deep:!0});const C=U(()=>i.clickable?o.value?.notes||[]:[]),c=()=>{const y=w=>{window.requestAnimationFrame(()=>{tt(async()=>{await f(),n("refresh"),w()})})};return new Promise(w=>{v.value?(window.clearTimeout(h),h=window.setTimeout(async()=>{await y(w),h=void 0},100)):y(w)})},f=async()=>{if(r.value&&e.value&&a.value){g.value=r.value.getDimension(i.track),e.value.width=e.value.offsetWidth*i.density,e.value.height=g.value.y*i.density,a.value.width=e.value.offsetWidth,a.value.height=g.value.y,o.value=await r.value.render(i.track,{flipActive:i.flipActive});const y=W(a.value,e.value.width);e.value.getContext("2d")?.drawImage(y,0,0,y.width,y.height,0,0,e.value.width,e.value.height)}};X(()=>{a.value=a.value||document.createElement("canvas"),P(),n("ready"),v.value=!0});const P=async()=>{if(!a.value)throw new Error("Canvas not found");r.value=new at(a.value),await c()},I=y=>{i.track.selectedIndex===y.index?i.track.setSelectedIndex(-1):i.track.setSelectedIndex(y.index),n("note:click",{note:y,selected:i.track.selectedIndex===y.index})};return(y,w)=>(k(),G("div",dt,[O("canvas",{ref_key:"canvasEl",ref:e,width:"0",height:"0"},null,512),(k(!0),G(Q,null,Y(C.value,({position:T,dimension:S,note:p})=>(k(),G("button",{key:p.index,"data-note":p.note?.toString(),"data-time":p.time?.toString(),class:J({selected:p.index===R.track.selectedIndex}),style:Z({...T.toCSSVars("position"),...S.toCSSVars("dimension")}),onClick:B=>I(p)},[O("span",null,"Note "+K(p.index),1)],14,ct))),128))]))}}),yt=et(ht,[["__scopeId","data-v-89880751"]]);export{yt as T};
