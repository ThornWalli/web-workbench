var e=Object.defineProperty,__publicField=(t,s,o)=>((t,s,o)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[s]=o)(t,"symbol"!=typeof s?s+"":s,o);import{i as t}from"./BHmTNEz3.js";import{d as s,E as o,l as i,D as n}from"./BSzGBLGV.js";import{S as a}from"./D3MPJlJW.js";import{f as r}from"./D3xLGof4.js";import{L as l,r as m,O as d,a9 as u}from"./BfpYGSxR.js";import{S as c,I as p}from"./D1WZfvAb.js";class SymbolItem{constructor({fsItem:e,command:s,model:o,layout:i}){__publicField(this,"ready",!1),__publicField(this,"fsItem"),__publicField(this,"command"),__publicField(this,"type","default"),__publicField(this,"id",crypto.randomUUID()),__publicField(this,"layout",l({position:t(0,0),size:t(0,0)})),__publicField(this,"ignoreRearrange",!1),__publicField(this,"model",l({title:"Item Title",symbol:c.DEFAULT,used:!1,visible:!0,url:void 0,ignoreRearrange:!1})),this.type="default",this.command=s,this.model=l({...this.model,...o||{}}),this.layout=l({...this.layout,...i||{}}),this.fsItem=e}async setup({core:e}){try{const t=this.fsItem;if(!t||this.ready)return;this.type=function getTypeFromFsItem(e){if(e instanceof s)return"container";if(e.meta.get(p.WEB_URL))return"link";return"default"}(t),await applyFsItemProperties(this,e),t.events.subscribe(async({name:s})=>{"addItem"!==s&&"removeItem"!==s&&t&&await applyFsItemProperties(this,e)})}catch(t){console.warn(t),this.model.symbol=c.DISALLOW_1}this.ready=!0}setLayout(e){e.position&&(this.layout.position=t(e.position.x,e.position.y)),e.size&&(this.layout.size=t(e.size.x,e.size.y))}}async function applyFsItemProperties(e,s){var o;const i=e.fsItem;if(i)if(e.model.title=i.name||"",e.layout.position=i.meta.get(p.POSITION)&&preparePoint(i.meta.get(p.POSITION))||t(0,0),e.model.visible=Boolean(i.meta.get(p.VISIBLE)),e.model.symbol=i.meta.get(p.SYMBOL),i.meta.get(p.WEB_URL)&&(e.model.url=String(i.meta.get(p.WEB_URL))),e.model.ignoreRearrange=!!i.meta.get(p.IGNORE_SYMBOL_REARRANGE),i.meta.get(p.REFERENCE)){const t=await(null==(o=s.modules.files)?void 0:o.fileSystem.get(String(i.meta.get(p.REFERENCE))));if(!t)throw new Error("Reference item not found");t.meta.get(p.WEB_URL)&&(e.model.url=String(t.meta.get(p.WEB_URL))),e.command=()=>getCommand(t,e.model)}else e.command=()=>getCommand(i,e.model)}function getCommand(e,o){if(e instanceof s){const s=[`openDirectory "${e.getPath()}"`];e.meta.get(p.WINDOW_SYMBOL_REARRANGE)&&s.push("-sort-symbols");const o=e.meta.get(p.WINDOW_POSITION)&&preparePoint(e.meta.get(p.WINDOW_POSITION))||t(0,0);o.length>0&&s.push(`--window-position="${t(o.x,o.y).toArray().join(",")}"`);const i=e.meta.get(p.WINDOW_SIZE)&&preparePoint(e.meta.get(p.WINDOW_SIZE))||t(0,0);return i.length>0&&s.push(`--window-size="${t(i.x,i.y).toArray().join(",")}"`),e.meta.has(p.WINDOW_SCALE)&&s.push(`--window-scale=${e.meta.get(p.WINDOW_SCALE)}`),e.meta.has(p.WINDOW_SCROLL_X)&&s.push(`--window-scroll-x=${e.meta.get(p.WINDOW_SCROLL_X)}`),e.meta.has(p.WINDOW_SCROLL_Y)&&s.push(`--window-scroll-y=${e.meta.get(p.WINDOW_SCROLL_Y)}`),e.meta.has(p.WINDOW_SIDEBAR)&&s.push(`--window-sidebar=${e.meta.get(p.WINDOW_SIDEBAR)}`),e.meta.has(p.WINDOW_FULL_SIZE)&&s.push(`--window-full-size=${e.meta.get(p.WINDOW_FULL_SIZE)}`),s.join(" ")}if(!o.url)return`execute "${e.getPath()}"`}function generateSymbolItems(e,t){return e.map(e=>{const s=e instanceof SymbolItem?e:new SymbolItem({...e});return s.setup({core:t}),s})}function preparePoint(e){return t(e.x,e.y)}function resolveCommand(e){return"function"==typeof e?e():e}var h=(e=>(e[e.NAME=0]="NAME",e[e.TYPE=1]="TYPE",e[e.CREATED_DATE=2]="CREATED_DATE",e[e.EDITED_DATE=3]="EDITED_DATE",e))(h||{}),y=(e=>(e[e.ASCENDING=0]="ASCENDING",e[e.DESCENDING=1]="DESCENDING",e))(y||{}),I=(e=>(e.SHOW_INVISIBLE_SYMBOLS="symbolWrapper_showInvisibleItems",e.ORDER_TYPE="symbolWrapper_iconsOrderType",e.ORDER_DIRECTION="symbolWrapper_iconsOrderDirection",e))(I||{});class SymbolWrapperEvent extends o{}class ISymbolWrapper{constructor(e,s=[],o=!1){__publicField(this,"id",crypto.randomUUID()),__publicField(this,"items",m([])),__publicField(this,"selectedItems",m([])),__publicField(this,"core"),__publicField(this,"root",!1),__publicField(this,"layout",l({size:t(0,0),position:t(0,0)})),__publicField(this,"size",t(0,0)),__publicField(this,"parentSize",t(0,0)),this.root=o||!1,this.core=e,this.items.value=generateSymbolItems(s||[],this.core)}setLayout(e){e.position&&(this.layout.position=t(e.position.x,e.position.y)),e.size&&(this.layout.size=t(e.size.x,e.position.y))}setSize(e){this.size=t(e.x,e.y)}setParentSize(e){this.parentSize=t(e.x,e.y)}rearrangeIcons(e={align:"left",axis:"horizontal",force:!1,root:!1,margin:10}){e=Object.assign({orderType:this.core.config.get(I.ORDER_TYPE)||h.NAME,orderDirection:this.core.config.get(I.ORDER_DIRECTION)||y.ASCENDING,onlyVisible:!this.core.config.get(I.SHOW_INVISIBLE_SYMBOLS)||!1,align:"left",axis:"horizontal",root:!1,margin:10},e);let s=this.items.value;switch(e.root&&(e.orderType=h.NAME,e.orderDirection=y.DESCENDING,e.force||(e.axis="vertical",e.align="right")),e.onlyVisible&&(s=s.filter(e=>e.model.visible)),e.force||(s=s.filter(e=>!e.model.ignoreRearrange)),e.orderType){case h.TYPE:s=s.sort((e,t)=>e.type.localeCompare(t.type));break;case h.CREATED_DATE:s=s.sort((e,t)=>{var s,o;const[i,n]=[(null==(s=e.fsItem)?void 0:s.createdDate)||0,(null==(o=t.fsItem)?void 0:o.createdDate)||0];return i===n?0:i>n?1:-1});break;case h.EDITED_DATE:s=s.sort((e,t)=>{var s,o;const[i,n]=[(null==(s=e.fsItem)?void 0:s.editedDate)||0,(null==(o=t.fsItem)?void 0:o.editedDate)||0];return i===n?0:i>n?1:-1});break;default:s=s.sort(e=>e.model.title.localeCompare(e.model.title))}if(e.orderDirection===y.ASCENDING)s.reverse();const o=e.margin||0;let i,n=o,a=0,r=0;return i="right"===e.align?this.size.x:o,s.forEach(s=>{"horizontal"===e.axis?(("left"===e.align&&i+(s.layout.size.x+o)>=this.parentSize.x||"right"===e.align&&i-(s.layout.size.x+o)<=0)&&(i="right"===e.align?this.size.x:o,n+=a+o,a=0),s.layout.position=t(i,n),i+=(s.layout.size.x+o)*("right"===e.align?-1:1),a=Math.max(a,s.layout.size.y)):(n+s.layout.size.y>this.parentSize.y-2*o&&(i+=(r+o)*("right"===e.align?-1:1),n=o,r=0),"right"===e.align?s.layout.position=t(i-(s.layout.size.x+o),n):s.layout.position=t(i,n),n+=s.layout.size.y+o,r=Math.max(r,s.layout.size.x))}),s.reduce((e,{id:t,layout:s})=>e.then(()=>this.savePosition(t,s.position)),Promise.resolve())}clearSelectedItems(){[...this.selectedItems.value].forEach(e=>this.unselectItem(e))}isSelectedItem(e){return this.selectedItems.value.includes(e)}selectItem(e){return!this.isSelectedItem(e)&&(this.selectedItems.value.push(e),!0)}unselectItem(e){return!!this.isSelectedItem(e)&&(this.selectedItems.value=this.selectedItems.value.filter(t=>t!==e),!0)}async moveItem(e,t){console.warn("Method not implemented.",e,t)}async moveItemToItem(e,t){console.warn("Method not implemented.",t,e)}async savePosition(e,t){console.warn("Method not implemented.",e,t)}get(e){return this.items.value.find(t=>t.id===e)}has(e){return!!this.items.value.find(t=>t.id===e)}add(...e){const t=generateSymbolItems(e,this.core);return this.items.value.push(...t),t}remove(e){let t;return t="string"==typeof e?this.get(e):e,t&&(this.unselectItem(t.id),this.items.value.splice(this.items.value.indexOf(t),1)),t}}class ASymbolWrapper extends ISymbolWrapper{constructor(){super(...arguments),__publicField(this,"events",d(new a))}add(...e){const t=super.add(...e);return this.events.next(new SymbolWrapperEvent({name:"add",value:{wrapper:this,items:Array.from(t)}})),t}remove(e){const t=super.remove(e);return t&&this.events.next(new SymbolWrapperEvent({name:"remove",value:{wrapper:this,item:t||void 0}})),t}setup(...e){return Promise.resolve()}selectItem(e){return!!super.selectItem(e)&&(this.events.next(new o({name:"selectItem",value:{wrapper:this,id:e}})),!0)}unselectItem(e){return!!super.unselectItem(e)&&(this.events.next(new o({name:"unselectItem",value:{wrapper:this,id:e}})),!0)}}class FileSystemSymbolWrapper extends ASymbolWrapper{constructor(){super(...arguments),__publicField(this,"fsItem"),__publicField(this,"usedMemory",0)}async setup(e){this.fsItem=e;const t=Array.from((await e.getItems()).values());await Promise.all(t.map(async e=>this.add(await FileSystemSymbolWrapper.fsItemToSymbol(e)))),e.events.subscribe(this.onEventItem.bind(this))}async moveItemToItem(e,s){var o,i;if(e.locked)throw new Error("Items are locked!");if(s.locked)throw new Error("Destination is locked!");e.meta.set(p.POSITION,t(0,0)),await(null==(o=this.core.modules.files)?void 0:o.fs.saveItem(e)),await(null==(i=this.core.modules.files)?void 0:i.fs.move(e,s,{override:!0}))}async moveItem(e,t){const s=this.get(e);if(s&&(s.fsItem instanceof i||s.fsItem instanceof n))try{if(!(null==s?void 0:s.fsItem)||!(null==t?void 0:t.fsItem))throw new Error("Item or wrapper not found");return await this.moveItemToItem(s.fsItem,t.fsItem),!0}catch(o){return console.warn(o),!1}return!1}async savePosition(e,t){var s;let o;if("string"==typeof e&&this.get(e)?o=this.get(e):e instanceof SymbolItem&&(o=e),!o)throw new Error(`Item not found. ${e}`);if(!o.fsItem)throw new Error(`Item has no fsItem. ${e}`);o.fsItem.meta.set(p.POSITION,t),null==(s=this.core.modules.files)||s.fs.saveItem(o.fsItem)}hasFsItem(e){return this.items.value.find(t=>{var s;return(null==(s=t.fsItem)?void 0:s.id)===e.id})}async onEventItem({name:e,value:t}){var s,o;if(null==t?void 0:t.item){let i;if("addItem"===e)i=await FileSystemSymbolWrapper.fsItemToSymbol(t.item),this.hasFsItem(t.item)||this.add(i);else if("removeItem"===e){const e=this.items.value.find(e=>{var s,o;return(null==(s=e.fsItem)?void 0:s.id)===(null==(o=t.item)?void 0:o.id)});if(!e)throw new Error(`Item not found in symbol wrapper. ${null==(s=t.item)?void 0:s.id}`);this.remove(e)}this.usedMemory=(null==(o=this.fsItem)?void 0:o.getUsedMemory())||0}else console.warn("Item event without value",e,t)}static getItemsFromItem(e){return Promise.all(Array.from(e.items.values()).map(FileSystemSymbolWrapper.fsItemToSymbol))}static async fsItemToSymbol(e){const t=await e.getPath(),s=new SymbolItem({fsItem:e,model:{title:e.name||"Untitled"}});return"function"==typeof e.action&&(s.command=`executeFile "${t}"`),e.meta.get(p.WEB_URL)&&(s.model.url=String(e.meta.get(p.WEB_URL))),s}}const f=t(0,0);class Window{constructor({sidebarComponent:e,sidebarComponentData:s,component:o,componentData:i,options:n,wrapper:r,layout:m,parentWindow:u}){__publicField(this,"events",new a),__publicField(this,"id",crypto.randomUUID()),__publicField(this,"component"),__publicField(this,"componentData"),__publicField(this,"sidebarComponent"),__publicField(this,"sidebarComponentData"),__publicField(this,"parentWindow"),__publicField(this,"options",l({title:void 0,scale:!1,scaleX:!1,scaleY:!1,scroll:!1,scrollX:!1,scrollY:!1,clamp:!1,clampX:!0,clampY:!1,freeze:!1,focused:!1,center:!0,close:!0,overlay:!0,embed:!1,fillHeader:!1,filled:!1,borderless:!1,hideRootHeader:!1,sidebar:!0,prompt:!1})),__publicField(this,"group"),__publicField(this,"wrapper"),__publicField(this,"layout",l({focused:!1,position:t(0,0),size:f,scrollOffset:t(0,0),zIndex:0})),this.parentWindow=u,e&&(this.sidebarComponent=d(e)),s&&(this.sidebarComponentData=d(s)),o&&(this.component=d(o)),this.componentData={...i||{}},r&&(this.wrapper=d(r)),this.options=Object.assign(this.options,n),this.layout=Object.assign(this.layout,m)}setLayout(e){e.position&&(this.layout.position=t(e.position.x,e.position.y)),e.size&&(this.layout.size=t(e.size.x,e.size.y)),e.scrollOffset&&(this.layout.scrollOffset=t(e.scrollOffset.x,e.scrollOffset.y)),e.focused&&(this.layout.focused=e.focused)}ready(){this.options.ready=!0,this.events.next(new o({name:"ready"}))}focus(){this.options.focused=!0,this.events.next(new o({name:"focus"}))}unfocus(){this.options.focused=!1,this.events.next(new o({name:"unfocus"}))}close(e){this.wrapper&&(this.events.next(new o({name:"close",value:e})),this.wrapper.remove(this.id),this.wrapper=void 0)}setWrapper(e){this.wrapper=d(e)}setGroup(e){this.group=e}awaitClose(){return new Promise(e=>{const t=this.events.pipe(r(({name:e})=>"close"===e)).subscribe(s=>{t.unsubscribe(),e(s)})})}awaitReady(){return new Promise(e=>{if(this.options.ready)e(this);else{const t=this.events.pipe(r(({name:e})=>"ready"===e)).subscribe(()=>{t.unsubscribe(),e(this)})}})}}var v=(e=>(e[e.CENTER=0]="CENTER",e[e.ORDER_HORIZONTAL=1]="ORDER_HORIZONTAL",e[e.ORDER_VERTICAL=2]="ORDER_VERTICAL",e[e.ORDER_DIAGONAL_LEFT=3]="ORDER_DIAGONAL_LEFT",e[e.ORDER_DIAGONAL_RIGHT=4]="ORDER_DIAGONAL_RIGHT",e[e.SPLIT_HORIZONTAL=5]="SPLIT_HORIZONTAL",e[e.SPLIT_VERTICAL=6]="SPLIT_VERTICAL",e[e.FULL=7]="FULL",e))(v||{});class WindowWrapper{constructor(e,s=[]){__publicField(this,"events",d(new a)),__publicField(this,"id",crypto.randomUUID()),__publicField(this,"core"),__publicField(this,"layout",{size:t(0,0),position:t(0,0)}),__publicField(this,"groups",new Map),__publicField(this,"modelMap",new Map),__publicField(this,"models",[]),__publicField(this,"_activeWindow"),this.core=e,s.forEach(e=>this.add(e))}setLayout(e){e.position&&(this.layout.position=t(e.position.x,e.position.y)),e.size&&(this.layout.size=t(e.size.x,e.size.y))}getActiveWindow(){return this.models.find(e=>e.options.focused)}setActiveWindow(e){this.models.forEach(t=>{t.options.focused=e===t.id,e===t.id&&(this._activeWindow=t,this.events.next(new o({name:"setActiveWindow",value:t})))})}hasEmbbedWindow(){return!!this.models.find(e=>e.options.embed)}isHeaderVsible(){return!this.models.find(e=>e.options.embed&&e.options.hideRootHeader)}add(e,s){const{full:i,maximize:n,active:a,group:r}={full:!1,maximize:!1,active:!0,group:null,...s||{}};let l;if(l=e instanceof Window?e:new Window(e),l.setWrapper(this),n?l.layout.size=t(this.layout.size.x,this.layout.size.y):i&&(l.layout.size=t(()=>t(this.layout.size.x,this.layout.size.y)+t(0,0))),r){let e;this.groups.has(r)?(e=this.groups.get(r),e.windows.push(l)):(e={primary:l,windows:[],name:r},this.groups.set(r,e)),l.setGroup(e)}return l.layout.zIndex=this.models.length,this.models.push(l),this.events.next(new o({name:"add",value:l})),this.modelMap.set(l.id,l),a&&this.setActiveWindow(l.id),l}remove(e){let t;t=e instanceof Window?e:this.get(e),void 0!==t&&(t.group&&(t.group.primary===e?(t.group.windows.forEach(e=>e.close()),this.groups.delete(t.group.name)):t.group.primary.focus()),this.models.splice(this.models.indexOf(t),1),this.modelMap.delete(t.id))}get(e){return this.modelMap.get(e)}clear(){this.models=[].splice(0,this.models.length),this.modelMap.clear()}setWindowUpDown(e,t){const s=this.models,o=Array.from(s).filter(e=>!e.options.embed).sort((e,t)=>(e.layout.zIndex||0)-(t.layout.zIndex||0)).map(u),i=this.get(e);if(i){const e=o.findIndex(({id:e})=>e===i.id),s=o[t?e-1:e+1];if(s){const e=i.layout.zIndex;i.layout.zIndex=s.layout.zIndex,s.layout.zIndex=e}}}centerWindow(e){let t;t=e instanceof Window?e:this.get(e),t&&centerWindow(t,this.layout)}setWindowPositions(e,s=[],o){const{embed:i}={embed:!1,...o};switch(s.length<1&&s.push(...this.models),i||(s=s.filter(e=>!e.options.embed)),e){case 7:s.forEach(e=>{!function fullWindow(e,s){e.layout.position=t(0,0),e.layout.size=s.size}(e,this.layout)});break;case 0:s.forEach(e=>{centerWindow(e,this.layout)});break;case 3:case 4:!function windowPositionDiagonal(e,s,o){const i=1/e.length;e.forEach((n,a)=>{centerWindow(n,s),a=-Math.floor(e.length/2)+a;const r=t(n.layout.position.x+(o?-1:1)*(i*n.layout.size.x)*a,n.layout.position.y+i*n.layout.size.y*a),l=t(()=>t(s.size.x,s.size.y)-t(n.layout.size.x,n.layout.size.y));n.layout.position=t(()=>Math.max(Math.min(r,l),0))})}(s,this.layout,4===e);break;case 5:case 6:!function windowPositionSplit(e,s,o){let i;const n=e.length;o?(i=t(s.size.x,s.size.y/n),e.forEach((e,s)=>{e.layout.position=t(0,s*i.y),e.layout.size=i})):(i=t(s.size.x/n,s.size.y),e.forEach((e,s)=>{e.layout.position=t(s*i.x,0),e.layout.size=i}))}(s,this.layout,6===e)}}saveSize(e,t){var s,o,i,n;const a=this.get(e);if(a&&(null==(s=a.componentData)?void 0:s.symbolWrapper)&&(null==(o=a.componentData)?void 0:o.symbolWrapper)instanceof FileSystemSymbolWrapper){const e=null==(i=a.componentData)?void 0:i.symbolWrapper.fsItem;e&&(e.meta.set(p.WINDOW_SIZE,t),null==(n=this.core.modules.files)||n.fs.saveItem(e))}}savePosition(e,t){var s,o,i,n;const a=this.get(e);if(a&&(null==(s=a.componentData)?void 0:s.symbolWrapper)&&(null==(o=a.componentData)?void 0:o.symbolWrapper)instanceof FileSystemSymbolWrapper){const e=null==(i=a.componentData)?void 0:i.symbolWrapper.fsItem;e&&(e.meta.set(p.WINDOW_POSITION,t),null==(n=this.core.modules.files)||n.fs.saveItem(e))}}}function centerWindow(e,s){e.layout.position=t(()=>(t(s.size.x,s.size.y)-t(e.layout.size.x,e.layout.size.y))/2)}export{I as C,FileSystemSymbolWrapper as F,ISymbolWrapper as I,h as O,WindowWrapper as W,Window as a,y as b,v as c,resolveCommand as r};
