import{N as C,u as g}from"./BbukiPGF.js";import{M as R,a as N}from"./D1G-YJO8.js";import{T as w,a as d}from"./C8JtUr3H.js";import{d as u}from"./BuCYUwbe.js";import x from"./DLHtQzqS.js";import{N as T}from"./DUL8HUBw.js";import{T as D}from"./xQeovHuD.js";import{_,g as c,t as p,v,z as l,A as h,C as A,K as f,a9 as b}from"./wBwW-Gex.js";import{S as B,f as k}from"./BxO05Tpb.js";import{u as L}from"./Bt7T5PmJ.js";import"./DWxMEIfg.js";import"./DwAjpAW9.js";import"./DxOVdChq.js";import"./BhIZyK9R.js";import"./C5mdboMC.js";import"./BhSFKTk7.js";import"./CFhzTvZQ.js";import"./Dpb40Ezb.js";import"./PIkGlXJS.js";import"./BDlJ-Lao.js";import"./C5qtQag8.js";import"./C1Z8QYso.js";import"./BrQUI1fL.js";import"./AEwztriR.js";const M={components:{TimelineCanvas:D,Navigation:C,Metronom:R},props:{track:{type:w,required:!0}},async setup(){return{...await g()}},data(){return{duration:0,model:{input:"note",inputType:""},metronom:new N,subscriptions:new B,midiController:new x,openNotes:new Map}},computed:{navigation(){return{model:this.model,items:[[],[{text:"Input:"},{label:"Note",value:"note",name:"input"},{label:"Pause",value:"pause",name:"input",disabled:!0}],[{text:"Note:&nbsp;"},{label:"Auto",value:"",name:"inputType"},...d().map(([e])=>({label:`1/${e.replace(/(\d+)[nm]/,"$1")} n`,name:"inputType",value:e})),{spacer:!0},{label:"Remove Note",action:()=>{this.track.removeNote(this.track.selectedIndex)}},{label:"Clean Range",action:()=>{this.track.removeNotesByDurationRange(this.metronom.getDuration(),this.metronom.timeDuration)}},{label:"Clean Beat",action:()=>{this.track.removeNotesFromBeat(this.track.getBeatIndex())}},{label:"Reset",action:()=>{this.reset()}}]]}}},async mounted(){await this.midiController.start(),console.log("domEvents",u);const e=this.midiController.listen();this.subscriptions.add(u.keydown.subscribe(o=>{switch(o.code){case"ArrowLeft":this.metronom.prev();break;case"ArrowRight":this.metronom.next();break;case"ArrowUp":this.metronom.prevBeat();break;case"ArrowDown":this.metronom.nextBeat();break;default:if(/Digit(\d+)/.test(o.code)){const i=o.code.replace(/Digit(\d+)/,"$1"),r=d()[i-1];r&&(this.metronom.time=r[0])}break}console.log(o)}),e.pipe(k(({type:o})=>o==="noteOn")).subscribe(this.onNoteOn.bind(this)),e.pipe(k(({type:o})=>o==="noteOff")).subscribe(this.onNoteOff.bind(this)))},unmounted(){this.subscriptions.unsubscribe(),this.midiController.destroy()},methods:{onReady({render:e}){this._render=e},onRender(e,{position:o,dimension:i}){const r=Array.from(this.openNotes.values());for(let n=0;n<r.length;n++){const t=r[Number(n)];console.log("test",t);const a=(this.metronom.now()-t)/1e3/(this.metronom.speed*2)*i.x;console.log(a),e.fillRect(o.x,o.y,a,i.y)}},onNoteOn({value:e}){console.log("value.identifier",e.identifier,this.metronom.getDuration()),this.animationLoop||(this.animationLoop=$(()=>{this._render&&this._render()})),this.openNotes.set(e.identifier,this.metronom.now())},onNoteOff({value:e}){const o=[1,2,4,8,16,32].map(t=>[`${t}n`,`${t}t`,`${t}n.`]).flat().map(t=>[t,new(this.tone.getTone()).Time(t).toSeconds()]).sort((t,s)=>s[1]-t[1]),i=Math.max((this.metronom.now()-this.openNotes.get(e.identifier))/1e3,o[o.length-1][1]);this.openNotes.delete(e.identifier);const r=new window.Tone.Time(o.map(([,t])=>t).find(t=>{const s=t*.2;return t-s<=i&&i<=t+s}));console.log("time",r.toNotation());const n=this.metronom.getDuration();console.log({delay:n,name:e.identifier,time:r.toNotation()}),this.track.addNote(new T({delay:n,name:e.identifier,time:r.toNotation()})),console.log("notes",this.track.notes),this.openNotes.size<1&&(this.animationLoop.stop(),this.animationLoop=null)},reset(){this.track.reset()},onClickNote(e){console.log("onClickNote",e)}}};function $(e){let o=0,i=0,r=!1;const n=t=>{const s=t-o;o=t,i+=s,e(t,i),r||requestAnimationFrame(n)};return requestAnimationFrame(n),{stop:()=>r=!0}}function O(e,o,i,r,n,t){const s=c("timeline-canvas"),a=c("navigation"),y=c("metronom");return p(),v("div",null,[l(y,{model:n.metronom,onRender:t.onRender,onReady:t.onReady,onValue:o[0]||(o[0]=m=>i.track.currentDuration=m)},{background:h(({onRefresh:m})=>[(p(),A(s,{key:n.metronom.value,track:i.track,duration:n.metronom.getDuration(),clickable:"",onRefresh:m,"onNote:click":t.onClickNote},null,8,["track","duration","onRefresh","onNote:click"]))]),navigation:h(({navigation:m})=>[l(a,f(b(m)),null,16),l(a,f(b(t.navigation)),null,16)]),_:1},8,["model","onRender","onReady"])])}const E=_(M,[["render",O]]),q={components:{Editor:E},async setup(){return{...L(),...await g()}},data(){const e=new N;return{track:new w({beatCount:1,speed:e.speed,notes:[{name:"C4",time:"2n",delay:4}]})}}};function z(e,o,i,r,n,t){const s=c("editor");return p(),v("div",null,[l(s,{track:n.track},null,8,["track"])])}const mt=_(q,[["render",z]]);export{mt as default};
