import{u as D,N as y}from"./at3Qp1uu.js";import{M as A,a as z}from"./C1NPf192.js";import{c as _,T as F}from"./Ds-AH-SM.js";import{d as P}from"./DeEbP9sG.js";import j from"./Cva1neKf.js";import{N as q}from"./ehWpBOkw.js";import{T as U}from"./CN_ZUaAL.js";import{f as C}from"./C723tzWh.js";import{S as V}from"./Wv4Ty0OG.js";import{d as W,r as l,k as I,o as G,W as H,y as M,z as w,C as v,D as T,S as x,ac as $,F as J,_ as K,g as Q}from"./BkRx7U8b.js";import{u as X}from"./JsFOm8c5.js";import"./Bwr9avpB.js";import"./OlYXjGCK.js";import"./B1Xgq4rl.js";import"./ClLpnmyR.js";import"./BTMT_sH9.js";import"./CaAbksje.js";import"./BoZA8JgY.js";import"./Ds4KxLLa.js";import"./B4rpyJsK.js";import"./CL1V9BUB.js";import"./D4lI5vpz.js";import"./OAVrZOa6.js";import"./D4b9WN8K.js";import"./CtlMGvom.js";import"./KQEr41HO.js";import"./CVx03s7S.js";import"./BQm3Nqs0.js";import"./CV0dHcg-.js";import"./D7YMvfqk.js";import"./CNkvSXuu.js";import"./Bjf3RcYt.js";const Y=W({__name:"Editor",props:{track:{}},setup(m){const{tone:N}=D(),b=m,g=l({input:"note",inputType:""}),r=l(new A),c=l(new V),p=l(new j),d=l(new Map),k=l(),h=I(()=>({model:g.value,items:[[],[{text:"Input:"},{label:"Note",value:"note",name:"input"},{label:"Pause",value:"pause",name:"input",disabled:!0}],[{text:"Note:&nbsp;"},{label:"Auto",value:"",name:"inputType"},..._().map(([e])=>({label:`1/${e.replace(/(\d+)[nm]/,"$1")} n`,name:"inputType",value:e}))]]}));G(()=>{p.value.start();const e=p.value.listen();c.value.add(P.keyDown.subscribe(t=>{switch(t.code){case"ArrowLeft":r.value.prev();break;case"ArrowRight":r.value.next();break;case"ArrowUp":r.value.prevBeat();break;case"ArrowDown":r.value.nextBeat();break;default:if(/Digit(\d+)/.test(t.code)){const o=Number(t.code.replace(/Digit(\d+)/,"$1")),a=_()[o-1];a&&(r.value.time=a[0])}break}})),c.value.add(e.pipe(C(({type:t})=>t==="noteOn")).subscribe(L)),c.value.add(e.pipe(C(({type:t})=>t==="noteOff")).subscribe(O))}),H(()=>{c.value.unsubscribe(),p.value.destroy()});function R({render:e}){k.value=e}function B(e,{position:t,dimension:o}){const a=Array.from(d.value.values());for(let i=0;i<a.length;i++){const s=a[Number(i)],u=(r.value.now()-s)/1e3/(r.value.speed*2)*o.x;e.fillRect(t.x,t.y,u,o.y)}}let f;function L({value:e}){e&&typeof e=="object"&&(f||(f=S(()=>{k.value&&k.value()})),d.value.set(e.identifier,r.value.now()))}function O({value:e}){if(e&&typeof e=="object"){const t=N.getTone(),o=[1,2,4,8,16,32].map(n=>[`${n}n`,`${n}t`,`${n}n.`]).flat().map(n=>[n,t.Time(n).toSeconds()]).sort((n,u)=>Number(u[1])-Number(n[1])),a=Math.max((r.value.now()-d.value.get(e.identifier))/1e3,Number(o[o.length-1][1]));d.value.delete(e.identifier);const i=t.Time(o.map(([,n])=>Number(n)).find(n=>{const u=n*.2;return n-u<=a&&a<=n+u})),s=r.value.getDuration();console.log({delay:s,name:e.identifier,time:i.toNotation()}),b.track.addNote(new q({delay:s,name:e.identifier,time:i.toNotation()})),console.log("notes",b.track.notes),d.value.size<1&&(f?.stop(),f=void 0)}else console.warn("onNoteOff",e)}function E({note:e,selected:t}){console.log("onClickNote",{note:e,selected:t})}function S(e){let t=0,o=0,a=!1;const i=s=>{const n=s-t;t=s,o+=n,e(s,o),a||requestAnimationFrame(i)};return requestAnimationFrame(i),{stop:()=>a=!0}}return(e,t)=>(w(),M("div",null,[v(z,{model:r.value,onRender:B,onReady:R,onValue:t[0]||(t[0]=o=>e.track.setCurrentDuration(o))},{background:T(({onRefresh:o})=>[(w(),J(U,{key:r.value.value,track:e.track,duration:r.value.getDuration(),clickable:"",onRefresh:o,"onNote:click":E},null,8,["track","duration","onRefresh"]))]),navigation:T(({navigation:o})=>[v(y,x($(o)),null,16),v(y,x($(h.value)),null,16)]),_:1},8,["model"])]))}}),Z={components:{Editor:Y},async setup(){return{...X(),...await D()}},data(){const m=new A;return{track:new F({beatCount:1,speed:m.speed,notes:[{name:"C4",time:"2n",delay:4}]})}}};function ee(m,N,b,g,r,c){const p=Q("editor");return w(),M("div",null,[v(p,{track:r.track},null,8,["track"])])}const Le=K(Z,[["render",ee]]);export{Le as default};
