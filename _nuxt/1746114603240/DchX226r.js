var he=Object.defineProperty;var de=(o,e,t)=>e in o?he(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var l=(o,e,t)=>de(o,typeof e!="symbol"?e+"":e,t);import{I as ue,i as m,p as fe}from"./BGIFtisS.js";import{S as C}from"./RAasLaaH.js";import{v as V}from"./L24w7Tb1.js";import{f as ae}from"./CSlkdJUE.js";import{K as T,I as A,r as re,a9 as pe}from"./BRP7lMhW.js";import{S as g,I as h}from"./BL9b5cpI.js";import{d as Q,e as w,R as X,f as ge,h as ye,j as se,P as Ie,k as we,c as ve,r as ce,b as Ee,l as De,T as x,m as Z,g as D,n as M,o as Se,q as xe,t as Te,v as _e,x as _,s as S,y as be,z as Pe,A as Ae,p as ze,B as Re,D as Le}from"./CDSNOiTq.js";class u{constructor({name:e,value:t,scope:s}){l(this,"name");l(this,"value");l(this,"scope");this.name=e,this.value=t,this.scope=s}}const Me={basic:g.BASIC,bas:g.BASIC,markdown:g.DISK_MARKDOWN,md:g.DISK_MARKDOWN,image:g.IMAGE,img:g.IMAGE};function Oe(o,e=g.NOTE_BLANK){const t=Me,s=se(o).toLowerCase();return t[s]||e}class ke extends u{}class v{constructor(e,{type:t,symbol:s=g.NOTE_BLANK}={type:"Unknown",symbol:g.NOTE_BLANK}){l(this,"type");l(this,"events");l(this,"_locked",!1);l(this,"parent");l(this,"createdDate");l(this,"editedDate");l(this,"id");l(this,"_name","");l(this,"meta");l(this,"_data");l(this,"_action");const{locked:i=!1,id:a,name:r=void 0,meta:n=void 0,data:c=void 0,action:d,createdDate:I=Date.now(),editedDate:y=void 0}=e;this.events=T(new C),this.createdDate=I||Date.now(),this.editedDate=y||I,this._locked=i||!1,this.id=a,this._name=r||"",this.type=t||"Unknown",this.meta=new Map([[h.SYMBOL,Oe(a||"",s||g.NOTE_BLANK)],[h.VISIBLE,!0],...n||[]]);let E=c;if(typeof c=="string")try{E=JSON.parse(c)}catch(N){throw console.log(E),N}this._action=d,this._data=Ce(E||{})}async remove(e={}){var a,r;const{silent:t}=Object.assign({silent:!1},e);let s;const i=this.isLocked();if(!i)s={type:this.type,id:this.id,name:this.name,path:await this.getPath(),size:this.size,storage:Q(this)};else if(!t)throw new Error((a=w.get("FileSystemItem_itemLocked",await this.getPath()))==null?void 0:a.join(" "));return(t||!i)&&(this.events.next(new u({name:"remove",value:{item:this}})),this.events.unsubscribe(),(r=this.parent)==null||r.removeItem(this)),s?[s]:[]}isLocked(e=!1){return e?!1:this.parent&&this.parent.locked&&this.parent.id!==X?!0:this._locked}async copy(){const e=this.constructor,t=await this.export({encodeData:!1}),s=new e(t);return Promise.resolve(s)}rename(e,t={}){const{name:s=!1,ignore:i=!1}=Object.assign({name:!1,ignore:!1},t);if(!this.isLocked(i)){if(s)return this.name=e,this;{const a=this.id;this.id=ge(e||""),this.parent&&a!==this.id&&this.parent.changeItemId(this,a,this.id)}this.events.next(new ke({name:"rename",value:{item:this}}))}return this}save(){this.events.next(new u({name:"save",value:{item:this}}))}getUsedMemory(){return this.size/this.maxSize}async export(e={}){const{encodeData:t}=Object.assign({encodeData:!0},e),s=new Map(this.meta);Array.from(s.keys()).forEach(a=>{s.get(a)instanceof ue&&s.set(a,s.get(a).toJSON())});let i;return t&&typeof this._data=="string"?i=await ye(this._data):i=this._data,{type:this.type,id:this.id,name:this._name,createdDate:this.createdDate,editedDate:this.editedDate,data:i,meta:Array.from(s)}}get data(){let e=this._data;if(typeof this._data=="string")try{e=JSON.parse(this._data)}catch(t){console.error(t),e={type:"markdown",content:"Cannot parse data",data:this._data}}return e}set data(e){typeof e=="object"&&(e=JSON.stringify(e)),this._data=e}get action(){return this._action}setId(e){this.id=e}setParent(e){this.parent=e}get locked(){var e;return((e=this.parent)==null?void 0:e.locked)||this._locked}get name(){return this._name||this.id}set name(e){this._name=e||""}get extension(){return se(this.id)}get size(){const e=Object.values(this.data||{});return new Blob(e).size}get maxSize(){return new Blob(Object.values(this.data||{})).size}getRealMaxSize(){return new Blob(Object.values(this.data||{})).size}getBase(){return v.getBaseRecursive({item:this},!1)}getPath(){return v.getBaseRecursive({item:this})}static getBaseRecursive({item:e,path:t=[]},s=!0){if(s&&t.push(e.id),e.parent)return v.getBaseRecursive({item:e.parent,path:t});if(t=t.reverse(),t[0]===X&&t.shift(),t.length>0){let i=t[0];return/\./.test(i)||(i+=":"),`${i}${t.slice(1,t.length).join(Ie)}`}else return X}}w.add([["FileSystemItem_itemLocked",["Item Locked","Item is locked, can't be edit… %1"]]]);function Ce(o){return typeof o=="object"&&(o=JSON.stringify(o)),o}class p extends v{constructor(t,s){t={...t};super(t,s);l(this,"items",new Map);l(this,"_maxSize",we(1));this.addItems(t.items||this.items),this._maxSize=t.maxSize||this._maxSize}async export(t={}){const s={...await super.export(t),items:[]};return Reflect.deleteProperty(s,"data"),s.items=await Promise.all(Array.from(this.items.values()).map(i=>i.export())),s}async addItems(t,s=!1){let i=[];t instanceof Map?i=Array.from(t.values()):Array.isArray(t)&&(i=t),i=i.map(r=>(typeof r.data=="string"&&(r.data=ve(r.data)),r));const a=this.parseItems(i);return Promise.all(a.map(r=>this.addItem(r,s)))}static normalizeItemData(t){const s={...t},i=[];if("items"in t&&!(t.items instanceof Map)&&(s.items=new Map(t.items.map(a=>[a.id,a]))),"info"in t&&t.info)debugger;return"extension"in s&&(s.id+="."+s.extension,delete s.extension,i.push("extension")),"createTime"in s&&(s.createdDate=s.createTime,delete s.createTime,i.push("createTime")),"editTime"in s&&(s.editedDate=s.editTime,delete s.editTime,i.push("editTime")),"icon"in s&&(delete s.icon,i.push("icon")),i.length&&console.warn("@deprecated TODO: muss weg, hier werden die alten Items angepasst.",s,i),s}parseItems(t){return t.map(s=>{const i=p.normalizeItemData(s);let a;return i.type?a=J(i.type):"items"in i?a=J("Directory"):a=J(),new a(i)})}async addItem(t,s=!1){const i=t.parent;if(!s&&this.hasItem(t.id))throw new Error(`File ${t.id} exists`);if(i&&await i.removeItem(t),s){const a=se(t.id),r=ce(t.id);t.setId(Ee(De(r,this,a),a))}return this.items.set(t.id,t),t.setParent(this),t.events.next(new u({name:"move",value:{item:t,lastParent:i}})),this.events.next(new u({name:"addItem",value:{item:t}})),t}removeItem(t){return t.setParent(void 0),this.items.delete(t.id),this.events.next(new u({name:"removeItem",value:{item:t}})),Promise.resolve()}async remove(t={}){var a;const{recursive:s}={recursive:!1,...t},i=[];if(s){const r=await this.getItems();for(const n of r.values())i.push(...await n.remove(t));return i.push(...await super.remove(t)),i}else{if((await this.getItems()).size>0)throw new Error((a=w.get("FileSystemItem_itemContainerNotEmpty",await this.getPath()))==null?void 0:a.join(" "));return await super.remove(t)}}changeItemId(t,s,i){this.items.delete(s),this.items.set(i,t),this.parent&&console.log("changeItemId by parent",s,i,this.parent.items)}getItems(){return Promise.resolve(this.items)}getItem(t){return this.items.get(t)}hasItem(t){return this.items.has(t)}get size(){return Array.from(this.items.values()).reduce(function(t,s){return s instanceof p||(t+=s.size),t},0)}get maxSize(){return t(this);function t(s){return s.parent&&s.getRealMaxSize()?t(s.parent):s.getRealMaxSize()}}}w.add([["FileSystemItem_itemContainerNotEmpty",["ItemWrapp Not Empty","ItemContainer not empty… %1"]]]);class P extends p{constructor(t,s){t={...t,locked:!0};super(t,s);l(this,"storage");this.storage=t.storage}get locked(){return this.storage.locked}mount(...t){return this.storage.mount(...t)}unmount(...t){return this.storage.unmount(...t)}async save(){return this.storage.save(await this.export())}}l(P,"TYPE","Storage");const G=class G extends P{constructor(e){super(e,{type:G.TYPE,symbol:g.CLOUD_DISK})}isLogged(){var e;return((e=this.storage.storage)==null?void 0:e.isLogged())||!1}};l(G,"TYPE","CloudDisk");let O=G;class k extends p{constructor(e){super(e,{type:"Directory",symbol:g.DIRECTORY}),[h.WINDOW_SCALE,h.WINDOW_SCROLL_X,h.WINDOW_SCROLL_Y].forEach(t=>{this.meta.has(t)||this.meta.set(t,!0)})}}l(k,"TYPE","Directory");class R extends v{constructor(e){super(e,{type:"File"})}}l(R,"TYPE","File");class Y extends p{constructor(e){super(e,{type:"FloppyDisk"})}}l(Y,"TYPE","FloppyDisk");class K extends P{constructor(e){super(e,{type:"HardDisk",symbol:g.HARD_DISK})}}l(K,"TYPE","HardDisk");class $ extends v{constructor(t){t={refPath:void 0,...t};super(t);l(this,"refPath");this.refPath=t.refPath}}l($,"TYPE","Link");class H extends P{constructor(e){super(e,{type:"RamDisk",symbol:g.RAM_DISK})}}l(H,"TYPE","RamDisk");class me extends p{constructor(e){e={...e,locked:!0,id:"ROOT",name:"ROOT"},super(e,{type:"Root"})}}l(me,"TYPE","Root");class U extends P{constructor(e){super(e,{type:"TmpDisk",symbol:g.TMP_DISK}),this.meta.set(h.VISIBLE,!1),this.meta.set(h.IGNORE_SYMBOL_REARRANGE,!0)}}l(U,"TYPE","TmpDisk");class b extends p{constructor(e){super(e,{type:"Trashcan",symbol:g.TRASHCAN})}}l(b,"TYPE","Trashcan");const f=class f{constructor(e){l(this,"name");l(this,"root");l(this,"currentItem");l(this,"storages",new Map);l(this,"events",T(new C));this.name=e,this.root=new me,this.setup()}setup(){this.currentItem=this.root;const e=[this.addStorage(f.RAM_DISK_TITLE,x.SESSION,{id:f.RAM_DISK_NAME}),this.addStorage(f.HARD_DISK_NAME,x.LOCAL,{trashcan:!0}),this.addStorage(f.TMP_DISK_TITLE,x.TEMP,{id:f.TMP_DISK_NAME,trashcan:!1})];return Promise.all(e).catch(t=>{throw t})}createTmpFile(e,t,s,i){return this.createRootFile(`TMP:${e}`,t,s,i)}createRootDir(e,t,s){const i=`${e}`;return this.makedir(i,t,{override:!0,...s})}createRootFile(e,t,s,i){let a=t,r=s;typeof t=="object"&&(r=t,a=void 0);const n=`${e||"Unknown"}`;return this.makefile(n,a,r,{...i||{},override:!0})}async get(e,t=!1){if(e instanceof v)return e;if(Z(e))try{return await this.parsePath(e)}catch(s){if(t)return new v({id:D(e),name:D(e)});throw s}else throw w.get("FileSystem_pathInvalid",D(e),M(e))}async parsePath(e){var a,r;let t=e,s=this.currentItem;const i=e.match(/^([^:\\/]+):(.*)$/);if(i?(s=(a=this.root)==null?void 0:a.getItem(i[1]),t=i[2]):t[0]==="/"&&this.currentItem?(t=t.slice(1),s=Q(this.currentItem)):t==="ROOT"&&(s=this.root,t=""),t&&t.length>0&&(s=ee(t.split("/"),s)),s)return s;throw w.get("FileSystem_pathInvalid",e,await((r=this.currentItem)==null?void 0:r.getBase())||"")}async addFloppyDisk(e){let t;if(typeof e=="function"?(t=await e(),t instanceof Promise&&(t=await t)):t=e,Array.isArray(t))throw new Error('data is an Array, use "defineFloppyDisk" for define a Disk');return this.addStorage(t)}async removeFloppyDisk(e){await e.remove({silent:!0})}async addStorage(e,t,s={}){s=Object.assign({id:null},s);let i;typeof t=="function"&&(i=t,t=x.CLOUD);const a=this.getFreeSlot(f.PREFIX.FLOPPY_DISK),r={id:a,itemClass:Y};let n={};if(typeof e=="object"){const c=e;r.name=c.name,c.items&&(r.items=c.items),r.meta=Array.from(new Map([[h.SYMBOL,g.DISK_1],...c.meta||[]]))}else{switch(t){case x.SESSION:r.id=f.PREFIX.RAM,r.itemClass=H;break;case x.TEMP:r.id=f.PREFIX.TMP,r.itemClass=U;break;case x.LOCAL:r.id=this.getFreeSlot(f.PREFIX.HARD_DISK),r.itemClass=K;break;case x.CLOUD:r.id=this.getFreeSlot(f.PREFIX.CLOUD_DISK),r.itemClass=O;break}r.id=s.id||r.id;let c;i&&typeof i=="function"?c=await this.registerStorageByStorage(r.id,i).mount(s):c=await this.registerStorageByType(r.id,t).mount(s);const d=await c.load();n=p.normalizeItemData(d),r.storage=c,x.NONE!==t&&(r.name=n.name||e)}return(r.meta=r.meta||[]).push(...n.meta||[]),this.addDisk({...r,...n,storage:r.storage||new Se({id:a,name:f.TMP_DISK_TITLE})},s)}removeStorage(e){return e.unmount().then(()=>(this.events.next(new u({name:"removeStorage",value:{itemStorage:e}})),e))}registerStorageByType(e,t){const s=xe(t),i=`${this.name}_${e}`,a=new s({id:e,name:i});return this.storages.set(i,a),a}registerStorageByStorage(e,t){const s=`${this.name}_${e}`,i=new t({id:e,name:s});return this.storages.set(s,i),i}connect(e,t){return this.addStorage(Te,e,t).then(s=>s).catch(s=>{throw s})}async disconnect(e){return e=await this.removeStorage(e),e.remove({silent:!0,recursive:!0}),e}addDisk({id:e,name:t,meta:s,items:i,itemClass:a,storage:r},n){var I;n={trashcan:!1,...n},i instanceof Map&&n.trashcan&&(!i||i&&!i.has(b.TYPE))&&(i=i||new Map,i.set(b.TYPE,{type:b.TYPE,id:b.TYPE,name:b.TYPE}));const c=a;if(!c)throw new Error("ItemClass is empty!");const d=new c({id:e,name:t||e,meta:s,items:i,storage:r});return(I=this.root)==null||I.addItem(d),this.events.next(new u({name:"addDisk",value:{id:e,item:d}})),d}getFreeSlot(e){var s;let t=0;for(;(s=this.root)!=null&&s.hasItem(`${e}${t}`);)t++;return`${e}${t}`}async exist(e){try{return!!await this.get(e)}catch(t){return console.error(t),!1}}async changeDirectory(e){const t=await this.get(e);return this.currentItem=t,this.events.next(new u({name:"changeDirectory",value:t})),t}async makedir(e,t,s){const{override:i,meta:a}={override:!1,meta:[],...s};let r;e&&_e(e)&&e!==t?r=await this.get(M(e)):r=this.currentItem;const n=new k({id:D(e),name:t||"",createdDate:Date.now(),meta:a});if(await _(r),i||!r.getItem(n.id))r.addItem(n,i),this.events.next(new u({name:"writeItem",value:n}));else throw w.get("FileSystem_fileExist",n.id);return await S(r),n}async makefile(e,t,s,i){var E,N,ie;const{override:a,meta:r}={...i,meta:i.meta||[]},n=D(e),c=new R({id:n,name:t||n,data:s,meta:r,createdDate:Date.now()});if(!Z(e))throw w.get("FileSystem_invalidPath",e);let d=be(e);const I=Pe(e);d===I&&(d=".");let y;if(Ae(d)?y=await this.get(d):((E=this.currentItem)==null?void 0:E.id)!=="ROOT"?y=await this.get(ze(await((N=this.currentItem)==null?void 0:N.getPath())||"",d)):y=await this.get(d),y.hasItem(I))if(a)await((ie=y.getItem(I))==null?void 0:ie.remove()),y.addItem(c);else throw w.get("FileSystem_fileExist",c.id);else y.addItem(c),this.events.next(new u({name:"writeItem",value:c}));return await S(y),c}async editfile(e,t){const s=await this.get(e);return await _(s),await Re(s),s.data=t,S(s)}async editfileMeta(e,t,s){const i=await this.get(e);return Array.isArray(t)?t.map(a=>({name:a[0],value:a[1]})):i.meta.set(t,s),S(i)}async getItemMetaList(e){const t=await this.get(e);return Array.from(t.meta).map(s=>({name:s[0],value:s[1]}))}async saveItem(e){const t=await this.get(e);return S(t)}async makelink(e,t=null){const s=await this.get(e);await _(s);const i=this.currentItem,a=new $({id:ce(s.id)+".ref",name:`${t||s.name}`,refPath:await s.getPath(),createdDate:Date.now()});return await i.addItem(a),await S(s),a}async editlink(e,t){const s=await this.get(e);await _(s);const i=await this.get(t);return s.refPath=await i.getPath(),S(s)}async rename(e,t,{name:s,removeName:i}={name:!1,removeName:!1}){let a;if(e instanceof v)a=e;else if(Z(e)||typeof e=="string")a=await this.get(e);else throw w.get("FileSystem_pathInvalid",M(e),e);return await _(a),i&&(s=!0,t=void 0),await a.rename(t,{ignore:!0,name:s}),S(a)}async copy(e,t,s={ignore:!1}){const{ignore:i}={ignore:!1,...s};let a,r,n;if(e instanceof v?(r=e,a=e.id):(r=await this.get(e),a=D(e)),t instanceof v)t instanceof p||(t=t.parent),n=t;else if(t){a=D(t);const d=await this.get(t,!0);if(d instanceof p?a=D(e):d.parent?n=d.parent:n=await this.get(M(t)),!(n instanceof p))throw new TypeError("no ItemContainer")}else throw new TypeError('"to" is empty!');await _(r);const c=await r.copy();if(n instanceof p&&(i||!n.getItem(a)))c.rename(a),n.addItem(c,i),this.events.next(new u({name:"copyItem",value:c}));else throw w.get("FileSystem_fileExist",a);return S(c)}async move(e,t,{override:s}={}){let i,a,r;if(e instanceof v)a=e,i=e.id;else{if(a=await this.get(e),a instanceof P)throw w.get("FileSystem_cantMoveStorage",a.id);i=D(e)}if(t instanceof v)t instanceof p?r=t:r=t.parent;else{if(i=D(t),r=await this.get(t),r instanceof p)i=D(e);else return this.get(M(t));if(!(r instanceof p))throw new TypeError("no ItemContainer")}let n;if(await _(a),s||!await r.getItem(i))n=Q(a),await a.rename(i),await r.addItem(a,s),this.events.next(new u({name:"moveItem",value:a}));else throw w.get("FileSystem_fileExist",a.id,i);return await S(a),n?n.save().then(()=>a):a}async remove(e,t,s={ignore:!1}){var r;const{ignore:i}={ignore:!1,...s},a=await this.get(e);await _(a);try{const n=await Le(t,a);return n[n.length-1].storage&&await((r=n[n.length-1].storage)==null?void 0:r.save()),n}catch(n){if(!i)throw n}}};l(f,"PREFIX",{FLOPPY_DISK:"DF",TMP:"TMP",RAM:"RAM",HARD_DISK:"HD",CLOUD_DISK:"CD"}),l(f,"TMP_DISK_NAME","TMP"),l(f,"TMP_DISK_TITLE","TMP DISK"),l(f,"RAM_DISK_NAME","RAM"),l(f,"RAM_DISK_TITLE","RAM DISK"),l(f,"HARD_DISK_NAME","HARD DISK");let ne=f;function ee(o,e){const t=o.shift();if(t===void 0)return e;if(t===".."){if(e.parent)return e.parent}else if(t==="."||t==="")return ee(o,e);if(e){const s=e.getItem(t);return o.length>0&&s instanceof p?ee(o,s):s}}function J(o){switch(o){case k.TYPE:return k;case b.TYPE:return b;case P.TYPE:return P;case U.TYPE:return U;case H.TYPE:return H;case K.TYPE:return K;case Y.TYPE:return Y;case O.TYPE:return O;case $.TYPE:return $;case R.TYPE:return R}return R}w.add([["FileSystem_invalidPath",["Invalid File",'Invalid path "%1"']],["FileSystem_invalidFile",["Invalid File",'Invalid file… "%1"']],["FileSystem_fileExist",["File Ready",'File already exists… "%1"']],["FileSystem_pathInvalid",["Path Invalid",'Path invalid… "%1"; base: "%2"']],["FileSystem_itemInvalid",["Item Invalid",'Item id invalid… "%1" from "%2"']],["FileSystem_cantMoveStorage",["Can't Move",`Can't move BaseStorage "%1"`]],["FileSystem_permissionsNeeded",["Permissions needed","Permissions needed"]]]);class j{constructor({fsItem:e,command:t,model:s,layout:i}){l(this,"fsItem");l(this,"command");l(this,"type");l(this,"id",V());l(this,"layout",A({position:m(0,0),size:m(0,0)}));l(this,"ignoreRearrange",!1);l(this,"model",A({title:"Item Title",symbol:g.DEFAULT,used:!1,visible:!0,url:"",ignoreRearrange:!1}));if(this.type="default",this.command=t,this.model=A({...this.model,...s||{}}),this.layout=A({...this.layout,...i||{}}),this.fsItem=e,this.fsItem){const a=this.fsItem;this.type=Ne(a),this.setProperties(a),this.fsItem.events.subscribe(({name:r})=>{r!=="addItem"&&r!=="removeItem"&&e&&this.setProperties(e)})}}setLayout(e){e.position&&(this.layout.position=m(e.position.x,e.position.y)),e.size&&(this.layout.size=m(e.size.x,e.size.y))}setProperties(e){if(this.model.title=e.name||"",this.layout.position=e.meta.get(h.POSITION)&&q(e.meta.get(h.POSITION))||m(0,0),this.model.visible=!!e.meta.get(h.VISIBLE),this.model.symbol=e.meta.get(h.SYMBOL),e.meta.get(h.WEB_URL)&&(this.model.url=String(e.meta.get(h.WEB_URL))),this.model.ignoreRearrange=!!e.meta.get(h.IGNORE_SYMBOL_REARRANGE),e instanceof p){const t=[`openDirectory "${e.getPath()}"`];e.meta.get(h.WINDOW_SYMBOL_REARRANGE)&&t.push("-sort-symbols");const s=e.meta.get(h.WINDOW_POSITION)&&q(e.meta.get(h.WINDOW_POSITION))||m(0,0);s.length>0&&t.push(`--window-position="${m(s.x,s.y).toArray().join(",")}"`);const i=e.meta.get(h.WINDOW_SIZE)&&q(e.meta.get(h.WINDOW_SIZE))||m(0,0);i.length>0&&t.push(`--window-size="${m(i.x,i.y).toArray().join(",")}"`),e.meta.has(h.WINDOW_SCALE)&&t.push(`--window-scale=${e.meta.get(h.WINDOW_SCALE)}`),e.meta.has(h.WINDOW_SCROLL_X)&&t.push(`--window-scroll-x=${e.meta.get(h.WINDOW_SCROLL_X)}`),e.meta.has(h.WINDOW_SCROLL_Y)&&t.push(`--window-scroll-y=${e.meta.get(h.WINDOW_SCROLL_Y)}`),e.meta.has(h.WINDOW_SIDEBAR)&&t.push(`--window-sidebar=${e.meta.get(h.WINDOW_SIDEBAR)}`),e.meta.has(h.WINDOW_FULL_SIZE)&&t.push(`--window-full-size=${e.meta.get(h.WINDOW_FULL_SIZE)}`),this.command=t.join(" ")}else this.model.url||(this.command=`execute "${e.getPath()}"`)}}function oe(o){return o.map(e=>e instanceof j?e:new j(e))}function Ne(o){return o instanceof p?"container":o.meta.get(h.WEB_URL)?"link":"default"}function q(o){return m(o.x,o.y)}var z=(o=>(o[o.NAME=0]="NAME",o[o.TYPE=1]="TYPE",o[o.CREATED_DATE=2]="CREATED_DATE",o[o.EDITED_DATE=3]="EDITED_DATE",o))(z||{}),W=(o=>(o[o.ASCENDING=0]="ASCENDING",o[o.DESCENDING=1]="DESCENDING",o))(W||{}),B=(o=>(o.SHOW_INVISIBLE_SYMBOLS="symbolWrapper_showInvisibleItems",o.ORDER_TYPE="symbolWrapper_iconsOrderType",o.ORDER_DIRECTION="symbolWrapper_iconsOrderDirection",o))(B||{});class le extends u{}class Fe{constructor(e,t=[],s=!1){l(this,"id",V());l(this,"items",re([]));l(this,"selectedItems",re([]));l(this,"core");l(this,"root",!1);l(this,"layout",A({size:m(0,0),position:m(0,0)}));l(this,"size",m(0,0));l(this,"parentSize",m(0,0));this.root=s||!1,this.core=e,this.items.value=oe(t||[])}setLayout(e){e.position&&(this.layout.position=m(e.position.x,e.position.y)),e.size&&(this.layout.size=m(e.size.x,e.position.y))}setSize(e){this.size=m(e.x,e.y)}setParentSize(e){this.parentSize=m(e.x,e.y)}rearrangeIcons(e={orderType:z.NAME,orderDirection:W.ASCENDING,onlyVisible:!1,root:!1,margin:10}){e=Object.assign({orderType:this.core.config.get(B.ORDER_TYPE),orderDirection:this.core.config.get(B.ORDER_DIRECTION),onlyVisible:!this.core.config.get(B.SHOW_INVISIBLE_SYMBOLS),root:!1,margin:10},e);let t=this.items.value;switch(e.root&&(e.orderType=z.NAME,e.orderDirection=W.DESCENDING),e.onlyVisible&&(t=t.filter(n=>n.model.visible)),t=t.filter(n=>!n.model.ignoreRearrange),e.orderType){case z.TYPE:t=t.sort((n,c)=>n.type.localeCompare(c.type));break;case z.CREATED_DATE:t=t.sort((n,c)=>{var y,E;const[d,I]=[((y=n.fsItem)==null?void 0:y.createdDate)||0,((E=c.fsItem)==null?void 0:E.createdDate)||0];return d===I?0:d>I?1:-1});break;case z.EDITED_DATE:t=t.sort((n,c)=>{var y,E;const[d,I]=[((y=n.fsItem)==null?void 0:y.editedDate)||0,((E=c.fsItem)==null?void 0:E.editedDate)||0];return d===I?0:d>I?1:-1});break;default:t=t.sort(n=>n.model.title.localeCompare(n.model.title))}switch(e.orderDirection){case W.ASCENDING:t.reverse();break}const s=e.margin||0;let i,a=s;const r=fe(0,0);return e.root?i=this.size.x:i=s,t.forEach(n=>{e.root?(n.layout.position=m(i-n.layout.size.x,a),n.layout.size.x>r.x&&(r.x=n.layout.size.x),a+n.layout.size.y<this.parentSize.y?a+=n.layout.size.y+s:(i-=r.x+s,a=s)):(n.layout.size.y>r.y&&(r.y=n.layout.size.y),n.layout.position=m(i,a),i+n.layout.size.x<this.parentSize.x||(i=s,a+=r.y+s,n.layout.position=m(i,a)),i+=n.layout.size.x+s)}),Promise.all(t.map(({id:n,layout:c})=>this.savePosition(n,c.position)))}clearSelectedItems(){[...this.selectedItems.value].forEach(e=>this.unselectItem(e))}isSelectedItem(e){return this.selectedItems.value.includes(e)}selectItem(e){return this.isSelectedItem(e)?!1:(this.selectedItems.value.push(e),!0)}unselectItem(e){return this.isSelectedItem(e)?(this.selectedItems.value=this.selectedItems.value.filter(t=>t!==e),!0):!1}async moveItem(e,t){console.warn("Method not implemented.",e,t)}async moveItemToItem(e,t){console.warn("Method not implemented.",t,e)}async savePosition(e,t){console.warn("Method not implemented.",e,t)}get(e){return this.items.value.find(t=>t.id===e)}has(e){return!!this.items.value.find(t=>t.id===e)}add(...e){const t=oe(e);return this.items.value.push(...t),t}remove(e){let t;return typeof e=="string"?t=this.get(e):t=e,t&&(this.unselectItem(t.id),this.items.value.splice(this.items.value.indexOf(t),1)),t}}class We extends Fe{constructor(){super(...arguments);l(this,"events",T(new C))}add(...t){const s=super.add(...t);return this.events.next(new le({name:"add",value:{wrapper:this,items:Array.from(s)}})),s}remove(t){const s=super.remove(t);return s&&this.events.next(new le({name:"remove",value:{wrapper:this,item:s||void 0}})),s}setup(...t){return Promise.resolve()}selectItem(t){return super.selectItem(t)?(this.events.next(new u({name:"selectItem",value:{wrapper:this,id:t}})),!0):!1}unselectItem(t){return super.unselectItem(t)?(this.events.next(new u({name:"unselectItem",value:{wrapper:this,id:t}})),!0):!1}}class L extends We{constructor(){super(...arguments);l(this,"fsItem");l(this,"usedMemory",0)}async setup(t){this.fsItem=t;const s=Array.from((await t.getItems()).values());await Promise.all(s.map(async i=>this.add(await L.fsItemToSymbol(i)))),t.events.subscribe(this.onEventItem.bind(this))}async moveItemToItem(t,s){var i,a;if(t.locked)throw new Error("Items are locked!");if(s.locked)throw new Error("Destination is locked!");t.meta.set(h.POSITION,m(0,0)),await((i=this.core.modules.files)==null?void 0:i.fs.saveItem(t)),await((a=this.core.modules.files)==null?void 0:a.fs.move(t,s,{override:!0}))}async moveItem(t,s){const i=this.get(t);if(i&&(i.fsItem instanceof R||i.fsItem instanceof k))try{if(i!=null&&i.fsItem&&(s!=null&&s.fsItem))await this.moveItemToItem(i.fsItem,s.fsItem);else throw new Error("Item or wrapper not found");return!0}catch(a){return console.warn(a),!1}return!1}async savePosition(t,s){var a;let i;if(typeof t=="string"&&this.get(t)?i=this.get(t):t instanceof j&&(i=t),i)if(i.fsItem)i.fsItem.meta.set(h.POSITION,s),(a=this.core.modules.files)==null||a.fs.saveItem(i.fsItem);else throw new Error(`Item has no fsItem. ${t}`);else throw new Error(`Item not found. ${t}`)}hasFsItem(t){return this.items.value.find(s=>{var i;return((i=s.fsItem)==null?void 0:i.id)===t.id})}async onEventItem({name:t,value:s}){var i;if(s!=null&&s.item){let a;if(t==="addItem")a=await L.fsItemToSymbol(s.item),this.hasFsItem(s.item)||this.add(a);else if(t==="removeItem"){const r=this.items.value.find(n=>n.fsItem===s.item);r?this.remove(r):console.warn("Item not found",s.item)}this.usedMemory=((i=this.fsItem)==null?void 0:i.getUsedMemory())||0}else console.warn("Item event without value",t,s)}static getItemsFromItem(t){return Promise.all(Array.from(t.items.values()).map(L.fsItemToSymbol))}static async fsItemToSymbol(t){const s=await t.getPath(),i=new j({fsItem:t,model:{title:t.name||"Untitled"}});return typeof t.action=="function"&&(i.command=`executeFile "${s}"`),t.meta.get(h.WEB_URL)&&(i.model.url=String(t.meta.get(h.WEB_URL))),i}}const Be=m(0,0);class F{constructor({sidebarComponent:e,sidebarComponentData:t,component:s,componentData:i,options:a,wrapper:r,layout:n,parentWindow:c}){l(this,"events",new C);l(this,"id",V());l(this,"component");l(this,"componentData");l(this,"sidebarComponent");l(this,"sidebarComponentData");l(this,"parentWindow");l(this,"options",A({title:"Unnamed",scaleX:!0,scaleY:!0,scrollX:!0,scrollY:!0,clampX:!0,clampY:!1,freeze:!1,focused:!1,center:!0,close:!0,overlay:!0,embed:!1,borderless:!1,hideRootHeader:!1,sidebar:!0,prompt:!1}));l(this,"group");l(this,"wrapper");l(this,"layout",A({focused:!1,position:m(0,0),size:Be,scrollOffset:m(0,0),zIndex:0}));this.parentWindow=c,e&&(this.sidebarComponent=T(e)),t&&(this.sidebarComponentData=T(t)),s&&(this.component=T(s)),this.componentData={window:this,...i||{}},r&&(this.wrapper=T(r)),this.options=Object.assign(this.options,a),this.layout=Object.assign(this.layout,n)}setLayout(e){e.position&&(this.layout.position=m(e.position.x,e.position.y)),e.size&&(this.layout.size=m(e.size.x,e.size.y)),e.scrollOffset&&(this.layout.scrollOffset=m(e.scrollOffset.x,e.scrollOffset.y)),e.focused&&(this.layout.focused=e.focused)}ready(){this.options.ready=!0,this.events.next(new u({name:"ready"}))}focus(){this.options.focused=!0,this.events.next(new u({name:"focus"}))}unfocus(){this.options.focused=!1,this.events.next(new u({name:"unfocus"}))}close(e){this.wrapper&&(this.events.next(new u({name:"close",value:e})),this.wrapper.remove(this.id),this.wrapper=void 0)}setWrapper(e){this.wrapper=T(e)}setGroup(e){this.group=e}awaitClose(){return new Promise(e=>{const t=this.events.pipe(ae(({name:s})=>s==="close")).subscribe(s=>{t.unsubscribe(),e(s)})})}awaitReady(){return new Promise(e=>{if(this.options.ready)e(this);else{const t=this.events.pipe(ae(({name:s})=>s==="ready")).subscribe(()=>{t.unsubscribe(),e(this)})}})}}const Ye=20;var Ke=(o=>(o[o.CENTER=0]="CENTER",o[o.ORDER_HORIZONTAL=1]="ORDER_HORIZONTAL",o[o.ORDER_VERTICAL=2]="ORDER_VERTICAL",o[o.ORDER_DIAGONAL_LEFT=3]="ORDER_DIAGONAL_LEFT",o[o.ORDER_DIAGONAL_RIGHT=4]="ORDER_DIAGONAL_RIGHT",o[o.SPLIT_HORIZONTAL=5]="SPLIT_HORIZONTAL",o[o.SPLIT_VERTICAL=6]="SPLIT_VERTICAL",o[o.FULL=7]="FULL",o))(Ke||{});class et{constructor(e,t=[]){l(this,"events",T(new C));l(this,"id",V());l(this,"core");l(this,"layout",{size:m(0,0),position:m(0,0)});l(this,"groups",new Map);l(this,"modelMap",new Map);l(this,"models",[]);l(this,"_activeWindow");this.core=e,t.forEach(s=>this.add(s))}setLayout(e){e.position&&(this.layout.position=m(e.position.x,e.position.y)),e.size&&(this.layout.size=m(e.size.x,e.size.y))}getActiveWindow(){return this.models.find(e=>e.options.focused)}setActiveWindow(e){this.models.forEach(t=>{t.options.focused=e===t.id,e===t.id&&(this._activeWindow=t,this.events.next(new u({name:"setActiveWindow",value:t})))})}hasEmbbedWindow(){return!!this.models.find(e=>e.options.embed)}isHeaderVsible(){return!this.models.find(e=>e.options.embed&&e.options.hideRootHeader)}add(e,t){const{full:s,maximize:i,active:a,group:r}={full:!1,maximize:!1,active:!0,group:null,...t||{}};let n;if(e instanceof F?n=e:n=new F(e),n.setWrapper(this),i?n.layout.size=m(this.layout.size.x,this.layout.size.y):s&&(n.layout.size=m(()=>m(this.layout.size.x,this.layout.size.y)+m(0,Ye))),r){let c;this.groups.has(r)?(c=this.groups.get(r),c.windows.push(n)):(c={primary:n,windows:[],name:r},this.groups.set(r,c)),n.setGroup(c)}return n.layout.zIndex=this.models.length,this.models.push(n),this.events.next(new u({name:"add",value:n})),this.modelMap.set(n.id,n),a&&this.setActiveWindow(n.id),n}remove(e){let t;e instanceof F?t=e:t=this.get(e),t!==void 0&&(t.group&&(t.group.primary===e?(t.group.windows.forEach(s=>s.close()),this.groups.delete(t.group.name)):t.group.primary.focus()),this.models.splice(this.models.indexOf(t),1),this.modelMap.delete(t.id))}get(e){return this.modelMap.get(e)}clear(){this.models=[].splice(0,this.models.length),this.modelMap.clear()}setWindowUpDown(e,t){const s=this.models,i=Array.from(s).filter(r=>!r.options.embed).sort((r,n)=>(r.layout.zIndex||0)-(n.layout.zIndex||0)).map(pe),a=this.get(e);if(a){const r=i.findIndex(({id:c})=>c===a.id),n=i[t?r-1:r+1];if(n){const c=a.layout.zIndex;a.layout.zIndex=n.layout.zIndex,n.layout.zIndex=c}}}centerWindow(e){let t;e instanceof F?t=e:t=this.get(e),t&&te(t,this.layout)}setWindowPositions(e,t=[],s){const{embed:i}={embed:!1,...s};switch(t.length<1&&t.push(...this.models),i||(t=t.filter(a=>!a.options.embed)),e){case 7:t.forEach(a=>{$e(a,this.layout)});break;case 0:t.forEach(a=>{te(a,this.layout)});break;case 3:case 4:He(t,this.layout,e===4);break;case 5:case 6:Ue(t,this.layout,e===6);break}}saveSize(e,t){var i,a,r,n;const s=this.get(e);if(s&&(i=s.componentData)!=null&&i.symbolWrapper&&((a=s.componentData)==null?void 0:a.symbolWrapper)instanceof L){const c=(r=s.componentData)==null?void 0:r.symbolWrapper.fsItem;c&&(c.meta.set(h.WINDOW_SIZE,t),(n=this.core.modules.files)==null||n.fs.saveItem(c))}}savePosition(e,t){var i,a,r,n;const s=this.get(e);if(s&&(i=s.componentData)!=null&&i.symbolWrapper&&((a=s.componentData)==null?void 0:a.symbolWrapper)instanceof L){const c=(r=s.componentData)==null?void 0:r.symbolWrapper.fsItem;c&&(c.meta.set(h.WINDOW_POSITION,t),(n=this.core.modules.files)==null||n.fs.saveItem(c))}}}function $e(o,e){o.layout.size=e.size}function te(o,e){o.layout.position=m(()=>(m(e.size.x,e.size.y)-m(o.layout.size.x,o.layout.size.y))/2)}function He(o,e,t){const s=1/o.length;o.forEach((i,a)=>{te(i,e),a=-Math.floor(o.length/2)+a;const r=m(i.layout.position.x+(t?-1:1)*(s*i.layout.size.x)*a,i.layout.position.y+s*i.layout.size.y*a),n=m(()=>m(e.size.x,e.size.y)-m(i.layout.size.x,i.layout.size.y));i.layout.position=m(()=>Math.max(Math.min(r,n),0))})}function Ue(o,e,t){let s;const i=o.length;t?(s=m(e.size.x,e.size.y/i),o.forEach((a,r)=>{a.layout.position=m(0,r*s.y),a.layout.size=s})):(s=m(e.size.x/i,e.size.y),o.forEach((a,r)=>{a.layout.position=m(r*s.x,0),a.layout.size=s}))}export{B as C,k as D,u as E,L as F,Ye as H,Fe as I,z as O,me as R,j as S,b as T,et as W,F as a,Ke as b,P as c,p as d,ne as e,W as f,v as g};
