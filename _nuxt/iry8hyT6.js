import{N as C,u as N}from"./DBOeMG7K.js";import{M as R,a as g}from"./CrKlwrAd.js";import{T as w,f as p}from"./DFzo1POf.js";import{S as x,b as u,e as h,u as T}from"./W3AasC-d.js";import D from"./D_DXwfvO.js";import{N as A}from"./JLkLOWM3.js";import{T as B}from"./BpiWq8DJ.js";import{_,i as c,t as d,v,z as l,A as f,E as L,N as b,ae as k}from"./0uggAJqN.js";import"./DRZdo0t4.js";import"./C5mdboMC.js";import"./CrI6ZSJ7.js";import"./CR28Sdxl.js";import"./fUUIntxy.js";import"./zix_Qzl-.js";const M={components:{TimelineCanvas:B,Navigation:C,Metronom:R},props:{track:{type:w,required:!0}},async setup(){return{...await N()}},data(){return{duration:0,model:{input:"note",inputType:""},metronom:new g,subscriptions:new x,midiController:new D,openNotes:new Map}},computed:{navigation(){return{model:this.model,items:[[],[{text:"Input:"},{label:"Note",value:"note",name:"input"},{label:"Pause",value:"pause",name:"input",disabled:!0}],[{text:"Note:&nbsp;"},{label:"Auto",value:"",name:"inputType"},...p().map(([t])=>({label:`1/${t.replace(/(\d+)[nm]/,"$1")} n`,name:"inputType",value:t})),{spacer:!0},{label:"Remove Note",action:()=>{this.track.removeNote(this.track.selectedIndex)}},{label:"Clean Range",action:()=>{this.track.removeNotesByDurationRange(this.metronom.getDuration(),this.metronom.timeDuration)}},{label:"Clean Beat",action:()=>{this.track.removeNotesFromBeat(this.track.getBeatIndex())}},{label:"Reset",action:()=>{this.reset()}}]]}}},async mounted(){await this.midiController.start(),console.log("domEvents",u);const t=this.midiController.listen();this.subscriptions.add(u.keydown.subscribe(o=>{switch(o.code){case"ArrowLeft":this.metronom.prev();break;case"ArrowRight":this.metronom.next();break;case"ArrowUp":this.metronom.prevBeat();break;case"ArrowDown":this.metronom.nextBeat();break;default:if(/Digit(\d+)/.test(o.code)){const i=o.code.replace(/Digit(\d+)/,"$1"),r=p()[i-1];r&&(this.metronom.time=r[0])}break}console.log(o)}),t.pipe(h(({type:o})=>o==="noteOn")).subscribe(this.onNoteOn.bind(this)),t.pipe(h(({type:o})=>o==="noteOff")).subscribe(this.onNoteOff.bind(this)))},unmounted(){this.subscriptions.unsubscribe(),this.midiController.destroy()},methods:{onReady({render:t}){this._render=t},onRender(t,{position:o,dimension:i}){const r=Array.from(this.openNotes.values());for(let n=0;n<r.length;n++){const e=r[Number(n)];console.log("test",e);const a=(this.metronom.now()-e)/1e3/(this.metronom.speed*2)*i.x;console.log(a),t.fillRect(o.x,o.y,a,i.y)}},onNoteOn({value:t}){console.log("value.identifier",t.identifier,this.metronom.getDuration()),this.animationLoop||(this.animationLoop=$(()=>{this._render&&this._render()})),this.openNotes.set(t.identifier,this.metronom.now())},onNoteOff({value:t}){const o=[1,2,4,8,16,32].map(e=>[`${e}n`,`${e}t`,`${e}n.`]).flat().map(e=>[e,new(this.tone.getTone()).Time(e).toSeconds()]).sort((e,s)=>s[1]-e[1]),i=Math.max((this.metronom.now()-this.openNotes.get(t.identifier))/1e3,o[o.length-1][1]);this.openNotes.delete(t.identifier);const r=new window.Tone.Time(o.map(([,e])=>e).find(e=>{const s=e*.2;return e-s<=i&&i<=e+s}));console.log("time",r.toNotation());const n=this.metronom.getDuration();console.log({delay:n,name:t.identifier,time:r.toNotation()}),this.track.addNote(new A({delay:n,name:t.identifier,time:r.toNotation()})),console.log("notes",this.track.notes),this.openNotes.size<1&&(this.animationLoop.stop(),this.animationLoop=null)},reset(){this.track.reset()},onClickNote(t){console.log("onClickNote",t)}}};function $(t){let o=0,i=0,r=!1;const n=e=>{const s=e-o;o=e,i+=s,t(e,i),r||requestAnimationFrame(n)};return requestAnimationFrame(n),{stop:()=>r=!0}}function O(t,o,i,r,n,e){const s=c("timeline-canvas"),a=c("navigation"),y=c("metronom");return d(),v("div",null,[l(y,{model:n.metronom,onRender:e.onRender,onReady:e.onReady,onValue:o[0]||(o[0]=m=>i.track.currentDuration=m)},{background:f(({onRefresh:m})=>[(d(),L(s,{key:n.metronom.value,track:i.track,duration:n.metronom.getDuration(),clickable:"",onRefresh:m,"onNote:click":e.onClickNote},null,8,["track","duration","onRefresh","onNote:click"]))]),navigation:f(({navigation:m})=>[l(a,b(k(m)),null,16),l(a,b(k(e.navigation)),null,16)]),_:1},8,["model","onRender","onReady"])])}const E=_(M,[["render",O]]),q={components:{Editor:E},async setup(){return{...T(),...await N()}},data(){const t=new g;return{track:new w({beatCount:1,speed:t.speed,notes:[{name:"C4",time:"2n",delay:4}]})}}};function z(t,o,i,r,n,e){const s=c("editor");return d(),v("div",null,[l(s,{track:n.track},null,8,["track"])])}const Y=_(q,[["render",z]]);export{Y as default};
