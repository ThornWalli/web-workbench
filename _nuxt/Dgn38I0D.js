import{E as Y,F as E,al as H,a2 as Z,g as R,w as $,u as F,S as A,p as z,o as d,b as S,e as k,C as M}from"./W3AasC-d.js";import{W}from"./BB2tHDi2.js";import{_ as w,i as _,t as u,v as m,x as h,z as y,$ as P,a0 as I,Y as f,Z as v,y as O,I as b,a4 as x,S as j,a7 as N,K as q,O as T,N as D,ae as L,A as G,C as X,D as J,B as K}from"./0uggAJqN.js";import{M as Q,a as ee}from"./CrKlwrAd.js";import te from"./D_DXwfvO.js";import{N as oe,u as ie}from"./DBOeMG7K.js";import{N as ne}from"./JLkLOWM3.js";import{r as se,f as g,h as ae}from"./DFzo1POf.js";import{g as re,b as le,C as l,t as B}from"./DRZdo0t4.js";import{T as ce,c as de}from"./BbCX8cCE.js";import{T as ue}from"./BpiWq8DJ.js";import"./C5mdboMC.js";import"./CrI6ZSJ7.js";import"./CR28Sdxl.js";import"./fUUIntxy.js";import"./zix_Qzl-.js";function U(e){return Y(function(i,s){var o=!1,n=null,t=null,r=function(){if(t==null||t.unsubscribe(),t=null,o){o=!1;var a=n;n=null,s.next(a)}};i.subscribe(E(s,function(a){t==null||t.unsubscribe(),o=!0,n=a,t=E(s,r,H),Z(e(a)).subscribe(t)},function(){r(),s.complete()},void 0,function(){n=t=null}))})}const me={components:{WbEnvMoleculeContextMenu:W},props:{parentLayout:{type:Object,default(){return{size:R(window.innerWidth,window.innerHeight)}}},title:{type:String,default:"Web-Workbench release. Version 1.3"},items:{type:Array,default(){return $.modules.windows.contextMenu.activeItems.items}}},emits:["inputContextMenu"],data(){return{cover:!1}},methods:{onUpdateModelValueContextMenu(...e){this.$emit("inputContextMenu",...e)}}},he={class:"wb-env-molecule-footer"},pe={ref:"menu",class:"menu"};function ye(e,i,s,o,n,t){const r=_("wb-env-molecule-context-menu");return u(),m("footer",he,[h("nav",pe,[y(r,{direction:"top",items:s.items,"parent-layout":s.parentLayout,"onUpdate:modelValue":t.onUpdateModelValueContextMenu},null,8,["items","parent-layout","onUpdate:modelValue"])],512)])}const _e=w(me,[["render",ye],["__scopeId","data-v-f49caf4e"]]),be=9,Ce={props:{disabled:{type:Boolean,default:!1},selectedNotes:{type:Array,default:null},size:{type:String,validator:e=>["small","medium","large"].includes(e),default:"large"},showNoteLabels:{type:Boolean,default:!1},startOctave:{type:Number,default:4},octaveCount:{type:Number,default:6}},emits:["down","up"],data:function(){return{pressedKeys:[],dimension:R()}},computed:{noteNames(){return Array.from(new Set(this.selectedNotes.map(e=>se(e.getName())).flat()))},height(){return{small:96,medium:96*1.5,large:96*2}[this.size]},octaveRange(){const e=[],i=["c","c#","d","d#","e","f","f#","g","g#","a","a#","b"];for(let s=0;s<this.octaveCount;s++)e.push(...i.map(o=>{const n=`${o}${this.startOctave+s}`;return{note:n,black:this.isBlackKey(n)}}));return this.startOctave+this.octaveCount<=be&&e.push({note:i[0]+(this.startOctave+this.octaveCount),black:!1}),e},styleClasses(){return{disabled:this.disabled}},style(){return{...this.dimension.toCSSVars("dimension"),"--height":this.height,"--keys":this.octaveRange.filter(({black:e})=>!e).length,"--white-keys":this.octaveRange.filter(({black:e})=>!e).length,"--black-keys":this.octaveRange.filter(({black:e})=>e).length}}},mounted(){this.dimension=R(this.$el.offsetWidth,0)},methods:{isBlackKey(e){return/^[a-z]#\d+/.test(e)},onPointerDown(e){this.disabled||(this.pressedKeys.push(e),this.$emit("down",e))},onPointerUp(e){!this.disabled&&this.pressedKeys.includes(e)&&(this.$emit("up",e),this.pressedKeys=this.pressedKeys.filter(i=>i!==e))}}},ke=["disabled"],fe={class:"keys white"},ve=["onMouseout","onPointerdown","onPointerup"],Ne={key:0},Te={key:0},ge={class:"keys black"},Re=["onMouseout","onPointerdown","onPointerup"],we={key:0},Ee={key:0};function Ae(e,i,s,o,n,t){return u(),m("div",{style:v(t.style),class:f([t.styleClasses,"wb-disks-synthesizer-keyboard"]),disabled:s.disabled},[h("div",null,[h("div",fe,[(u(!0),m(P,null,I(t.octaveRange,({note:r,black:a},c)=>(u(),m("div",{key:c,class:f(["key",{black:a,white:!a,selected:t.noteNames.includes(r.toLowerCase())}]),style:v({"--index":c}),onMouseout:p=>t.onPointerUp(r),onPointerdown:p=>t.onPointerDown(r),onPointerup:p=>t.onPointerUp(r)},[a?b("",!0):(u(),m("span",Ne,[s.showNoteLabels?(u(),m("i",Te,O(r),1)):b("",!0)]))],46,ve))),128))]),h("div",ge,[(u(!0),m(P,null,I(t.octaveRange,({note:r,black:a},c)=>(u(),m("div",{key:c,class:f(["key",{black:a,white:!a,selected:t.noteNames.includes(r.toLowerCase())}]),style:v({"--index":c}),onMouseout:p=>t.onPointerUp(r),onPointerdown:p=>t.onPointerDown(r),onPointerup:p=>t.onPointerUp(r)},[a?(u(),m("span",we,[s.showNoteLabels?(u(),m("i",Ee,O(r),1)):b("",!0)])):b("",!0)],46,Re))),128))])])],14,ke)}const Se=w(Ce,[["render",Ae],["__scopeId","data-v-b065455c"]]),Me={components:{TimelineCanvas:ue,Navigation:oe,Metronom:Q,Keyboard:Se,WbEnvMoleculeFooter:_e},props:{model:{type:Object,default:re()},trackModel:{type:Object,default:le()},toneDestination:{type:Object,default:null}},emits:["refresh"],async setup(e){const i=x(e,"model"),s=x(e,"trackModel"),o=F();j(i,()=>{o.setContextMenu(de,{model:i.value,trackModel:s.value,preserveContextMenu:o.preserveContextMenu})},{immediate:!0,deep:!0});const n=N(s.value[l.SYNTHESIZER_TRACK]);console.log("track",n);const t=N(new ee(n)),r=N(new ce(n));console.log("trackPlayer",r);const a=await ie(),c=new te;await c.start();const p=c.hasInputs;return{...o,...a,metronom:t,track:n,trackPlayer:r,midiController:c,hasMidi:p}},data(){return{windowsModule:q(this.core.modules.windows),duration:0,subscriptions:new A,midiControllerListener:null,openNotes:new Map,footerModel:{}}},computed:{styleClasses(){return{[`keyboard-align-${this.trackModel[l.SYNTHESIZER_TRACK_KEYBOARD_ALIGN]}`]:!0}},showKeyboard(){return this.trackModel[l.SYNTHESIZER_TRACK_SHOW_KEYBOARD]},inputNote(){return this.trackModel[l.SYNTHESIZER_TRACK_INPUT_NOTE]},bpm(){return Number(this.model[l.SYNTHESIZER_BPM])},trackPlayerIndex(){return Object.values(this.trackPlayer.sequenceNoteIndex).flat()},selectedNotes(){return this.track.notes.filter(e=>Object.values(this.trackPlayer.sequenceNoteIndex).flat().includes(e.index))},timelineCanvasData(){return{track:this.track,duration:this.metronom.getDuration()}},keybordData(){return{size:this.trackModel[l.SYNTHESIZER_TRACK_KEYBOARD_SIZE],showNoteLabels:this.trackModel[l.SYNTHESIZER_TRACK_SHOW_NOTE_LABELS],startOctave:this.trackModel[l.SYNTHESIZER_TRACK_START_OCTAVE],octaveCount:this.trackModel[l.SYNTHESIZER_TRACK_OCTAVE_COUNT],selectedNotes:this.selectedNotes}},metronomNavigation(){return{model:this.metronom,items:[[{icon:"skipPrev",label:"Prev Beat",hideLabel:!0,disabled:this.metronom.value===0,action:()=>{this.metronom.reset()}},{icon:"doublePrev",label:"Prev Beat",hideLabel:!0,disabled:Math.floor(this.metronom.currentBeat/2)===0,action:()=>{this.metronom.prevBeat()}},{icon:"prev",label:"Prev",hideLabel:!0,disabled:this.metronom.value===0,action:()=>{this.metronom.prev()}},{icon:"reset",iconAlign:"right",label:"Next",disabled:this.metronom.value/2-Math.floor(this.metronom.currentBeat)===0,hideLabel:!0,action:()=>{this.metronom.setBeat(this.metronom.currentBeat)}},{icon:"next",iconAlign:"right",label:"Next",hideLabel:!0,action:()=>{this.metronom.next()}},{icon:"doubleNext",label:"Next Beat",hideLabel:!0,action:()=>{this.metronom.nextBeat()}},{spacer:!0},{text:`Duration: ${this.metronom.value.toFixed(2)}`},{text:`Beat: ${this.metronom.currentBeat}-${this.metronom.currentBeat+this.metronom.beatCount}`}],[...g().map(([e])=>({label:`1/${e.replace(/(\d+)[nm]/,"$1")} n`,name:"time",value:e})),{spacer:!0}]]}},navigation(){return{model:this.trackModel,items:[[{text:"Input:"},{label:"Note",value:"note",name:l.SYNTHESIZER_TRACK_INPUT},{label:"Pause",value:"pause",name:l.SYNTHESIZER_TRACK_INPUT,disabled:!0},{spacer:!0},{label:"Remove Note",action:()=>{this.track.removeNote(this.track.selectedIndex)}},{label:"Clean Range",action:()=>{this.track.removeNotesByDurationRange(this.metronom.getDuration(),this.metronom.timeDuration)}},{label:"Clean Beat",action:()=>{this.track.removeNotesFromBeat(this.track.getBeatIndex())}},{label:"Reset",action:()=>{this.reset()}}],[{text:"Note:&nbsp;"},{label:"Auto",value:"",name:l.SYNTHESIZER_TRACK_INPUT_NOTE},...g().map(([e])=>({label:`1/${e.replace(/(\d+)[nm]/,"$1")} n`,name:l.SYNTHESIZER_TRACK_INPUT_NOTE,value:e})),{spacer:!0},this.trackPlayer.playing?{selected:!0,label:"Pause",icon:"pause",disabled:!this.trackPlayer.currentSequence||!this.trackPlayer.playing,onClick:()=>this.onClickPlause()}:{label:"Play",icon:"play",disabled:this.trackPlayer.playing||this.track.notes.length===0,onClick:()=>this.onClickPlay()},{label:"Stop",icon:"stop",disabled:!this.trackPlayer.currentSequence,onClick:()=>this.onClickStop()},{label:"Restart",disabled:this.track.selectedIndex>-1,onClick:()=>this.onClickRestart()}]]}},footer(){const e=this.track,i=this.trackModel,s=e.getDuration().toFixed(2);return{items:z([{options:{disabled:!this.hasMidi},title:`MIDI (${this.midiController.input?this.midiController.input.name:"OFF"})`,action:async()=>{this.midiControllerListener||await this.registerMidiListener()},items:this.midiController.ready&&this.midiControllerListener?[{title:"Inputs",items:this.midiController.inputs.map((o,n)=>({title:o.name,model:this.midiController,name:"activeInput",type:d.RADIO,value:o.id,action:async()=>{await this.registerMidiListener(this.midiController.listen(n))}}))},{title:"Input Channel",items:Array(16).fill(null).map((o,n)=>({title:String(n+1),value:n+1,type:d.RADIO,model:this.midiController,name:"inputChannel",action:async()=>{await this.registerMidiListener(this.midiController.listen(this.midiController.input))}}))},{title:"Outputs",items:this.midiController.outputs.map(o=>({title:o.name,model:this.midiController,name:"activeOutput",type:d.RADIO,value:o.id,action(){}}))},{type:d.SEPARATOR},{title:"Disconnect",action:()=>{var o;(o=this.midiControllerListener)==null||o.unsubscribe(),this.midiControllerListener=null,this.midiController.unlisten()}}]:[]},{type:d.SEPARATOR},{type:d.DEFAULT,title:`Instr.: ${this.track.type}`,items:Object.entries(ae()).map(([o,n])=>({type:d.RADIO,title:n,model:e,name:"type",value:o}))},{type:d.SEPARATOR},{title:`Octave: ${i[l.SYNTHESIZER_TRACK_START_OCTAVE]}-${i[l.SYNTHESIZER_TRACK_START_OCTAVE]+i[l.SYNTHESIZER_TRACK_OCTAVE_COUNT]-1}`,items:[{type:d.DEFAULT,title:"Start Octave",items:Array(9).fill({}).map((o,n)=>({type:d.RADIO,title:String(n+1),model:i,name:l.SYNTHESIZER_TRACK_START_OCTAVE,value:n+1,action(t){t=Number(t),t+i[l.SYNTHESIZER_TRACK_OCTAVE_COUNT]>9&&(i[l.SYNTHESIZER_TRACK_OCTAVE_COUNT]=10-t)}}))},{type:d.DEFAULT,title:"Octave Count",items:Array(10-i[l.SYNTHESIZER_TRACK_START_OCTAVE]).fill({}).map((o,n)=>({type:d.RADIO,title:String(n+1),model:i,name:l.SYNTHESIZER_TRACK_OCTAVE_COUNT,value:n+1}))}]},{type:d.SPACER},{type:d.TEXT,text:`BPM: ${this.bpm}`},{type:d.TEXT,text:`Dur.: ${s}`}])}}},watch:{"track.beatCount"(e){this.metronom.beatCount=e}},mounted(){console.log("TRACK",this.track),this.subscriptions.add(S.keydown.pipe(U(()=>B(100)),k(e=>e.key==="Enter")).subscribe(()=>{this.onClickActivateMidi()})),this.subscriptions.add(S.keydown.pipe(U(()=>B(100))).subscribe(e=>{switch(e.code){case"ArrowLeft":this.metronom.prev();break;case"ArrowRight":this.metronom.next();break;case"ArrowUp":this.metronom.prevBeat();break;case"ArrowDown":this.metronom.nextBeat();break;default:if(/Digit(\d+)/.test(e.code)){const i=e.code.replace(/Digit(\d+)/,"$1"),s=g()[i-1];s&&(this.metronom.time=s[0])}break}console.log(e)})),this.$nextTick(()=>{this.$emit("refresh")})},unmounted(){this.subscriptions.unsubscribe(),this.midiController.destroy()},methods:{async registerMidiListener(e){var i;try{await this.midiController.start();const s=this.midiController.listen(e>-1&&this.midiController.inputs[e]||this.midiController.inputs[0]);(i=this.midiControllerListener)==null||i.unsubscribe(),this.midiControllerListener=new A,this.midiControllerListener.add(s.pipe(k(({type:o})=>o==="noteOn")).subscribe(this.onNoteOn.bind(this)),s.pipe(k(({type:o})=>o==="noteOff")).subscribe(this.onNoteOff.bind(this)),s.pipe(k(({type:o})=>o==="volume")).subscribe(({value:o})=>{console.log("Volume: ",o),this.core.config.set(M.SCREEN_CONFIG,{...this.core.config.get(M.SCREEN_CONFIG),soundVolume:o})}))}catch(s){console.warn(s)}},async setup(){this.tone.ready||(await this.tone.start(),this.trackPlayer.createInstrument())},onReady({render:e}){this._render=e},onRender(e,{position:i,dimension:s}){if(this.inputNote==="auto"){const o=Array.from(this.openNotes.values());for(let n=0;n<o.length;n++){const t=o[Number(n)],a=(this.metronom.now()-t)/1e3/(this.metronom.speed*2)*s.x/this.track.beatCount;e.fillRect(i.x,i.y,a,s.y)}}},async onNoteOn({value:e}){await this.setup();const i=e.identifier;console.log("value.identifier",i,this.metronom.getDuration()),this.startNote(i),this.trackPlayer.triggerAttack(i)},async onNoteOff({value:e}){this.endNote(e.identifier),await this.tone.ready,this.trackPlayer.triggerRelease()},startNote(e){this.animationLoop||(this.animationLoop=Pe(()=>{this._render&&this._render()})),this.openNotes.set(e,this.metronom.now())},endNote(e){var r;const i=[1,2,4,8,16,32].map(a=>[`${a}n`,`${a}t`,`${a}n.`]).flat().map(a=>[a,new(this.tone.getTone()).Time(a).toSeconds()]).sort((a,c)=>c[1]-a[1]),s=Math.max((this.metronom.now()-this.openNotes.get(e))/1e3,i[i.length-1][1]);this.openNotes.delete(e);const{Time:o}=this.tone.getTone();let n;this.inputNote?n=new o(this.inputNote):n=new o(i.map(([,a])=>a).find(a=>{const c=a*.2;return a-c<=s&&s<=a+c}));const t=this.metronom.getDuration();console.log({delay:t,name:e,time:n.toNotation()}),this.track.addNote(new ne({delay:t,name:e,time:n.toNotation()})),this.openNotes.size<1&&((r=this.animationLoop)==null||r.stop(),this.animationLoop=null)},async onClickNote({note:e,selected:i}){await this.setup(),i&&e.getName()&&this.trackPlayer.triggerAttackRelease(e)},async onClickPlay(){await this.setup(),this.trackPlayer.play()},onClickPlause(){this.trackPlayer.pause()},onClickStop(){this.trackPlayer.stop()},onClickRestart(){this.trackPlayer.restart()},async onDownKeyboard(e){await this.setup(),this.startNote(e),this.trackPlayer.triggerAttack(e)},async onUpKeyboard(e){await this.tone.awaitReady,this.endNote(e),this.trackPlayer.triggerRelease()},reset(){this.track.reset()},onClickActivateMidi(){this.registerMidiListener()}}};function Pe(e){let i=0,s=0,o=!1;const n=t=>{const r=t-i;i=t,s+=r,e(t,s),o||requestAnimationFrame(n)};return requestAnimationFrame(n),{stop:()=>o=!0}}const Ie=e=>(X("data-v-00f4c863"),e=e(),J(),e),Oe={key:0,class:"keyboard"},xe=Ie(()=>h("div",null,[h("div",null,[h("span",null,[K("Click here, or press "),h("strong",null,"Enter"),K(" to activate the Midi Keyboard!")])])],-1)),De=[xe],Le={class:"sheet"},Ke={class:"panel"};function Be(e,i,s,o,n,t){const r=_("keyboard"),a=_("navigation"),c=_("timeline-canvas"),p=_("metronom"),V=_("wb-env-molecule-footer");return u(),m("div",{class:f(["wb-disks-extras13-synthesizer-track",t.styleClasses])},[h("div",null,[h("div",null,[t.showKeyboard?(u(),m("div",Oe,[y(r,T({disabled:o.trackPlayer.playing},t.keybordData,{onDown:t.onDownKeyboard,onUp:t.onUpKeyboard}),null,16,["disabled","onDown","onUp"]),o.hasMidi&&!n.midiControllerListener?(u(),m("div",{key:0,class:"midi-message",onClick:i[0]||(i[0]=(...C)=>t.onClickActivateMidi&&t.onClickActivateMidi(...C))},De)):b("",!0)])):b("",!0)]),y(a,D(L(t.navigation)),null,16),h("div",Le,[y(p,{model:o.metronom,onRender:t.onRender,onReady:t.onReady,onValue:i[1]||(i[1]=C=>o.track.currentDuration=C)},{background:G(({onRefresh:C})=>[y(c,T(t.timelineCanvasData,{clickable:"",onRefresh:C,"onNote:click":t.onClickNote}),null,16,["onRefresh","onNote:click"])]),_:1},8,["model","onRender","onReady"])]),h("div",Ke,[y(a,D(L(t.metronomNavigation)),null,16)])]),y(V,T(t.footer,{"parent-layout":n.windowsModule.contentWrapper.layout}),null,16,["parent-layout"])],2)}const tt=w(Me,[["render",Be],["__scopeId","data-v-00f4c863"]]);export{tt as default};
