var H=Object.defineProperty;var V=(u,t,e)=>t in u?H(u,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):u[t]=e;var g=(u,t,e)=>V(u,typeof t!="symbol"?t+"":t,e);import{g as m,h as O}from"./C0_snZds.js";import{B as v,p as W,e as $,T as q}from"./Dq9By7M7.js";import{f as j,p as Q,g as U}from"./C1Z8QYso.js";import{S as D,N as X}from"./CDk6Z4eJ.js";import{G as z}from"./euEAQSzi.js";import{_ as Y,r as N,Q as Z,i as J,o as K,t as k,v as A,x as L,$ as tt,a0 as et,Y as it,Z as nt,y as st,D as ot,a5 as rt}from"./WqrcCs0p.js";const at=4;class lt{constructor(t,e){g(this,"beatCount",1);g(this,"gutter",27);g(this,"count",1);g(this,"height",36);g(this,"outerMargin",[10,0,10,0]);g(this,"innerMargin",[0,48,0,48]);g(this,"innerPadding",[20,0,10,0]);g(this,"color","#ffaa55");this.setOptions(e),this.canvas=t,this.ctx=t.getContext("2d")}setOptions(t){const{gutter:e,height:i,margin:n,color:o,outerMargin:r,innerMargin:f,innerPadding:d}=t||{};this.gutter=e||this.gutter,this.height=i||this.height,this.margin=n||this.margin,this.color=o||this.color,this.outerMargin=r||this.outerMargin,this.innerMargin=f||this.innerMargin,this.innerPadding=d||this.innerPadding}render({beatCount:t,count:e}){this.count=e,this.beatCount=t;const i=this.ctx;i.clearRect(0,0,i.canvas.width,i.canvas.height);for(let n=0;n<this.count;n++)this.renderGridRow(this.getGridBoundingBox(n),this.getInnerGridBoundingBox(n))}getInnerGridRowBoundingBox(t){const{position:e,dimension:i}=this.getInnerGridBoundingBox(t);return{position:e,dimension:m(i.x,i.y*this.beatGrid.y+1)}}get firstRowIndex(){return 0}get lastRowIndex(){return this.count-1}get innerBoundingBox(){return{position:m(this.outerMargin[0],this.outerMargin[1]),dimension:m(this.ctx.canvas.width-(this.outerMargin[0]+this.outerMargin[2]),this.ctx.canvas.height-(this.outerMargin[1]+this.outerMargin[3]))}}get beatGrid(){return m(this.beatCount,at)}get dimension(){return m(this.canvas.width,this.canvas.height)}get mergedMargin(){return[this.outerMargin[0]+this.innerMargin[0],this.outerMargin[1]+this.innerMargin[1],this.outerMargin[2]+this.innerMargin[2],this.outerMargin[3]+this.innerMargin[3]]}getGridBoundingBox(t){const e=this.mergedMargin,i=e[0]+0,n=e[1]+t*this.height+t*this.gutter,o=-(e[0]+e[2])+this.dimension.x,r=this.height/this.beatGrid.y;return{position:m(i,n),dimension:m(o,r)}}getInnerGridBoundingBox(t){const{position:e,dimension:i}=this.getGridBoundingBox(t);return{position:m(e.x+this.innerPadding[0],e.y+this.innerPadding[1]),dimension:m(i.x-this.innerPadding[0]-this.innerPadding[2],(this.height-this.innerPadding[1]-this.innerPadding[3])/this.beatGrid.y)}}renderGridRow(t,e){const i=this.ctx;i.fillStyle=i.strokeStyle=this.color;let n=new Path2D;dt(n,this.beatGrid,t),i.fill(n),n=new Path2D,ct(n,this.beatGrid,e,{first:!0,last:!0}),i.fill(n),i.fillRect(t.position.x+t.dimension.x-5,t.position.y,5,t.dimension.y*this.beatGrid.y)}}function ct(u,t,{position:e,dimension:i},n={}){const{first:o,last:r}={first:!1,last:!1,...n};for(let f=o?0:1;f<t.x+r||!1;f++)u.rect(e.x+0+f*Math.floor(i.x/t.x),e.y,1,i.y*t.y)}function dt(u,t,{position:e,dimension:i}){for(let n=0;n<=t.y;n++)u.rect(e.x,n*i.y+e.y,i.x,1)}class ht{constructor(t,e={}){g(this,"padding",10);g(this,"flipActive",!1);g(this,"colors",{background:"#0055aa",foreground:"#ffffff",highlight:"#ffaa55"});g(this,"baseNote",4);g(this,"noteCount",4);const{colors:i,gridRenderer:n,noteRenderer:o}={gridRenderer:null,noteRenderer:null,...e};this.colors={...this.colors,...i},this.gridRenderer=n,this.noteRenderer=o,this.canvas=t,this.ctx=t.getContext("2d")}async render({baseNote:t,noteCount:e,beats:i,flipActive:n}){this.flipActive=n||!1,this.baseNote=t,this.noteCount=e,this.beats=i;const o=this.gridRenderer.beatCount,{position:r,dimension:f}=this.gridRenderer.getInnerGridRowBoundingBox(this.gridRenderer.lastRowIndex),d=[];for(let x=0;x<this.beats.length;x++){const p=this.beats[Number(x)],y=f.x/o-this.padding*2,w=r.x+this.padding+x*y+x*this.padding*2;d.push(await this.renderBeat(p,w,y))}return d.flat()}async renderBeat(t,e,i){const n=this.baseNote,o=this.noteCount,r=[],{position:f,dimension:d}=this.gridRenderer.getInnerGridRowBoundingBox(this.gridRenderer.lastRowIndex),x=Object.entries(t.noteGroups);for(let p=0;p<x.length;p++){const[,y]=x[Number(p)];for(let w=0;w<y.length;w++){const{notes:b,align:T}=y[Number(w)];let h;for(let R=0;R<b.length;R++){const c=R===0,M=R===b.length-1,_=b[Number(R)].bindingCount&&(c||h),P=this.flipActive&&b[Number(R)].bindingCount>0&&w%2===1&&b[Number(R)].name,C=await this.resolveNote(b,R,{baseNote:n,noteCount:o,align:T,flip:P,binding:_}),{position:E,note:I,canvas:G}=C;let a=C.firstPixel;P&&(a=[G.width-a.x-1,G.height-a.y-1-v]);let s=O(e,f.y);s.x=s.x+i*(I.delay-t.index*2)/2,s.y+=(d.y-G.height)/2,s.y-=G.height/2,s.y+=D,s.y+=v/2,s.y-=E.y,s=O(()=>Math.round(s));let S=G;if(P&&(S=j(G,!0,!0),s.y+=D+S.height-v*2),this.ctx.drawImage(S,s.x,s.y),r.push({dimension:m(S.width,S.height),position:s,note:I}),!I.isPause){if(this.ctx.fillStyle=this.getNoteColors(I).primary,R===0&&R===b.length-1){const B=[5,2];for(let l=0;l<I.bindingCount;l++)P?(this.ctx.fillRect(s.x+a.x,s.y+v+a.y+l*-6,...B),this.ctx.fillRect(s.x+a.x+B[0]-2,s.y+v+a.y+l*-6-2,2,2)):(this.ctx.fillRect(s.x+a.x,s.y+a.y+l*6,...B),this.ctx.fillRect(s.x+a.x+B[0]-2,2+s.y+a.y+l*6,2,2))}else if(c)h=m(s.x+a.x,s.y+a.y);else if(M){this.ctx.lineWidth=1;const B=4;this.ctx.beginPath();for(let l=0;l<I.bindingCount;l++)P?(this.ctx.moveTo(h.x,h.y+v-l*6),this.ctx.lineTo(s.x+a.x+1,s.y+a.y+v-l*6),this.ctx.lineTo(s.x+a.x+1,s.y+a.y+v-l*6+B),this.ctx.lineTo(h.x,h.y+v-l*6+B),this.ctx.lineTo(h.x,h.y+v-l*6)):(this.ctx.moveTo(h.x,h.y+l*6),this.ctx.lineTo(s.x+a.x+1,s.y+a.y+l*6),this.ctx.lineTo(s.x+a.x+1,s.y+a.y+l*6+B),this.ctx.lineTo(h.x,h.y+l*6+B),this.ctx.lineTo(h.x,h.y+l*6));this.ctx.fill(),h=null}}}}}return r}async resolveNote(t,e,{align:i,flip:n,binding:o}){const r=t[Number(e)],f=m(0,r.octavePosition*v);let d=0;const x=i===z.ASCENDING,p=i===z.EQUAL?0:3,y=t[t.length-1],w=t[0];o&&(n?x?d=Math.floor((r.octavePosition-w.octavePosition)*v-p*e):d=Math.floor((r.octavePosition-y.octavePosition)*v-p*(t.length-1-e)):x?d=Math.floor((y.octavePosition-r.octavePosition)*v-p*(t.length-1-e)):d=Math.floor((w.octavePosition-r.octavePosition)*v-p*e));const{canvas:b,...T}=await this.noteRenderer.render(r,{colors:this.getNoteColors(r)},d);return{offsetHeight:d,position:f,note:r,canvas:b,...T}}getNoteColors(t){return{primary:t.selected?this.colors.highlight:this.colors.foreground,secondary:this.colors.background}}}class gt{constructor(t,e){g(this,"colors",{background:"#0055aa",foreground:"#ffffff",highlight:"#ffaa55"});g(this,"gridInnerPadding",[20,0,10,0]);const{colors:i}=e||{};this.colors={...this.colors,...i},this.canvas=t,this.ctx=t.getContext("2d",{willReadFrequently:!0}),this.noteRenderer=new X,this.gridRenderer=new lt(this.canvas,{innerPadding:this.gridInnerPadding}),this.beatRenderer=new ht(this.canvas,{gridRenderer:this.gridRenderer,noteRenderer:this.noteRenderer})}async render(t,e={}){e={selectedIndex:[],flipActive:!1,...e},this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.gridRenderer.render({beatCount:t.beatCount,count:this.getOctaveLength(t)});let i=[];try{const n=t.getVisibleBeatsByDuration(void 0,W(t.notes));i=await this.beatRenderer.render({flipActive:e.flipActive,baseNote:t.baseNote,noteCount:t.noteCount,beats:n})}catch(n){console.error(n)}for(let n=0;n<this.gridRenderer.count;n++){const{position:o}=this.gridRenderer.getGridBoundingBox(n);this.renderTimeSignature(t,o.x+(this.gridInnerPadding[0]-6)/2,o.y+3)}return Q(this.ctx,["#000000","#ffffff",...Object.values(this.colors)]),{notes:i}}renderTimeSignature(t,e,i){const o=this.ctx;o.fillStyle=this.colors.foreground,o.textBaseline="top",o.font='16px "Amiga Topaz 13", sans-serif',o.fillText(t.baseNote,e,i),o.fillText(t.noteCount,e,i+16*1+1)}getOctaveLength(t){const{length:e}=$(t.notes);return Math.max(Math.floor(e*.8),1)}getDimension(t){const{height:e,gutter:i,outerMargin:n,innerMargin:o}=this.gridRenderer,r=this.getOctaveLength(t);return m(void 0,e*r+i*(r-1)+n[1]+n[3]+o[1]+o[3])}}const ut={class:"synthesizer-timeline-canvas"},ft=["data-note","data-time","onClick"],xt={__name:"TimelineCanvas",props:{flipActive:{type:Boolean,default:!1},track:{type:q,required:!0},clickable:{type:Boolean,default:!1},static:{type:Boolean,default:!1},selectedNotes:{type:Array,default:()=>[]},density:{type:Number,default(){return window.devicePixelRatio||1}}},emits:["note:click","refresh","ready"],setup(u,{emit:t}){const e=N(null),i=u,n=t,o=N(null),r=N(null),f=N(m(0,0)),d=N(null),x=N(null),p=N(!1),y=N(null);Z(()=>i.track,()=>{i.static||(window.clearTimeout(x.value),x.value=window.setTimeout(async()=>{await T(),x.value=null},250))},{deep:!0});const w=J(()=>{var c;return i.clickable?((c=o.value)==null?void 0:c.notes)||[]:[]}),b=()=>{const c=M=>{window.requestAnimationFrame(()=>{rt(async()=>{await T(),n("refresh"),M()})})};return new Promise(M=>{p.value?(window.clearTimeout(d.value),d.value=window.setTimeout(async()=>{await c(M),d.value=null},100)):c(M)})},T=async()=>{f.value=r.value.getDimension(i.track),e.value.width=e.value.offsetWidth*i.density,e.value.height=f.value.y*i.density,y.value.width=e.value.offsetWidth,y.value.height=f.value.y,o.value=await r.value.render(i.track,{flipActive:i.flipActive});const c=U(y.value,e.value.width);e.value.getContext("2d").drawImage(c,0,0,c.width,c.height,0,0,e.value.width,e.value.height)};K(()=>{y.value=y.value||document.createElement("canvas"),h(),n("ready"),p.value=!0});const h=async()=>{r.value=new gt(y.value),await b()},R=c=>{i.track.selectedIndex===c.index?i.track.selectedIndex=-1:i.track.selectedIndex=c.index,n("note:click",{note:c,selected:i.track.selectedIndex===c.index})};return(c,M)=>(k(),A("div",ut,[L("canvas",{ref_key:"canvasEl",ref:e,width:"0",height:"0"},null,512),(k(!0),A(tt,null,et(ot(w),({position:_,dimension:P,note:C})=>(k(),A("button",{key:C.index,"data-note":C.note.toString(),"data-time":C.time.toString(),class:it({selected:C.index===u.track.selectedIndex}),style:nt({..._.toCSSVars("position"),...P.toCSSVars("dimension")}),onClick:E=>R(C)},[L("span",null,"Note "+st(C.index),1)],14,ft))),128))]))}},Ct=Y(xt,[["__scopeId","data-v-ac8d8212"]]);export{Ct as T};
