var j=Object.defineProperty;var H=(s,e,t)=>e in s?j(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var w=(s,e,t)=>(H(s,typeof e!="symbol"?e+"":e,t),t);import{af as X,g as m}from"./index.0712caa6.js";import{B as v,h as U,T as K}from"./Track.34d43f2d.js";import{G as Y}from"./index.3998eac9.js";import{_ as Q,k as $,l as D,m as q,N as J,O as Z,L as ee,M as te,t as ie}from"./entry.9fb9bafb.js";function ne(s,e=["#000000"],t=!1){const i=s.getImageData(0,0,s.canvas.width,s.canvas.height),n=i.data;for(let r=0;r<n.length;r+=4){const c=n[Number(r)],o=n[r+1],d=n[r+2];(!e.includes(X(`#${c.toString(16)}${o.toString(16)}${d.toString(16)}`))||n[r+3]!==255)&&(n[r+3]=0)}return t&&(s=new OffscreenCanvas(i.width,i.height).getContext("2d")),s.putImageData(i,0,0),s.canvas}const se=(s,e,t)=>{const i=new OffscreenCanvas(s.width,s.height),n=i.getContext("2d"),r=1-e*2,c=1-t*2;return n.translate(e*s.width,t*s.height),n.scale(r,c),n.drawImage(s,0,0,s.width,s.height),i},re=4;class oe{constructor(e,t){w(this,"beatCount",1);w(this,"gutter",27);w(this,"count",1);w(this,"height",36);w(this,"outerMargin",[10,0,10,0]);w(this,"innerMargin",[0,48,0,48]);w(this,"innerPadding",[20,0,10,0]);w(this,"color","#ffaa55");this.setOptions(t),this.canvas=e,this.ctx=e.getContext("2d")}setOptions(e){const{gutter:t,height:i,margin:n,color:r,innerPadding:c}=e||{};this.gutter=t||this.gutter,this.height=i||this.height,this.margin=n||this.margin,this.color=r||this.color,this.innerPadding=c||this.innerPadding}render({beatCount:e,count:t}){this.count=t,this.beatCount=e;const i=this.ctx;i.clearRect(0,0,i.canvas.width,i.canvas.height);for(let n=0;n<this.count;n++)this.renderGridRow(this.getGridBoundingBox(n),this.getInnerGridBoundingBox(n))}getInnerGridRowBoundingBox(e){const{position:t,dimension:i}=this.getInnerGridBoundingBox(e);return{position:t,dimension:m(i.x,i.y*this.beatGrid.y+1)}}get firstRowIndex(){return 0}get lastRowIndex(){return this.count-1}get innerBoundingBox(){return{position:m(this.outerMargin[0],this.outerMargin[1]),dimension:m(this.ctx.canvas.width-(this.outerMargin[0]+this.outerMargin[2]),this.ctx.canvas.height-(this.outerMargin[1]+this.outerMargin[3]))}}get beatGrid(){return m(this.beatCount,re)}get dimension(){return m(this.canvas.width,this.canvas.height)}get mergedMargin(){return[this.outerMargin[0]+this.innerMargin[0],this.outerMargin[1]+this.innerMargin[1],this.outerMargin[2]+this.innerMargin[2],this.outerMargin[3]+this.innerMargin[3]]}getGridBoundingBox(e){const t=this.mergedMargin,i=t[0]+0,n=t[1]+e*this.height+e*this.gutter,r=-(t[0]+t[2])+this.dimension.x,c=this.height/this.beatGrid.y;return{position:m(i,n),dimension:m(r,c)}}getInnerGridBoundingBox(e){const{position:t,dimension:i}=this.getGridBoundingBox(e);return{position:m(t.x+this.innerPadding[0],t.y+this.innerPadding[1]),dimension:m(i.x-this.innerPadding[0]-this.innerPadding[2],(this.height-this.innerPadding[1]-this.innerPadding[3])/this.beatGrid.y)}}renderGridRow(e,t){const i=this.ctx;i.fillStyle=i.strokeStyle=this.color;let n=new Path2D;le(n,this.beatGrid,e),i.fill(n),n=new Path2D,ae(n,this.beatGrid,t,{first:!0,last:!0}),i.fill(n),i.fillRect(e.position.x+e.dimension.x-5,e.position.y,5,e.dimension.y*this.beatGrid.y)}}function ae(s,e,{position:t,dimension:i},n={}){const{first:r,last:c}={first:!1,last:!1,...n};for(let o=r?0:1;o<e.x+c||0;o++)s.rect(t.x+0+o*Math.floor(i.x/e.x),t.y,1,i.y*e.y)}function le(s,e,{position:t,dimension:i}){for(let n=0;n<=e.y;n++)s.rect(t.x,n*i.y+t.y,i.x,1)}function g(s,e,t,i,n=0){s.fillStyle=i,s.fillRect(Number(e.getAttribute("x"))+t[0],Number(e.getAttribute("y"))+t[1]-n,Number(e.getAttribute("width")),Number(e.getAttribute("height"))+n)}function f(s,e,t,i){if(!(e instanceof SVGPolygonElement))throw new Error("polygon is not an instance of SVGPolygonElement");s.fillStyle=i,s.beginPath(),Array.from(e.points).forEach((n,r)=>{r<1?s.moveTo(n.x+t[0],n.y+t[1]):s.lineTo(n.x+t[0],n.y+t[1])}),s.closePath(),s.fill()}const de=[{test:/^2m/,name:"sharp",selectors:[{selector:"#sharp rect",draw:g,offset:[-8,0]}]},{test:/^2m/,name:"doubleSharp",selectors:[{selector:"#double-sharp rect",draw:g,offset:[-8,0]}]},{test:/^2m/,name:"dot",selectors:[{selector:"#dot",draw:f,offset:[4,0]}]},{test:/^1m/,name:"sharp",selectors:[{selector:"#sharp rect",draw:g,offset:[-4,0]}]},{test:/^1m/,name:"doubleSharp",selectors:[{selector:"#double-sharp rect",draw:g,offset:[-4,0]}]},{test:/^1m/,name:"dot",selectors:[{selector:"#dot",draw:f,offset:[1,0]}]},{test:/^2m/,name:"flat",selectors:[{selector:"#flat-1 rect",draw:g,offset:[-8,0]}]},{test:/^2m/,name:"doubleFlat",selectors:[{selector:"#flat-1 rect",draw:g,offset:[-8,0]},{selector:"#flat-2 rect",draw:g,offset:[-8,0]}]},{test:/^1m/,name:"flat",selectors:[{selector:"#flat-1 rect",draw:g,offset:[-5,0]}]},{test:/^1m/,name:"doubleFlat",selectors:[{selector:"#flat-1 rect",draw:g,offset:[-5,0]},{selector:"#flat-2 rect",draw:g,offset:[-5,0]}]},{name:"flat",selectors:[{selector:"#flat-1 rect",draw:g}]},{name:"doubleFlat",selectors:[{selector:"#flat-1 rect",draw:g},{selector:"#flat-2 rect",draw:g}]},{name:"sharp",selectors:[{selector:"#sharp rect",draw:g}]},{name:"doubleSharp",selectors:[{selector:"#double-sharp rect",draw:(...s)=>g(...s)}]},{name:"dot",selectors:[{selector:"#dot",draw:f}]}],he=[{time:[/^1m/],offset:[0,3],selectors:[{selector:"#whole-pause",draw:g}]},{time:[/^2m/],offset:[0,3],selectors:[{selector:"#double-pause",draw:g}]},{time:[/^2[nt]/],offset:[0,7],selectors:[{selector:"#half-pause",draw:g}]},{time:[/^4[nt]/],offset:[0,0],selectors:[{selector:"#divide-pause-line-0",draw:g},{selector:"#divide-pause-line-1",draw:f}]},{time:[/^8[nt]/],selectors:[{selector:"#divide-pause-line-0",draw:g},{selector:"#divide-pause-line-1",draw:f},{selector:"#divide-pause-line-2",draw:f}]},{time:[/^16[nt]/],offset:[0,0],selectors:[{selector:"#divide-pause-line-0",draw:g},{selector:"#divide-pause-line-1",draw:f},{selector:"#divide-pause-line-2",draw:f,color:"black"},{selector:"#divide-pause-line-3",draw:f,color:"black"}]},{time:[/^32[nt]/],offset:[0,0],selectors:[{selector:"#divide-pause-line-0",draw:g},{selector:"#divide-pause-line-1",draw:f},{selector:"#divide-pause-line-2",draw:f},{selector:"#divide-pause-line-3",draw:f},{selector:"#divide-pause-line-4",draw:f}]}],O={PRIMARY:"primary",SECONDARY:"secondary",TERTIARY:"tertiary"},ce=[{time:[/^1m/],selectors:[{selector:"#whole-background",draw:f},{selector:"#whole-foreground",draw:f,color:O.SECONDARY}]},{time:[/^2m/],selectors:[{selector:"#whole-background",draw:f},{selector:"#whole-foreground",draw:f,color:O.SECONDARY},{selector:"#whole-double rect",draw:g}]},{time:[/^2[nt]/],selectors:[{selector:"#divide-background",draw:f},{selector:"#divide-foreground",draw:f,color:O.SECONDARY},{selector:"#divide-line",draw:g,autoHeight:!0}]},{time:[/^4[nt]/],selectors:[{selector:"#divide-background",draw:f},{selector:"#divide-line",draw:g,autoHeight:!0}]},{time:[/^8[nt]/],selectors:[{selector:"#divide-background",draw:f},{selector:"#divide-line",draw:g,autoHeight:!0}]},{time:[/^16[nt]/],selectors:[{selector:"#divide-background",draw:f},{selector:"#divide-line",draw:g,autoHeight:!0}]},{time:[/^32[nt]/],selectors:[{selector:"#divide-background",draw:f},{selector:"#divide-line",draw:g,autoHeight:!0}]}],ge=`<?xml version="1.0" encoding="utf-8"?>
<!-- Generator: Adobe Illustrator 27.8.1, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<svg version="1.1" id="Ebene_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="26px" height="39px" viewBox="0 0 26 39" style="enable-background:new 0 0 26 39;" xml:space="preserve">
<polygon id="divide-background" style="display:none;" points="19,30 19,29 18,29 18,28 16,28 16,27 13,27 13,28 11,28 11,29 10,29
	10,30 9,30 9,31 9,32 9,33 10,33 10,34 11,34 11,35 13,35 13,36 16,36 16,35 18,35 18,34 19,34 19,33 20,33 20,32 20,31 20,30 "/>
<polygon id="divide-foreground" style="display:none;fill:#FFFFFF;" points="16,30 16,29 15,29 14,29 14,30 13,30 13,31 12,31
	12,32 12,33 13,33 13,34 14,34 15,34 15,33 16,33 16,32 17,32 17,31 17,30 "/>
<rect id="divide-line" x="19" width="1" height="30"/>
<polygon id="divide-line-4" style="display:none;" points="20,23 24,23 24,25 26,25 26,22 25,22 25,21 20,21 "/>
<polygon id="divide-line-3" style="display:none;" points="20,17 24,17 24,19 26,19 26,16 25,16 25,15 20,15 "/>
<polygon id="divide-line-2" style="display:none;" points="20,11 24,11 24,13 26,13 26,10 25,10 25,9 20,9 "/>
<polygon id="divide-line-1" style="display:none;" points="20,5 24,5 24,7 26,7 26,4 25,4 25,3 20,3 "/>
<polygon id="dot" style="display:none;" points="24,31 23,31 23,30 22,30 22,31 21,31 21,32 22,32 22,33 23,33 23,32 24,32 "/>
<polygon id="whole-background" points="18.9,30 18.9,29 17.9,29 17.9,28 15.7,28 15.7,27 9.3,27 9.3,28 7.1,28 7.1,29 6.1,29
	6.1,30 5,30 5,31 5,32 5,33 6.1,33 6.1,34 7.1,34 7.1,35 9.3,35 9.3,36 15.7,36 15.7,35 17.9,35 17.9,34 18.9,34 18.9,33 20,33
	20,32 20,31 20,30 "/>
<polygon id="whole-foreground" style="fill:#FFFFFF;" points="14.8,31 14.8,30 13.7,30 13.7,29 10.2,29 10.2,30 9,30 9,32 10.2,32
	10.2,33 11.3,33 11.3,34 14.8,34 14.8,33 16,33 16,31 "/>
<g id="whole-double" style="display:none;">
	<rect x="3" y="27" style="display:inline;" width="1" height="9"/>
	<rect x="1" y="27" style="display:inline;" width="1" height="9"/>
	<rect x="23" y="27" style="display:inline;" width="1" height="9"/>
	<rect x="21" y="27" style="display:inline;" width="1" height="9"/>
</g>
<polygon id="divide-pause-line-4" style="display:none;" points="17,6 17,7 16,7 16,6 16,5 15,5 15,4 13,4 13,5 12,5 12,6 12,7
	13,7 13,8 15,8 17,8 17,12 18,12 18,6 "/>
<polygon id="divide-pause-line-3" style="display:none;" points="16,12 16,13 15,13 15,12 15,11 14,11 14,10 12,10 12,11 11,11
	11,12 11,13 12,13 12,14 14,14 16,14 16,18 17,18 17,12 "/>
<polygon id="divide-pause-line-2" style="display:none;" points="15,18 15,19
	14,19 14,18 14,17 13,17 13,16 11,16 11,17 10,17 10,18 10,19 11,19 11,20 13,20 15,20 15,24 16,24 16,18 "/>
<polygon id="divide-pause-line-1" style="display:none;" points="14,24 14,25
	13,25 13,24 13,23 12,23 12,22 10,22 10,23 9,23 9,24 9,25 10,25 10,26 12,26 14,26 14,30 15,30 15,24 "/>
<rect id="divide-pause-line-0" x="13" y="30" style="display:none;" width="1" height="6"/>
<rect id="half-pause" x="10" y="27" style="display:none;" width="8" height="3"/>
<rect id="whole-pause" x="10" y="31" style="display:none;" width="8" height="3"/>
<rect id="double-pause" x="10" y="27" style="display:none;" width="8" height="7"/>
<g id="sharp" style="display:none;">
	<rect x="3" y="27" style="display:inline;" width="1" height="9"/>
	<rect x="1" y="29" style="display:inline;" width="7" height="1"/>
	<rect x="1" y="33" style="display:inline;" width="7" height="1"/>
	<rect x="5" y="27" style="display:inline;" width="1" height="9"/>
</g>
<g id="double-sharp" style="display:none;">
	<rect x="1" y="29" style="display:inline;" width="2" height="2"/>
	<rect x="1" y="33" style="display:inline;" width="2" height="2"/>
	<rect x="5" y="29" style="display:inline;" width="2" height="2"/>
	<rect x="5" y="33" style="display:inline;" width="2" height="2"/>
	<rect x="3" y="31" style="display:inline;" width="2" height="2"/>
</g>
<g id="flat-2" style="display:none;">
	<rect x="1" y="30" style="display:inline;" width="2" height="1"/>
	<rect y="23" style="display:inline;" width="1" height="13"/>
	<rect x="3" y="31" style="display:inline;" width="1" height="4"/>
	<rect y="31" style="display:inline;" width="1" height="4"/>
	<rect x="1" y="35" style="display:inline;" width="2" height="1"/>
</g>
<g id="flat-1" style="display:none;">
	<rect x="5" y="30" style="display:inline;" width="2" height="1"/>
	<rect x="4" y="23" style="display:inline;" width="1" height="13"/>
	<rect x="7" y="31" style="display:inline;" width="1" height="4"/>
	<rect x="4" y="31" style="display:inline;" width="1" height="4"/>
	<rect x="5" y="35" style="display:inline;" width="2" height="1"/>
</g>
<g id="natural" style="display:none;">
	<rect x="4" y="27" style="display:inline;" width="2" height="2"/>
	<rect x="4" y="32" style="display:inline;" width="2" height="2"/>
	<rect x="2" y="28" style="display:inline;" width="2" height="2"/>
	<rect x="2" y="33" style="display:inline;" width="2" height="2"/>
	<rect x="6" y="26" style="display:inline;" width="1" height="12"/>
	<rect x="1" y="24" style="display:inline;" width="1" height="12"/>
</g>
</svg>
`,z=100,V=3;class ue{constructor(e){this.canvas=e,this.firstPixel=fe(this.canvas)}}function fe(s){const{data:e}=s.getContext("2d").getImageData(0,0,s.width,s.height);for(let t=0;t<e.length;t+=4)if(e[t+3]===255){const i=Math.floor(t/4/s.width);return[t/4-i*s.width,i]}}const ye=new Map;class pe{constructor(e){w(this,"localCache",!1);w(this,"_cache",new Map);w(this,"colors",{background:"#000000",foreground:"#000000"});const{localCache:t}=e||{};this.localCache=t!==void 0?t:!1,this.queue=Promise.resolve();const i=new DOMParser;this.svgNode=i.parseFromString(ge,"image/svg+xml").querySelector("svg");const{width:n,height:r}=this.svgNode.viewBox.baseVal;this.dimension=m(n,r),this.canvas=new OffscreenCanvas(this.dimension.x+z,this.dimension.y+z),this.canvasContext=this.canvas.getContext("2d",{willReadFrequently:!0}),this.canvasContext.imageSmoothingEnabled=!1}get cache(){return this.localCache?this._cache:ye}render(e,t,i=0){const{colors:n}=t||{},r={background:"#0055aa",foreground:"#000000",...n},c=[e.getName(),e.getTime(),Object.values(r).join("_"),i].join("_");return this.cache.has(c)?Promise.resolve(this.cache.get(c)):this.queue=this.queue.then(()=>{var G,M,B,E,P;const o=this.svgNode,d=this.canvasContext.canvas,a=this.canvasContext;a.clearRect(0,0,d.width,d.height);const l=(e.isPause?he:ce).find(N=>N.time.find(u=>u.test(e.time.toString())));l&&_(o,a,l.selectors,r,i),(G=e.time)!=null&&G.dot&&_(o,a,F("dot",e),r,i),(M=e.note)!=null&&M.flat&&_(o,a,F("flat",e),r,i),(B=e.note)!=null&&B.doubleFlat&&_(o,a,F("doubleFlat",e),r,i),(E=e.note)!=null&&E.sharp&&_(o,a,F("sharp",e),r,i),(P=e.note)!=null&&P.doubleSharp&&_(o,a,F("doubleSharp",e),r,i);const{x:h,y:I,width:R,height:k}=we(a);let y=0,x=k+V;l.offset&&(l.offset[1]<0?(y=Math.abs(y),x+=Math.abs(y)):x+=l.offset[1]);const b=new OffscreenCanvas(R,x),C=b.getContext("2d");C.imageSmoothingEnabled=!1,C.drawImage(d,h,I,b.width,b.height,0,0,b.width,b.height);const A=new ue(b);return this.cache.set(c,A),A})}}function we(s){const e=s.canvas,t=s.getImageData(0,0,e.width,e.height).data;let i=1/0,n=-1/0,r=1/0,c=-1/0;for(let o=0;o<t.length;o+=4){const d=Math.floor(o/4)%e.width,a=Math.floor(o/4/e.width);t[o+3]&&(d<i?i=d:d>n&&(n=d),a<r?r=a:a>c&&(c=a))}return{x:i,y:r,width:n-i+1,height:c-r+1}}function _(s,e,t,i,n=0){t.forEach(({selector:r,draw:c,color:o,offset:d,autoHeight:a})=>{d=[...d||[0,0]],d[0]+=(e.canvas.width-26)/2,d[1]+=n,Array.from(s.querySelectorAll(r)).forEach(S=>{c(e,S,d,i[String(o||O.PRIMARY)],a&&n||0)})})}function F(s,e){var t;return(t=de.find(i=>{var n;return i.name===s&&(((n=i.test)==null?void 0:n.test(e.time.toString()))||!i.test)}))==null?void 0:t.selectors}class me{constructor(e,t={}){w(this,"padding",10);w(this,"flipActive",!1);w(this,"colors",{background:"#0055aa",foreground:"#ffffff",highlight:"#ffaa55"});w(this,"baseNote",4);w(this,"noteCount",4);const{colors:i,gridRenderer:n,noteRenderer:r}={gridRenderer:null,noteRenderer:null,...t};this.colors={...this.colors,...i},this.gridRenderer=n,this.noteRenderer=r,this.canvas=e,this.ctx=e.getContext("2d")}async render({baseNote:e,noteCount:t,beats:i,flipActive:n}){this.flipActive=n||!1,this.baseNote=e,this.noteCount=t,this.beats=i,console.log("beats",i);const r=this.gridRenderer.beatCount,{position:c,dimension:o}=this.gridRenderer.getInnerGridRowBoundingBox(this.gridRenderer.lastRowIndex),d=[];for(let a=0;a<this.beats.length;a++){const S=this.beats[Number(a)],l=o.x/r-this.padding*2,h=c.x+this.padding+a*l+a*this.padding*2;d.push(await this.renderBeat(S,h,l))}return d.flat()}async renderBeat(e,t,i){const n=this.baseNote,r=this.noteCount,{position:c,dimension:o}=this.gridRenderer.getInnerGridRowBoundingBox(this.gridRenderer.lastRowIndex),{groupedNotes:d}=e;let a=0;const S=[];let l,h;for(let I=0;I<d.length;I++){const{notes:R,direction:k}=d[Number(I)];let y;for(let x=0;x<R.length;x++){l=t+a,h=c.y;const b=R[Number(x)];if(b.isPause&&b.duration){const C=m(3,8);this.ctx.fillRect(l,h+o.y/2-8,C.x,16),this.ctx.fillRect(l+Math.floor(i*b.duration/2)-C.x+1,h+o.y/2-C.y,C.x,16),this.ctx.fillRect(l,h+o.y/2-C.x/2,i*b.duration/2,C.x),a+=i*b.duration/2,S.push({dimension:m(i*b.duration/2,16),position:m(l,h+o.y/2-8),note:b})}else{const C=x===0,A=x===R.length-1,G=R[Number(x)].bindingCount&&(C||y),M=this.flipActive&&R[Number(x)].bindingCount>0&&I%2===1&&R[Number(x)].name,B=await this.resolveNote(R,x,{baseNote:n,noteCount:r,width:i,direction:k,flip:M,binding:G}),{position:E,note:P,canvas:N}=B;let u=B.firstPixel;M&&(u=[N.width-u[0]-1,N.height-u[1]-1-v]),h+=(o.y-N.height)/2,h-=N.height/2,h+=V,h+=v/2,h-=E.y,l=Math.round(l),h=Math.round(h),a+=E.x;let L=N;if(M&&(L=se(N,!0,!0),h+=V+N.height-v*2),this.ctx.drawImage(L,l,h),S.push({dimension:m(N.width,N.height),position:m(l,h),note:P}),!P.isPause){if(this.ctx.fillStyle=this.getNoteColors(P).primary,x===0&&x===R.length-1){const T=[5,2];for(let p=0;p<P.bindingCount;p++)M?(this.ctx.fillRect(l+u[0],h+v+u[1]+p*-6,...T),this.ctx.fillRect(l+u[0]+T[0]-2,h+v+u[1]+p*-6-2,2,2)):(this.ctx.fillRect(l+u[0],h+u[1]+p*6,...T),this.ctx.fillRect(l+u[0]+T[0]-2,2+h+u[1]+p*6,2,2))}else if(C)y=[l+u[0],h+u[1]];else if(A){this.ctx.lineWidth=1;const T=4;this.ctx.beginPath();for(let p=0;p<P.bindingCount;p++)M?(this.ctx.moveTo(y[0],y[1]+v-p*6),this.ctx.lineTo(l+u[0]+1,h+u[1]+v-p*6),this.ctx.lineTo(l+u[0]+1,h+u[1]+v-p*6+T),this.ctx.lineTo(y[0],y[1]+v-p*6+T),this.ctx.lineTo(y[0],y[1]+v-p*6)):(this.ctx.moveTo(y[0],y[1]+p*6),this.ctx.lineTo(l+u[0]+1,h+u[1]+p*6),this.ctx.lineTo(l+u[0]+1,h+u[1]+p*6+T),this.ctx.lineTo(y[0],y[1]+p*6+T),this.ctx.lineTo(y[0],y[1]+p*6));this.ctx.fill(),y=null}}}}}return S}async resolveNote(e,t,{width:i,direction:n,flip:r,binding:c}){const o=e[Number(t)],d=m(o.toSeconds()/(2*(this.baseNote/this.noteCount))*i,o.position*v);let a=0;const S=n===Y.ASCENDING,l=n===Y.EQUAL?0:3,h=e[e.length-1],I=e[0];r?S?a=Math.floor((o.position-I.position)*v-l*t):a=Math.floor((o.position-h.position)*v-l*(e.length-1-t)):S?a=Math.floor((h.position-o.position)*v-l*(e.length-1-t)):a=Math.floor((I.position-o.position)*v-l*t);const{canvas:R,...k}=await this.noteRenderer.render(o,{colors:this.getNoteColors(o)},c?a:0);return{offsetHeight:a,position:d,note:o,canvas:R,...k}}getNoteColors(e){return{primary:e.selected?this.colors.highlight:this.colors.foreground,secondary:this.colors.background}}}class xe{constructor(e,t){w(this,"colors",{background:"#0055aa",foreground:"#ffffff",highlight:"#ffaa55"});w(this,"gridInnerPadding",[20,0,10,0]);const{colors:i}=t||{};this.colors={...this.colors,...i},this.canvas=e,this.ctx=e.getContext("2d",{willReadFrequently:!0}),this.noteRenderer=new pe,this.gridRenderer=new oe(this.canvas,{innerPadding:this.gridInnerPadding}),this.beatRenderer=new me(this.canvas,{gridRenderer:this.gridRenderer,noteRenderer:this.noteRenderer})}async render(e,t={}){t={selectedIndex:-1,flipActive:!1,...t},this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.gridRenderer.render({beatCount:e.beatCount,count:this.getOctaveLength(e)});const i=await this.beatRenderer.render({flipActive:t.flipActive,baseNote:e.baseNote,noteCount:e.noteCount,beats:e.getVisibleBeats(t)});for(let n=0;n<this.gridRenderer.count;n++){const{position:r}=this.gridRenderer.getGridBoundingBox(n);this.renderTimeSignature(e,r.x+(this.gridInnerPadding[0]-6)/2,r.y+3)}return ne(this.ctx,["#000000","#ffffff",...Object.values(this.colors)]),{notes:i}}renderTimeSignature(e,t,i){const r=this.ctx;r.fillStyle=this.colors.foreground,r.textBaseline="top",r.font='16px "Amiga Topaz 13", sans-serif',r.fillText(e.baseNote,t,i),r.fillText(e.noteCount,t,i+16*1+1)}getOctaveLength(e){const{length:t}=U(e.notes);return Math.max(Math.floor(t*.8),1)}getDimension(e){const{height:t,gutter:i,outerMargin:n,innerMargin:r}=this.gridRenderer,c=this.getOctaveLength(e);return m(void 0,t*c+i*(c-1)+n[1]+n[3]+r[1]+r[3])}}const ve={props:{flipActive:{type:Boolean,default:!1},track:{type:K,required:!0},clickable:{type:Boolean,default:!1}},emits:["note:click","refresh","ready"],data(){return{colors:{background:"#ffffff",foreground:"#000000",highlight:"#ffaa55"},renderResult:null,gridRenderer:null,dimension:m(0,0),renderTimeout:null,ready:!1}},computed:{buttons(){var s;return this.clickable?((s=this.renderResult)==null?void 0:s.notes)||[]:[]},notes(){return this.track.notes}},watch:{track:{async handler(){await this.refresh()},deep:!0}},async mounted(){await this.createRenderer(),this.$emit("ready"),this.ready=!0},methods:{refresh(){return new Promise(s=>{const e=t=>{window.requestAnimationFrame(async()=>{this.dimension=this.timelineRenderer.getDimension(this.track),this.$refs.canvas.width=this.$refs.canvas.offsetWidth,this.$refs.canvas.height=this.dimension.y,await this.render(),this.$emit("refresh"),t()})};this.ready?(window.clearTimeout(this.renderTimeout),this.renderTimeout=null,this.renderTimeout=window.setTimeout(async()=>{await e(s),this.renderTimeout=null},this.renderTimeout?50:0)):e(s)})},async render(){this.renderResult=await this.timelineRenderer.render(this.track,{flipActive:this.flipActive})},async createRenderer(){this.timelineRenderer=new xe(this.$refs.canvas),await this.refresh()},onClickNote(s){this.track.selectedIndex===s.index?this.track.selectedIndex=-1:this.track.selectedIndex=s.index,this.$emit("note:click",{note:s,selected:this.track.selectedIndex===s.index})}}},be={ref:"canvas",width:"0",height:"0"},Re=["data-note","data-time","onClick"];function Ce(s,e,t,i,n,r){return $(),D("div",null,[q("canvas",be,null,512),($(!0),D(J,null,Z(r.buttons,({position:c,dimension:o,note:d})=>($(),D("button",{key:d.index,"data-note":d.note.toString(),"data-time":d.time.toString(),class:ee({selected:d.index===t.track.selectedIndex}),style:te({...c.toCSSVars("position"),...o.toCSSVars("dimension")}),onClick:a=>r.onClickNote(d)},[q("span",null,"Note "+ie(d.index),1)],14,Re))),128))])}const Pe=Q(ve,[["render",Ce],["__scopeId","data-v-a6843418"]]);export{pe as N,ge as S,Pe as T};
